<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAG í†µí•© í…ŒìŠ¤íŠ¸ - ê°ë¦°ì´</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css" rel="stylesheet">
  <style>
    body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
    .log-container { max-height: 400px; overflow-y: auto; }
    .log-entry { padding: 8px; margin: 4px 0; border-radius: 4px; font-size: 13px; font-family: 'Courier New', monospace; }
    .log-info { background: #e0f2fe; color: #0c4a6e; }
    .log-success { background: #dcfce7; color: #14532d; }
    .log-error { background: #fee2e2; color: #7f1d1d; }
    .log-warning { background: #fef3c7; color: #78350f; }
  </style>
</head>
<body class="bg-gray-50 p-8">
  <div class="max-w-4xl mx-auto">
    <header class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <h1 class="text-3xl font-bold text-purple-600 mb-2">ğŸ” RAG í†µí•© í…ŒìŠ¤íŠ¸</h1>
      <p class="text-gray-600">ragService.searchAll() í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ - ì±—ë´‡ í†µí•© í™•ì¸</p>
    </header>

    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">ğŸ”‘ API ì„¤ì •</h2>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-2">Gemini API Key:</label>
        <div class="flex gap-2">
          <input
            type="password"
            id="api-key-input"
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
            placeholder="API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          >
          <button
            id="save-api-key-btn"
            class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition"
          >
            ì €ì¥
          </button>
          <button
            id="clear-api-key-btn"
            class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition"
          >
            ì‚­ì œ
          </button>
        </div>
        <p id="api-key-status" class="text-sm mt-2 text-gray-600"></p>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">ğŸ“ í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬</h2>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-2">ì§ˆë¬¸ ì…ë ¥:</label>
        <input
          type="text"
          id="query-input"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
          placeholder="ì˜ˆ: ê°ì‚¬ìœ„í—˜ì´ë€ ë¬´ì—‡ì¸ê°€?"
          value="ê°ì‚¬ìœ„í—˜ì´ë€ ë¬´ì—‡ì¸ê°€?"
        >
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-2">í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„):</label>
        <input
          type="text"
          id="keywords-input"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
          placeholder="ì˜ˆ: ì¤‘ìš”ì„±, ë…ë¦½ì„±, ë‚´ë¶€í†µì œ"
        >
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-2">íƒ€ì…ë³„ ê²€ìƒ‰ ê°œìˆ˜ (topK):</label>
        <input
          type="number"
          id="topk-input"
          class="w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
          value="3"
          min="1"
          max="10"
        >
      </div>

      <button
        id="search-btn"
        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg transition disabled:bg-gray-400 disabled:cursor-not-allowed"
      >
        ğŸ” ê²€ìƒ‰ ì‹¤í–‰
      </button>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">ğŸ“Š ê²€ìƒ‰ ê²°ê³¼</h2>

      <div id="results-container" class="space-y-4">
        <p class="text-gray-500 text-center py-8">ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6">
      <h2 class="text-xl font-bold mb-4">ğŸ–¥ï¸ ì½˜ì†” ë¡œê·¸</h2>

      <div id="log-container" class="log-container bg-gray-50 p-4 rounded-lg border border-gray-200">
        <p class="text-gray-500 text-sm">ì½˜ì†” ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
      </div>

      <button
        id="clear-log-btn"
        class="mt-3 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition text-sm"
      >
        ë¡œê·¸ ì§€ìš°ê¸°
      </button>
    </div>
  </div>

  <!-- RAG Service -->
  <script src="./js/services/ragService.js"></script>

  <script>
    // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
    const logContainer = document.getElementById('log-container');

    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function clearLog() {
      logContainer.innerHTML = '<p class="text-gray-500 text-sm">ì½˜ì†” ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>';
    }

    // ì›ë³¸ console í•¨ìˆ˜ ì˜¤ë²„ë¼ì´ë“œ
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    console.log = function(...args) {
      originalLog.apply(console, args);
      addLog(args.join(' '), 'info');
    };

    console.error = function(...args) {
      originalError.apply(console, args);
      addLog(args.join(' '), 'error');
    };

    console.warn = function(...args) {
      originalWarn.apply(console, args);
      addLog(args.join(' '), 'warning');
    };

    // ê²€ìƒ‰ ì‹¤í–‰
    document.getElementById('search-btn').addEventListener('click', async () => {
      const queryInput = document.getElementById('query-input');
      const keywordsInput = document.getElementById('keywords-input');
      const topKInput = document.getElementById('topk-input');
      const searchBtn = document.getElementById('search-btn');
      const resultsContainer = document.getElementById('results-container');

      const query = queryInput.value.trim();
      const keywords = keywordsInput.value.trim()
        ? keywordsInput.value.split(',').map(k => k.trim()).filter(k => k)
        : [];
      const topK = parseInt(topKInput.value) || 3;

      if (!query) {
        alert('ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”!');
        return;
      }

      // UI ë¹„í™œì„±í™”
      searchBtn.disabled = true;
      searchBtn.textContent = 'ğŸ” ê²€ìƒ‰ ì¤‘...';
      resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">ê²€ìƒ‰ ì¤‘...</p>';

      try {
        console.log('='.repeat(60));
        console.log('ğŸ” RAG í†µí•© ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ì‹œì‘');
        console.log('='.repeat(60));

        addLog('ê²€ìƒ‰ ì‹œì‘...', 'info');
        addLog(`ì¿¼ë¦¬: "${query}"`, 'info');
        addLog(`í‚¤ì›Œë“œ: [${keywords.join(', ')}]`, 'info');
        addLog(`topK: ${topK}`, 'info');

        const startTime = performance.now();
        const results = await ragService.searchAll(query, keywords, topK);
        const endTime = performance.now();
        const duration = (endTime - startTime).toFixed(0);

        addLog(`âœ… ê²€ìƒ‰ ì™„ë£Œ (${duration}ms)`, 'success');

        // ê²°ê³¼ í‘œì‹œ
        let html = '';

        // í†µê³„
        const total = results.audit.length + results.law.length + results.ethics.length +
                     results.study.length + results.kam.length + results.auditcase.length + results.exam.length;

        html += `
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
            <h3 class="font-bold text-purple-900 mb-2">ğŸ“Š ê²€ìƒ‰ í†µê³„</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
              <div><span class="font-semibold">ì´ ë¬¸ì„œ:</span> ${total}ê°œ</div>
              <div><span class="font-semibold">ê²€ìƒ‰ ì‹œê°„:</span> ${duration}ms</div>
              <div><span class="font-semibold">ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´:</span> ${results.context.length}ì</div>
            </div>
          </div>
        `;

        // íƒ€ì…ë³„ ê²°ê³¼
        const types = [
          { key: 'audit', label: 'ğŸ“˜ íšŒê³„ê°ì‚¬ê¸°ì¤€', color: 'blue' },
          { key: 'law', label: 'ğŸ“• ì™¸ë¶€ê°ì‚¬ë²•', color: 'red' },
          { key: 'ethics', label: 'ğŸ“— ìœ¤ë¦¬ê¸°ì¤€', color: 'green' },
          { key: 'study', label: 'ğŸ“š í•™ìŠµìë£Œ', color: 'yellow' },
          { key: 'kam', label: 'ğŸ’¼ KAM ì‚¬ë¡€', color: 'purple' },
          { key: 'auditcase', label: 'ğŸš¨ ê°ë¦¬ì§€ì ì‚¬ë¡€', color: 'orange' },
          { key: 'exam', label: 'ğŸ“ ê¸°ì¶œë¬¸ì œ', color: 'indigo' }
        ];

        types.forEach(({ key, label, color }) => {
          const docs = results[key];
          if (docs && docs.length > 0) {
            html += `
              <div class="border border-${color}-200 rounded-lg p-4 mb-3">
                <h3 class="font-bold text-${color}-900 mb-2">${label} (${docs.length}ê°œ)</h3>
                <div class="space-y-2">
            `;

            docs.forEach((doc, idx) => {
              const similarity = (doc.similarity * 100).toFixed(1);
              const preview = doc.text.substring(0, 150);
              const title = doc.metadata?.title || 'ì œëª© ì—†ìŒ';

              html += `
                <div class="bg-${color}-50 border border-${color}-100 rounded p-3 text-sm">
                  <div class="flex justify-between items-start mb-1">
                    <span class="font-semibold text-${color}-900">${idx + 1}. ${title}</span>
                    <span class="text-${color}-700 text-xs bg-${color}-100 px-2 py-1 rounded">${similarity}%</span>
                  </div>
                  <p class="text-gray-700 text-xs">${preview}${preview.length >= 150 ? '...' : ''}</p>
                </div>
              `;
            });

            html += `
                </div>
              </div>
            `;

            addLog(`${label}: ${docs.length}ê°œ (ìµœê³  ìœ ì‚¬ë„: ${(docs[0].similarity * 100).toFixed(1)}%)`, 'success');
          } else {
            addLog(`${label}: 0ê°œ`, 'warning');
          }
        });

        // ì»¨í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°
        if (results.context) {
          const preview = results.context.substring(0, 500);
          const previewEscaped = preview.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const suffix = preview.length >= 500 ? '\n\n... (ìƒëµ)' : '';

          const contextDiv = document.createElement('div');
          contextDiv.className = 'border border-gray-300 rounded-lg p-4';
          contextDiv.innerHTML = `
            <h3 class="font-bold text-gray-900 mb-2">ğŸ“„ AI ì»¨í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h3>
            <pre class="bg-gray-50 p-3 rounded text-xs overflow-x-auto whitespace-pre-wrap">${previewEscaped}${suffix}</pre>
            <button
              id="copy-context-btn"
              class="mt-2 px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded text-xs"
            >
              ğŸ“‹ ì „ì²´ ì»¨í…ìŠ¤íŠ¸ ë³µì‚¬
            </button>
          `;

          resultsContainer.innerHTML = html;
          resultsContainer.appendChild(contextDiv);

          // ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          document.getElementById('copy-context-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(results.context)
              .then(() => alert('ì»¨í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'))
              .catch(err => alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err));
          });

          return; // ì´ë¯¸ innerHTMLì„ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ ì•„ë˜ ì½”ë“œ ì‹¤í–‰ ì•ˆ í•¨
        }

        resultsContainer.innerHTML = html;

        console.log('='.repeat(60));
        console.log('âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
        console.log('='.repeat(60));

      } catch (error) {
        console.error('âŒ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
        addLog(`ê²€ìƒ‰ ì‹¤íŒ¨: ${error.message}`, 'error');

        resultsContainer.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h3 class="font-bold text-red-900 mb-2">âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
            <p class="text-red-700 text-sm">${error.message}</p>
            <pre class="bg-red-100 p-3 rounded text-xs mt-2 overflow-x-auto">${error.stack}</pre>
          </div>
        `;
      } finally {
        // UI ì¬í™œì„±í™”
        searchBtn.disabled = false;
        searchBtn.textContent = 'ğŸ” ê²€ìƒ‰ ì‹¤í–‰';
      }
    });

    // ë¡œê·¸ ì§€ìš°ê¸°
    document.getElementById('clear-log-btn').addEventListener('click', clearLog);

    // API í‚¤ ê´€ë¦¬
    const apiKeyInput = document.getElementById('api-key-input');
    const apiKeyStatus = document.getElementById('api-key-status');
    const saveApiKeyBtn = document.getElementById('save-api-key-btn');
    const clearApiKeyBtn = document.getElementById('clear-api-key-btn');

    // API í‚¤ ì €ì¥
    saveApiKeyBtn.addEventListener('click', () => {
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        apiKeyStatus.textContent = 'âš ï¸ API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
        apiKeyStatus.className = 'text-sm mt-2 text-orange-600';
        return;
      }

      localStorage.setItem('gemini_api_key', apiKey);
      apiKeyStatus.textContent = `âœ… API Key ì €ì¥ ì™„ë£Œ! (${apiKey.substring(0, 8)}...${apiKey.substring(apiKey.length - 4)})`;
      apiKeyStatus.className = 'text-sm mt-2 text-green-600';
      addLog(`API Key ì €ì¥ ì™„ë£Œ (${apiKey.substring(0, 8)}...)`, 'success');
    });

    // API í‚¤ ì‚­ì œ
    clearApiKeyBtn.addEventListener('click', () => {
      localStorage.removeItem('gemini_api_key');
      apiKeyInput.value = '';
      apiKeyStatus.textContent = 'ğŸ—‘ï¸ API Keyê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
      apiKeyStatus.className = 'text-sm mt-2 text-gray-600';
      addLog('API Key ì‚­ì œ ì™„ë£Œ', 'info');
    });

    // API í‚¤ ìƒíƒœ í™•ì¸
    function checkApiKeyStatus() {
      const savedKey = localStorage.getItem('gemini_api_key');
      if (savedKey) {
        apiKeyStatus.textContent = `âœ… API Key ì €ì¥ë¨ (${savedKey.substring(0, 8)}...${savedKey.substring(savedKey.length - 4)})`;
        apiKeyStatus.className = 'text-sm mt-2 text-green-600';
        addLog(`ì €ì¥ëœ API Key í™•ì¸ (${savedKey.substring(0, 8)}...)`, 'info');
      } else {
        apiKeyStatus.textContent = 'âš ï¸ API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìœ„ ì…ë ¥ë€ì— API Keyë¥¼ ì…ë ¥í•˜ê³  ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
        apiKeyStatus.className = 'text-sm mt-2 text-orange-600';
        addLog('API Key ë¯¸ì„¤ì • - ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ
    window.addEventListener('load', () => {
      addLog('âœ… í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'success');
      addLog('ragService ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...', 'info');
      checkApiKeyStatus();
    });
  </script>
</body>
</html>
