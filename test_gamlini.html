<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gamlini 2.0 Test Suite</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .test-section {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .test-pass {
      color: #10b981;
      font-weight: bold;
    }
    .test-fail {
      color: #ef4444;
      font-weight: bold;
    }
    .log-output {
      background: #1f2937;
      color: #f3f4f6;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">ü§ñ Gamlini 2.0 Test Suite</h1>

    <!-- Test Results Summary -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Test Results</h2>
      <div id="test-summary" class="space-y-2">
        <!-- ÎèôÏ†ÅÏúºÎ°ú Ï±ÑÏõåÏßê -->
      </div>
    </div>

    <!-- Test 1: RAG Service -->
    <div class="test-section bg-white">
      <h3 class="text-lg font-bold mb-3">Test 1: RAG Service</h3>
      <button id="test-rag" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        Run RAG Service Test
      </button>
      <div id="rag-result" class="mt-4 hidden">
        <div class="log-output" id="rag-log"></div>
      </div>
    </div>

    <!-- Test 2: Chat Storage Manager -->
    <div class="test-section bg-white">
      <h3 class="text-lg font-bold mb-3">Test 2: Chat Storage Manager</h3>
      <button id="test-storage" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
        Run Chat Storage Test
      </button>
      <div id="storage-result" class="mt-4 hidden">
        <div class="log-output" id="storage-log"></div>
      </div>
    </div>

    <!-- Test 3: Gamlini Drawer UI -->
    <div class="test-section bg-white">
      <h3 class="text-lg font-bold mb-3">Test 3: Gamlini Drawer UI</h3>
      <button id="test-drawer" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
        Initialize Gamlini Drawer
      </button>
      <button id="open-drawer" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 ml-2">
        Open Drawer (Demo)
      </button>
      <div id="drawer-result" class="mt-4 hidden">
        <div class="log-output" id="drawer-log"></div>
      </div>
    </div>

    <!-- Test 4: AI Tutor Integration -->
    <div class="test-section bg-white">
      <h3 class="text-lg font-bold mb-3">Test 4: AI Tutor Session</h3>
      <button id="test-tutor" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">
        Create AI Tutor Session
      </button>
      <div id="tutor-result" class="mt-4 hidden">
        <div class="log-output" id="tutor-log"></div>
      </div>
    </div>

    <!-- Console Log -->
    <div class="bg-gray-900 rounded-lg shadow p-6 mt-6">
      <h2 class="text-xl font-bold text-white mb-4">Console Log</h2>
      <div class="log-output" id="console-log"></div>
    </div>
  </div>

  <script type="module">
    import { ragService } from './js/services/ragService.js';
    import { chatStorage } from './js/services/chatStorageManager.js';
    import { initializeGamliniDrawer, openGamliniDrawer } from './js/features/exam/gamliniDrawer.js';
    import { getAiTutorSession } from './js/features/exam/examAiTutor.js';

    const testResults = {
      rag: null,
      storage: null,
      drawer: null,
      tutor: null
    };

    // Console log interceptor
    const originalLog = console.log;
    const consoleLogEl = document.getElementById('console-log');
    console.log = function(...args) {
      originalLog.apply(console, args);
      const message = args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
      ).join(' ');
      consoleLogEl.innerHTML += `<div>${message}</div>`;
      consoleLogEl.scrollTop = consoleLogEl.scrollHeight;
    };

    function updateSummary() {
      const summary = document.getElementById('test-summary');
      summary.innerHTML = `
        <div>RAG Service: ${testResults.rag === null ? '‚ö™ Not tested' : testResults.rag ? '‚úÖ PASS' : '‚ùå FAIL'}</div>
        <div>Chat Storage: ${testResults.storage === null ? '‚ö™ Not tested' : testResults.storage ? '‚úÖ PASS' : '‚ùå FAIL'}</div>
        <div>Gamlini Drawer: ${testResults.drawer === null ? '‚ö™ Not tested' : testResults.drawer ? '‚úÖ PASS' : '‚ùå FAIL'}</div>
        <div>AI Tutor: ${testResults.tutor === null ? '‚ö™ Not tested' : testResults.tutor ? '‚úÖ PASS' : '‚ùå FAIL'}</div>
      `;
    }

    // Test 1: RAG Service
    document.getElementById('test-rag').addEventListener('click', async () => {
      const resultEl = document.getElementById('rag-result');
      const logEl = document.getElementById('rag-log');
      resultEl.classList.remove('hidden');
      logEl.innerHTML = 'Testing RAG Service...\n';

      try {
        // Initialize
        logEl.innerHTML += '1. Initializing RAG Service...\n';
        await ragService.initialize();
        logEl.innerHTML += `‚úÖ Initialized successfully\n`;
        logEl.innerHTML += `   - kamData: ${ragService.kamData?.length || 0} items\n`;
        logEl.innerHTML += `   - questions: ${ragService.questionsData?.length || 0} items\n`;
        logEl.innerHTML += `   - kamStandards: ${ragService.kamStandardsData?.length || 0} items\n`;
        logEl.innerHTML += `   - examData: ${ragService.examData?.length || 0} items\n\n`;

        // Search test
        logEl.innerHTML += '2. Testing search functionality...\n';
        const result = await ragService.searchAll('Ïû¨Í≥†ÏûêÏÇ∞ Ïã§ÏÇ¨', ['Ïû¨Í≥†', 'Ïã§ÏÇ¨']);
        logEl.innerHTML += `‚úÖ Search completed\n`;
        logEl.innerHTML += `   - procedures: ${result.procedures.length}\n`;
        logEl.innerHTML += `   - similarQuestions: ${result.similarQuestions.length}\n`;
        logEl.innerHTML += `   - examQuestions: ${result.examQuestions.length}\n`;
        logEl.innerHTML += `   - standards: ${result.standards.length}\n`;
        logEl.innerHTML += `   - keywords: ${result.keywords.join(', ')}\n\n`;

        logEl.innerHTML += '3. Context preview:\n';
        logEl.innerHTML += result.context.substring(0, 300) + '...\n\n';

        logEl.innerHTML += '‚úÖ ALL RAG TESTS PASSED\n';
        testResults.rag = true;
      } catch (error) {
        logEl.innerHTML += `‚ùå ERROR: ${error.message}\n`;
        logEl.innerHTML += error.stack;
        testResults.rag = false;
      }
      updateSummary();
    });

    // Test 2: Chat Storage
    document.getElementById('test-storage').addEventListener('click', () => {
      const resultEl = document.getElementById('storage-result');
      const logEl = document.getElementById('storage-log');
      resultEl.classList.remove('hidden');
      logEl.innerHTML = 'Testing Chat Storage...\n';

      try {
        // Create chat
        logEl.innerHTML += '1. Creating test chat...\n';
        const chat = chatStorage.createChat(
          'test_q_123',
          'Ïù¥ Î¨∏Ï†úÎäî ÌÖåÏä§Ìä∏ Î¨∏Ï†úÏûÖÎãàÎã§. Ïû¨Í≥†ÏûêÏÇ∞ Ïã§ÏÇ¨Ïóê ÎåÄÌïú ÎÇ¥Ïö©ÏûÖÎãàÎã§.',
          { topic: 'Í∞êÏÇ¨Ï¶ùÍ±∞', type: 'Rule', keywords: ['Ïû¨Í≥†ÏûêÏÇ∞', 'Ïã§ÏÇ¨'] }
        );
        logEl.innerHTML += `‚úÖ Chat created: ${chat.id}\n`;
        logEl.innerHTML += `   - title: ${chat.title}\n`;
        logEl.innerHTML += `   - tags: ${chat.tags.join(', ')}\n\n`;

        // Add messages
        logEl.innerHTML += '2. Adding messages...\n';
        chatStorage.addMessage(chat.id, 'user', 'Ïù¥ Î¨∏Ï†ú ÏÑ§Î™ÖÌï¥Ï£ºÏÑ∏Ïöî');
        chatStorage.addMessage(chat.id, 'assistant', 'Ïû¨Í≥†ÏûêÏÇ∞ Ïã§ÏÇ¨Îäî Í∞êÏÇ¨Ïù∏Ïù¥ ÏßÅÏ†ë...');
        chatStorage.saveChat(chat);
        logEl.innerHTML += `‚úÖ Messages added\n\n`;

        // Load chat
        logEl.innerHTML += '3. Loading chat...\n';
        const loaded = chatStorage.loadChat(chat.id);
        logEl.innerHTML += `‚úÖ Loaded: ${loaded.messages.length} messages\n\n`;

        // Search
        logEl.innerHTML += '4. Testing search...\n';
        const results = chatStorage.searchChats('Ïû¨Í≥†ÏûêÏÇ∞');
        logEl.innerHTML += `‚úÖ Found ${results.length} chat(s)\n\n`;

        // Stats
        logEl.innerHTML += '5. Getting stats...\n';
        const stats = chatStorage.getStats();
        logEl.innerHTML += `‚úÖ Stats:\n`;
        logEl.innerHTML += `   - Total chats: ${stats.totalChats}\n`;
        logEl.innerHTML += `   - Total messages: ${stats.totalMessages}\n\n`;

        // Cleanup
        chatStorage.deleteChat(chat.id);
        logEl.innerHTML += '‚úÖ Test chat deleted\n\n';

        logEl.innerHTML += '‚úÖ ALL STORAGE TESTS PASSED\n';
        testResults.storage = true;
      } catch (error) {
        logEl.innerHTML += `‚ùå ERROR: ${error.message}\n`;
        logEl.innerHTML += error.stack;
        testResults.storage = false;
      }
      updateSummary();
    });

    // Test 3: Gamlini Drawer
    document.getElementById('test-drawer').addEventListener('click', () => {
      const resultEl = document.getElementById('drawer-result');
      const logEl = document.getElementById('drawer-log');
      resultEl.classList.remove('hidden');
      logEl.innerHTML = 'Initializing Gamlini Drawer...\n';

      try {
        initializeGamliniDrawer();
        logEl.innerHTML += '‚úÖ Drawer initialized\n';
        logEl.innerHTML += 'Check the page - drawer should be in DOM\n\n';

        const drawerEl = document.getElementById('gamlini-drawer');
        if (drawerEl) {
          logEl.innerHTML += `‚úÖ Drawer element found in DOM\n`;
          logEl.innerHTML += `   - Classes: ${drawerEl.className}\n\n`;
        } else {
          logEl.innerHTML += `‚ùå Drawer element not found!\n\n`;
          testResults.drawer = false;
          updateSummary();
          return;
        }

        logEl.innerHTML += '‚úÖ DRAWER INITIALIZATION PASSED\n';
        testResults.drawer = true;
      } catch (error) {
        logEl.innerHTML += `‚ùå ERROR: ${error.message}\n`;
        logEl.innerHTML += error.stack;
        testResults.drawer = false;
      }
      updateSummary();
    });

    // Open Drawer Demo
    document.getElementById('open-drawer').addEventListener('click', () => {
      const mockQuestion = {
        id: 'demo_q1',
        question: 'Ïû¨Í≥†ÏûêÏÇ∞ Ïã§ÏÇ¨Ïùò Î™©Ï†ÅÏùÄ Î¨¥ÏóáÏù∏Í∞Ä?',
        model_answer: 'Ïû¨Í≥†ÏûêÏÇ∞Ïùò Ïã§Ïû¨ÏÑ±Í≥º ÏôÑÏ†ÑÏÑ±ÏùÑ ÌôïÏù∏ÌïòÍ∏∞ ÏúÑÌï®',
        score: 10,
        type: 'Rule',
        keywords: ['Ïû¨Í≥†ÏûêÏÇ∞', 'Ïã§ÏÇ¨', 'Ïã§Ïû¨ÏÑ±']
      };

      const mockFeedback = {
        score: 8,
        feedback: 'Ï†ÑÎ∞òÏ†ÅÏúºÎ°ú Ïûò ÏûëÏÑ±ÌïòÏòÄÏúºÎÇò ÏôÑÏ†ÑÏÑ± Î∂ÄÎ∂ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.',
        strengths: ['Ïã§Ïû¨ÏÑ± Í∞úÎÖê Ïù¥Ìï¥'],
        improvements: ['ÏôÑÏ†ÑÏÑ± Ï∂îÍ∞Ä ÌïÑÏöî']
      };

      const mockExamCase = {
        topic: 'Í∞êÏÇ¨Ï¶ùÍ±∞',
        type: 'Rule'
      };

      const apiKey = 'demo-api-key';

      openGamliniDrawer(
        mockQuestion.id,
        mockQuestion,
        'Ïã§Ïû¨ÏÑ± ÌôïÏù∏',
        mockFeedback,
        mockExamCase,
        apiKey
      );
    });

    // Test 4: AI Tutor
    document.getElementById('test-tutor').addEventListener('click', () => {
      const resultEl = document.getElementById('tutor-result');
      const logEl = document.getElementById('tutor-log');
      resultEl.classList.remove('hidden');
      logEl.innerHTML = 'Creating AI Tutor Session...\n';

      try {
        const mockQuestion = {
          question: 'Ïû¨Í≥†ÏûêÏÇ∞ Ïã§ÏÇ¨Ïùò Î™©Ï†ÅÏùÄ?',
          model_answer: 'Ïã§Ïû¨ÏÑ±Í≥º ÏôÑÏ†ÑÏÑ± ÌôïÏù∏',
          score: 10,
          type: 'Rule'
        };

        const mockFeedback = {
          score: 8,
          feedback: 'Ïûò ÏûëÏÑ±Ìï®'
        };

        const mockExamCase = {
          topic: 'Í∞êÏÇ¨Ï¶ùÍ±∞',
          type: 'Rule'
        };

        const session = getAiTutorSession(
          'test_q1',
          mockQuestion,
          'Ïã§Ïû¨ÏÑ± ÌôïÏù∏',
          mockFeedback,
          mockExamCase
        );

        logEl.innerHTML += `‚úÖ Session created\n`;
        logEl.innerHTML += `   - questionId: ${session.questionId}\n`;
        logEl.innerHTML += `   - examCase.topic: ${session.examCase.topic}\n\n`;

        // Test preset buttons
        logEl.innerHTML += 'Testing preset buttons...\n';
        const presets = session.getContextInjectionPresets();
        logEl.innerHTML += `‚úÖ Found ${presets.length} presets:\n`;
        presets.forEach(p => {
          logEl.innerHTML += `   - ${p.icon} ${p.label} (RAG: ${p.requiresRAG})\n`;
        });

        logEl.innerHTML += '\n‚úÖ ALL TUTOR TESTS PASSED\n';
        testResults.tutor = true;
      } catch (error) {
        logEl.innerHTML += `‚ùå ERROR: ${error.message}\n`;
        logEl.innerHTML += error.stack;
        testResults.tutor = false;
      }
      updateSummary();
    });

    // Initialize summary
    updateSummary();
  </script>
</body>
</html>
