<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="referrer" content="same-origin" />
  <title>감린이 - 회계감사 학습 도우미 v3.x</title>

  <!-- Tailwind (DEV용) : 프로덕션에서는 빌드된 CSS로 대체 권장 -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 폰트 (기존 유지) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- 셸/3-Pane 최소 CSS (Tailwind와 공존 가능) -->
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    :root{
      --left-w: 320px; --right-w: 360px; --gap: 12px;
      --bg:#0b0c10; --panel:#12141a; --line:#1f2330; --fg:#e6e6e6;
      --muted:#9aa3b2; --chip:#2a3345;
    }
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--fg)}
    #app{
      display:grid; grid-template-columns: var(--left-w) 1fr var(--right-w);
      gap:var(--gap); height:calc(100vh - 56px); padding:var(--gap); overflow:hidden;
    }
    .panel{
      border:1px solid var(--line); border-radius:10px; background:var(--panel);
      overflow:hidden; min-height:0; display:flex; flex-direction:column;
    }
    header.shell{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-bottom:1px solid var(--line); gap:8px; background:#0e1117;
      position:sticky; top:0; z-index:50; height:56px;
    }
    .toolbar{display:flex; gap:8px; align-items:center}
    .btn{padding:6px 10px; border:1px solid var(--line); border-radius:8px; background:#0e1117; color:#dfe6ee; cursor:pointer}
    .btn.primary{border-color:#2a3345; background:#162038}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:var(--chip); color:#cfd7e6; font-size:12px}
    .scroll{overflow:auto}
    /* 좌측 캘린더/차트 섹션 기초 */
    #left .section{padding:12px; border-bottom:1px dashed var(--line)}
    #calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:4px}
    .cell{aspect-ratio:1/1; border-radius:6px; background:#0f1522; border:1px solid #162033}
    .cell.int-1{background:#16233f} .cell.int-3{background:#193053}
    .cell.int-5{background:#1b3a6a} .cell.int-8{background:#1d4788}
    @media (max-width:1024px){
      #app{grid-template-columns:1fr}
      #left, #right{display:none}
    }

    /* 로더(기존 유지) */
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
      width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* 다크모드 (기존 유지) */
    .dark { background-color: #1a202c; color: #e2e8f0; }
    .dark .bg-white { background-color: #2d3748; }
    .dark .bg-gray-100 { background-color: #1a202c; }
    .dark .bg-gray-50 { background-color: #2d3748; }
    .dark .text-gray-800 { color: #e2e8f0; }
    .dark .text-gray-700 { color: #cbd5e0; }
    .dark .text-gray-600 { color: #a0aec0; }
    .dark .border-gray-200 { border-color: #4a5568; }
    .dark .border-gray-300 { border-color: #4a5568; }

    /* 다크모드 접근성 보강(기존 유지 id) */
    html.dark { color-scheme: dark; }
    html.dark input, html.dark textarea, html.dark select {
      background-color: #1f2937; /* gray-800 */
      color: #e5e7eb;            /* gray-200 */
      border-color: #4b5563;     /* gray-600 */
    }
    html.dark ::placeholder { color: #9ca3af; } /* gray-400 */
    html.dark :is(button, a, input, textarea, select):focus-visible {
      outline: 2px solid #60a5fa; outline-offset: 2px;
    }
    html.dark .progress-track { background-color: #374151; } /* gray-700 */
  </style>

  <!-- Chart.js (좌측 통계용) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="min-h-screen">
  <!-- 상단 셸 -->
  <header class="shell">
    <div class="flex items-center gap-3">
      <span class="text-sm font-semibold tracking-tight text-blue-400">감린이 v3.x</span>
      <span class="chip">엔진: <strong id="engine-mode-label">forgetting</strong></span>
    </div>
    <div class="toolbar">
      <button class="btn" id="toggle-left">대시보드</button>
      <button class="btn" id="toggle-right">탐색</button>
      <button class="btn primary" id="btn-start-review">오늘의 복습 시작</button>
      <button id="settings-btn" class="btn" aria-haspopup="dialog">설정 ⚙️</button>
    </div>
  </header>

  <!-- 3-Pane -->
  <main id="app">
    <!-- 좌: 캘린더/통계/엔진 제어 -->
    <section id="left" class="panel">
      <div class="section">
        <h3 class="text-sm font-semibold mb-2">잔디밭 캘린더</h3>
        <div id="calendar" class="scroll" aria-label="activity calendar"></div>
      </div>
      <div class="p-3 scroll space-y-3">
        <canvas id="chart-daily" height="140"></canvas>
        <canvas id="chart-chapter" height="140"></canvas>
      </div>
      <div class="section">
        <h3 class="text-sm font-semibold mb-2">오늘의 복습 제어</h3>
        <div class="flex items-center gap-3">
          <label class="text-xs">전략
            <select id="engine-strategy" class="ml-1 text-black">
              <option value="forgetting" selected>망각</option>
              <option value="low-score">저득점</option>
              <option value="recent-wrong">최근오답</option>
            </select>
          </label>
          <label class="text-xs">개수
            <input id="engine-N" type="range" min="5" max="30" value="10" />
          </label>
        </div>
      </div>
    </section>

    <!-- 중: 퀴즈 -->
    <section id="center" class="panel">
      <div class="p-3 scroll space-y-3">
        <div class="flex items-center gap-2">
          <div id="question-meta" class="chip">단원 <span id="q-chapter">-</span> · 문제 <span id="q-no">-</span></div>
          <span class="text-xs opacity-70">Ctrl+Enter=채점, ←/→=이전/다음, ?=단축키</span>
        </div>
        <h2 id="q-title" class="text-base font-semibold"></h2>
        <p id="q-body" class="whitespace-pre-wrap text-sm opacity-90"></p>
        <div>
          <div class="flex items-center justify-between mb-1">
            <label for="q-answer" class="text-xs opacity-80">답안 입력</label>
            <button id="load-prev-answer-btn" class="text-xs text-blue-300 hover:underline">이전 답안 불러오기</button>
          </div>
          <textarea id="q-answer" class="w-full rounded-md border border-slate-700 bg-[#0f1320] text-slate-100 p-3" rows="6" placeholder="여기에 답안을 입력하세요..."></textarea>
          <p id="error-message" class="text-red-400 text-xs mt-1 hidden">답안을 입력해주세요.</p>
        </div>
        <div class="flex items-center gap-2">
          <button class="btn" id="btn-prev">이전(←)</button>
          <button class="btn" id="btn-next">다음(→)</button>
          <button class="btn primary relative min-w-[120px]" id="btn-grade">
            <span id="grade-btn-text">채점(Ctrl+Enter)</span>
            <div id="grade-loader" class="loader absolute inset-0 m-auto hidden" aria-hidden="true"></div>
          </button>
          <button class="btn" id="hint-btn">힌트</button>
        </div>
        <div id="hint-container" class="hidden mt-1 text-xs bg-indigo-900/60 border border-indigo-700 text-indigo-100 rounded p-2"></div>

        <!-- 결과 -->
        <div id="result-box" class="hidden bg-black/20 border border-slate-700 rounded p-3 mt-2" aria-live="polite">
          <h3 class="text-sm font-semibold mb-1">채점 결과</h3>
          <div class="mb-2">
            <p class="text-sm">유사도 점수: <span id="score" class="font-bold text-blue-300 text-lg">0</span><span class="text-sm opacity-70">점</span></p>
            <div class="w-full bg-slate-700 progress-track rounded-full h-3 mt-1 overflow-hidden">
              <div id="progress-bar" class="h-3 rounded-full transition-all duration-500 ease-out" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="width: 0%"></div>
            </div>
          </div>
          <div class="mb-2">
            <h4 class="text-sm font-semibold mb-1">🤖 AI 총평</h4>
            <div id="ai-feedback" class="bg-[#0b0f1a] p-2 border border-slate-700 rounded text-sm min-h-[40px]"></div>
          </div>
          <div>
            <h4 class="text-sm font-semibold mb-1">📘 모범 답안</h4>
            <pre id="correct-answer" class="bg-[#0b0f1a] p-2 border border-slate-700 rounded text-xs font-sans leading-relaxed whitespace-pre-wrap"></pre>
          </div>
        </div>
      </div>
    </section>

    <!-- 우: 탐색(단원 트리/목록/뱃지) -->
    <section id="right" class="panel">
      <div class="p-2 scroll" id="explorer-tree" aria-label="문항 탐색 트리"></div>
    </section>
  </main>

  <!-- 토스트 영역 (기존 id 유지) -->
  <div id="toast" class="hidden fixed top-4 right-4 z-[9999]"></div>

  <!-- ========== API 키 최초 인증 모달 (기존 유지) ========== -->
  <div id="api-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1000]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-xl dark:bg-gray-900 dark:text-gray-100">
      <h2 class="text-xl font-bold">Gemini API 키 인증</h2>
      <p class="text-sm text-gray-600 mt-1 dark:text-gray-300">최초 1회만 입력합니다. 로컬 저장을 체크하면 다음부터는 팝업이 뜨지 않습니다.</p>
      <p class="text-sm mt-2">처음 사용하시나요?
        <a href="README.html" target="_blank" rel="noopener" class="underline text-blue-600 dark:text-blue-300">도움말(README)</a>
      </p>
      <label for="api-modal-input" class="block text-sm font-medium mt-4">🔑 API Key</label>
      <input type="password" id="api-modal-input" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700" placeholder="Google AI Studio API 키" autocomplete="off" spellcheck="false" inputmode="text" />
      <div class="flex items-center gap-2 mt-2">
        <input type="checkbox" id="modal-remember" class="rounded border-gray-300" />
        <label for="modal-remember" class="text-sm">이 브라우저에 키 저장</label>
      </div>
      <p class="text-xs text-yellow-600 mt-1">⚠️ 공용 PC에서는 체크 해제를 권장합니다.</p>
      <div class="mt-5 flex justify-end gap-2">
        <button id="api-cancel-btn" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900">취소</button>
        <button id="api-save-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700">저장</button>
      </div>
    </div>
  </div>

  <!-- ========== 설정 모달 (기존 유지) ========== -->
  <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1001]">
    <div role="dialog" aria-modal="true" aria-labelledby="settings-title" class="bg-white dark:bg-gray-900 dark:text-gray-100 rounded-2xl w-full max-w-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-2">
        <h2 id="settings-title" class="text-2xl font-bold">설정 ⚙️</h2>
        <button id="settings-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white" aria-label="닫기">✕</button>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold mb-3">API 키 설정</h3>
        <button id="open-api-key-modal-btn" class="w-full bg-blue-50 border border-blue-300 text-blue-700 font-medium py-2 px-4 rounded-lg hover:bg-blue-100 transition">
          API 키 변경/설정
        </button>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold mb-3">AI 모델 선택</h3>
        <select id="ai-model-select" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="gemini-2.5-flash">Gemini 2.5 Flash (기본)</option>
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (경량)</option>
        </select>
        <p class="text-xs text-gray-500 mt-2">힌트 및 채점에 사용될 AI 모델을 선택하세요.</p>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold mb-3">다크 모드</h3>
        <select id="dark-mode-select" class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="system">시스템 설정 (기본)</option>
          <option value="light">라이트 모드</option>
          <option value="dark">다크 모드</option>
        </select>
      </div>

      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-3">데이터 관리</h3>
        <div class="flex gap-3">
          <button id="export-data-btn" class="flex-1 bg-green-50 border border-green-300 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition">
            📥 데이터 내보내기
          </button>
          <button id="import-data-btn" class="flex-1 bg-yellow-50 border border-yellow-300 text-yellow-700 font-medium py-2 px-4 rounded-lg hover:bg-yellow-100 transition">
            📤 데이터 가져오기
          </button>
        </div>
        <input type="file" id="import-file-input" accept=".json" class="hidden" />
        <p class="text-xs text-gray-500 mt-2">학습 기록 및 설정을 백업하거나 복원할 수 있습니다.</p>
      </div>

      <div class="flex justify-end">
        <button id="settings-close-btn-bottom" class="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">
          닫기
        </button>
      </div>
    </div>
  </div>

  <!-- ========== 내장 데이터(JSON) 폴백 (기존 유지) ========== -->
  <script id="dataset-json" type="application/json">[
    {
      "고유ID": "q_001",
      "표시번호": "1",
      "출처": "ISA 200-A54",
      "problemTitle": "",
      "단원": 1,
      "물음번호": 1,
      "물음": "회계감사에는 고유한계가 존재하며 ... 원인을 세가지만 기재하시오.",
      "정답": "① 재무보고의 성격 ② 감사절차의 성격 ③ 합리적인 시간 내에 합리적인 비용으로 감사가 수행될 필요성"
    },
    {
      "고유ID": "q_002",
      "표시번호": "2",
      "출처": "ISA 200-A51",
      "problemTitle": "",
      "단원": 1,
      "물음번호": 2,
      "물음": "회계감사기준은 ... 채택하고 있는 감사절차에는 어떤 것이 있는지 세가지를 서술하시오.",
      "정답": "① 계획 ② 위험 높은 분야 집중 ③ 테스트 등 표본 사용"
    }
  ]</script>

  <!-- 부트스트랩: 셸 토글 + 앱 시작 (중복 로드 금지) -->
  <script type="module">
    // 헤더 토글 (모바일 대응)
    const $ = s => document.querySelector(s);
    $('#toggle-left')?.addEventListener('click', () => {
      const el = $('#left'); el.style.display = (el.style.display === 'none' ? 'flex' : 'none');
    });
    $('#toggle-right')?.addEventListener('click', () => {
      const el = $('#right'); el.style.display = (el.style.display === 'none' ? 'flex' : 'none');
    });

    // 앱 엔트리 (app.js가 하위 모듈 import)
    import './js/app.js';
  </script>

  <!-- GA 스니펫은 js/analytics/ga.js에서 초기화하고, app.js에서 이벤트 훅 연결 -->
</body>
</html>
