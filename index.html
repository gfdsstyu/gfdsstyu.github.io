<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="same-origin" />
  <title>감린이 - 회계감사 학습 도우미 v3.3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .summary-btn{ width:38px;height:38px;font-size:.8rem;line-height:1;display:flex;align-items:center;justify-content:center;padding:0 2px;transition:.2s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis }
    .summary-btn:hover{ transform:scale(1.1) }
    pre{ white-space:pre-wrap; word-wrap:break-word }
    #toast{ position:fixed; top:16px; right:16px; z-index:9999 }
    .no-kr-break{ word-break:keep-all }

    .dark{ background-color:#1a202c; color:#e2e8f0 }
    .dark .bg-white{ background-color:#2d3748 }
    .dark .bg-gray-100{ background-color:#1a202c }
    .dark .bg-gray-50{ background-color:#2d3748 }
    .dark .text-gray-800{ color:#e2e8f0 }
    .dark .text-gray-700{ color:#cbd5e0 }
    .dark .text-gray-600{ color:#a0aec0 }
    .dark .border-gray-200{ border-color:#4a5568 }
    .dark .border-gray-300{ border-color:#4a5568 }
  </style>

  <style id="dark-a11y-20251026">
    html.dark { color-scheme: dark; }
    html.dark input, html.dark textarea, html.dark select { background-color:#1f2937; color:#e5e7eb; border-color:#4b5563 }
    html.dark ::placeholder { color:#9ca3af }
    html.dark :is(button,a,input,textarea,select):focus-visible { outline:2px solid #60a5fa; outline-offset:2px }
    html.dark .progress-track{ background-color:#374151 }
    html.dark #result-box{ background-color:#1f2937; border-color:#374151 }
    html.dark #quiz-area .bg-gray-50{ background-color:#111827 }
    html.dark #quiz-area .border-gray-200{ border-color:#374151 }
    html.dark #hint-container{ background-color:#1e3a8a; border-color:#334155; color:#e0e7ff }
    html.dark #summary-area .border{ border-color:#374151 }
    html.dark #summary-area .bg-gray-50{ background-color:#111827 }
    html.dark .summary-btn.bg-gray-100{ background-color:#111827; color:#d1d5db; border-color:#374151 }
    html.dark .summary-btn.bg-red-100{ background-color:#7f1d1d; color:#fecaca; border-color:#991b1b }
    html.dark .summary-btn.bg-yellow-100{ background-color:#78350f; color:#fde68a; border-color:#92400e }
    html.dark .summary-btn.bg-green-100{ background-color:#14532d; color:#bbf7d0; border-color:#166534 }
  </style>

  <style id="focus-mode-css">
    html.focus-mode { scroll-behavior: smooth; }
    html.focus-mode #result-box { max-height:none!important; overflow:visible!important; }
  </style>

  <style id="layout-css">
    .heatmap-cell{ width:14px; height:14px; border-radius:3px }
    .drawer-open{ overflow:hidden }
    .cal-cell { height: 32px; border-radius: 6px; position: relative; display: grid; place-items: center; font-size: 12px; border: 1px solid rgba(0,0,0,0.06); }
    .cal-cell .cal-day { position: absolute; top: 4px; right: 6px; font-size: 10px; opacity: 0.85; font-weight: 600; }
    .cal-cell.muted { opacity: 0.35; }
  </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
  <div id="toast" class="hidden"></div>

  <!-- 상단 네비 -->
  <header id="fixed-header" class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur border-b border-gray-200 dark:bg-gray-900/80 dark:border-gray-800">
    <div class="mx-auto max-w-[1400px] 2xl:max-w-[1600px] px-4 lg:px-6 xl:px-8 py-2 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-xl font-extrabold tracking-tight text-blue-700 dark:text-blue-400">감린이</span>
        <span class="hidden sm:inline text-xs text-gray-500 dark:text-gray-400">회계감사 암기 도우미 v3.3</span>
      </div>
      <nav class="flex items-center gap-2">
        <a id="help-button" href="README.html" target="_blank" class="hidden sm:inline text-sm text-gray-700 hover:text-blue-700 dark:text-gray-300 dark:hover:text-white">도움말</a>
        <button id="settings-btn" class="ml-1 inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-haspopup="dialog">
          <span>설정</span><span aria-hidden>⚙️</span>
        </button>
        <button id="hamburger" class="lg:hidden inline-flex items-center justify-center w-9 h-9 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-label="메뉴">≡</button>
      </nav>
    </div>
  </header>
  <div class="h-14"></div>

  <div id="drawer-backdrop" class="fixed inset-0 bg-black/40 hidden z-[1099]"></div>

  <div id="layout-root" class="pt-2 flex-1 px-4 lg:px-6 xl:px-8">
    <div class="mx-auto max-w-[1400px] 2xl:max-w-[1600px] grid grid-cols-1 lg:grid-cols-12 gap-4 xl:gap-6 2xl:gap-8">
      <!-- LEFT -->
      <aside id="left-dashboard" class="lg:col-span-3 xl:col-span-3 2xl:col-span-3 space-y-4">
        <button id="drawer-close" class="hidden lg:hidden absolute top-2 right-2 z-[1101] inline-flex items-center justify-center w-9 h-9 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700" aria-label="닫기">✕</button>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-lg">학습 캘린더</h3>
            <div class="flex items-center gap-2">
              <button id="cal-prev" class="w-8 h-8 grid place-items-center rounded-md border hover:bg-gray-50" aria-label="이전 달">◀</button>
              <div id="cal-title" class="min-w-[96px] text-sm font-semibold text-center">YYYY.MM</div>
              <button id="cal-next" class="w-8 h-8 grid place-items-center rounded-md border hover:bg-gray-50" aria-label="다음 달">▶</button>
            </div>
          </div>
          <div id="calendar-weekdays" class="grid grid-cols-7 text-center text-xs text-gray-500 mb-1">
            <div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div><div>일</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
          <div class="mt-2 text-[11px] text-gray-500">색 = 해당일 풀이량 (노랑→초록→파랑)</div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">오늘의 통계</h3>
          <div id="stats-overview" class="text-sm space-y-1"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">오늘의 복습</h3>
          <label class="text-sm block mb-2">우선순위</label>
          <select id="review-strategy-select" class="w-full p-2 border rounded">
            <option value="smart">지능형 추천 (기본)</option>
            <option value="low">점수 낮은 순</option>
            <option value="recentWrong">최근 틀린 순</option>
            <option value="flag">사용자 지정 복습 목록</option>
          </select>
          <button id="start-review-btn" class="mt-3 w-full bg-blue-600 text-white py-2 rounded-lg">오늘의 복습 시작</button>
        </div>
      </aside>

      <!-- CENTER -->
      <main id="center-core" class="lg:col-span-6 xl:col-span-6 2xl:col-span-6">
        <div class="bg-white rounded-2xl shadow-xl w-full p-6 md:p-8">
          <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
            <div class="flex-1 w-full">
              <label for="chapter-select" class="block text-sm font-medium text-gray-700 mb-1">단원 선택</label>
              <select id="chapter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
                <option value="">-- 전체 단원 --</option>
              </select>
            </div>
            <div class="flex-1 w-full">
              <label for="filter-select" class="block text-sm font-medium text-gray-700 mb-1">문제 필터</label>
              <select id="filter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-700 dark:text-gray-100 dark:border-gray-700">
                <option value="all">모든 문제 풀기</option>
                <option value="unanswered">아직 안 푼 문제</option>
                <option value="today-review">오늘의 복습 (추천)</option>
                <option value="80">80점 미만 문제</option>
                <option value="60">60점 미만 문제</option>
              </select>
            </div>
            <div class="w-full md:w-auto md:self-end flex gap-2">
              <button id="load-quiz-btn" class="flex-1 bg-blue-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">학습 시작</button>
              <button id="random-quiz-btn" class="flex-1 bg-purple-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-purple-700 transition duration-200">랜덤 문제</button>
            </div>
          </div>

          <div id="source-group-filter" class="mb-6"></div>

          <!-- 문제 영역 -->
          <div id="quiz-area" class="hidden">
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-4">
              <div class="flex justify-between items-center mb-2">
                <h2 id="question-number" class="text-xl font-bold text-blue-700 bg-blue-100 px-3 py-1 rounded-md">문항</h2>
                <span id="question-counter" class="text-gray-500 font-medium">0 / 0</span>
              </div>
              <div id="db-question-id" class="text-xs text-gray-500 hidden">ID: -</div>

              <p id="question-text" class="text-gray-800 text-base md:text-lg leading-relaxed mt-2">문제를 불러오는 중입니다...</p>

              <!-- 힌트/복습 버튼 영역 -->
              <div class="mt-3 flex items-center justify-between gap-2">
                <button id="hint-btn" class="text-sm bg-purple-600 text-white px-3 py-1.5 rounded-md shadow hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">힌트</button>

                <div class="flex items-center gap-2">
                  <button id="review-flag-toggle" class="text-sm px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-100 flex items-center gap-1" aria-pressed="false" title="복습 필요 토글">
                    <span class="text-yellow-500">☆</span><span>복습 필요</span>
                  </button>

                  <!-- NEW: 복습 제외 토글 (오늘의 복습에서 제외) -->
                  <button id="review-exclude-toggle" class="text-sm px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-100 flex items-center gap-1" aria-pressed="false" title="오늘의 복습에서 제외/해제">
                    <span class="text-gray-600">➖</span><span>복습 제외</span>
                  </button>
                </div>
              </div>

              <div id="hint-container" class="hidden mt-3 text-sm bg-purple-50 border border-purple-200 text-purple-800 rounded-lg p-3 dark:bg-indigo-900 dark:border-indigo-700 dark:text-indigo-100"></div>
            </div>

            <div class="flex items-center justify-between mb-2">
              <label for="user-answer" class="text-sm font-medium text-gray-700">답안 입력</label>
              <button id="load-prev-answer-btn" class="text-xs text-blue-600 hover:underline">이전 답안 불러오기</button>
            </div>
            <textarea id="user-answer" class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition dark:bg-gray-800 dark=text-gray-100 dark:placeholder-gray-400 dark:border-gray-700" rows="8" placeholder="여기에 정답을 입력하세요... (Enter=채점, Shift+Enter=줄바꿈, Ctrl+[=이전위치, Ctrl+]=포커스/현황판)"></textarea>
            <p id="error-message" class="text-red-500 text-sm mt-2 hidden">답안을 입력해주세요.</p>
            <p id="hotkey-guide" class="text-xs text-gray-500 mt-2">
              단축키: Ctrl+←/→ 이전/다음 · Enter 채점 · Shift+Enter 줄바꿈 · H 힌트 · Ctrl+[ 이전 · Ctrl+] 포커스/현황판
            </p>

            <div class="flex justify-between items-center my-5">
              <button id="prev-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">이전</button>
              <button id="grade-btn" class="bg-green-500 text-white font-bold py-2 px-8 rounded-lg shadow-md hover:bg-green-600 transition duration-200 relative min-w-[120px]">
                <span id="grade-btn-text">채점하기</span>
                <div id="grade-loader" class="loader absolute inset-0 m-auto hidden" aria-hidden="true"></div>
              </button>
              <button id="next-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">다음</button>
            </div>
          </div>

          <!-- 결과 -->
          <div id="result-box" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-6 mt-6 dark:bg-gray-800 dark:border-gray-700" aria-live="polite">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">채점 결과</h3>
            <div id="score-display" class="mb-5">
              <p class="text-lg font-medium text-gray-700">
                유사도 점수: <span id="score" class="font-bold text-blue-600 text-2xl">0</span><span class="text-gray-600 text-lg">점</span>
              </p>
              <div class="w-full bg-gray-200 progress-track rounded-full h-4 mt-2 overflow-hidden shadow-inner">
                <div id="progress-bar" class="h-4 rounded-full transition-all duration-500 ease-out" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="width: 0%"></div>
              </div>
            </div>
            <div class="mb-5">
              <h4 class="text-xl font-semibold text-gray-700 mb-2">🤖 AI 총평</h4>
              <div id="ai-feedback" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 leading-relaxed min-h-[50px]"></div>
            </div>
            <div>
              <h4 class="text-xl font-semibold text-gray-700 mb-2">📘 모범 답안</h4>
              <pre id="correct-answer" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 text-sm font-sans leading-relaxed"></pre>
            </div>
          </div>

          <!-- 학습 현황판 -->
          <div id="summary-area" class="mt-8 pt-6 border-t hidden">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-3">
              <h3 class="text-xl font-bold text-gray-800">학습 현황판 (클릭하여 이동)</h3>
              <div class="flex flex-wrap gap-3 items-center">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-gray-600">보기:</span>
                  <button id="summary-view-all" class="px-3 py-1.5 text-sm border rounded bg-gray-100 hover:bg-gray-200">모든 단원보기</button>
                  <button id="summary-view-current" class="px-3 py-1.5 text-sm border rounded">현재 학습단원보기</button>
                </div>
                <div class="flex gap-4">
                  <button id="clear-filter-btn" class="text-sm text-blue-700 hover:underline dark:text-blue-300">필터 해제</button>
                  <button id="reset-scores-btn" class="text-sm text-red-600 hover:underline dark:text-red-300">학습 기록 초기화</button>
                </div>
              </div>
            </div>
            <div id="score-summary" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
      </main>

      <!-- RIGHT -->
      <aside id="right-explorer" class="lg:col-span-3 xl:col-span-3 2xl:col-span-3 space-y-4">
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">학습 범위 필터</h3>
          <div id="source-filter-side"></div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">단원 네비게이터</h3>
          <div id="explorer-chapters" class="space-y-2"></div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-lg whitespace-nowrap no-kr-break">문제 목록</h3>
            <input id="explorer-search" class="border rounded px-2 py-1 text-sm" placeholder="검색...">
          </div>
          <div id="explorer-problems" class="space-y-1 max-h-[60vh] overflow-y-auto pr-1"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- API 키 모달 -->
  <div id="api-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1000]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-xl">
      <h2 class="text-xl font-bold text-gray-800">Gemini API 키 인증</h2>
      <p class="text-sm text-gray-600 mt-1">최초 1회만 입력합니다. 로컬 저장을 체크하면 다음부터는 팝업이 뜨지 않습니다.</p>
      <p class="text-sm mt-2">처음 사용하시나요?
        <a href="README.html" target="_blank" rel="noopener" class="underline text-blue-600 dark:text-blue-300">도움말(README)</a>를 확인하세요.
      </p>

      <label for="api-modal-input" class="block text-sm font-medium text-gray-700 mt-4">🔑 API Key</label>
      <input type="password" id="api-modal-input"
             class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-gray-100 dark:placeholder-gray-400 dark:border-gray-700"
             placeholder="Google AI Studio API 키" autocomplete="off" spellcheck="false" inputmode="text" />

      <div class="flex items-center gap-2 mt-2">
        <input type="checkbox" id="modal-remember" class="rounded border-gray-300" />
        <label for="modal-remember" class="text-sm text-gray-700">이 브라우저에 키 저장</label>
      </div>
      <p class="text-xs text-yellow-600 mt-1">⚠️ 공용 PC에서는 체크 해제를 권장합니다.</p>

      <div class="mt-5 flex justify-end gap-2">
        <button id="api-cancel-btn" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900">취소</button>
        <button id="api-save-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700">저장</button>
      </div>
    </div>
  </div>

  <!-- 설정 모달 -->
  <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1001]">
    <div role="dialog" aria-modal="true" aria-labelledby="settings-title" class="bg-white dark:bg-gray-900 dark:text-gray-100 rounded-2xl w-full max-w-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-2">
        <h2 id="settings-title" class="text-2xl font-bold">설정 ⚙️</h2>
        <button id="settings-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white" aria-label="닫기">✕</button>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">API 키 설정</h3>
        <button id="open-api-key-modal-btn" class="w-full bg-blue-50 border border-blue-300 text-blue-700 font-medium py-2 px-4 rounded-lg hover:bg-blue-100 transition">API 키 변경/설정</button>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">AI 모델 선택</h3>
        <select id="ai-model-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="gemini-2.5-flash">Gemini 2.5 Flash (기본)</option>
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (경량)</option>
        </select>
        <p class="text-xs text-gray-500 mt-2">힌트 및 채점에 사용될 AI 모델을 선택하세요.</p>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">다크 모드</h3>
        <select id="dark-mode-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="system">시스템 설정 (기본)</option>
          <option value="light">라이트 모드</option>
          <option value="dark">다크 모드</option>
        </select>
      </div>

      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">데이터 관리</h3>
        <div class="flex gap-3">
          <button id="export-data-btn" class="flex-1 bg-green-50 border border-green-300 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition">📥 데이터 내보내기</button>
          <button id="import-data-btn" class="flex-1 bg-yellow-50 border border-yellow-300 text-yellow-700 font-medium py-2 px-4 rounded-lg hover:bg-yellow-100 transition">📤 데이터 가져오기</button>
        </div>
        <input type="file" id="import-file-input" accept=".json" class="hidden" />
        <p class="text-xs text-gray-500 mt-2">학습 기록 및 설정을 백업하거나 복원할 수 있습니다.</p>
      </div>

      <div class="flex justify-end">
        <button id="settings-close-btn-bottom" class="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">닫기</button>
      </div>
    </div>
  </div>

  <!-- 내장 데이터(JSON) -->
  <script id="dataset-json" type="application/json">[
    {"고유ID":"q_001","표시번호":"1","출처":"S","problemTitle":"회계감사의 고유한계 원인 세 가지","단원":1,"물음번호":1,"물음":"회계감사에는 고유한계가 존재한다. 그 원인을 세 가지 쓰시오.","정답":"ISA 200-A47 ① 재무보고의 성격 ② 감사절차의 성격 ③ 합리적 시간·비용 제약"},
    {"고유ID":"q_002","표시번호":"2","출처":"H","problemTitle":"적시성과 비용-효익 고려 시 채택하는 절차","단원":1,"물음번호":2,"물음":"감사인은 적시성과 비용-효익 균형을 고려한다. 이에 따라 채택하는 절차 세 가지는?","정답":"ISA 200-A51 ① 효과적 계획 ② 위험 높은 분야 집중 ③ 테스트 등 표본 사용"},
    {"고유ID":"q_003","표시번호":"3","출처":"SS","problemTitle":"샘플 문제","단원":1,"물음번호":3,"물음":"…","정답":"…"}
  ]</script>

  <script type="module">
    const BASE_SYSTEM_PROMPT =
`당신은 매우 엄격한 회계감사 과목 채점 교수님입니다.
- 사용자 답안을 모범답안과 비교해 0~100의 "score"(NUMBER)와 "feedback"(STRING, 한국어)을 JSON으로만 반환하세요.
- 채점 기준을 매우 엄격하게(strictly) 적용합니다.
- 대신 띄어쓰기나 맞춤법 실수 같은 단순한 타이핑실수는 봐줍니다. 또한 중요왜곡표시위험을 RMM으로, 성격·시기·범위를 성시범으로, 공인회계사를 CPA로 줄여쓰는 정도의 수험상 합의된 언어는 봐줍니다.

[채점 기준]
1. 모범 답안의 핵심 키워드 포함 여부
2. 핵심 키워드 대부분 누락: 50점 미만
3. 일부 포함이나 설명 부정확: 50~80점
4. 모든 핵심 키워드 + 의도 일치: 80점 이상
5. 조사까지 동일할 때만 100점
6. 키워드는 모범답안에서 스스로 추출하되, 한국 회계감사 기준·규정(ISA, KSA, 외부감사법, 윤리기준)에 맞는 동의어·표현 변형을 허용
7. 물음에서의 물음 부분이 굳이 답변에 포함되지 않아도 됨(물음의 내용이 모범답안에 재진술되어있다고해서 굳이 사용자 답안에 해당 내용이 포함되지 않아도됨)

- 불필요한 말/코드블록 금지. JSON 객체만 반환.`;

    const LITE_STRICT_ADDENDUM =
`[엄격 모드 지침(라이트 전용)]
- 모호/추정/확장 서술은 감점.
- 점수 짜게준다.
- 필수 키워드가 문장 내 명시적으로 없으면 큰 감점.
- 레퍼런스 밖 주장은 근거 없으면 감점.
- 도출한 점수보다 7점 깎아서 제시할 것`;

    let allData=[], currentQuizData=[], currentQuestionIndex=0, questionScores={};
    let geminiApiKey='', activeHintQuestionKey=null, selectedAiModel='gemini-2.5-flash', darkMode='system';
    let prevLoaded=false, summaryViewMode='ALL', statsView=localStorage.getItem('statsView_v1')||'day';
    let ctrlNavState='dashboard', lastScrollYBeforeFocus=0;

    let calRefDate = (() => { const d = new Date(); d.setHours(0,0,0,0); d.setDate(1); return d; })();

    const $ = id=>document.getElementById(id);
    const el = {
      toast: $('toast'), apiModal:$('api-modal'), apiModalInput:$('api-modal-input'), apiModalRemember:$('modal-remember'),
      apiModalSaveBtn:$('api-save-btn'), apiModalCancelBtn:$('api-cancel-btn'),
      settingsBtn:$('settings-btn'), settingsModal:$('settings-modal'),
      settingsCloseBtn:$('settings-close-btn'), settingsCloseBtnBottom:$('settings-close-btn-bottom'),
      openApiKeyModalBtn:$('open-api-key-modal-btn'), aiModelSelect:$('ai-model-select'), darkModeSelect:$('dark-mode-select'),
      exportDataBtn:$('export-data-btn'), importDataBtn:$('import-data-btn'), importFileInput:$('import-file-input'),
      chapterSelect:$('chapter-select'), filterSelect:$('filter-select'), loadQuizBtn:$('load-quiz-btn'), randomQuizBtn:$('random-quiz-btn'),
      quizArea:$('quiz-area'), questionNumber:$('question-number'), questionText:$('question-text'), questionCounter:$('question-counter'),
      userAnswer:$('user-answer'), errorMessage:$('error-message'), prevBtn:$('prev-btn'), nextBtn:$('next-btn'),
      gradeBtn:$('grade-btn'), gradeBtnText:$('grade-btn-text'), gradeLoader:$('grade-loader'), hintBtn:$('hint-btn'), hintBox:$('hint-container'),
      loadPrevAnswerBtn:$('load-prev-answer-btn'), resultBox:$('result-box'), score:$('score'), progressBar:$('progress-bar'),
      aiFeedback:$('ai-feedback'), correctAnswer:$('correct-answer'), summaryArea:$('summary-area'), scoreSummary:$('score-summary'),
      clearFilterBtn:$('clear-filter-btn'), resetScoresBtn:$('reset-scores-btn'), summaryViewAllBtn:$('summary-view-all'), summaryViewCurrentBtn:$('summary-view-current'),
      dbQuestionId:$('db-question-id'), fixedHeader:$('fixed-header'), layoutRoot:$('layout-root'),
      statsOverview:$('stats-overview'),
      reviewStrategySelect:$('review-strategy-select'), startReviewBtn:$('start-review-btn'),
      sourceFilterSide:$('source-filter-side'), sourceGroupFilter:$('source-group-filter'),
      explorerChapters:$('explorer-chapters'), explorerProblems:$('explorer-problems'), explorerSearch:$('explorer-search'),
      reviewFlagToggle:$('review-flag-toggle'), reviewExcludeToggle:$('review-exclude-toggle'),
      hamburger:$('hamburger'), leftDashboard:$('left-dashboard'), drawerBackdrop:$('drawer-backdrop'), drawerClose:$('drawer-close'),
      calPrev:$('cal-prev'), calNext:$('cal-next'), calTitle:$('cal-title'), calendarGrid:$('calendar-grid')
    };

    const clamp=(v,min,max)=>Math.max(min,Math.min(max,Number(v)||0));
    const normId=v=>String(v).trim();
    const sanitizeModelText=t=>{ let s=(t||'').trim(); if(s.startsWith('```')) s=s.replace(/^```[\s\S]*?\n/,'').replace(/```$/,'').trim(); s=s.replace(/^\uFEFF/,''); const a=s.indexOf('{'), b=s.lastIndexOf('}'); if(a!==-1&&b!==-1&&b>a) s=s.slice(a,b+1); return s; };
    const showToast=(msg,type='info')=>{
      const base='px-4 py-2 rounded shadow text-sm mb-2';
      const color= type==='error'?'bg-red-600 text-white': type==='warn'?'bg-yellow-500 text-white':'bg-gray-900 text-white';
      el.toast.classList.remove('hidden');
      const item=document.createElement('div'); item.className=`${base} ${color}`; item.textContent=msg; el.toast.appendChild(item);
      setTimeout(()=>{ item.remove(); if(!el.toast.hasChildNodes()) el.toast.classList.add('hidden'); }, 3000);
    };
    const getHeaderOffset=()=>el.fixedHeader?.getBoundingClientRect().height||0;
    const smoothScrollTo=y=>window.scrollTo({top:y,behavior:'smooth'});
    const elmTop=e=>e.getBoundingClientRect().top + window.pageYOffset;

    function hslToHex(h, s, l) { s/=100; l/=100; const k=n=>(n+h/30)%12; const a=s*Math.min(l,1-l); const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1))); const toHex=x=>Math.round(x*255).toString(16).padStart(2,'0'); return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`; }
    function colorForCount(c) {
      if (!Number.isFinite(c) || c <= 0) return { bg: '#e5e7eb', fg: '#111827' };
      const fgForL = (l) => (l < 55 ? '#ffffff' : '#111827');
      if (c >= 1 && c <= 6) { const steps=6, idx=c-1, h=50, s=95, lStart=92, lEnd=55; const l=lStart+(lEnd-lStart)*(idx/(steps-1)); return { bg:hslToHex(h,s,l), fg:fgForL(l) }; }
      if (c >= 7 && c <= 15){ const steps=9, idx=c-7, h=140, s=85, lStart=92, lEnd=45; const l=lStart+(lEnd-lStart)*(idx/(steps-1)); return { bg:hslToHex(h,s,l), fg:fgForL(l) }; }
      if (c >= 16 && c <= 30){ const steps=15, idx=c-16, h=210, s=85, lStart=92, lEnd=40; const l=lStart+(lEnd-lStart)*(idx/(steps-1)); return { bg:hslToHex(h,s,l), fg:fgForL(l) }; }
      return { bg: '#1e40af', fg: '#ffffff' };
    }
    const ymd=(d)=>{ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; };
    const dowMon0=d=> (d.getDay()+6)%7;

    const CHAPTER_LABELS={ 1:"제1장 감사와 회계감사의 기본개념", 2:"제2장 감사인의 의무, 책임 및 자격요건", 3:"제3장 감사인의 독립성과 품질관리", 4:"제1장 감사인의 선임", 5:"제2장 감사계약", 6:"제1장 회계감사수행을 위한 기초지식", 7:"제2장 위험평가절차와 계획수립", 8:"제1장 통제테스트와 위험평가의 확정", 9:"제1-2장 데이터분석", 10:"제2장 실증절차의 기초", 11:"제3장 기초잔액과 거래유형별 실증절차", 12:"제4장 특정항목별 감사절차", 13:"제5장 테스트항목의 범위와 표본감사 데이터분석", 14:"제6장 실증절차의 마무리절차", 15:"제1장 미수정왜곡표시의 평가와 감사의견의 형성", 16:"제2장 감사보고서의 작성과 보고", 17:"제1장 인증업무개념체계와 특정목적재무보고체계, 제2장 그룹재무제표에 대한 감사", 18:"제3장 내부회계관리제도에 대한 감사와 검토", 19:"제4장 중간재무제표에 대한 검토", 20:"제5장 소규모기업 재무제표에 대한 감사" };
    const PART_INSERTIONS=[ {before:1,label:"Part 1. 회계감사의 기초"}, {before:4,label:"Part 2. 감사인의 선임과 감사계약"}, {before:6,label:"Part 3. 회계감사의 시작과 위험평가절차"}, {before:8,label:"Part 4. 위험평가절차에 대한 추가감사절차"}, {before:15,label:"Part 5. 감사의견의 형성과 감사보고서"}, {before:17,label:"Part 6. 그룹재무제표에 대한 감사와 기타인증업무"} ];
    const chapterLabelText=chStr=>{ const n=Number(chStr), t=CHAPTER_LABELS[n]; return Number.isFinite(n)? (t?`${n}. ${t}`:`단원 ${n}`):String(chStr); };

    const PART_VALUE=(s,e)=>`PART:${s}-${e}`;
    const isPartValue=v=>/^PART:\d+-\d+$/.test(v||'');
    const parsePartValue=v=>{ const m=String(v||'').match(/^PART:(\d+)-(\d+)$/); return m?{start:+m[1], end:+m[2]}:null; };
    const getAllChapterNums=()=>[...new Set(allData.map(i=>+i.단원).filter(Number.isFinite))].sort((a,b)=>a-b);
    function computePartRanges(chapterNums){
      if(!chapterNums.length) return [];
      const parts=[...PART_INSERTIONS].sort((a,b)=>a.before-b.before);
      const maxCh=Math.max(...chapterNums);
      const ranges=[];
      for(let i=0;i<parts.length;i++){
        const start=parts[i].before;
        const end=(i+1<parts.length)? (parts[i+1].before-1) : maxCh;
        if(chapterNums.some(n=>n>=start && n<=end)) ranges.push({start,end,label:parts[i].label});
      }
      return ranges;
    }

    function applyDarkMode(){
      const mode=localStorage.getItem('darkMode')||'system'; darkMode=mode;
      if(el.darkModeSelect) el.darkModeSelect.value=mode;
      if(mode==='dark') document.documentElement.classList.add('dark');
      else if(mode==='light') document.documentElement.classList.remove('dark');
      else{
        if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      }
    }
    if(window.matchMedia){ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',()=>{ if(darkMode==='system') applyDarkMode(); }); }

    async function loadData(){
      const CAND=['questions.json','./questions.json','./data/questions.json','./assets/questions.json'];
      const errs=[];
      for(const path of CAND){
        try{
          const res=await fetch(path,{cache:'no-store'}); if(!res.ok){ errs.push(`${path}: HTTP ${res.status}`); continue; }
          const arr=await res.json(); if(!Array.isArray(arr)){ errs.push(`${path}: JSON 최상위가 배열 아님`); continue; }
          const need=['고유ID','단원','물음','정답']; const bad=arr.findIndex(r=>!r||need.some(k=>!(k in r)));
          if(bad!==-1){ errs.push(`${path}: 필수키 누락(index ${bad})`); continue; }
          allData=arr; console.info('[questions.json] loaded from',path); selfTest(); populateChapterSelect(); updateSummary(); return;
        }catch(e){ errs.push(`${path}: ${e.message}`); }
      }
      try{
        const node=$('dataset-json'); if(!node) throw new Error('dataset-json 없음');
        const text=(node.textContent||'').trim(); if(!text) throw new Error('내장 데이터 비어 있음');
        const parsed=JSON.parse(text); if(!Array.isArray(parsed)) throw new Error('내장 데이터 최상위가 배열 아님');
        allData=parsed; console.warn('[questions.json] 모든 후보 실패. 내장 데이터로 폴백',errs); showToast('외부 DB 실패 → 내장 데이터 사용','warn');
        selfTest(); populateChapterSelect(); updateSummary();
      }catch(err){ console.error('질문 데이터 로드 실패:',errs,err); showToast('문제 데이터 로드 실패: 콘솔 확인','error'); $('question-text').textContent='문제 데이터 로드 실패 (questions.json 또는 dataset-json 확인).'; }
    }
    function selfTest(){
      const miss=[]; allData.forEach((r,i)=>{ if(!(r&&'고유ID'in r && '단원'in r && '물음'in r && '정답'in r)) miss.push(i+1); });
      if(miss.length) showToast(`경고: 필수 필드 누락 ${miss.length}개`,'warn');
      const seen=new Set(), dup=[]; for(const r of allData){ const k=String(r.고유ID).trim(); if(seen.has(k)) dup.push(k); else seen.add(k); }
      if(dup.length) showToast(`경고: 중복 고유ID ${dup.length}개`,'warn');
      if(!new Set(allData.map(r=>String(r.단원).trim())).size) throw new Error('단원 데이터 없음');
    }

    function populateChapterSelect(){
      while(el.chapterSelect.options.length>1) el.chapterSelect.remove(1);
      const chNums=getAllChapterNums(); const ranges=computePartRanges(chNums);
      for(const r of ranges){
        const opt=document.createElement('option'); opt.value=PART_VALUE(r.start,r.end);
        opt.textContent=`--- ${r.label} (${r.start}~${r.end}장) ---`; opt.className='text-gray-700';
        el.chapterSelect.appendChild(opt);
        chNums.filter(n=>n>=r.start && n<=r.end).forEach(n=>{
          const copt=document.createElement('option'); copt.value=String(n); copt.textContent=chapterLabelText(n);
          el.chapterSelect.appendChild(copt);
        });
      }
    }

    function loadScores(){ try{ questionScores=JSON.parse(localStorage.getItem('auditQuizScores')||'{}'); }catch{ questionScores={}; localStorage.removeItem('auditQuizScores'); } }
    function loadApiKey(){ geminiApiKey=sessionStorage.getItem('geminiApiKey')||localStorage.getItem('geminiApiKey')||''; }
    function loadSettings(){ selectedAiModel=localStorage.getItem('aiModel')||'gemini-2.5-flash'; if(el.aiModelSelect) el.aiModelSelect.value=selectedAiModel; }

    function migrateData(){
      const version=localStorage.getItem('schemaVersion'); if(version==='2') return;
      try{
        const old=localStorage.getItem('auditQuizScores'); if(!old){ localStorage.setItem('schemaVersion','2'); return; }
        const parsed=JSON.parse(old), newScores={}, map={};
        allData.forEach(q=>{ const disp=String(q.표시번호??'').trim(), num=String(q.물음번호??'').trim(); if(disp) map[disp]=q.고유ID; if(num) map[num]=q.고유ID; });
        Object.keys(parsed).forEach(k=>{
          const nk=map[k]||k, ov=parsed[k]||{}, hist=Array.isArray(ov.solveHistory)?ov.solveHistory:(ov.score!=null?[{date:Date.now(),score:+ov.score||0}]:[]);
          newScores[nk]={ score:+(ov.score??0), feedback:String(ov.feedback??''), user_answer:String(ov.user_answer??''), hintUsed:!!ov.hintUsed, isSolved:!!(ov.isSolved||(ov.score!=null)), lastSolvedDate:+(ov.lastSolvedDate??(hist.at(-1)?.date||Date.now())), solveHistory:hist, userReviewFlag:!!ov.userReviewFlag };
        });
        localStorage.setItem('auditQuizScores',JSON.stringify(newScores)); localStorage.setItem('schemaVersion','2'); questionScores=newScores; showToast('데이터 마이그레이션 완료','info');
      }catch(e){ console.error(e); showToast('마이그레이션 오류','error'); }
    }

    function openApiModal(initial=false){ if(initial) el.apiModalCancelBtn.classList.add('hidden'); else el.apiModalCancelBtn.classList.remove('hidden');
      el.apiModal.classList.remove('hidden'); el.apiModal.classList.add('flex'); el.apiModalInput.value=geminiApiKey||''; el.apiModalRemember.checked=!!localStorage.getItem('geminiApiKey'); setTimeout(()=>el.apiModalInput.focus(),0);
    }
    const closeApiModal=()=>{ el.apiModal.classList.add('hidden'); el.apiModal.classList.remove('flex'); };
    const ensureApiKeyGate=()=>{ if(!geminiApiKey) openApiModal(true); };
    el.apiModalSaveBtn.addEventListener('click',()=>{
      const key=(el.apiModalInput.value||'').trim(); if(!key){ showToast('API 키를 입력하세요.','error'); el.apiModalInput.focus(); return; }
      geminiApiKey=key; sessionStorage.setItem('geminiApiKey',key); if(el.apiModalRemember.checked) localStorage.setItem('geminiApiKey',key); else localStorage.removeItem('geminiApiKey'); closeApiModal(); showToast('API 키 저장 완료');
    });
    el.apiModalCancelBtn.addEventListener('click',closeApiModal);
    document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ if(!el.apiModalCancelBtn.classList.contains('hidden') && !el.apiModal.classList.contains('hidden')) closeApiModal(); if(!el.settingsModal.classList.contains('hidden')) closeSettingsModal(); } });

    function openSettingsModal(){ el.settingsModal.classList.remove('hidden'); el.settingsModal.classList.add('flex'); if(el.aiModelSelect) el.aiModelSelect.value=selectedAiModel; if(el.darkModeSelect) el.darkModeSelect.value=darkMode; }
    function closeSettingsModal(){ el.settingsModal.classList.add('hidden'); el.settingsModal.classList.remove('flex'); }
    el.settingsBtn.addEventListener('click',openSettingsModal);
    el.settingsCloseBtn.addEventListener('click',closeSettingsModal);
    el.settingsCloseBtnBottom.addEventListener('click',closeSettingsModal);
    el.openApiKeyModalBtn?.addEventListener('click',()=>{ closeSettingsModal(); openApiModal(false); });
    el.aiModelSelect?.addEventListener('change',e=>{ selectedAiModel=e.target.value; localStorage.setItem('aiModel',selectedAiModel); showToast(`AI 모델 변경: ${selectedAiModel}`); });
    el.darkModeSelect?.addEventListener('change',e=>{ localStorage.setItem('darkMode',e.target.value); applyDarkMode(); showToast('다크 모드 설정 변경됨'); });

    el.exportDataBtn?.addEventListener('click',()=>{
      try{
        const data={ version:'3.x', schemaVersion:+(localStorage.getItem('schemaVersion')||2), exportDate:new Date().toISOString(), auditQuizScores:questionScores, geminiApiKey:localStorage.getItem('geminiApiKey')||'', aiModel:selectedAiModel, darkMode:darkMode };
        const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=`gamlini_backup_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url); showToast('데이터 내보내기 완료');
      }catch(err){ console.error(err); showToast('데이터 내보내기 실패','error'); }
    });
    el.importDataBtn?.addEventListener('click',()=>el.importFileInput.click());
    el.importFileInput?.addEventListener('change',e=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        try{
          const data=JSON.parse(ev.target.result);
          if(!data.auditQuizScores) throw new Error('올바른 백업 파일이 아닙니다.');
          localStorage.setItem('auditQuizScores',JSON.stringify(data.auditQuizScores)); questionScores=data.auditQuizScores;
          if(data.geminiApiKey){ localStorage.setItem('geminiApiKey',data.geminiApiKey); geminiApiKey=data.geminiApiKey; }
          if(data.aiModel){ localStorage.setItem('aiModel',data.aiModel); selectedAiModel=data.aiModel; if(el.aiModelSelect) el.aiModelSelect.value=data.aiModel; }
          if(data.darkMode){ localStorage.setItem('darkMode',data.darkMode); darkMode=data.darkMode; applyDarkMode(); }
          if(data.schemaVersion) localStorage.setItem('schemaVersion',String(data.schemaVersion));
          showToast('데이터 가져오기 완료'); setTimeout(()=>location.reload(),600);
        }catch(err){ console.error(err); showToast(`가져오기 실패: ${err.message}`,'error'); }
      };
      reader.readAsText(file); e.target.value='';
    });

    const SOURCE_LS='sourceFilterSelectionV1', BASIC_TAGS=['S','H','HS'], ADV_TAGS=['SS','P'];
    function buildSourceFilterUI(){
      if(!el.sourceGroupFilter) return;
      el.sourceGroupFilter.innerHTML=`
        <div class="rounded-xl border p-3">
          <div class="text-sm font-semibold mb-2">출처별 필터</div>
          <div class="flex flex-wrap gap-3">
            <label class="text-sm flex items-center gap-1"><input type="checkbox" value="basic" class="source-filter"> 기본(S/H/HS)</label>
            <label class="text-sm flex items-center gap-1"><input type="checkbox" value="advanced" class="source-filter"> 심화(SS/P)</label>
            <label class="text-sm flex items-center gap-1"><input type="checkbox" value="other" class="source-filter"> 기타</label>
            <button id="source-filter-all" class="ml-auto text-xs px-2 py-1 border rounded">전체</button>
            <button id="source-filter-none" class="text-xs px-2 py-1 border rounded">해제</button>
          </div>
        </div>`;
      const saved=JSON.parse(localStorage.getItem(SOURCE_LS)||'["basic","advanced","other"]');
      el.sourceGroupFilter.querySelectorAll('input.source-filter').forEach(cb=>{
        cb.checked=saved.includes(cb.value);
        cb.addEventListener('change',()=>{ localStorage.setItem(SOURCE_LS,JSON.stringify(getSelectedSourceGroups())); reloadAndRefresh(); });
      });
      el.sourceGroupFilter.querySelector('#source-filter-all')?.addEventListener('click',()=>{ setAllGroups(['basic','advanced','other']); });
      el.sourceGroupFilter.querySelector('#source-filter-none')?.addEventListener('click',()=>{ setAllGroups([]); });
      function setAllGroups(arr){ el.sourceGroupFilter.querySelectorAll('input.source-filter').forEach(cb=>cb.checked=arr.includes(cb.value)); localStorage.setItem(SOURCE_LS,JSON.stringify(arr)); reloadAndRefresh(); }
    }
    const getSelectedSourceGroups=()=>{ const boxes=el.sourceGroupFilter?.querySelectorAll('input.source-filter'); if(!boxes||boxes.length===0) return JSON.parse(localStorage.getItem(SOURCE_LS)||'["basic","advanced","other"]'); const arr=[]; boxes.forEach(cb=>{ if(cb.checked) arr.push(cb.value); }); return arr; };
    const detectSourceGroup=src=>{ const s=String(src||'').toUpperCase(), tok=s.split(/\s*[;,\/\s]\s*/).filter(Boolean); const hasBasic=tok.some(t=>BASIC_TAGS.includes(t)), hasAdv=tok.some(t=>ADV_TAGS.includes(t)); if(hasBasic && !hasAdv) return 'basic'; if(!hasBasic && hasAdv) return 'advanced'; if(hasBasic && hasAdv) return 'basic-advanced'; return 'other'; };
    const applySourceFilter=arr=>{ const selected=new Set(getSelectedSourceGroups()); if(selected.size===0||selected.size===3) return arr; return (arr||[]).filter(q=>{ const g=detectSourceGroup(q.출처); if(g==='basic-advanced') return selected.has('basic')||selected.has('advanced'); return selected.has(g); }); };

    function filterByChapterSelection(list){
      const sel=el.chapterSelect?.value||'';
      if(!sel) return list;
      if(isPartValue(sel)){
        const pr=parsePartValue(sel); if(!pr) return list;
        return list.filter(q=>{ const n=+q.단원; return Number.isFinite(n) && n>=pr.start && n<=pr.end; });
      }
      return list.filter(q=>String(q.단원).trim()===String(sel));
    }

    function getFilteredByUI(){
      const filter=el.filterSelect.value;
      let list=applySourceFilter(allData);
      list=filterByChapterSelection(list);

      list=list.filter(q=>{
        const key=normId(q.고유ID), s=questionScores[key];
        if(filter==='unanswered') return !s;
        if(filter==='80') return !s || +s.score<80;
        if(filter==='60') return !s || +s.score<60;
        return true;
      });

      if(filter==='today-review') {
        // 복습 제외 표시된 문제는 오늘의 복습 후보에서 제거
        list = list.filter(q => !questionScores[normId(q.고유ID)]?.userReviewExclude);
        list = prioritizeTodayReview(list).slice(0,10);
      }
      return list;
    }
    function reloadAndRefresh(){
      if(isPartValue(el.chapterSelect.value)){
        summaryViewMode='CURRENT';
        el.summaryViewCurrentBtn?.classList.add('bg-gray-100');
        el.summaryViewAllBtn?.classList.remove('bg-gray-100');
      }
      currentQuizData=getFilteredByUI(); currentQuestionIndex=0;
      if(currentQuizData.length){ el.quizArea.classList.remove('hidden'); el.summaryArea.classList.remove('hidden'); displayQuestion(); }
      else{ el.quizArea.classList.add('hidden'); el.summaryArea.classList.remove('hidden'); showToast('선택한 조건에 맞는 문제가 없습니다.','warn'); }
      updateSummary(); refreshPanels();
    }

    el.chapterSelect.addEventListener('change', reloadAndRefresh);
    el.filterSelect.addEventListener('change', reloadAndRefresh);
    el.loadQuizBtn.addEventListener('click', reloadAndRefresh);
    el.randomQuizBtn.addEventListener('click',()=>{
      const list=getFilteredByUI(); if(!list.length){ showToast('선택 조건에 맞는 문제가 없습니다.','warn'); return; }
      currentQuizData=list; currentQuestionIndex=Math.floor(Math.random()*list.length);
      el.quizArea.classList.remove('hidden'); el.summaryArea.classList.remove('hidden'); displayQuestion(); updateSummary(); refreshPanels(); showToast('랜덤 문제 시작!');
    });

    function displayQuestion(){
      if(!currentQuizData.length){ el.quizArea.classList.add('hidden'); return; }
      const q=currentQuizData[currentQuestionIndex];
      el.quizArea.classList.remove('hidden');
      el.questionNumber.textContent=`문항 ${q.표시번호||q.물음번호||q.고유ID}`;
      el.questionText.textContent=q.물음;
      el.questionCounter.textContent=`${currentQuestionIndex+1} / ${currentQuizData.length}`;
      el.dbQuestionId.textContent=`ID: ${q.고유ID??'-'}`;
      activeHintQuestionKey=null; el.hintBox.classList.add('hidden'); el.hintBox.innerHTML='';
      el.resultBox.classList.add('hidden'); el.userAnswer.value='';
      el.loadPrevAnswerBtn.textContent='이전 답안 불러오기'; el.loadPrevAnswerBtn.removeAttribute('aria-pressed'); prevLoaded=false;

      const saved=questionScores[normId(q.고유ID)];
      const flagged=!!(saved?.userReviewFlag);
      el.reviewFlagToggle.setAttribute('aria-pressed', flagged?'true':'false');
      el.reviewFlagToggle.querySelector('span').textContent= flagged?'★':'☆';

      const excluded = !!(saved?.userReviewExclude);
      if (el.reviewExcludeToggle) {
        el.reviewExcludeToggle.setAttribute('aria-pressed', excluded ? 'true' : 'false');
      }

      if(saved && saved.score!==undefined) showResult(saved.score, saved.feedback, q.정답);
      el.prevBtn.disabled=(currentQuestionIndex===0);
      el.nextBtn.disabled=(currentQuizData.length-1===currentQuestionIndex);
      updateSummaryHighlight();
    }

    el.reviewFlagToggle.addEventListener('click',()=>{
      if(!currentQuizData.length) return;
      const q=currentQuizData[currentQuestionIndex], key=normId(q.고유ID), rec=questionScores[key]||{}, next=!rec.userReviewFlag;
      questionScores[key]={...rec, userReviewFlag:next};
      try{ localStorage.setItem('auditQuizScores',JSON.stringify(questionScores)); }catch{}
      el.reviewFlagToggle.setAttribute('aria-pressed', next?'true':'false');
      el.reviewFlagToggle.querySelector('span').textContent= next?'★':'☆';
      showToast(next?'복습 필요에 추가':'복습 필요 해제'); refreshPanels();
    });

    // NEW: 복습 제외 토글 (오늘의 복습에서 제외)
    el.reviewExcludeToggle?.addEventListener('click', ()=>{
      if(!currentQuizData.length) return;
      const q=currentQuizData[currentQuestionIndex];
      const key=normId(q.고유ID);
      const rec=questionScores[key]||{};
      const next = !rec.userReviewExclude;

      questionScores[key] = { ...rec, userReviewExclude: next };
      try { localStorage.setItem('auditQuizScores', JSON.stringify(questionScores)); } catch {}

      el.reviewExcludeToggle.setAttribute('aria-pressed', next?'true':'false');
      showToast(next ? '오늘의 복습에서 제외했습니다.' : '복습 제외를 해제했습니다.');
      refreshPanels();
    });

    el.loadPrevAnswerBtn.addEventListener('click',()=>{
      if(!currentQuizData.length) return;
      const q=currentQuizData[currentQuestionIndex], saved=questionScores[normId(q.고유ID)];
      if(!prevLoaded){
        if(saved?.user_answer){ el.userAnswer.value=saved.user_answer; el.loadPrevAnswerBtn.textContent='답안 지우기'; el.loadPrevAnswerBtn.setAttribute('aria-pressed','true'); prevLoaded=true; showToast('이전 답안을 불러왔습니다.'); }
        else showToast('저장된 답안이 없습니다.','warn');
      }else{
        el.userAnswer.value=''; el.loadPrevAnswerBtn.textContent='이전 답안 불러오기'; el.loadPrevAnswerBtn.setAttribute('aria-pressed','false'); prevLoaded=false;
      }
    });

    el.prevBtn.addEventListener('click',()=>{ if(currentQuestionIndex>0){ currentQuestionIndex--; displayQuestion(); } });
    el.nextBtn.addEventListener('click',()=>{ if(currentQuestionIndex<currentQuizData.length-1){ currentQuestionIndex++; displayQuestion(); } });
    el.userAnswer.addEventListener('input',()=> el.errorMessage.classList.add('hidden'));
    el.userAnswer.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); el.gradeBtn.click(); } });

    el.gradeBtn.addEventListener('click',handleGrade);
    async function handleGrade(){
      if(!geminiApiKey){ openApiModal(false); showToast('Gemini API 키를 입력해주세요.','error'); return; }
      const answer=el.userAnswer.value.trim(); if(!answer){ el.errorMessage.textContent='답안을 입력해주세요.'; el.errorMessage.classList.remove('hidden'); el.userAnswer.focus(); return; }
      el.errorMessage.classList.add('hidden');
      const q=currentQuizData[currentQuestionIndex], qKey=normId(q.고유ID);
      setLoading(true);
      try{
        let {score, feedback}=await callGeminiAPI(answer, q.정답, geminiApiKey);
        if (selectedAiModel === 'gemini-2.5-flash-lite') score = clamp(score - 7, 0, 100);
        const usedHint=(activeHintQuestionKey===qKey);
        const finalScore= usedHint? Math.min(59, Math.round(score*0.8)) : score;
        const finalFeedback= usedHint? `${feedback?feedback+' ':''}(힌트사용으로 감점)` : feedback;
        showResult(finalScore, finalFeedback, q.정답);

        const existing=questionScores[qKey]||{}, newHistory=[...(existing.solveHistory||[]), {date:Date.now(), score:finalScore}];
        questionScores[qKey]={ score:finalScore, feedback:finalFeedback, user_answer:answer, hintUsed:usedHint, isSolved:true, lastSolvedDate:Date.now(), solveHistory:newHistory, userReviewFlag:!!existing.userReviewFlag, userReviewExclude: !!existing.userReviewExclude };
        try{ localStorage.setItem('auditQuizScores',JSON.stringify(questionScores)); }catch{ showToast('localStorage 저장 실패(용량)','error'); }

        const {increased, uniqueReads}=registerUniqueRead(qKey); if(increased) showToast(`회독 +1 (이 문제 고유 ${uniqueReads}회)`);
        updateSummary(); refreshPanels();
      }catch(e){
        console.error('채점 오류:',e); el.aiFeedback.textContent=`채점 중 오류: ${e.message}`; el.score.textContent='Error'; el.progressBar.style.width='0%'; el.resultBox.classList.remove('hidden');
        showToast('채점 요청 실패: API 키/네트워크/할당량 확인.','error');
      }finally{ setLoading(false); }
    }
    function setLoading(v){ if(v){ el.gradeBtnText.classList.add('hidden'); el.gradeLoader.classList.remove('hidden'); el.gradeBtn.disabled=true; el.resultBox.classList.add('hidden'); } else { el.gradeBtnText.classList.remove('hidden'); el.gradeLoader.classList.add('hidden'); el.gradeBtn.disabled=false; } }

    async function callGeminiAPI(userAnswer, correctAnswer, apiKey, retries=2, delay=800){
      const modelMap={'gemini-2.5-flash':'gemini-2.5-flash','gemini-2.5-flash-lite':'gemini-2.5-flash-lite'};
      const model=modelMap[selectedAiModel]||'gemini-2.5-flash';
      const url=`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
      const generationConfig={ responseMimeType:'application/json', responseSchema:{ type:'OBJECT', properties:{score:{type:'NUMBER'}, feedback:{type:'STRING'}}, required:['score','feedback'] } };

      const systemText = (model === 'gemini-2.5-flash-lite') ? `${BASE_SYSTEM_PROMPT}\n\n${LITE_STRICT_ADDENDUM}` : BASE_SYSTEM_PROMPT;
      const systemInstruction={ parts:[{ text: systemText }] };
      const userQuery=`[모범 답안]\n${correctAnswer}\n\n[사용자 답안]\n${userAnswer}\n\n[채점 요청]\n{"score": number, "feedback": string}`;
      const payload={ contents:[{ parts:[{ text:userQuery }] }], systemInstruction, generationConfig };

      try{
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        if(!res.ok){ const body=await res.json().catch(()=>({})); const msg=body?.error?.message||res.statusText;
          if((res.status===404||res.status===400)&&/model/i.test(msg)) throw new Error(`모델/버전 불일치: ${msg}`);
          if(res.status===429) throw new Error(`API 할당량 초과 (429)`); if(res.status>=500) throw new Error(`서버 오류 (${res.status})`); throw new Error(msg);
        }
        const data=await res.json(); const raw=data?.candidates?.[0]?.content?.parts?.[0]?.text??''; const cleaned=sanitizeModelText(raw);
        let parsed; try{ parsed=JSON.parse(cleaned); }catch{ throw new Error('API 응답 파싱 실패'); }
        return { score:clamp(+parsed.score,0,100), feedback:String(parsed.feedback||'피드백 없음').trim() };
      }catch(err){
        if(retries>0 && (String(err.message).includes('429') || /^서버 오류/.test(String(err.message)))){ await new Promise(r=>setTimeout(r,delay)); return callGeminiAPI(userAnswer, correctAnswer, apiKey, retries-1, delay*1.6); }
        throw err;
      }
    }

    el.hintBtn.addEventListener('click',()=>{ if(currentQuizData.length) handleHint(currentQuizData[currentQuestionIndex]); });
    async function handleHint(q){
      if(!geminiApiKey){ openApiModal(false); showToast('Gemini API 키를 입력해주세요.','error'); return; }
      setLoading(true);
      try{
        const hint=await callGeminiHintAPI(el.userAnswer.value.trim(), q.정답, q.물음, geminiApiKey);
        el.hintBox.innerHTML=`<strong class="font-semibold">힌트</strong><br>${String(hint||'').replace(/\n/g,'<br>')}`;
        el.hintBox.classList.remove('hidden'); activeHintQuestionKey=normId(q.고유ID); showToast('힌트를 표시했습니다. (즉시 채점 시 감점)','warn');
      }catch(e){ console.error(e); showToast(`힌트 생성 실패: ${e.message}`,'error'); }
      finally{ setLoading(false); }
    }
    async function callGeminiHintAPI(userAnswer, correctAnswer, questionText, apiKey, retries=2, delay=800){
      const modelMap={'gemini-2.5-flash':'gemini-2.5-flash','gemini-2.5-flash-lite':'gemini-2.5-flash-lite'};
      const model=modelMap[selectedAiModel]||'gemini-2.5-flash';
      const url=`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
      const generationConfig={ responseMimeType:'application/json', responseSchema:{ type:'OBJECT', properties:{hint:{type:'STRING'}}, required:['hint'] } };
      const systemInstruction={ parts:[{ text:`역할: 회계감사 학습 튜터.\n목표: 정답을 노출하지 않고 핵심 개념을 떠올리게 만드는 2~4줄 힌트 제공.\n출력: JSON만.` }] };
      const userQuery=`[문제]\n${questionText}\n\n[모범 답안]\n${correctAnswer}\n\n[사용자 답안]\n${userAnswer||'(미입력)'}\n\n[요청]\n{"hint": string }`;
      const payload={ contents:[{ parts:[{ text:userQuery }] }], systemInstruction, generationConfig };
      try{
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!res.ok){ const body=await res.json().catch(()=>({})); const msg=body?.error?.message||res.statusText;
          if((res.status===404||res.status===400)&&/model/i.test(msg)) throw new Error(`모델/버전 불일치: ${msg}`);
          if(res.status===429) throw new Error(`API 할당량 초과 (429)`); if(res.status>=500) throw new Error(`서버 오류 (${res.status})`); throw new Error(msg);
        }
        const data=await res.json(); const raw=data?.candidates?.[0]?.content?.parts?.[0]?.text??''; const cleaned=sanitizeModelText(raw);
        let parsed; try{ parsed=JSON.parse(cleaned); }catch{ throw new Error('API 응답 파싱 실패'); }
        return String(parsed.hint||'').trim();
      }catch(err){
        if(retries>0 && (String(err.message).includes('429') || /^서버 오류/.test(String(err.message)))){ await new Promise(r=>setTimeout(r,delay)); return callGeminiHintAPI(userAnswer, correctAnswer, questionText, apiKey, retries-1, delay*1.6); }
        throw err;
      }
    }

    function showResult(scoreVal, feedback, correctAnswer){
      const s=clamp(+scoreVal,0,100);
      el.score.textContent=s.toFixed(1); el.progressBar.style.width=`${s}%`; el.progressBar.setAttribute('aria-valuenow',String(Math.round(s)));
      el.progressBar.className='h-4 rounded-full transition-all duration-500 ease-out '+(s<60?'bg-red-500': s<80?'bg-yellow-500':'bg-blue-600');
      el.aiFeedback.textContent=String(feedback||''); el.correctAnswer.textContent=String(correctAnswer||''); el.resultBox.classList.remove('hidden');
    }

    el.summaryViewAllBtn?.addEventListener('click',()=>{ summaryViewMode='ALL'; el.summaryViewAllBtn.classList.add('bg-gray-100'); el.summaryViewCurrentBtn.classList.remove('bg-gray-100'); updateSummary(); });
    el.summaryViewCurrentBtn?.addEventListener('click',()=>{ summaryViewMode='CURRENT'; el.summaryViewCurrentBtn.classList.add('bg-gray-100'); el.summaryViewAllBtn.classList.remove('bg-gray-100'); updateSummary(); });

    const READ_STORE_KEY='readSessions_v2', UNIQUE_WINDOW_MS=5*60*1000;
    const loadReadStore=()=>{ try{ return JSON.parse(localStorage.getItem(READ_STORE_KEY)||'{}'); }catch{ return {}; } };
    const saveReadStore=obj=>localStorage.setItem(READ_STORE_KEY,JSON.stringify(obj));
    const computeUniqueReadsFromHistory=h=>{ const times=(Array.isArray(h)?h:[]).map(x=>+x?.date).filter(Number.isFinite).sort((a,b)=>a-b); if(!times.length) return {uniqueReads:0,lastAt:0}; let c=0,last=-Infinity; for(const t of times){ if(t-last>=UNIQUE_WINDOW_MS){ c++; last=t; } } return {uniqueReads:c,lastAt:times.at(-1)}; };
    function backfillReadStoreFromScores(force=false){
      if(!force && localStorage.getItem('readStoreBackfilled_v2')==='1') return;
      const db=loadReadStore(); let touched=0;
      for(const [qid,rec] of Object.entries(questionScores||{})){ const hist=Array.isArray(rec?.solveHistory)?rec.solveHistory:[]; if(!hist.length) continue; const has=db[qid];
        if(!has || !Number.isFinite(+has.uniqueReads) || +has.uniqueReads===0){ const seed=computeUniqueReadsFromHistory(hist); if(seed.uniqueReads>0){ db[qid]=seed; touched++; } }
      }
      if(touched>0) saveReadStore(db); localStorage.setItem('readStoreBackfilled_v2','1');
    }
    function registerUniqueRead(qid){
      const t=Date.now(), db=loadReadStore(); let rec=db[qid];
      if(!rec){ const hist=questionScores[qid]?.solveHistory; rec=Array.isArray(hist)&&hist.length?computeUniqueReadsFromHistory(hist):{uniqueReads:0,lastAt:0}; }
      if(t-(rec.lastAt||0)>=UNIQUE_WINDOW_MS){ rec.uniqueReads=(+rec.uniqueReads||0)+1; rec.lastAt=t; db[qid]=rec; saveReadStore(db); return {increased:true, uniqueReads:rec.uniqueReads}; }
      rec.lastAt=t; db[qid]=rec; saveReadStore(db); return {increased:false, uniqueReads:rec.uniqueReads};
    }

    function updateSummary(){
      el.scoreSummary.innerHTML='';
      const base=(summaryViewMode==='CURRENT')?(currentQuizData||[]):(allData||[]);
      const groups=new Map(); for(const q of base){ const ch=String(q.단원).trim(); if(!groups.has(ch)) groups.set(ch,[]); groups.get(ch).push(q); }
      const chapters=[...groups.keys()].sort((a,b)=>{ const na=+a, nb=+b; if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; if(Number.isFinite(na)) return -1; if(Number.isFinite(nb)) return 1; return a.localeCompare(b,'ko'); });

      const readStore=loadReadStore(), _clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

      chapters.forEach(ch=>{
        const n=+ch; if(Number.isFinite(n)){ const hit=PART_INSERTIONS.find(p=>p.before===n); if(hit){ const part=document.createElement('div'); part.className='w-full px-3 py-2 mb-2 rounded-lg border-2 bg-blue-50 border-blue-200 text-blue-800 font-bold'; part.textContent=hit.label; el.scoreSummary.appendChild(part); } }
        const list=(groups.get(ch)||[]).sort((a,b)=>{ const na=+(a.물음번호||a.표시번호), nb=+(b.물음번호||b.표시번호); if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; return String(a.표시번호||a.물음번호).localeCompare(String(b.표시번호||b.물음번호),'ko'); });

        let sum=0,cnt=0,sumRounds=0, last=0;
        list.forEach(q=>{
          const id=String(q.고유ID).trim(), s=questionScores[id];
          if(s && Number.isFinite(+s.score)){ sum+=+s.score; cnt++; }
          const rs=readStore[id]; const ur= rs && Number.isFinite(+rs.uniqueReads)? +rs.uniqueReads : computeUniqueReadsFromHistory(s?.solveHistory||[]).uniqueReads;
          sumRounds+=ur; if(s?.lastSolvedDate && s.lastSolvedDate>last) last=s.lastSolvedDate;
        });

        const avg=cnt? (sum/cnt):null, rounds=list.length? (sumRounds/list.length):0;
        const recent= last? ((d=>d===0?'오늘':d===1?'어제':`${d}일 전`)(Math.floor((Date.now()-last)/86400000))):'학습 기록 없음';
        const ratio=`응시 ${cnt}/${list.length}`, avgTxt=avg==null?'-':avg.toFixed(1), roundsTxt=rounds.toFixed(1);
        const barW=_clamp(avg??0,0,100), barCls= avg==null?'bg-gray-300': avg<60?'bg-red-500': avg<80?'bg-yellow-500':'bg-green-500';

        const header=document.createElement('div'); header.className='px-3 py-2 rounded-md border bg-gray-50 mb-2';
        header.innerHTML=`
          <div class="font-semibold text-lg">${chapterLabelText(ch)}</div>
          <div class="text-sm text-gray-700 mt-1 space-y-1">
            <div>평균 ${avgTxt}점 · ${ratio}</div>
            <div>평균 ${roundsTxt}회독 · 최근 ${recent}</div>
          </div>
          <div class="w-28 h-2 bg-gray-200 rounded-full overflow-hidden mt-2"><div class="h-2 ${barCls}" style="width:${barW}%"></div></div>
          <div class="mt-2 flex justify-end"><button class="text-xs text-blue-700 hover:underline summary-toggle">접기</button></div>`;
        const grid=document.createElement('div'); grid.className='flex flex-wrap gap-2 mt-2 mb-4';

        list.forEach(q=>{
          const btn=document.createElement('button');

          // 라벨 구성 (➖ 아이콘)
          const disp=(q.표시번호??'').toString().trim();
          const fallback=(q.물음번호??q.고유ID??'').toString().trim();
          const baseLabel = disp || fallback || '';

          const id=String(q.고유ID).trim();
          const saved=questionScores[id];
          const excluded = !!(saved?.userReviewExclude);
          const isFlagged = !!(saved?.userReviewFlag);

          const label = excluded ? `➖ ${baseLabel}` : baseLabel;
          btn.textContent=label;
          if(baseLabel.length>=3) btn.style.fontSize='.72rem';
          if(baseLabel.length>=4){ btn.style.fontSize='.66rem'; btn.style.letterSpacing='-0.2px'; }

          const metaFlags=[];
          if(excluded) metaFlags.push('복습제외');
          if(isFlagged) metaFlags.push('복습필요');

          const fullMeta=[ q.problemTitle && String(q.problemTitle).trim(),
            `표시번호:${disp||'-'}`, `물음번호:${(q.물음번호??'').toString().trim()||'-'}`, `ID:${(q.고유ID??'').toString().trim()||'-'}`, metaFlags.join(', ')
          ].filter(Boolean).join(' | ');
          btn.title=fullMeta; btn.setAttribute('aria-label',fullMeta);

          btn.classList.add('summary-btn','font-medium','rounded-lg','border');

          const sc= saved? +saved.score: NaN;
          const cls= !Number.isFinite(sc)? ['bg-gray-100','text-gray-600','border-gray-300'] : sc<60? ['bg-red-100','text-red-700','border-red-300'] : sc<80? ['bg-yellow-100','text-yellow-700','border-yellow-300'] : ['bg-green-100','text-green-700','border-green-300'];
          btn.classList.add(...cls); btn.dataset.qid=id;

          btn.addEventListener('click',()=>{
            const idx=currentQuizData.findIndex(it=>String(it.고유ID).trim()===id);
            if(idx===-1){
              const chVal=String(q.단원).trim(), set=allData.filter(it=>String(it.단원).trim()===chVal);
              if(set.length){ currentQuizData=set; currentQuestionIndex=set.findIndex(it=>String(it.고유ID).trim()===id); }
            } else currentQuestionIndex=idx;
            if(currentQuestionIndex<0) currentQuestionIndex=0;
            el.quizArea.classList.remove('hidden'); displayQuestion(); showToast(`'${baseLabel}'로 이동`);
          });
          grid.appendChild(btn);
        });

        header.querySelector('.summary-toggle').addEventListener('click',e=>{
          const hidden=grid.classList.toggle('hidden'); e.currentTarget.textContent= hidden?'펼치기':'접기';
        });

        const section=document.createElement('div'); section.className='w-full space-y-2 mb-3'; section.appendChild(header); section.appendChild(grid);
        el.scoreSummary.appendChild(section);
      });
      updateSummaryHighlight();
    }
    function updateSummaryHighlight(){
      if(!currentQuizData.length) return; const cur=String(currentQuizData[currentQuestionIndex].고유ID).trim();
      el.scoreSummary.querySelectorAll('button.summary-btn').forEach(b=>{ b.classList.remove('ring-2','ring-blue-500','ring-offset-2'); if(b.dataset.qid===cur) b.classList.add('ring-2','ring-blue-500','ring-offset-2'); });
    }

    el.clearFilterBtn.addEventListener('click',()=>{
      el.filterSelect.value='all'; el.chapterSelect.value='';
      el.sourceGroupFilter?.querySelectorAll('input.source-filter')?.forEach(cb=>cb.checked=true);
      localStorage.setItem(SOURCE_LS,JSON.stringify(['basic','advanced','other']));
      reloadAndRefresh(); showToast('필터 해제: 모든 문제 표시');
    });
    el.resetScoresBtn.addEventListener('click',()=>{
      if(confirm('정말로 모든 학습 기록을 초기화하시겠습니까?')){
        questionScores={}; localStorage.removeItem('auditQuizScores'); localStorage.removeItem('schemaVersion'); localStorage.removeItem('readSessions_v2'); localStorage.removeItem('readStoreBackfilled_v2');
        updateSummary(); if(currentQuizData.length){ currentQuestionIndex=0; reloadAndRefresh(); } refreshPanels(); showToast('학습 기록 초기화 완료');
      }
    });

    function ensureResultBoxReady(){ if(currentQuizData.length){ const q=currentQuizData[currentQuestionIndex]; if(!el.correctAnswer.textContent?.trim()) el.correctAnswer.textContent=String(q.정답||''); } el.resultBox.classList.remove('hidden'); }
    function enterFocusMode(){ lastScrollYBeforeFocus=window.pageYOffset; document.documentElement.classList.add('focus-mode'); ensureResultBoxReady(); const header=el.userAnswer; const margin=12; const y=header.getBoundingClientRect().top + window.pageYOffset - (el.fixedHeader?.getBoundingClientRect().height||0) - margin; window.scrollTo({top:Math.max(0,y),behavior:'smooth'}); ctrlNavState='focus'; }
    function exitToDashboard(){ document.documentElement.classList.remove('focus-mode'); if(el.summaryArea) window.scrollTo({top:el.summaryArea.getBoundingClientRect().top + window.pageYOffset - (el.fixedHeader?.getBoundingClientRect().height||0) - 8, behavior:'smooth'}); else window.scrollTo({top:0,behavior:'smooth'}); ctrlNavState='dashboard'; }
    function backFromFocus(){ document.documentElement.classList.remove('focus-mode'); window.scrollTo({top:Math.max(0,lastScrollYBeforeFocus),behavior:'smooth'}); ctrlNavState='dashboard'; }
    const isEditing=t=> t && (t.tagName==='INPUT' || t.tagName==='TEXTAREA' || t.isContentEditable);
    document.addEventListener('keydown',e=>{
      if((e.key==='h'||e.key==='H') && !isEditing(e.target)){ e.preventDefault(); el.hintBtn?.click(); return; }
      if(e.ctrlKey && !e.altKey && !e.metaKey){
        if(e.key==='ArrowLeft'){ e.preventDefault(); el.prevBtn?.click(); return; }
        if(e.key==='ArrowRight'){ e.preventDefault(); el.nextBtn?.click(); return; }
        if(e.key==='['){ e.preventDefault(); if(ctrlNavState==='focus') backFromFocus(); else window.scrollTo({top:0,behavior:'smooth'}); return; }
        if(e.key===']'){ e.preventDefault(); if(ctrlNavState!=='focus') enterFocusMode(); else exitToDashboard(); return; }
      }
    });

    const getScopeFilteredData=()=> filterByChapterSelection(applySourceFilter(allData||[]));

    function renderCalendarMonth() {
      const grid = el.calendarGrid, title = el.calTitle; if (!grid || !title) return;
      title.textContent = `${calRefDate.getFullYear()}.${String(calRefDate.getMonth()+1).padStart(2,'0')}`;
      const base = getScopeFilteredData(); const idSet = new Set(base.map(q => String(q.고유ID).trim()));
      const counts = new Map();
      for (const [qid, rec] of Object.entries(questionScores || {})) {
        if (!idSet.has(qid)) continue;
        const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
        for (const h of hist) {
          const t = Number(h?.date); if (!Number.isFinite(t)) continue;
          const d = new Date(t); d.setHours(0,0,0,0);
          const k = ymd(d);
          counts.set(k, (counts.get(k)||0) + 1);
        }
      }
      const first = new Date(calRefDate); const firstDow = dowMon0(first);
      const start = new Date(first); start.setDate(first.getDate() - firstDow);
      const lastDay = new Date(calRefDate.getFullYear(), calRefDate.getMonth()+1, 0);
      const lastDow = dowMon0(lastDay);
      const end = new Date(lastDay); end.setDate(lastDay.getDate() + (6 - lastDow));

      grid.innerHTML = '';
      for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
        const inMonth = (d.getMonth() === calRefDate.getMonth() && d.getFullYear() === calRefDate.getFullYear());
        const key = ymd(d);
        const c = counts.get(key) || 0;
        const { bg, fg } = colorForCount(c);
        const cell = document.createElement('div');
        cell.className = `cal-cell` + (inMonth ? '' : ' muted');
        cell.title = `${key} · 풀이 ${c}회`;
        cell.style.backgroundColor = bg;
        cell.style.color = fg;
        const day = document.createElement('div');
        day.className = 'cal-day';
        day.textContent = String(d.getDate());
        cell.appendChild(day);
        grid.appendChild(cell);
      }
    }
    el.calPrev?.addEventListener('click', () => { calRefDate.setMonth(calRefDate.getMonth()-1); renderCalendarMonth(); });
    el.calNext?.addEventListener('click', () => { calRefDate.setMonth(calRefDate.getMonth()+1); renderCalendarMonth(); });

    function renderStats(){
      if(!el.statsOverview) return;
      const now=new Date(), startOfDay=d=>{const t=new Date(d); t.setHours(0,0,0,0); return t;}, endOfDay=d=>{const t=new Date(d); t.setHours(23,59,59,999); return t;}, startOfWeek=d=>{const t=startOfDay(d); const dow=(t.getDay()+6)%7; t.setDate(t.getDate()-dow); return t;}, startOfMonth=d=>startOfDay(new Date(d.getFullYear(), d.getMonth(),1));
      let title='오늘의 통계', label='오늘', start=startOfDay(now), end=endOfDay(now);
      if(statsView==='week'){ title='주간 통계'; label='주간'; start=startOfWeek(now); }
      if(statsView==='month'){ title='월간 통계'; label='월간'; start=startOfMonth(now); }

      const base=getScopeFilteredData(), idSet=new Set(base.map(q=>String(q.고유ID).trim()));
      let solved=0,sum=0, flagged=0,last=0; const daySet=new Set();
      for(const q of base){
        const id=String(q.고유ID).trim(), rec=questionScores[id];
        if(rec && Number.isFinite(+rec.score)){ solved++; sum+=+rec.score; }
        if(rec?.userReviewFlag) flagged++;
        if(rec?.lastSolvedDate && rec.lastSolvedDate>last) last=rec.lastSolvedDate;
        (Array.isArray(rec?.solveHistory)?rec.solveHistory:[]).forEach(h=>{ const t=+h?.date; if(!Number.isFinite(t)) return; const d=new Date(t); d.setHours(0,0,0,0); daySet.add(ymd(d)); });
      }
      const avgAll=solved?(sum/solved):null;
      const recentTxt= last? ((d=>d===0?'오늘':d===1?'어제':`${d}일 전`)(Math.floor((Date.now()-last)/86400000))):'기록 없음';
      const hasSolved=dayKey=> daySet.has(dayKey);
      let streak=0, cur=new Date(); cur.setHours(0,0,0,0);
      while(hasSolved(ymd(cur))){ streak++; cur.setDate(cur.getDate()-1); }
      const bestKey='bestStreak_v1', best=Math.max(streak, +(localStorage.getItem(bestKey)||0)); if(best>+(localStorage.getItem(bestKey)||0)) localStorage.setItem(bestKey,String(best));

      let periodSolves=0, periodSum=0; const byCh=new Map(), chRec=ch=>{ if(!byCh.has(ch)) byCh.set(ch,{solves:0,sum:0}); return byCh.get(ch); };
      for(const q of base){
        const id=String(q.고유ID).trim(), ch=String(q.단원).trim(), rec=questionScores[id], hist=Array.isArray(rec?.solveHistory)?rec.solveHistory:[];
        for(const h of hist){ const t=+h?.date, sc=+h?.score; if(!Number.isFinite(t)) continue; if(t>=+start && t<=+end){ periodSolves++; if(Number.isFinite(sc)) periodSum+=sc; const slot=chRec(ch); slot.solves++; if(Number.isFinite(sc)) slot.sum+=sc; } }
      }
      const periodAvg=periodSolves? (periodSum/periodSolves):null;
      const weak=[]; byCh.forEach((v,ch)=>{ if(v.solves>=3) weak.push({ch,avg:v.sum/v.solves,cnt:v.solves}); }); weak.sort((a,b)=>a.avg-b.avg); const weakTop=weak.slice(0,3);

      const baseDaily=+(localStorage.getItem('dailyTarget_v1')||20);
      if(!localStorage.getItem('weeklyTarget_v1')) localStorage.setItem('weeklyTarget_v1', String(baseDaily*7));
      if(!localStorage.getItem('monthlyTarget_v1')) localStorage.setItem('monthlyTarget_v1', String(baseDaily*30));
      const targetKey= statsView==='day'?'dailyTarget_v1': statsView==='week'?'weeklyTarget_v1':'monthlyTarget_v1';
      const targetLabel= statsView==='day'?'오늘 목표': statsView==='week'?'이번 주 목표':'이번 달 목표';
      const targetVal= +(localStorage.getItem(targetKey) || (statsView==='day'?baseDaily: (statsView==='week'? baseDaily*7: baseDaily*30)));
      const pct=Math.max(0,Math.min(100,Math.round((periodSolves/Math.max(1,targetVal))*100)));
      const fmt=v=> v==null?'-':(Math.round(v*10)/10).toFixed(1);
      const chip=txt=>`<button data-go-ch="${txt}" class="px-2 py-0.5 text-xs rounded border hover:bg-gray-50">${chapterLabelText(txt)}</button>`;
      const weakHtml= weakTop.length? weakTop.map(w=>`${chip(w.ch)} <span class="text-xs text-red-600 ml-1">${fmt(w.avg)}점·${w.cnt}회</span>`).join('<br>'):'데이터 부족';

      el.statsOverview.innerHTML=`
        <div class="border rounded p-3 relative">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold" id="stats-title">${title}</h3>
            <div class="relative">
              <button id="stats-view-btn" class="flex items-center gap-1 text-sm px-2 py-1 rounded border hover:bg-gray-50"><span id="stats-view-label">${label}</span><span id="stats-caret" class="inline-block transition-transform">▼</span></button>
              <div id="stats-view-menu" class="hidden absolute right-0 mt-1 w-28 bg-white dark:bg-gray-900 border rounded shadow-md overflow-hidden z-10">
                <button data-view="day" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">오늘</button>
                <button data-view="week" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">주간</button>
                <button data-view="month" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">월간</button>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">기간 풀이</div><div class="text-lg font-semibold">${periodSolves} 개</div></div>
            <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">기간 평균</div><div class="text-lg font-semibold">${fmt(periodAvg)} 점</div></div>
            <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">스트릭</div><div class="text-lg font-semibold">${streak} 일 <span class="text-xs text-gray-500">(최고 ${best}일)</span></div></div>
            <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">스코프 평균</div><div class="text-lg font-semibold">${fmt(avgAll)} 점</div></div>
          </div>

          <div class="mt-3">
            <div class="flex items-center justify-between"><div class="text-[12px] text-gray-500">${targetLabel} ${targetVal}개</div><div class="text-[12px] text-gray-500">${pct}%</div></div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div class="h-2 ${pct<60?'bg-red-500':(pct<100?'bg-yellow-500':'bg-green-600')}" style="width:${pct}%"></div></div>
            <div class="flex items-center gap-2 mt-2">
              <label for="stats-target-input" class="text-xs text-gray-500">목표:</label>
              <input id="stats-target-input" type="number" min="1" class="w-20 px-2 py-1 text-xs border rounded" value="${targetVal}">
              <button id="apply-stats-target" class="text-xs px-2 py-1 border rounded hover:bg-gray-50">적용</button>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-3 mt-3">
            <div class="p-2 rounded border">
              <div class="text-[12px] text-gray-500 mb-1">약한 단원 Top 3 <span class="text-[11px] text-gray-400">(기간 기준)</span></div>
              <div class="text-sm leading-5">${weakHtml}</div>
            </div>
          </div>

          <div class="text-[12px] text-gray-500 mt-2">최근 학습: <strong class="text-gray-700">${recentTxt}</strong> · 복습 필요(★): <strong class="text-gray-700">${flagged}</strong></div>
        </div>`;

      const btn=$('stats-view-btn'), caret=$('stats-caret'), menu=$('stats-view-menu');
      const openMenu=()=>{ menu.classList.remove('hidden'); caret.style.transform='rotate(180deg)'; };
      const closeMenu=()=>{ menu.classList.add('hidden'); caret.style.transform='rotate(0deg)'; };
      btn?.addEventListener('click',e=>{ e.stopPropagation(); if(menu.classList.contains('hidden')) openMenu(); else closeMenu(); });
      document.addEventListener('click', closeMenu, {once:true});
      menu?.querySelectorAll('[data-view]')?.forEach(i=> i.addEventListener('click',()=>{ const v=i.getAttribute('data-view'); statsView=v; localStorage.setItem('statsView_v1',v); renderStats(); }) );
      $('apply-stats-target')?.addEventListener('click',()=>{ const v=Math.max(1,Math.min(9999,Math.round(+($('stats-target-input')?.value||1)))); localStorage.setItem(targetKey,String(v)); renderStats(); });
      el.statsOverview.querySelectorAll('[data-go-ch]')?.forEach(b=> b.addEventListener('click',()=>{ const ch=b.getAttribute('data-go-ch')||''; if(ch){ el.chapterSelect.value=ch; reloadAndRefresh(); showToast(`${chapterLabelText(ch)} 로 이동`);} }));
    }

    function renderExplorer(){
      if(!el.explorerChapters||!el.explorerProblems) return;
      const base=getScopeFilteredData(), group=new Map();
      for(const q of base){ const ch=String(q.단원).trim(); if(!group.has(ch)) group.set(ch,[]); group.get(ch).push(q); }
      const chapters=[...group.keys()].sort((a,b)=>{ const na=+a, nb=+b; if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; if(Number.isFinite(na)) return -1; if(Number.isFinite(nb)) return 1; return a.localeCompare(b,'ko'); });

      el.explorerChapters.innerHTML='';
      chapters.forEach(ch=>{
        const btn=document.createElement('button'); btn.className='w-full text-left px-3 py-2 rounded border hover:bg-gray-50'; btn.textContent=chapterLabelText(ch);
        btn.addEventListener('click',()=>{
          const list=group.get(ch)||[]; if(list.length){ currentQuizData=list; currentQuestionIndex=0; el.quizArea.classList.remove('hidden'); displayQuestion(); showToast(`${chapterLabelText(ch)} 로 이동`); updateSummaryHighlight(); }
        });
        el.explorerChapters.appendChild(btn);
      });

      const q=(el.explorerSearch?.value||'').trim().toLowerCase();
      const filtered=base.filter(it=> (it.problemTitle||'').toLowerCase().includes(q) || (it.물음||'').toLowerCase().includes(q) );
      el.explorerProblems.innerHTML='';
      filtered.sort((a,b)=>{ const na=+(a.물음번호||a.표시번호), nb=+(b.물음번호||b.표시번호); if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; return String(a.표시번호||a.물음번호).localeCompare(String(b.표시번호||b.물음번호),'ko'); })
      .forEach(it=>{
        const rec=questionScores[String(it.고유ID).trim()], score= Number.isFinite(+rec?.score)? +rec.score : null;
        const flagged=!!(rec?.userReviewFlag);
        const excluded=!!(rec?.userReviewExclude);

        const row=document.createElement('button'); row.className='w-full flex items-center justify-between gap-2 px-3 py-1.5 rounded hover:bg-gray-50 border';

        const left=document.createElement('div'); left.className='flex items-center gap-2 text-sm';
        if(flagged){ const star=document.createElement('span'); star.textContent='★'; star.className='text-purple-500'; left.appendChild(star); }
        if(excluded){ const minus=document.createElement('span'); minus.textContent='➖'; minus.className='text-gray-500'; left.appendChild(minus); }

        const title=document.createElement('span'); const label=(it.problemTitle && String(it.problemTitle).trim())||`문항 ${it.표시번호||it.물음번호||it.고유ID}`;
        title.textContent=label; title.className='block max-w-[18rem] xl:max-w-[22rem] truncate'; left.appendChild(title);

        const right=document.createElement('div'); right.className='text-xs'; const badge=document.createElement('span'); badge.className='px-2 py-0.5 rounded-full border '+(score==null?'text-gray-600 border-gray-300':'text-blue-700 border-blue-300'); badge.textContent= score==null?'X':`${score}`; right.appendChild(badge);

        row.appendChild(left); row.appendChild(right); row.title=`출처:${it.출처||'-'} | ID:${it.고유ID}`;
        row.addEventListener('click',()=>{
          const ch=String(it.단원).trim(), list=base.filter(x=>String(x.단원).trim()===ch);
          currentQuizData=list.length?list:[it]; currentQuestionIndex=list.findIndex(x=>String(x.고유ID).trim()===String(it.고유ID).trim()); if(currentQuestionIndex<0) currentQuestionIndex=0;
          el.quizArea.classList.remove('hidden'); displayQuestion(); showToast(`'${label}' 로 이동`);
        });
        el.explorerProblems.appendChild(row);
      });
    }
    const moveSourceFilterToSide=()=>{ if(!el.sourceFilterSide||!el.sourceGroupFilter) return; el.sourceFilterSide.innerHTML=''; el.sourceGroupFilter.classList.remove('mb-6'); el.sourceFilterSide.appendChild(el.sourceGroupFilter); };
    const refreshPanels=()=>{ renderCalendarMonth(); renderStats(); renderExplorer(); };

    const REVIEW_STRATEGY_LS='reviewStrategy_v1';
    const getReviewStrategy=()=> localStorage.getItem(REVIEW_STRATEGY_LS)||'smart';
    function prioritizeTodayReview(list){
      // 제외 토글 선제 제거 (중복 안전장치)
      list = (list||[]).filter(a => !questionScores[normId(a.고유ID)]?.userReviewExclude);

      const strat=getReviewStrategy();
      if(strat==='flag'){ const f=list.filter(a=>questionScores[normId(a.고유ID)]?.userReviewFlag); const r=list.filter(a=>!questionScores[normId(a.고유ID)]?.userReviewFlag); return f.concat(r); }
      if(strat==='low'){ return [...list].sort((a,b)=>{ const sa=questionScores[normId(a.고유ID)]?.score??101, sb=questionScores[normId(b.고유ID)]?.score??101; return sa-sb; }); }
      if(strat==='recentWrong'){ return [...list].sort((a,b)=>{ const sa=questionScores[normId(a.고유ID)], sb=questionScores[normId(b.고유ID)], as=sa?.score??101, bs=sb?.score??101, ad=sa?.lastSolvedDate??0, bd=sb?.lastSolvedDate??0; return (as-bs)||(ad-bd); }); }
      return [...list].sort((a,b)=>{ const sa=questionScores[normId(a.고유ID)], sb=questionScores[normId(b.고유ID)], af=sa?.userReviewFlag?0:1, bf=sb?.userReviewFlag?0:1, aUn=sa?1:0, bUn=sb?1:0, aS=sa?.score??101, bS=sb?.score??101, aD=sa?.lastSolvedDate??0, bD=sb?.lastSolvedDate??0; return (af-bf)||(aUn-bUn)||(aS-bS)||(aD-bD); });
    }
    el.reviewStrategySelect?.addEventListener('change',e=>{ localStorage.setItem(REVIEW_STRATEGY_LS, e.target.value); showToast(`오늘의 복습 전략: ${e.target.value}`); refreshPanels(); });
    (function syncStrategy(){ const cur=getReviewStrategy(); if(el.reviewStrategySelect) el.reviewStrategySelect.value=cur; })();
    el.startReviewBtn?.addEventListener('click',()=>{ if(el.filterSelect) el.filterSelect.value='today-review'; reloadAndRefresh(); showToast('오늘의 복습 시작'); });

    function openDrawer(){ document.body.classList.add('drawer-open'); el.drawerBackdrop.classList.remove('hidden'); el.leftDashboard.classList.remove('hidden'); el.leftDashboard.classList.add('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900','relative'); el.drawerClose.classList.remove('hidden'); }
    function closeDrawer(){ document.body.classList.remove('drawer-open'); el.drawerBackdrop.classList.add('hidden'); el.leftDashboard.classList.add('hidden'); el.leftDashboard.classList.remove('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900','relative'); el.drawerClose.classList.add('hidden'); }
    el.hamburger?.addEventListener('click', openDrawer);
    el.drawerBackdrop?.addEventListener('click', closeDrawer);
    el.drawerClose?.addEventListener('click', closeDrawer);
    window.addEventListener('resize',()=>{
      if(window.innerWidth>=1024){
        el.leftDashboard.classList.remove('hidden'); el.drawerBackdrop.classList.add('hidden'); document.body.classList.remove('drawer-open');
        el.leftDashboard.classList.remove('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900','relative'); el.drawerClose.classList.add('hidden');
      }else{ el.leftDashboard.classList.add('hidden'); }
    });

    document.addEventListener('DOMContentLoaded', async ()=>{
      try{ await loadData(); }catch(err){ console.error(err); $('question-text').textContent='문제 데이터 로드 실패 (questions.json 또는 dataset-json 확인).'; showToast(`문제 데이터 로드 실패: ${err.message}`,'error'); }
      loadScores(); loadApiKey(); loadSettings(); applyDarkMode(); migrateData(); backfillReadStoreFromScores(false); ensureApiKeyGate();
      buildSourceFilterUI(); moveSourceFilterToSide();
      el.explorerSearch?.addEventListener('input', renderExplorer);
      refreshPanels();
    });
  </script>
</body>
</html>

