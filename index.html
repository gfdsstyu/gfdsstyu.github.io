<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="same-origin" />
  <title>ê°ë¦°ì´ - íšŒê³„ê°ì‚¬ í•™ìŠµ ë„ìš°ë¯¸ v3.3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .summary-btn {
      width: 38px; height: 38px;
      font-size: 0.8rem; line-height: 1;
      display: flex; align-items: center; justify-content: center;
      padding: 0 2px; transition: all 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .summary-btn:hover { transform: scale(1.1); }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    #toast { position: fixed; top: 16px; right: 16px; z-index: 9999; }

    /* ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼(ê¸°ì¡´) */
    .dark { background-color: #1a202c; color: #e2e8f0; }
    .dark .bg-white { background-color: #2d3748; }
    .dark .bg-gray-100 { background-color: #1a202c; }
    .dark .bg-gray-50 { background-color: #2d3748; }
    .dark .text-gray-800 { color: #e2e8f0; }
    .dark .text-gray-700 { color: #cbd5e0; }
    .dark .text-gray-600 { color: #a0aec0; }
    .dark .border-gray-200 { border-color: #4a5568; }
    .dark .border-gray-300 { border-color: #4a5568; }
  </style>

  <!-- ë‹¤í¬ëª¨ë“œ ì ‘ê·¼ì„± ë³´ê°• ì „ì—­ CSS -->
  <style id="dark-a11y-20251026">
    html.dark { color-scheme: dark; }
    html.dark input, html.dark textarea, html.dark select {
      background-color: #1f2937; /* gray-800 */
      color: #e5e7eb;            /* gray-200 */
      border-color: #4b5563;     /* gray-600 */
    }
    html.dark ::placeholder { color: #9ca3af; } /* gray-400 */
    html.dark :is(button, a, input, textarea, select):focus-visible {
      outline: 2px solid #60a5fa; /* sky-400 */ outline-offset: 2px;
    }
    /* ì§„í–‰ë°” íŠ¸ë™/ê²°ê³¼/íŒíŠ¸/í˜„í™©íŒ ëŒ€ë¹„ */
    html.dark .progress-track { background-color: #374151; } /* gray-700 */
    html.dark #result-box { background-color: #1f2937; border-color: #374151; */
    }
    html.dark #quiz-area .bg-gray-50 { background-color: #111827; }
    html.dark #quiz-area .border-gray-200 { border-color: #374151; }
    html.dark #hint-container { background-color: #1e3a8a; border-color: #334155; color: #e0e7ff; }
    html.dark #summary-area .border { border-color: #374151; }
    html.dark #summary-area .bg-gray-50 { background-color: #111827; }
    html.dark .summary-btn.bg-gray-100 { background-color:#111827; color:#d1d5db; border-color:#374151; }
    html.dark .summary-btn.bg-red-100   { background-color:#7f1d1d; color:#fecaca; border-color:#991b1b; }
    html.dark .summary-btn.bg-yellow-100{ background-color:#78350f; color:#fde68a; border-color:#92400e; }
    html.dark .summary-btn.bg-green-100 { background-color:#14532d; color:#bbf7d0; border-color:#166534; }
  </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
  <div id="toast" class="hidden"></div>

  <!-- ========== [A] ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” ========== -->
  <header id="fixed-header" class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur border-b border-gray-200 dark:bg-gray-900/80 dark:border-gray-800">
    <div class="mx-auto max-w-4xl px-4 py-2 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-xl font-extrabold tracking-tight text-blue-700 dark:text-blue-400">ê°ë¦°ì´</span>
        <span class="hidden sm:inline text-xs text-gray-500 dark:text-gray-400">íšŒê³„ê°ì‚¬ ì•”ê¸° ë„ìš°ë¯¸ v3.2</span>
      </div>
      <nav class="flex items-center gap-2">
        <a id="help-button" href="README.html" target="_blank" class="hidden sm:inline text-sm text-gray-700 hover:text-blue-700 dark:text-gray-300 dark:hover:text-white">ë„ì›€ë§</a>
        <button id="settings-btn" class="ml-1 inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-haspopup="dialog">
          <span>ì„¤ì •</span><span aria-hidden>âš™ï¸</span>
        </button>
        <button id="hamburger" class="sm:hidden inline-flex items-center justify-center w-9 h-9 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-label="ë©”ë‰´">â‰¡</button>
      </nav>
    </div>
  </header>
  <div class="h-14"></div><!-- ìƒë‹¨ë°” ê³µê°„ í™•ë³´ -->

  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <div class="pt-2 flex-1 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-6 md:p-8">

      <!-- ì˜µì…˜ -->
      <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
        <div class="flex-1 w-full">
          <label for="chapter-select" class="block text-sm font-medium text-gray-700 mb-1">ë‹¨ì› ì„ íƒ</label>
          <select id="chapter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
            <option value="">-- ì „ì²´ ë‹¨ì› --</option>
          </select>
        </div>
        <div class="flex-1 w-full">
          <label for="filter-select" class="block text-sm font-medium text-gray-700 mb-1">ë¬¸ì œ í•„í„°</label>
          <select id="filter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-700 dark:text-gray-100 dark:border-gray-700">
            <option value="all">ëª¨ë“  ë¬¸ì œ í’€ê¸°</option>
            <option value="unanswered">ì•„ì§ ì•ˆ í‘¼ ë¬¸ì œ</option>
            <option value="today-review">ì˜¤ëŠ˜ì˜ ë³µìŠµ (ì¶”ì²œ)</option>
            <option value="80">80ì  ë¯¸ë§Œ ë¬¸ì œ</option>
            <option value="60">60ì  ë¯¸ë§Œ ë¬¸ì œ</option>
          </select>
        </div>
        <div class="w-full md:w-auto md:self-end flex gap-2">
          <button id="load-quiz-btn" class="flex-1 bg-blue-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">í•™ìŠµ ì‹œì‘</button>
          <button id="random-quiz-btn" class="flex-1 bg-purple-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-purple-700 transition duration-200">ëœë¤ ë¬¸ì œ</button>
        </div>
      </div>

      <!-- ë¬¸ì œ ì˜ì—­ -->
      <div id="quiz-area" class="hidden">
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-4">
          <div class="flex justify-between items-center mb-2">
            <h2 id="question-number" class="text-xl font-bold text-blue-700 bg-blue-100 px-3 py-1 rounded-md">ë¬¸í•­</h2>
            <span id="question-counter" class="text-gray-500 font-medium">0 / 0</span>
          </div>
          <!-- DB ë¬¸ì œë²ˆí˜¸(ìŠ¤í…) -->
          <div id="db-question-id" class="text-xs text-gray-500 hidden">ID: -</div>

          <p id="question-text" class="text-gray-800 text-base md:text-lg leading-relaxed mt-2">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>

          <!-- íŒíŠ¸ ë²„íŠ¼ -->
          <div class="mt-3 flex items-center justify-end">
            <button id="hint-btn" class="text-sm bg-purple-600 text-white px-3 py-1.5 rounded-md shadow hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
              íŒíŠ¸
            </button>
          </div>

          <!-- íŒíŠ¸ ë°•ìŠ¤ -->
          <div id="hint-container" class="hidden mt-3 text-sm bg-purple-50 border border-purple-200 text-purple-800 rounded-lg p-3 dark:bg-indigo-900 dark:border-indigo-700 dark:text-indigo-100"></div>
        </div>

        <div class="flex items-center justify-between mb-2">
          <label for="user-answer" class="text-sm font-medium text-gray-700">ë‹µì•ˆ ì…ë ¥</label>
          <button id="load-prev-answer-btn" class="text-xs text-blue-600 hover:underline">ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <textarea id="user-answer" class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition dark:bg-gray-800 dark:text-gray-100 dark:placeholder-gray-400 dark:border-gray-700" rows="8" placeholder="ì—¬ê¸°ì— ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”... (Enter=ì±„ì , Shift+Enter=ì¤„ë°”ê¿ˆ, Ctrl+[=ë§¨ ìœ„, Ctrl+]=ëª¨ë²”ë‹µì•ˆ)"></textarea>
        <p id="error-message" class="text-red-500 text-sm mt-2 hidden">ë‹µì•ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        <!-- ë‹¨ì¶•í‚¤ ê°€ì´ë“œ -->
        <p id="hotkey-guide" class="text-xs text-gray-500 mt-2">
          ë‹¨ì¶•í‚¤: Ctrl+â†/â†’ ì´ì „/ë‹¤ìŒ Â· Enter ì±„ì  Â· Shift+Enter ì¤„ë°”ê¿ˆ Â· H íŒíŠ¸ Â· Ctrl+[ ë§¨ ìœ„ Â· Ctrl+] ëª¨ë²”ë‹µì•ˆ
        </p>

        <div class="flex justify-between items-center my-5">
          <button id="prev-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">ì´ì „</button>
          <button id="grade-btn" class="bg-green-500 text-white font-bold py-2 px-8 rounded-lg shadow-md hover:bg-green-600 transition duration-200 relative min-w-[120px]">
            <span id="grade-btn-text">ì±„ì í•˜ê¸°</span>
            <div id="grade-loader" class="loader absolute inset-0 m-auto hidden" aria-hidden="true"></div>
          </button>
          <button id="next-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">ë‹¤ìŒ</button>
        </div>
      </div>

      <!-- ê²°ê³¼ ì˜ì—­ -->
      <div id="result-box" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-6 mt-6 dark:bg-gray-800 dark:border-gray-700" aria-live="polite">
        <h3 class="text-2xl font-bold text-gray-800 mb-4">ì±„ì  ê²°ê³¼</h3>

        <div id="score-display" class="mb-5">
          <p class="text-lg font-medium text-gray-700">
            ìœ ì‚¬ë„ ì ìˆ˜: <span id="score" class="font-bold text-blue-600 text-2xl">0</span><span class="text-gray-600 text-lg">ì </span>
          </p>
          <div class="w-full bg-gray-200 progress-track rounded-full h-4 mt-2 overflow-hidden shadow-inner">
            <div id="progress-bar" class="h-4 rounded-full transition-all duration-500 ease-out" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="width: 0%"></div>
          </div>
        </div>

        <div class="mb-5">
          <h4 class="text-xl font-semibold text-gray-700 mb-2">ğŸ¤– AI ì´í‰</h4>
          <div id="ai-feedback" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 leading-relaxed min-h-[50px]"></div>
        </div>

        <div>
          <h4 class="text-xl font-semibold text-gray-700 mb-2">ğŸ“˜ ëª¨ë²” ë‹µì•ˆ</h4>
          <pre id="correct-answer" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 text-sm font-sans leading-relaxed"></pre>
        </div>
      </div>

      <!-- í•™ìŠµ í˜„í™©íŒ -->
      <div id="summary-area" class="mt-8 pt-6 border-t hidden">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-3">
          <h3 class="text-xl font-bold text-gray-800">í•™ìŠµ í˜„í™©íŒ (í´ë¦­í•˜ì—¬ ì´ë™)</h3>
          <div class="flex flex-wrap gap-3 items-center">
            <!-- ë³´ê¸° í† ê¸€(ìš”ì•½íŒ ì „ìš©, ë¬¸ì œ í•„í„°ì™€ ë…ë¦½) -->
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-600">ë³´ê¸°:</span>
              <button id="summary-view-all" class="px-3 py-1.5 text-sm border rounded bg-gray-100 hover:bg-gray-200">ëª¨ë“  ë‹¨ì›ë³´ê¸°</button>
              <button id="summary-view-current" class="px-3 py-1.5 text-sm border rounded">í˜„ì¬ í•™ìŠµë‹¨ì›ë³´ê¸°</button>
            </div>
            <div class="flex gap-4">
              <button id="clear-filter-btn" class="text-sm text-blue-700 hover:underline dark:text-blue-300">í•„í„° í•´ì œ</button>
              <button id="reset-scores-btn" class="text-sm text-red-600 hover:underline dark:text-red-300">í•™ìŠµ ê¸°ë¡ ì´ˆê¸°í™”</button>
            </div>
          </div>
        </div>
        <div id="score-summary" class="flex flex-wrap gap-2"></div>
      </div>
    </div>
  </div>

  <!-- ========== API í‚¤ ìµœì´ˆ ì¸ì¦ ëª¨ë‹¬ ========== -->
  <div id="api-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1000]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-xl">
      <h2 class="text-xl font-bold text-gray-800">Gemini API í‚¤ ì¸ì¦</h2>
      <p class="text-sm text-gray-600 mt-1">ìµœì´ˆ 1íšŒë§Œ ì…ë ¥í•©ë‹ˆë‹¤. ë¡œì»¬ ì €ì¥ì„ ì²´í¬í•˜ë©´ ë‹¤ìŒë¶€í„°ëŠ” íŒì—…ì´ ëœ¨ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <p class="text-sm mt-2">ì²˜ìŒ ì‚¬ìš©í•˜ì‹œë‚˜ìš”?
        <a href="README.html" target="_blank" rel="noopener" class="underline text-blue-600 dark:text-blue-300">ë„ì›€ë§(README)</a>ë¥¼ í™•ì¸í•˜ì„¸ìš”.
      </p>

      <label for="api-modal-input" class="block text-sm font-medium text-gray-700 mt-4">ğŸ”‘ API Key</label>
      <input type="password" id="api-modal-input"
             class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-gray-100 dark:placeholder-gray-400 dark:border-gray-700"
             placeholder="Google AI Studio API í‚¤" autocomplete="off" spellcheck="false" inputmode="text" />

      <div class="flex items-center gap-2 mt-2">
        <input type="checkbox" id="modal-remember" class="rounded border-gray-300" />
        <label for="modal-remember" class="text-sm text-gray-700">ì´ ë¸Œë¼ìš°ì €ì— í‚¤ ì €ì¥</label>
      </div>
      <p class="text-xs text-yellow-600 mt-1">âš ï¸ ê³µìš© PCì—ì„œëŠ” ì²´í¬ í•´ì œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</p>

      <div class="mt-5 flex justify-end gap-2">
        <button id="api-cancel-btn" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900">ì·¨ì†Œ</button>
        <button id="api-save-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700">
          ì €ì¥
        </button>
      </div>
    </div>
  </div>

  <!-- ========== [B] ì„¤ì • ëª¨ë‹¬ ========== -->
  <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1001]">
    <div role="dialog" aria-modal="true" aria-labelledby="settings-title" class="bg-white dark:bg-gray-900 dark:text-gray-100 rounded-2xl w-full max-w-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-2">
        <h2 id="settings-title" class="text-2xl font-bold">ì„¤ì • âš™ï¸</h2>
        <button id="settings-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white" aria-label="ë‹«ê¸°">âœ•</button>
      </div>

      <!-- API í‚¤ ì„¤ì • -->
      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">API í‚¤ ì„¤ì •</h3>
        <button id="open-api-key-modal-btn" class="w-full bg-blue-50 border border-blue-300 text-blue-700 font-medium py-2 px-4 rounded-lg hover:bg-blue-100 transition">
          API í‚¤ ë³€ê²½/ì„¤ì •
        </button>
      </div>

      <!-- AI ëª¨ë¸ ì„ íƒ -->
      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">AI ëª¨ë¸ ì„ íƒ</h3>
        <select id="ai-model-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="gemini-2.5-flash">Gemini 2.5 Flash (ê¸°ë³¸)</option>
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (ê²½ëŸ‰)</option>
        </select>
        <p class="text-xs text-gray-500 mt-2">íŒíŠ¸ ë° ì±„ì ì— ì‚¬ìš©ë  AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”.</p>
      </div>

      <!-- ë‹¤í¬ ëª¨ë“œ -->
      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">ë‹¤í¬ ëª¨ë“œ</h3>
        <select id="dark-mode-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="system">ì‹œìŠ¤í…œ ì„¤ì • (ê¸°ë³¸)</option>
          <option value="light">ë¼ì´íŠ¸ ëª¨ë“œ</option>
          <option value="dark">ë‹¤í¬ ëª¨ë“œ</option>
        </select>
      </div>

      <!-- ë°ì´í„° Import/Export -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">ë°ì´í„° ê´€ë¦¬</h3>
        <div class="flex gap-3">
          <button id="export-data-btn" class="flex-1 bg-green-50 border border-green-300 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition">
            ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
          </button>
          <button id="import-data-btn" class="flex-1 bg-yellow-50 border border-yellow-300 text-yellow-700 font-medium py-2 px-4 rounded-lg hover:bg-yellow-100 transition">
            ğŸ“¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          </button>
        </div>
        <input type="file" id="import-file-input" accept=".json" class="hidden" />
        <p class="text-xs text-gray-500 mt-2">í•™ìŠµ ê¸°ë¡ ë° ì„¤ì •ì„ ë°±ì—…í•˜ê±°ë‚˜ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>

      <!-- ë‹«ê¸° ë²„íŠ¼ -->
      <div class="flex justify-end">
        <button id="settings-close-btn-bottom" class="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">
          ë‹«ê¸°
        </button>
      </div>
    </div>
  </div>

  <!-- ========== ë‚´ì¥ ë°ì´í„°(JSON) ========== -->
  <script id="dataset-json" type="application/json">[
    {
      "ê³ ìœ ID": "q_001",
      "í‘œì‹œë²ˆí˜¸": "1",
      "ì¶œì²˜": "",
      "problemTitle": "",
      "ë‹¨ì›": 1,
      "ë¬¼ìŒë²ˆí˜¸": 1,
      "ë¬¼ìŒ": "íšŒê³„ê°ì‚¬ì—ëŠ” ê³ ìœ í•œê³„ê°€ ì¡´ì¬í•˜ë©°, ê°ì‚¬ì¸ì˜ ê²°ë¡ ë„ì¶œê³¼ ì˜ê²¬í‘œëª…ì˜ ê¸°ì´ˆê°€ ë˜ëŠ” ëŒ€ë¶€ë¶„ì˜ ê°ì‚¬ì¦ê±°ëŠ” ê²°ì •ì  ì¦ê±°ì´ê¸° ë³´ë‹¤ëŠ” ì„¤ë“ì  ì¦ê±°ì´ê¸° ë•Œë¬¸ì— íšŒê³„ê°ì‚¬ë¥¼ í†µí•´ ì¬ë¬´ì œí‘œì— ë¶€ì •ì´ ë‚˜ì˜¤ë¥˜ë¡œ ì¸í•œ ì¤‘ìš”í•œ ì™œê³¡í‘œì‹œê°€ ì—†ë‹¤ëŠ” ì ˆëŒ€ì  í™•ì‹ ì€ ì–»ì„ ìˆ˜ì—†ë‹¤. ì´ëŸ¬í•œ íšŒê³„ê°ì‚¬ì˜ ê³ ìœ í•œí•œê³„ì˜ ì›ì¸ì„ ì„¸ê°€ì§€ë§Œ ê¸°ì¬í•˜ì‹œì˜¤.",
      "ì •ë‹µ": "ISA 200-A47 â‘  ì¬ë¬´ë³´ê³ ì˜ ì„±ê²© â‘¡ ê°ì‚¬ì ˆì°¨ì˜ ì„±ê²© â‘¢ í•©ë¦¬ì ì¸ ì‹œê°„ ë‚´ì— í•©ë¦¬ì ì¸ ë¹„ìš©ìœ¼ë¡œ ê°ì‚¬ê°€ ìˆ˜í–‰ë  í•„ìš”ì„±"
    },
    {
      "ê³ ìœ ID": "q_002",
      "í‘œì‹œë²ˆí˜¸": "2",
      "ì¶œì²˜": "",
      "problemTitle": "",
      "ë‹¨ì›": 1,
      "ë¬¼ìŒë²ˆí˜¸": 2,
      "ë¬¼ìŒ": "íšŒê³„ê°ì‚¬ê¸°ì¤€ì€ ê°ì‚¬ë¥¼ ê³„íší•˜ê³  ìˆ˜í–‰í•  ë•Œì¬ë¬´ë³´ê³ ì˜ ì ì‹œì„± ë°íš¨ìµê³¼ ë¹„ìš©ê°„ì˜ ê· í˜•ì„ ê³ ë ¤í•  ê²ƒì„ ê·œì •í•˜ê³  ìˆë‹¤. ë”°ë¼ì„œ ê°ì‚¬ì¸ì€ ë¬´í•œí•œ ì •ë„ì˜ ê°ì‚¬ì ˆì°¨ë¥¼ ìˆ˜í–‰í•¨ìœ¼ë¡œì¨ ì ˆëŒ€ì  í™•ì‹ ì„ ì œê³µí•˜ë ¤ëŠ” ê°ì‚¬ì ˆì°¨ë¥¼ ìˆ˜í–‰í•˜ê¸° ë³´ë‹¤ëŠ” ì¬ë¬´ë³´ê³  ì´ìš©ìë“¤ì˜ ìš”êµ¬ìˆ˜ì¤€ì„ ì¶©ì¡±í•  ìˆ˜ìˆëŠ” ì •ë„ì˜ ê°ì‚¬ì ˆì°¨ë¥¼ ìˆ˜í–‰í•  ìˆ˜ìˆë‹¤. ì´ì™€ ê°™ì´ ê°ì‚¬ì¸ì´ ì¬ë¬´ë³´ê³ ì˜ ì ì‹œì„± ë°íš¨ìµê³¼ ë¹„ìš©ì˜ ê· í˜•ì„ ê³ ë ¤í•˜ì—¬ ì±„íƒí•˜ê³  ìˆëŠ” ê°ì‚¬ì ˆì°¨ì—ëŠ” ì–´ë–¤ ê²ƒì´ ìˆëŠ”ì§€ ì„¸ê°€ì§€ë¥¼ ì„œìˆ í•˜ì‹œì˜¤.",
      "ì •ë‹µ": "ISA 200-A51 â‘  ê°ì‚¬ê°€ íš¨ê³¼ì ìœ¼ë¡œ ìˆ˜í–‰ë  ìˆ˜ìˆë„ë¡ ê³„íší•¨ â‘¡ ë¶€ì •ì´ë‚˜ ì˜¤ë¥˜ë¡œ ì¸í•œ ì¤‘ìš”ì™œê³¡í‘œì‹œìœ„í—˜ì´ í¬í•¨ë  ê²ƒìœ¼ë¡œ ê°€ì¥ ë†’ê²Œ ì˜ˆìƒë˜ëŠ” ë¶„ì•¼ì— ê°ì‚¬ë…¸ë ¥ì„ ì§‘ì¤‘í•˜ê³ , ê·¸ë ‡ì§€ ì•„ë‹ˆí•œ ë‹¤ë¥¸ ë¶„ì•¼ì—ëŠ” ìƒëŒ€ì ìœ¼ë¡œ ì ì€ ë…¸ë ¥ì„ ê¸°ìš¸ì„ â‘¢ ëª¨ì§‘ë‹¨ì˜ ì™œê³¡í‘œì‹œë¥¼ ì¡°ì‚¬í•˜ê¸° ìœ„í•´ í…ŒìŠ¤íŠ¸ë‚˜ ê¸°íƒ€ ìˆ˜ë‹¨ì„ ì‚¬ìš©í•¨"
    },
    {
      "ê³ ìœ ID": "q_003",
      "í‘œì‹œë²ˆí˜¸": "3",
      "ì¶œì²˜": "",
      "problemTitle": "",
      "ë‹¨ì›": 1,
      "ë¬¼ìŒë²ˆí˜¸": 3,
      "ë¬¼ìŒ": "â€¦",
      "ì •ë‹µ": "â€¦"
    }
  ]</script>

  <script type="module">
    /* ----------------------------------------------------
     * ê°ë¦°ì´ v3.x (í´ë¦°, ìŠ¤ëª°íŒ¨ì¹˜ í†µí•©)
     * - ë°ì´í„° ë¡œë”©: questions.json â†’ dataset-json í´ë°±
     * - ìš”ì•½íŒ ë³´ê¸° í† ê¸€(ALL/CURRENT) ì¶”ê°€(ë¬¸ì œ í•„í„°ì™€ ë…ë¦½)
     * - ë‹¨ì¶•í‚¤: Ctrl+â†/â†’, Enter/Shift+Enter, H, Ctrl+[ / Ctrl+]
     * - ì±„ì  í”„ë¡¬í”„íŠ¸: flash ìœ ì§€, flash-liteëŠ” ì—„ê²© ë¬¸êµ¬ ì¶”ê°€
     * ---------------------------------------------------- */

    // ====== ì „ì—­ ìƒíƒœ ======
    let allData = [];
    let currentQuizData = [];
    let currentQuestionIndex = 0;
    let questionScores = {};
    let geminiApiKey = '';
    let activeHintQuestionKey = null;
    let selectedAiModel = 'gemini-2.5-flash';
    let darkMode = 'system';
    let prevLoaded = false;
    let summaryViewMode = 'ALL'; // 'ALL' | 'CURRENT' (ìš”ì•½íŒ ì „ìš©)

    // ====== DOM ìºì‹œ ======
    const el = {
      toast: document.getElementById('toast'),
      apiModal: document.getElementById('api-modal'),
      apiModalInput: document.getElementById('api-modal-input'),
      apiModalRemember: document.getElementById('modal-remember'),
      apiModalSaveBtn: document.getElementById('api-save-btn'),
      apiModalCancelBtn: document.getElementById('api-cancel-btn'),
      settingsBtn: document.getElementById('settings-btn'),
      settingsModal: document.getElementById('settings-modal'),
      settingsCloseBtn: document.getElementById('settings-close-btn'),
      settingsCloseBtnBottom: document.getElementById('settings-close-btn-bottom'),
      openApiKeyModalBtn: document.getElementById('open-api-key-modal-btn'),
      aiModelSelect: document.getElementById('ai-model-select'),
      darkModeSelect: document.getElementById('dark-mode-select'),
      exportDataBtn: document.getElementById('export-data-btn'),
      importDataBtn: document.getElementById('import-data-btn'),
      importFileInput: document.getElementById('import-file-input'),
      chapterSelect: document.getElementById('chapter-select'),
      filterSelect: document.getElementById('filter-select'),
      loadQuizBtn: document.getElementById('load-quiz-btn'),
      randomQuizBtn: document.getElementById('random-quiz-btn'),
      quizArea: document.getElementById('quiz-area'),
      questionNumber: document.getElementById('question-number'),
      questionText: document.getElementById('question-text'),
      questionCounter: document.getElementById('question-counter'),
      userAnswer: document.getElementById('user-answer'),
      errorMessage: document.getElementById('error-message'),
      prevBtn: document.getElementById('prev-btn'),
      nextBtn: document.getElementById('next-btn'),
      gradeBtn: document.getElementById('grade-btn'),
      gradeBtnText: document.getElementById('grade-btn-text'),
      gradeLoader: document.getElementById('grade-loader'),
      hintBtn: document.getElementById('hint-btn'),
      hintBox: document.getElementById('hint-container'),
      loadPrevAnswerBtn: document.getElementById('load-prev-answer-btn'),
      resultBox: document.getElementById('result-box'),
      score: document.getElementById('score'),
      progressBar: document.getElementById('progress-bar'),
      aiFeedback: document.getElementById('ai-feedback'),
      correctAnswer: document.getElementById('correct-answer'),
      summaryArea: document.getElementById('summary-area'),
      scoreSummary: document.getElementById('score-summary'),
      clearFilterBtn: document.getElementById('clear-filter-btn'),
      resetScoresBtn: document.getElementById('reset-scores-btn'),
      summaryViewAllBtn: document.getElementById('summary-view-all'),
      summaryViewCurrentBtn: document.getElementById('summary-view-current'),
      dbQuestionId: document.getElementById('db-question-id')
    };

    // ====== ìœ í‹¸ ======
    const clamp = (v, min, max) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return min;
      return Math.max(min, Math.min(max, n));
    };
    const sanitizeModelText = (t) => {
      let s = (t || '').trim();
      if (s.startsWith('```')) s = s.replace(/^```[\s\S]*?\n/, '').replace(/```$/, '').trim();
      s = s.replace(/^\uFEFF/, '');
      const start = s.indexOf('{'), end = s.lastIndexOf('}');
      if (start !== -1 && end !== -1 && end > start) s = s.slice(start, end + 1);
      return s;
    };
    const normId = (v) => String(v).trim();
    const toNum = (v) => { const n = Number(v); return Number.isFinite(n) ? n : null; };
    function showToast(msg, type = 'info') {
      const base = 'px-4 py-2 rounded shadow text-sm mb-2';
      const color = type === 'error' ? 'bg-red-600 text-white' : type === 'warn' ? 'bg-yellow-500 text-white' : 'bg-gray-900 text-white';
      el.toast.classList.remove('hidden');
      const item = document.createElement('div');
      item.className = `${base} ${color}`;
      item.textContent = msg;
      el.toast.appendChild(item);
      setTimeout(() => { item.remove(); if (!el.toast.hasChildNodes()) el.toast.classList.add('hidden'); }, 3500);
    }

    // ====== ë‹¤í¬ ëª¨ë“œ ======
    function applyDarkMode() {
      const mode = localStorage.getItem('darkMode') || 'system';
      darkMode = mode;
      if (el.darkModeSelect) el.darkModeSelect.value = mode;

      if (mode === 'dark') document.documentElement.classList.add('dark');
      else if (mode === 'light') document.documentElement.classList.remove('dark');
      else {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      }
    }
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (darkMode === 'system') applyDarkMode();
      });
    }

    // ====== ë°ì´í„° ë¡œë”©: questions.json â†’ dataset-json ======
    async function loadData() {
      const CANDIDATES = [
        'questions.json',
        './questions.json',
        './data/questions.json',
        './assets/questions.json'
      ];
      const errs = [];

      for (const path of CANDIDATES) {
        try {
          const res = await fetch(path, { cache: 'no-store' });
          if (!res.ok) { errs.push(`${path}: HTTP ${res.status}`); continue; }

          const arr = await res.json();
          if (!Array.isArray(arr)) { errs.push(`${path}: JSON ìµœìƒìœ„ê°€ ë°°ì—´ ì•„ë‹˜`); continue; }

          const need = ['ê³ ìœ ID','ë‹¨ì›','ë¬¼ìŒ','ì •ë‹µ'];
          const bad = arr.findIndex(r => !r || need.some(k => !(k in r)));
          if (bad !== -1) { errs.push(`${path}: í•„ìˆ˜í‚¤ ëˆ„ë½(index ${bad})`); continue; }

          allData = arr;
          console.info('[questions.json] loaded from', path);
          selfTest();
          populateChapterSelect();
          updateSummary();
          return;
        } catch (e) {
          errs.push(`${path}: ${e.message}`);
        }
      }

      try {
        const node = document.getElementById('dataset-json');
        if (!node) throw new Error('dataset-json ì—†ìŒ');
        const text = (node.textContent || '').trim();
        if (!text) throw new Error('ë‚´ì¥ ë°ì´í„° ë¹„ì–´ ìˆìŒ');
        const parsed = JSON.parse(text);
        if (!Array.isArray(parsed)) throw new Error('ë‚´ì¥ ë°ì´í„° ìµœìƒìœ„ê°€ ë°°ì—´ ì•„ë‹˜');

        allData = parsed;
        console.warn('[questions.json] ëª¨ë“  í›„ë³´ ì‹¤íŒ¨. ë‚´ì¥ ë°ì´í„°ë¡œ í´ë°±í•©ë‹ˆë‹¤.', errs);
        showToast('ì™¸ë¶€ DBë¥¼ ëª» ì½ì–´ ë‚´ì¥ ë°ì´í„°ë¡œ í´ë°±í–ˆìŠµë‹ˆë‹¤(ìì„¸í•œ ì›ì¸ì€ ì½˜ì†”).', 'warn');

        selfTest();
        populateChapterSelect();
        updateSummary();
      } catch (err) {
        console.error('ì§ˆë¬¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ìƒì„¸:', errs, err);
        showToast(`ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ì½˜ì†”ì—ì„œ ì›ì¸ì„ í™•ì¸í•˜ì„¸ìš”.`, 'error');
        const msg = document.getElementById('question-text');
        if (msg) msg.textContent = 'ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (questions.json ë˜ëŠ” dataset-jsonì„ í™•ì¸í•˜ì„¸ìš”).';
      }
    }

    function selfTest() {
      const missing = [];
      allData.forEach((row, i) => {
        if (!(row && 'ê³ ìœ ID' in row && 'ë‹¨ì›' in row && 'ë¬¼ìŒ' in row && 'ì •ë‹µ' in row)) missing.push(i + 1);
      });
      if (missing.length) showToast(`ê²½ê³ : í•„ìˆ˜ í•„ë“œ ëˆ„ë½ ${missing.length}ê°œ`, 'warn');

      const seen = new Set(); const dup = [];
      for (const r of allData) {
        const key = String(r.ê³ ìœ ID).trim();
        if (seen.has(key)) dup.push(key); else seen.add(key);
      }
      if (dup.length) showToast(`ê²½ê³ : ì¤‘ë³µ ê³ ìœ ID ${dup.length}ê°œ ë°œê²¬`, 'warn');

      const uniqChapterCount = new Set(allData.map(r => String(r.ë‹¨ì›).trim())).size;
      if (uniqChapterCount === 0) throw new Error('ë‹¨ì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }

    function populateChapterSelect() {
      while (el.chapterSelect.options.length > 1) el.chapterSelect.remove(1);
      const chapters = [...new Set(allData.map(item => String(item.ë‹¨ì›).trim()))];
      chapters.sort((a, b) => {
        const na = toNum(a), nb = toNum(b);
        if (na !== null && nb !== null) return na - nb;
        if (na !== null) return -1;
        if (nb !== null) return 1;
        return a.localeCompare(b, 'ko');
      });
      chapters.forEach(ch => {
        const opt = document.createElement('option');
        opt.value = ch;
        opt.textContent = Number.isFinite(Number(ch)) ? `ë‹¨ì› ${ch}` : ch;
        el.chapterSelect.appendChild(opt);
      });
    }

    // ====== ë¡œì»¬ ìƒíƒœ ë¡œë”© ======
    function loadScores() {
      const savedScores = localStorage.getItem('auditQuizScores');
      if (savedScores) {
        try { questionScores = JSON.parse(savedScores); }
        catch { questionScores = {}; localStorage.removeItem('auditQuizScores'); }
      }
    }
    function loadApiKey() {
      const savedSession = sessionStorage.getItem('geminiApiKey');
      const savedLocal = localStorage.getItem('geminiApiKey');
      geminiApiKey = savedSession || savedLocal || '';
    }
    function loadSettings() {
      selectedAiModel = localStorage.getItem('aiModel') || 'gemini-2.5-flash';
      if (el.aiModelSelect) el.aiModelSelect.value = selectedAiModel;
    }

    // ====== ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (v3 â†’ v3.x) ======
    function migrateData() {
      const version = localStorage.getItem('schemaVersion');
      if (version === '2') return;

      try {
        const oldScores = localStorage.getItem('auditQuizScores');
        if (!oldScores) {
          localStorage.setItem('schemaVersion', '2');
          return;
        }

        const parsed = JSON.parse(oldScores);
        const newScores = {};
        const mapping = {};
        allData.forEach(q => {
          const disp = String(q.í‘œì‹œë²ˆí˜¸ ?? '').trim();
          const num = String(q.ë¬¼ìŒë²ˆí˜¸ ?? '').trim();
          if (disp) mapping[disp] = q.ê³ ìœ ID;
          if (num) mapping[num] = q.ê³ ìœ ID;
        });

        Object.keys(parsed).forEach(oldKey => {
          const newKey = mapping[oldKey] || oldKey;
          const oldValue = parsed[oldKey] || {};
          const hist = Array.isArray(oldValue.solveHistory) ? oldValue.solveHistory
                      : (oldValue.score != null ? [{ date: Date.now(), score: Number(oldValue.score)||0 }] : []);
          newScores[newKey] = {
            score: Number(oldValue.score ?? 0),
            feedback: String(oldValue.feedback ?? ''),
            user_answer: String(oldValue.user_answer ?? ''),
            hintUsed: Boolean(oldValue.hintUsed ?? false),
            isSolved: Boolean(oldValue.isSolved ?? (oldValue.score != null)),
            lastSolvedDate: Number(oldValue.lastSolvedDate ?? (hist.length ? hist[hist.length-1].date : Date.now())),
            solveHistory: hist
          };
        });

        localStorage.setItem('auditQuizScores', JSON.stringify(newScores));
        localStorage.setItem('schemaVersion', '2');
        questionScores = newScores;
        showToast('ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ (v3 â†’ v3.x)', 'info');
      } catch (err) {
        console.error('ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', err);
        showToast('ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
      }
    }

    // ====== API í‚¤ ëª¨ë‹¬ ======
    function openApiModal(initial = false) {
      if (initial) el.apiModalCancelBtn.classList.add('hidden');
      else el.apiModalCancelBtn.classList.remove('hidden');

      el.apiModal.classList.remove('hidden');
      el.apiModal.classList.add('flex');

      el.apiModalInput.value = geminiApiKey || '';
      el.apiModalRemember.checked = !!localStorage.getItem('geminiApiKey');
      setTimeout(() => el.apiModalInput.focus(), 0);
    }
    function closeApiModal() {
      el.apiModal.classList.add('hidden');
      el.apiModal.classList.remove('flex');
    }
    function ensureApiKeyGate() {
      if (geminiApiKey) return;
      openApiModal(true);
    }
    el.apiModalSaveBtn.addEventListener('click', () => {
      const key = (el.apiModalInput.value || '').trim();
      if (!key) { showToast('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error'); el.apiModalInput.focus(); return; }
      geminiApiKey = key;
      sessionStorage.setItem('geminiApiKey', key);
      if (el.apiModalRemember.checked) localStorage.setItem('geminiApiKey', key);
      else localStorage.removeItem('geminiApiKey');
      closeApiModal();
      showToast('API í‚¤ ì €ì¥ ì™„ë£Œ');
    });
    el.apiModalCancelBtn.addEventListener('click', () => closeApiModal());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !el.apiModalCancelBtn.classList.contains('hidden')) {
        if (!el.apiModal.classList.contains('hidden')) closeApiModal();
      }
      if (e.key === 'Escape' && !el.settingsModal.classList.contains('hidden')) {
        closeSettingsModal();
      }
    });

    // ====== ì„¤ì • ëª¨ë‹¬ ======
    function openSettingsModal() {
      el.settingsModal.classList.remove('hidden');
      el.settingsModal.classList.add('flex');
      if (el.aiModelSelect) el.aiModelSelect.value = selectedAiModel;
      if (el.darkModeSelect) el.darkModeSelect.value = darkMode;
    }
    function closeSettingsModal() {
      el.settingsModal.classList.add('hidden');
      el.settingsModal.classList.remove('flex');
    }
    el.settingsBtn.addEventListener('click', openSettingsModal);
    el.settingsCloseBtn.addEventListener('click', closeSettingsModal);
    el.settingsCloseBtnBottom.addEventListener('click', closeSettingsModal);
    el.openApiKeyModalBtn?.addEventListener('click', () => {
      closeSettingsModal();
      openApiModal(false);
    });

    // AI ëª¨ë¸ ì„ íƒ
    el.aiModelSelect?.addEventListener('change', (e) => {
      selectedAiModel = e.target.value;
      localStorage.setItem('aiModel', selectedAiModel);
      showToast(`AI ëª¨ë¸ ë³€ê²½: ${selectedAiModel}`);
    });

    // ë‹¤í¬ ëª¨ë“œ ì„ íƒ
    el.darkModeSelect?.addEventListener('change', (e) => {
      localStorage.setItem('darkMode', e.target.value);
      applyDarkMode();
      showToast('ë‹¤í¬ ëª¨ë“œ ì„¤ì • ë³€ê²½ë¨');
    });

    // ====== Import/Export ======
    el.exportDataBtn?.addEventListener('click', () => {
      try {
        const data = {
          version: '3.x',
          schemaVersion: Number(localStorage.getItem('schemaVersion') || 2),
          exportDate: new Date().toISOString(),
          auditQuizScores: questionScores,
          geminiApiKey: localStorage.getItem('geminiApiKey') || '',
          aiModel: selectedAiModel,
          darkMode: darkMode
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gamlini_backup_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
      } catch (err) {
        console.error(err);
        showToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨', 'error');
      }
    });
    el.importDataBtn?.addEventListener('click', () => el.importFileInput.click());
    el.importFileInput?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          if (!data.auditQuizScores) throw new Error('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
          if (data.auditQuizScores) {
            localStorage.setItem('auditQuizScores', JSON.stringify(data.auditQuizScores));
            questionScores = data.auditQuizScores;
          }
          if (data.geminiApiKey) {
            localStorage.setItem('geminiApiKey', data.geminiApiKey);
            geminiApiKey = data.geminiApiKey;
          }
          if (data.aiModel) {
            localStorage.setItem('aiModel', data.aiModel);
            selectedAiModel = data.aiModel;
            el.aiModelSelect.value = data.aiModel;
          }
          if (data.darkMode) {
            localStorage.setItem('darkMode', data.darkMode);
            darkMode = data.darkMode;
            applyDarkMode();
          }
          if (data.schemaVersion) {
            localStorage.setItem('schemaVersion', String(data.schemaVersion));
          }
          showToast('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');
          setTimeout(() => location.reload(), 800);
        } catch (err) {
          console.error(err);
          showToast(`ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`, 'error');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    // ====== í•„í„° ë° í•™ìŠµ ì‹œì‘ ======
    el.chapterSelect.addEventListener('change', handleLoadQuiz);
    el.filterSelect.addEventListener('change', handleLoadQuiz);
    el.loadQuizBtn.addEventListener('click', handleLoadQuiz);

    // ëœë¤ ë¬¸ì œ ë²„íŠ¼
    el.randomQuizBtn.addEventListener('click', () => {
      const selectedChapter = el.chapterSelect.value;
      const selectedFilter = el.filterSelect.value;

      let filtered = allData;
      if (selectedChapter) {
        filtered = allData.filter(q => String(q.ë‹¨ì›).trim() === String(selectedChapter));
      }

      filtered = filtered.filter(q => {
        const key = normId(q.ê³ ìœ ID);
        const saved = questionScores[key];
        if (selectedFilter === 'unanswered') return !saved;
        if (selectedFilter === '80') return !saved || Number(saved.score) < 80;
        if (selectedFilter === '60') return !saved || Number(saved.score) < 60;
        if (selectedFilter === 'today-review') {
          if (!saved) return true;
          return Number(saved.score) < 60 || (saved.lastSolvedDate && (Date.now() - saved.lastSolvedDate > 7 * 24 * 60 * 60 * 1000));
        }
        return true;
      });

      if (filtered.length === 0) {
        showToast('ì„ íƒí•œ ì¡°ê±´ì— ë§ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.', 'warn');
        return;
      }

      currentQuizData = filtered;
      currentQuestionIndex = Math.floor(Math.random() * filtered.length);
      el.quizArea.classList.remove('hidden');
      el.summaryArea.classList.remove('hidden');
      displayQuestion();
      updateSummary();
      showToast('ëœë¤ ë¬¸ì œ ì‹œì‘!');
    });

    function handleLoadQuiz() {
      const selectedChapter = el.chapterSelect.value;
      const selectedFilter = el.filterSelect.value;

      let filtered = allData;
      if (selectedChapter) {
        filtered = allData.filter(q => String(q.ë‹¨ì›).trim() === String(selectedChapter));
      }

      filtered = filtered.filter(q => {
        const key = normId(q.ê³ ìœ ID);
        const saved = questionScores[key];
        if (selectedFilter === 'unanswered') return !saved;
        if (selectedFilter === '80') return !saved || Number(saved.score) < 80;
        if (selectedFilter === '60') return !saved || Number(saved.score) < 60;
        if (selectedFilter === 'today-review') {
          if (!saved) return true;
          return Number(saved.score) < 60 || (saved.lastSolvedDate && (Date.now() - saved.lastSolvedDate > 7 * 24 * 60 * 60 * 1000));
        }
        return true;
      });

      if (selectedFilter === 'today-review') {
        filtered.sort((a, b) => {
          const aScore = questionScores[normId(a.ê³ ìœ ID)]?.score ?? 101;
          const bScore = questionScores[normId(b.ê³ ìœ ID)]?.score ?? 101;
          const aDate = questionScores[normId(a.ê³ ìœ ID)]?.lastSolvedDate ?? 0;
          const bDate = questionScores[normId(b.ê³ ìœ ID)]?.lastSolvedDate ?? 0;
          if (aScore !== bScore) return aScore - bScore;
          return aDate - bDate;
        });
        filtered = filtered.slice(0, 10);
      }

      currentQuizData = filtered;
      currentQuestionIndex = 0;

      if (currentQuizData.length > 0) {
        el.quizArea.classList.remove('hidden');
        el.summaryArea.classList.remove('hidden');
        displayQuestion();
      } else {
        el.quizArea.classList.add('hidden');
        el.summaryArea.classList.remove('hidden');
        showToast('ì„ íƒí•œ ì¡°ê±´ì— ë§ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.', 'warn');
      }
      updateSummary();
    }

    // ====== ë¬¸ì œ í‘œì‹œ ======
    function displayQuestion() {
      if (currentQuizData.length === 0) { el.quizArea.classList.add('hidden'); return; }
      el.quizArea.classList.remove('hidden');
      const q = currentQuizData[currentQuestionIndex];
      el.questionNumber.textContent = `ë¬¸í•­ ${q.í‘œì‹œë²ˆí˜¸ || q.ë¬¼ìŒë²ˆí˜¸ || q.ê³ ìœ ID}`;
      el.questionText.textContent = q.ë¬¼ìŒ;
      el.questionCounter.textContent = `${currentQuestionIndex + 1} / ${currentQuizData.length}`;
      // DB ë¬¸ì œë²ˆí˜¸(ìŠ¤í… ì—…ë°ì´íŠ¸, ê¸°ë³¸ ìˆ¨ê¹€ ìœ ì§€)
      if (el.dbQuestionId) {
        el.dbQuestionId.textContent = `ID: ${q.ê³ ìœ ID ?? '-'}`;
        // el.dbQuestionId.classList.remove('hidden'); // í•„ìš” ì‹œ ë…¸ì¶œ
      }

      // íŒíŠ¸ ìë™ í•´ì œ
      activeHintQuestionKey = null;
      el.hintBox.classList.add('hidden');
      el.hintBox.innerHTML = '';

      el.resultBox.classList.add('hidden');
      el.userAnswer.value = ''; // í•­ìƒ ì´ˆê¸°í™”

      // ì´ì „ë‹µì•ˆ í† ê¸€ ì´ˆê¸°í™”
      if (el.loadPrevAnswerBtn) {
        el.loadPrevAnswerBtn.textContent = 'ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°';
        el.loadPrevAnswerBtn.removeAttribute('aria-pressed');
        prevLoaded = false;
      }

      const saved = questionScores[normId(q.ê³ ìœ ID)];
      if (saved && saved.score !== undefined) {
        showResult(saved.score, saved.feedback, q.ì •ë‹µ);
      }

      el.prevBtn.disabled = currentQuestionIndex === 0;
      el.nextBtn.disabled = currentQuizData.length - 1 === currentQuestionIndex;

      updateSummaryHighlight();
    }

    // ====== ì´ì „ ë‹µì•ˆ í† ê¸€ ======
    el.loadPrevAnswerBtn.addEventListener('click', () => {
      if (currentQuizData.length === 0) return;
      const q = currentQuizData[currentQuestionIndex];
      const saved = questionScores[normId(q.ê³ ìœ ID)];
      if (!prevLoaded) {
        if (saved && saved.user_answer) {
          el.userAnswer.value = saved.user_answer;
          el.loadPrevAnswerBtn.textContent = 'ë‹µì•ˆ ì§€ìš°ê¸°';
          el.loadPrevAnswerBtn.setAttribute('aria-pressed', 'true');
          prevLoaded = true;
          showToast('ì´ì „ ë‹µì•ˆì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } else {
          showToast('ì €ì¥ëœ ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤.', 'warn');
        }
      } else {
        el.userAnswer.value = '';
        el.loadPrevAnswerBtn.textContent = 'ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°';
        el.loadPrevAnswerBtn.setAttribute('aria-pressed', 'false');
        prevLoaded = false;
      }
    });

    // ====== ë„¤ë¹„ê²Œì´ì…˜ ======
    el.prevBtn.addEventListener('click', () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
      }
    });
    el.nextBtn.addEventListener('click', () => {
      if (currentQuestionIndex < currentQuizData.length - 1) {
        currentQuestionIndex++;
        displayQuestion();
      }
    });
    el.userAnswer.addEventListener('input', () => el.errorMessage.classList.add('hidden'));

    // ====== ì±„ì  ======
    el.gradeBtn.addEventListener('click', handleGrade);

    async function handleGrade() {
      if (!geminiApiKey) {
        openApiModal(false);
        showToast('Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      const answer = el.userAnswer.value.trim();
      if (!answer) {
        el.errorMessage.textContent = 'ë‹µì•ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        el.errorMessage.classList.remove('hidden');
        el.userAnswer.focus();
        return;
      }
      el.errorMessage.classList.add('hidden');

      const q = currentQuizData[currentQuestionIndex];
      const qKey = normId(q.ê³ ìœ ID);

      setLoading(true);
      try {
        const result = await callGeminiAPI(answer, q.ì •ë‹µ, geminiApiKey);
        let finalScore = result.score;
        let finalFeedback = result.feedback;

        if (activeHintQuestionKey === qKey) {
          finalScore = Math.min(59, Math.max(0, Math.round(finalScore * 0.8)));
          finalFeedback = `${finalFeedback ? finalFeedback + ' ' : ''}(íŒíŠ¸ì‚¬ìš©ìœ¼ë¡œ ê°ì ì…ë‹ˆë‹¤)`;
        }

        showResult(finalScore, finalFeedback, q.ì •ë‹µ);

        const existing = questionScores[qKey] || {};
        const newHistory = [...(existing.solveHistory || [])];
        newHistory.push({ date: Date.now(), score: finalScore });

        questionScores[qKey] = {
          score: finalScore,
          feedback: finalFeedback,
          user_answer: answer,
          hintUsed: activeHintQuestionKey === qKey,
          isSolved: true,
          lastSolvedDate: Date.now(),
          solveHistory: newHistory
        };

        try { localStorage.setItem('auditQuizScores', JSON.stringify(questionScores)); } catch (e) {
          showToast('localStorage ì €ì¥ ì‹¤íŒ¨ (ìš©ëŸ‰ ì´ˆê³¼ ê°€ëŠ¥)', 'error');
        }

        updateSummary();
      } catch (e) {
        console.error('ì±„ì  ì˜¤ë¥˜:', e);
        el.aiFeedback.textContent = `ì±„ì  ì¤‘ ì˜¤ë¥˜: ${e.message}`;
        el.score.textContent = 'Error';
        el.progressBar.style.width = '0%';
        el.resultBox.classList.remove('hidden');
        showToast('ì±„ì  ìš”ì²­ ì‹¤íŒ¨: API í‚¤/ë„¤íŠ¸ì›Œí¬/í• ë‹¹ëŸ‰ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
      } finally {
        setLoading(false);
      }
    }

    function setLoading(isLoading) {
      if (isLoading) {
        el.gradeBtnText.classList.add('hidden');
        el.gradeLoader.classList.remove('hidden');
        el.gradeBtn.disabled = true;
        el.resultBox.classList.add('hidden');
      } else {
        el.gradeBtnText.classList.remove('hidden');
        el.gradeLoader.classList.add('hidden');
        el.gradeBtn.disabled = false;
      }
    }

    // ====== Gemini API: ì±„ì  (flash=ê¸°ì¡´, flash-lite=ì—„ê²© ì¶”ê°€) ======
    async function callGeminiAPI(userAnswer, correctAnswer, apiKey, retries = 2, delay = 1000) {
      const modelMap = {
        'gemini-2.5-flash': 'gemini-2.5-flash',
        'gemini-2.5-flash-lite': 'gemini-2.5-flash-lite'
      };
      const model = modelMap[selectedAiModel] || 'gemini-2.5-flash';
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;

      const generationConfig = {
        responseMimeType: 'application/json',
        responseSchema: {
          type: 'OBJECT',
          properties: {
            score: { type: 'NUMBER', description: '0~100 ìœ ì‚¬ë„ ì ìˆ˜' },
            feedback: { type: 'STRING', description: 'ê°„ê²°í•˜ê³  ë‚ ì¹´ë¡œìš´ í•œêµ­ì–´ í”¼ë“œë°±' }
          },
          required: ['score', 'feedback']
        }
      };

      // â˜… ê¸°ì¡´ í”„ë¡¬í”„íŠ¸(Flash)ëŠ” ê·¸ëŒ€ë¡œ. LiteëŠ” 'ì—„ê²© ëª¨ë“œ ì§€ì¹¨'ë§Œ ì¶”ê°€ë¡œ ë¶™ì„.
      const BASE_SYSTEM_PROMPT =
`ë‹¹ì‹ ì€ ë§¤ìš° ì—„ê²©í•œ íšŒê³„ê°ì‚¬ ê³¼ëª© ì±„ì  êµìˆ˜ë‹˜ì…ë‹ˆë‹¤.
- ì‚¬ìš©ì ë‹µì•ˆì„ ëª¨ë²”ë‹µì•ˆê³¼ ë¹„êµí•´ 0~100ì˜ "score"(NUMBER)ì™€ "feedback"(STRING, í•œêµ­ì–´)ì„ JSONìœ¼ë¡œë§Œ ë°˜í™˜í•˜ì„¸ìš”.
- ì±„ì  ê¸°ì¤€ì„ ë§¤ìš° ì—„ê²©í•˜ê²Œ(strictly) ì ìš©í•©ë‹ˆë‹¤.
- ëŒ€ì‹  ë„ì–´ì“°ê¸°ë‚˜ ë§ì¶¤ë²• ì‹¤ìˆ˜ ê°™ì€ ë‹¨ìˆœí•œ íƒ€ì´í•‘ì‹¤ìˆ˜ëŠ” ë´ì¤ë‹ˆë‹¤. ë˜í•œ ì¤‘ìš”ì™œê³¡í‘œì‹œìœ„í—˜ì„ RMMìœ¼ë¡œ, ì„±ê²©Â·ì‹œê¸°Â·ë²”ìœ„ë¥¼ ì„±ì‹œë²”ìœ¼ë¡œ, ê³µì¸íšŒê³„ì‚¬ë¥¼ CPAë¡œ ì¤„ì—¬ì“°ëŠ” ì •ë„ì˜ ìˆ˜í—˜ìƒ í•©ì˜ëœ ì–¸ì–´ëŠ” ë´ì¤ë‹ˆë‹¤.

[ì±„ì  ê¸°ì¤€]
1. ëª¨ë²” ë‹µì•ˆì˜ í•µì‹¬ í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€
2. í•µì‹¬ í‚¤ì›Œë“œ ëŒ€ë¶€ë¶„ ëˆ„ë½: 50ì  ë¯¸ë§Œ
3. ì¼ë¶€ í¬í•¨ì´ë‚˜ ì„¤ëª… ë¶€ì •í™•: 50~80ì 
4. ëª¨ë“  í•µì‹¬ í‚¤ì›Œë“œ + ì˜ë„ ì¼ì¹˜: 80ì  ì´ìƒ
5. ì¡°ì‚¬ê¹Œì§€ ë™ì¼í•  ë•Œë§Œ 100ì 
6. í‚¤ì›Œë“œëŠ” ëª¨ë²”ë‹µì•ˆì—ì„œ ìŠ¤ìŠ¤ë¡œ ì¶”ì¶œí•˜ë˜, í•œêµ­ íšŒê³„ê°ì‚¬ ê¸°ì¤€Â·ê·œì •(ISA, KSA, ì™¸ë¶€ê°ì‚¬ë²•, ìœ¤ë¦¬ê¸°ì¤€)ì— ë§ëŠ” ë™ì˜ì–´Â·í‘œí˜„ ë³€í˜•ì„ í—ˆìš©
7. ë¬¼ìŒì—ì„œì˜ ë¬¼ìŒ ë¶€ë¶„ì´ êµ³ì´ ë‹µë³€ì— í¬í•¨ë˜ì§€ ì•Šì•„ë„ ë¨

- ë¶ˆí•„ìš”í•œ ë§/ì½”ë“œë¸”ë¡ ê¸ˆì§€. JSON ê°ì²´ë§Œ ë°˜í™˜.`;

      const LITE_STRICT_ADDENDUM =
`[ì—„ê²© ëª¨ë“œ ì§€ì¹¨(ë¼ì´íŠ¸ ì „ìš©)]
- ëª¨í˜¸/ì¶”ì •/í™•ì¥ ì„œìˆ ì€ ê°ì .
- ë™ì˜ì–´ ì¸ì • ë²”ìœ„ë¥¼ ì¢ê²Œ ì ìš©(ëª…ì‹œì  ì¼ì¹˜ ìš°ì„ ).
- í•„ìˆ˜ í‚¤ì›Œë“œê°€ ë¬¸ì¥ ë‚´ ëª…ì‹œì ìœ¼ë¡œ ì—†ìœ¼ë©´ í° ê°ì .
- ë ˆí¼ëŸ°ìŠ¤ ë°– ì£¼ì¥ì€ ê·¼ê±° ì—†ìœ¼ë©´ ê°ì .`;

      const systemText = model.includes('flash-lite')
        ? `${BASE_SYSTEM_PROMPT}\n\n${LITE_STRICT_ADDENDUM}`
        : BASE_SYSTEM_PROMPT;

      const systemInstruction = { parts: [{ text: systemText }] };

      const userQuery = `[ëª¨ë²” ë‹µì•ˆ]
${correctAnswer}

[ì‚¬ìš©ì ë‹µì•ˆ]
${userAnswer}

[ì±„ì  ìš”ì²­]
JSONìœ¼ë¡œ { "score": number, "feedback": string }ë§Œ ë°˜í™˜`;

      const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction, generationConfig };

      try {
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          const msg = body?.error?.message || res.statusText;
          if ((res.status === 404 || res.status === 400) && /model/i.test(msg)) throw new Error(`ëª¨ë¸/ë²„ì „ ë¶ˆì¼ì¹˜: ${msg}`);
          if (res.status === 429) throw new Error(`API í• ë‹¹ëŸ‰ ì´ˆê³¼ (429)`);
          if (res.status >= 500) throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${res.status})`);
          throw new Error(msg);
        }
        const data = await res.json();
        const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text ?? '';
        const cleaned = sanitizeModelText(raw);
        let parsed;
        try { parsed = JSON.parse(cleaned); }
        catch { throw new Error(`API ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨`); }
        const scoreNum = clamp(Number(parsed.score), 0, 100);
        const feedbackStr = String(parsed.feedback || '').trim();
        return { score: scoreNum, feedback: feedbackStr || 'í”¼ë“œë°± ì—†ìŒ' };
      } catch (err) {
        if (retries > 0 && (String(err.message).includes('429') || String(err.message).match(/^ì„œë²„ ì˜¤ë¥˜/))) {
          await new Promise(r => setTimeout(r, delay));
          return callGeminiAPI(userAnswer, correctAnswer, apiKey, retries - 1, delay * 2);
        }
        throw err;
      }
    }

    // ====== íŒíŠ¸ ======
    el.hintBtn.addEventListener('click', () => {
      if (currentQuizData.length === 0) return;
      handleHint(currentQuizData[currentQuestionIndex]);
    });

    async function handleHint(q) {
      if (!geminiApiKey) {
        openApiModal(false);
        showToast('Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      const userAns = el.userAnswer.value.trim();
      const qKey = normId(q.ê³ ìœ ID);

      setLoading(true);
      try {
        const hint = await callGeminiHintAPI(userAns, q.ì •ë‹µ, q.ë¬¼ìŒ, geminiApiKey);
        el.hintBox.innerHTML = `<strong class="font-semibold">íŒíŠ¸</strong><br>${String(hint || '').replace(/\n/g, '<br>')}`;
        el.hintBox.classList.remove('hidden');
        activeHintQuestionKey = qKey;
        showToast('íŒíŠ¸ë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤. (ì´ ë¬¸í•­ì—ì„œ ì¦‰ì‹œ ì±„ì  ì‹œ ê°ì )', 'warn');
      } catch (e) {
        console.error(e);
        showToast(`íŒíŠ¸ ìƒì„± ì‹¤íŒ¨: ${e.message}`, 'error');
      } finally {
        setLoading(false);
      }
    }

    async function callGeminiHintAPI(userAnswer, correctAnswer, questionText, apiKey, retries = 2, delay = 1000) {
      const modelMap = {
        'gemini-2.5-flash': 'gemini-2.5-flash',
        'gemini-2.5-flash-lite': 'gemini-2.5-flash-lite'
      };
      const model = modelMap[selectedAiModel] || 'gemini-2.5-flash';
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;

      const generationConfig = {
        responseMimeType: 'application/json',
        responseSchema: {
          type: 'OBJECT',
          properties: {
            hint: { type: 'STRING', description: 'ì •ë‹µì„ ì§ì ‘ ë§í•˜ì§€ ì•ŠëŠ” 2~4ì¤„ í•œêµ­ì–´ íŒíŠ¸' }
          },
          required: ['hint']
        }
      };

      const systemInstruction = {
        parts: [{ text:
`ì—­í• : íšŒê³„ê°ì‚¬ í•™ìŠµ íŠœí„°.
ëª©í‘œ: ì •ë‹µì„ ë…¸ì¶œí•˜ì§€ ì•Šê³  í•µì‹¬ ê°œë…ì„ ë– ì˜¬ë¦¬ê²Œ ë§Œë“œëŠ” íŒíŠ¸ ì œê³µ.
ê·œì¹™:
- ì •ë‹µ/ì¡°í•©/ëª©ë¡ì„ ê·¸ëŒ€ë¡œ ì“°ì§€ ë§ˆì„¸ìš”.
- 2~4ì¤„ í•œê¸€ íŒíŠ¸, í•„ìš” ì‹œ í•µì‹¬ í‚¤ì›Œë“œì˜ ë°©í–¥ë§Œ ì•”ì‹œ.
- ì¶œë ¥ì€ JSONë§Œ.` }]
      };

      const userQuery =
`[ë¬¸ì œ]
${questionText}

[ëª¨ë²” ë‹µì•ˆ]
${correctAnswer}

[ì‚¬ìš©ì ë‹µì•ˆ]
${userAnswer || '(ë¯¸ì…ë ¥)'}

[ìš”ì²­]
ì •ë‹µ ë…¸ì¶œ ì—†ì´ í•™ìŠµì„ ë•ëŠ” íŒíŠ¸ 2~4ì¤„. JSONìœ¼ë¡œ {"hint": string }ë§Œ ë°˜í™˜`;

      const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction, generationConfig };

      try {
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          const msg = body?.error?.message || res.statusText;
          if ((res.status === 404 || res.status === 400) && /model/i.test(msg)) throw new Error(`ëª¨ë¸/ë²„ì „ ë¶ˆì¼ì¹˜: ${msg}`);
          if (res.status === 429) throw new Error(`API í• ë‹¹ëŸ‰ ì´ˆê³¼ (429)`);
          if (res.status >= 500) throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${res.status})`);
          throw new Error(msg);
        }
        const data = await res.json();
        const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text ?? '';
        const cleaned = sanitizeModelText(raw);
        let parsed;
        try { parsed = JSON.parse(cleaned); }
        catch { throw new Error(`API ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨`); }
        return String(parsed.hint || '').trim();
      } catch (err) {
        if (retries > 0 && (String(err.message).includes('429') || String(err.message).match(/^ì„œë²„ ì˜¤ë¥˜/))) {
          await new Promise(r => setTimeout(r, delay));
          return callGeminiHintAPI(userAnswer, correctAnswer, questionText, apiKey, retries - 1, delay * 2);
        }
        throw err;
      }
    }

    // ====== ê²°ê³¼ í‘œì‹œ ======
    function showResult(scoreVal, feedback, correctAnswer) {
      const s = clamp(Number(scoreVal), 0, 100);
      el.score.textContent = s.toFixed(1);
      el.progressBar.style.width = `${s}%`;
      el.progressBar.setAttribute('aria-valuenow', String(Math.round(s)));
      el.progressBar.className = 'h-4 rounded-full transition-all duration-500 ease-out ' + (s < 60 ? 'bg-red-500' : s < 80 ? 'bg-yellow-500' : 'bg-blue-600');
      el.aiFeedback.textContent = String(feedback || '');
      el.correctAnswer.textContent = String(correctAnswer || '');
      el.resultBox.classList.remove('hidden');
    }

    // ====== ìš”ì•½íŒ(í•™ìŠµ í˜„í™©íŒ) ë³´ê¸° í† ê¸€ ======
    el.summaryViewAllBtn?.addEventListener('click', () => {
      summaryViewMode = 'ALL';
      el.summaryViewAllBtn.classList.add('bg-gray-100');
      el.summaryViewCurrentBtn.classList.remove('bg-gray-100');
      updateSummary();
    });
    el.summaryViewCurrentBtn?.addEventListener('click', () => {
      summaryViewMode = 'CURRENT';
      el.summaryViewCurrentBtn.classList.add('bg-gray-100');
      el.summaryViewAllBtn.classList.remove('bg-gray-100');
      updateSummary();
    });

    // ====== í˜„í™©íŒ ======
    function updateSummary() {
      el.scoreSummary.innerHTML = '';

      // ìš”ì•½íŒì€ ë¬¸ì œ í•„í„°/ë‹¨ì› ì…€ë ‰íŠ¸ì™€ **ë…ë¦½ì ìœ¼ë¡œ** ë™ì‘
      const base = (summaryViewMode === 'CURRENT')
        ? (currentQuizData || [])
        : (allData || []);

      const groups = new Map();
      for (const q of base) {
        const ch = String(q.ë‹¨ì›).trim();
        if (!groups.has(ch)) groups.set(ch, []);
        groups.get(ch).push(q);
      }

      const chapters = [...groups.keys()].sort((a, b) => {
        const na = Number(a), nb = Number(b);
        if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;
        if (Number.isFinite(na)) return -1;
        if (Number.isFinite(nb)) return 1;
        return a.localeCompare(b, 'ko');
      });

      const _clamp = (v, min, max) => Math.max(min, Math.min(max, v));

      chapters.forEach(ch => {
        const list = groups.get(ch) || [];
        list.sort((a, b) => {
          const na = Number(a.ë¬¼ìŒë²ˆí˜¸ || a.í‘œì‹œë²ˆí˜¸), nb = Number(b.ë¬¼ìŒë²ˆí˜¸ || b.í‘œì‹œë²ˆí˜¸);
          if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;
          return String(a.í‘œì‹œë²ˆí˜¸ || a.ë¬¼ìŒë²ˆí˜¸).localeCompare(String(b.í‘œì‹œë²ˆí˜¸ || b.ë¬¼ìŒë²ˆí˜¸), 'ko');
        });

        let sum = 0, cnt = 0;
        let totalRounds = 0, roundCnt = 0;
        let latestDate = 0;

        list.forEach(q => {
          const s = questionScores[String(q.ê³ ìœ ID)?.trim()];
          if (s && Number.isFinite(Number(s.score))) { sum += Number(s.score); cnt++; }
          if (s && s.solveHistory && s.solveHistory.length > 0) {
            totalRounds += s.solveHistory.length; roundCnt++;
          }
          if (s && s.lastSolvedDate && s.lastSolvedDate > latestDate) latestDate = s.lastSolvedDate;
        });

        const avg = cnt ? (sum / cnt) : null;
        const avgRounds = roundCnt ? (totalRounds / roundCnt) : null;

        let recentText = '';
        if (latestDate > 0) {
          const daysDiff = Math.floor((Date.now() - latestDate) / (24 * 60 * 60 * 1000));
          if (daysDiff === 0) recentText = 'ì˜¤ëŠ˜';
          else if (daysDiff === 1) recentText = 'ì–´ì œ';
          else recentText = `${daysDiff}ì¼ ì „`;
        } else {
          recentText = 'í•™ìŠµ ê¸°ë¡ ì—†ìŒ';
        }

        const ratioText = `ì‘ì‹œ ${cnt}/${list.length}`;
        const avgText = (avg === null) ? '-' : avg.toFixed(1);
        const avgRoundsText = avgRounds ? avgRounds.toFixed(1) : '-';

        const barW = _clamp(avg ?? 0, 0, 100);
        const barCls = (avg === null) ? 'bg-gray-300'
                     : avg < 60 ? 'bg-red-500'
                     : avg < 80 ? 'bg-yellow-500'
                     : 'bg-green-500';

        const header = document.createElement('div');
        header.className = 'px-3 py-2 rounded-md border bg-gray-50 mb-2';

        const title = document.createElement('div');
        title.className = 'font-semibold text-lg';
        title.textContent = Number.isFinite(Number(ch)) ? `ë‹¨ì› ${ch}` : ch;

        const meta = document.createElement('div');
        meta.className = 'text-sm text-gray-700 mt-1 space-y-1';

        const line1 = document.createElement('div');
        line1.textContent = `í‰ê·  ${avgText}ì  Â· ${ratioText}`;
        const line2 = document.createElement('div');
        line2.textContent = `í‰ê·  ${avgRoundsText}íšŒë… Â· ìµœê·¼ ${recentText}`;

        meta.appendChild(line1);
        meta.appendChild(line2);

        const mini = document.createElement('div');
        mini.className = 'w-28 h-2 bg-gray-200 rounded-full overflow-hidden mt-2';
        const miniFill = document.createElement('div');
        miniFill.className = `h-2 ${barCls}`;
        miniFill.style.width = `${barW}%`;
        mini.appendChild(miniFill);

        const toggleWrap = document.createElement('div');
        toggleWrap.className = 'mt-2 flex justify-end';
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'text-xs text-blue-700 hover:underline';
        toggleBtn.textContent = 'ì ‘ê¸°';
        toggleWrap.appendChild(toggleBtn);

        header.appendChild(title);
        header.appendChild(meta);
        header.appendChild(mini);
        header.appendChild(toggleWrap);

        const grid = document.createElement('div');
        grid.className = 'flex flex-wrap gap-2 mt-2 mb-4';

        list.forEach(q => {
          const btn = document.createElement('button');

          const displayOnly = (q.í‘œì‹œë²ˆí˜¸ ?? '').toString().trim();
          const fallback    = (q.ë¬¼ìŒë²ˆí˜¸ ?? q.ê³ ìœ ID ?? '').toString().trim();
          const label       = displayOnly || fallback || '';
          btn.textContent   = label;

          if (label.length >= 3) btn.style.fontSize = '0.72rem';
          if (label.length >= 4) { btn.style.fontSize = '0.66rem'; btn.style.letterSpacing = '-0.2px'; }

          const fullMeta = [
            q.problemTitle && String(q.problemTitle).trim(),
            `í‘œì‹œë²ˆí˜¸:${displayOnly || '-'}`,
            `ë¬¼ìŒë²ˆí˜¸:${(q.ë¬¼ìŒë²ˆí˜¸ ?? '').toString().trim() || '-'}`,
            `ID:${(q.ê³ ìœ ID ?? '').toString().trim() || '-'}`].filter(Boolean).join(' | ');
          btn.title = fullMeta;
          btn.setAttribute('aria-label', fullMeta);

          btn.classList.add('summary-btn', 'font-medium', 'rounded-lg', 'border');

          const saved = questionScores[String(q.ê³ ìœ ID)?.trim()];
          const sc = saved ? Number(saved.score) : NaN;
          const { bg, txt, bd } =
            !Number.isFinite(sc) ? { bg:'bg-gray-100', txt:'text-gray-600', bd:'border-gray-300' }
            : sc < 60 ? { bg:'bg-red-100', txt:'text-red-700', bd:'border-red-300' }
            : sc < 80 ? { bg:'bg-yellow-100', txt:'text-yellow-700', bd:'border-yellow-300' }
                      : { bg:'bg-green-100', txt:'text-green-700', bd:'border-green-300' };
          btn.classList.add(bg, txt, bd);
          btn.dataset.qid = String(q.ê³ ìœ ID).trim();

          btn.addEventListener('click', () => {
            // ìš”ì•½íŒì€ ë…ë¦½ ë™ì‘ì´ì§€ë§Œ, í´ë¦­ ì‹œ í•´ë‹¹ ë¬¸í•­ìœ¼ë¡œ ì´ë™ í¸ì˜ ì œê³µ
            // í˜„ì¬ ì„¸íŠ¸ê°€ í•´ë‹¹ ë¬¸í•­ì„ í¬í•¨í•˜ì§€ ì•Šìœ¼ë©´, ì „ì²´ allDataì—ì„œ ì°¾ì•„ì„œ í˜„ì¬ ì„¸íŠ¸ë¥¼ ì¬êµ¬ì„±
            const idxInCurrent = currentQuizData.findIndex(it => String(it.ê³ ìœ ID).trim() === String(q.ê³ ìœ ID).trim());
            if (idxInCurrent === -1) {
              // í˜„ì¬ ì„¸íŠ¸ë¥¼ í•´ë‹¹ ë‹¨ì›ìœ¼ë¡œ ì ì‹œ êµ¬ì„±
              const chVal = String(q.ë‹¨ì›).trim();
              const newSet = allData.filter(it => String(it.ë‹¨ì›).trim() === chVal);
              if (newSet.length) {
                currentQuizData = newSet;
                currentQuestionIndex = newSet.findIndex(it => String(it.ê³ ìœ ID).trim() === String(q.ê³ ìœ ID).trim());
              }
            } else {
              currentQuestionIndex = idxInCurrent;
            }
            if (currentQuestionIndex < 0) currentQuestionIndex = 0;
            el.quizArea.classList.remove('hidden');
            displayQuestion();
            showToast(`'${q.í‘œì‹œë²ˆí˜¸ || q.ë¬¼ìŒë²ˆí˜¸ || q.ê³ ìœ ID}'ë²ˆìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);
          });

          grid.appendChild(btn);
        });

        toggleBtn.addEventListener('click', () => {
          const isHidden = grid.classList.toggle('hidden');
          toggleBtn.textContent = isHidden ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°';
        });

        const section = document.createElement('div');
        section.className = 'w-full space-y-2 mb-3';
        section.appendChild(header);
        section.appendChild(grid);
        el.scoreSummary.appendChild(section);
      });

      updateSummaryHighlight();
    }

    function updateSummaryHighlight() {
      if (currentQuizData.length === 0) return;
      const currentQ = String(currentQuizData[currentQuestionIndex].ê³ ìœ ID).trim();
      const buttons = el.scoreSummary.querySelectorAll('button.summary-btn');
      buttons.forEach(b => b.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-2'));
      buttons.forEach(b => {
        if (b.dataset.qid === currentQ) b.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2');
      });
    }

    // ====== í•„í„° í•´ì œ ë° ì´ˆê¸°í™” (ë¬¸ì œ ëª©ë¡ìš©) ======
    el.clearFilterBtn.addEventListener('click', () => {
      el.filterSelect.value = 'all';
      el.chapterSelect.value = '';
      handleLoadQuiz();
      showToast('í•„í„°ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤. ëª¨ë“  ë¬¸ì œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
    });
    el.resetScoresBtn.addEventListener('click', () => {
      if (confirm('ì •ë§ë¡œ ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        questionScores = {};
        localStorage.removeItem('auditQuizScores');
        localStorage.removeItem('schemaVersion');
        updateSummary();
        if (currentQuizData.length > 0) {
          currentQuestionIndex = 0;
          handleLoadQuiz();
        }
        showToast('í•™ìŠµ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ====== ë‹¨ì¶•í‚¤ ======
    function isEditing(t) { return t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable); }
    function goTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
    function ensureModelAnswerVisible() {
      // ê²°ê³¼ ì˜ì—­ ì—´ê³  ëª¨ë²”ë‹µì•ˆ ìœ„ì¹˜ë¡œ ìŠ¤í¬ë¡¤. í•„ìš” ì‹œ ì¦‰ì‹œ ì •ë‹µ í…ìŠ¤íŠ¸ë„ ì±„ìš´ë‹¤.
      if (currentQuizData.length) {
        const q = currentQuizData[currentQuestionIndex];
        if (!el.correctAnswer.textContent?.trim()) {
          el.correctAnswer.textContent = String(q.ì •ë‹µ || '');
        }
      }
      el.resultBox.classList.remove('hidden');
      (el.correctAnswer || el.resultBox).scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    document.addEventListener('keydown', (e) => {
      // H/h íŒíŠ¸ (ì…ë ¥ ì¤‘ì´ ì•„ë‹ ë•Œ)
      if ((e.key === 'h' || e.key === 'H') && !isEditing(e.target)) {
        e.preventDefault(); el.hintBtn?.click(); return;
      }
      if (e.ctrlKey && !e.altKey && !e.metaKey) {
        // Ctrl+Arrow: ì´ì „/ë‹¤ìŒ
        if (e.key === 'ArrowLeft')  { e.preventDefault(); el.prevBtn?.click(); return; }
        if (e.key === 'ArrowRight') { e.preventDefault(); el.nextBtn?.click(); return; }
        // Ctrl+[ / Ctrl+]
        if (e.key === '[') { e.preventDefault(); goTop(); return; }
        if (e.key === ']') { e.preventDefault(); ensureModelAnswerVisible(); return; }
      }
    });

    // ë‹µì•ˆì°½: Enter=ì±„ì , Shift+Enter=ì¤„ë°”ê¿ˆ
    el.userAnswer?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        el.gradeBtn?.click();
      }
    });

    // ====== ì´ˆê¸°í™” ======
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadData();
      } catch (err) {
        console.error(err);
        document.getElementById('question-text').textContent = 'ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (questions.json ë˜ëŠ” dataset-jsonì„ í™•ì¸í•˜ì„¸ìš”).';
        showToast(`ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}`, 'error');
      }
      loadScores();
      loadApiKey();
      loadSettings();
      applyDarkMode();
      migrateData();
      ensureApiKeyGate();
    });
  </script>
</body>
</html>
