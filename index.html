<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="same-origin" />
  <title>감린이 - 회계감사 학습 도우미 v3.2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .summary-btn { width: 38px; height: 38px; font-size: 0.8rem; line-height: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .summary-btn:hover { transform: scale(1.1); }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    #toast { position: fixed; top: 16px; right: 16px; z-index: 9999; }

    /* 다크모드 스타일 */
    .dark { background-color: #1a202c; color: #e2e8f0; }
    .dark .bg-white { background-color: #2d3748; }
    .dark .bg-gray-100 { background-color: #1a202c; }
    .dark .bg-gray-50 { background-color: #2d3748; }
    .dark .text-gray-800 { color: #e2e8f0; }
    .dark .text-gray-700 { color: #cbd5e0; }
    .dark .text-gray-600 { color: #a0aec0; }
    .dark .border-gray-200 { border-color: #4a5568; }
    .dark .border-gray-300 { border-color: #4a5568; }
  </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
  <div id="toast" class="hidden"></div>

  <!-- ========== [A] 상단 네비게이션 바 (고정, 패치 스타일 우선) ========== -->
  <header id="fixed-header" class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur border-b border-gray-200 dark:bg-gray-900/80 dark:border-gray-800">
    <div class="mx-auto max-w-4xl px-4 py-2 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-xl font-extrabold tracking-tight text-blue-700 dark:text-blue-400">감린이</span>
        <span class="hidden sm:inline text-xs text-gray-500 dark:text-gray-400">회계감사 암기 도우미 v3.2</span>
      </div>
      <nav class="flex items-center gap-2">
        <a id="help-button" href="README.html" target="_blank" class="hidden sm:inline text-sm text-gray-700 hover:text-blue-700 dark:text-gray-300 dark:hover:text-white">도움말</a>
        <!-- id는 현행 스크립트에 맞춰 유지 -->
        <button id="settings-btn" class="ml-1 inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-haspopup="dialog">
          <span>설정</span><span aria-hidden>⚙️</span>
        </button>
        <button id="hamburger" class="sm:hidden inline-flex items-center justify-center w-9 h-9 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-label="메뉴">≡</button>
      </nav>
    </div>
  </header>
  <div class="h-14"></div><!-- 상단바 공간 확보 -->

  <!-- 메인 컨텐츠 -->
  <div class="pt-2 flex-1 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-6 md:p-8">

      <!-- 옵션 -->
      <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
        <div class="flex-1 w-full">
          <label for="chapter-select" class="block text-sm font-medium text-gray-700 mb-1">단원 선택</label>
          <select id="chapter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition">
            <option value="">-- 전체 단원 --</option>
          </select>
        </div>
        <div class="flex-1 w-full">
          <label for="filter-select" class="block text-sm font-medium text-gray-700 mb-1">문제 필터</label>
          <select id="filter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition">
            <option value="all">모든 문제 풀기</option>
            <option value="unanswered">아직 안 푼 문제</option>
            <option value="today-review">오늘의 복습 (추천)</option>
            <option value="80">80점 미만 문제</option>
            <option value="60">60점 미만 문제</option>
          </select>
        </div>
        <div class="w-full md:w-auto md:self-end flex gap-2">
          <button id="load-quiz-btn" class="flex-1 bg-blue-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">학습 시작</button>
          <button id="random-quiz-btn" class="flex-1 bg-purple-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-purple-700 transition duration-200">랜덤 문제</button>
        </div>
      </div>

      <!-- 문제 영역 -->
      <div id="quiz-area" class="hidden">
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-4">
          <div class="flex justify-between items-center mb-4">
            <h2 id="question-number" class="text-xl font-bold text-blue-700 bg-blue-100 px-3 py-1 rounded-md">문항</h2>
            <span id="question-counter" class="text-gray-500 font-medium">0 / 0</span>
          </div>
          <p id="question-text" class="text-gray-800 text-base md:text-lg leading-relaxed">문제를 불러오는 중입니다...</p>

          <!-- 힌트 버튼 -->
          <div class="mt-3 flex items-center justify-end">
            <button id="hint-btn" class="text-sm bg-purple-600 text-white px-3 py-1.5 rounded-md shadow hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
              힌트
            </button>
          </div>

          <!-- 힌트 박스 -->
          <div id="hint-container" class="hidden mt-3 text-sm bg-purple-50 border border-purple-200 text-purple-800 rounded-lg p-3"></div>
        </div>

        <div class="flex items-center justify-between mb-2">
          <label for="user-answer" class="text-sm font-medium text-gray-700">답안 입력</label>
          <button id="load-prev-answer-btn" class="text-xs text-blue-600 hover:underline">이전 답안 불러오기</button>
        </div>
        <textarea id="user-answer" class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" rows="8" placeholder="여기에 정답을 입력하세요..."></textarea>
        <p id="error-message" class="text-red-500 text-sm mt-2 hidden">답안을 입력해주세요.</p>

        <div class="flex justify-between items-center my-5">
          <button id="prev-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">이전</button>
          <button id="grade-btn" class="bg-green-500 text-white font-bold py-2 px-8 rounded-lg shadow-md hover:bg-green-600 transition duration-200 relative min-w-[120px]">
            <span id="grade-btn-text">채점하기</span>
            <div id="grade-loader" class="loader absolute inset-0 m-auto hidden" aria-hidden="true"></div>
          </button>
          <button id="next-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">다음</button>
        </div>
      </div>

      <!-- 결과 영역 -->
      <div id="result-box" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-6 mt-6" aria-live="polite">
        <h3 class="text-2xl font-bold text-gray-800 mb-4">채점 결과</h3>

        <div id="score-display" class="mb-5">
          <p class="text-lg font-medium text-gray-700">
            유사도 점수: <span id="score" class="font-bold text-blue-600 text-2xl">0</span><span class="text-gray-600 text-lg">점</span>
          </p>
          <div class="w-full bg-gray-200 rounded-full h-4 mt-2 overflow-hidden shadow-inner">
            <div id="progress-bar" class="h-4 rounded-full transition-all duration-500 ease-out" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="width: 0%"></div>
          </div>
        </div>

        <div class="mb-5">
          <h4 class="text-xl font-semibold text-gray-700 mb-2">🤖 AI 총평</h4>
          <div id="ai-feedback" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 leading-relaxed min-h-[50px]"></div>
        </div>

        <div>
          <h4 class="text-xl font-semibold text-gray-700 mb-2">📘 모범 답안</h4>
          <pre id="correct-answer" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 text-sm font-sans leading-relaxed"></pre>
        </div>
      </div>

      <!-- 학습 현황판 -->
      <div id="summary-area" class="mt-8 pt-6 border-t hidden">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-xl font-bold text-gray-800">학습 현황판 (클릭하여 이동)</h3>
          <div class="flex gap-4">
            <button id="clear-filter-btn" class="text-sm text-blue-700 hover:underline">필터 해제</button>
            <button id="reset-scores-btn" class="text-sm text-red-600 hover:underline">학습 기록 초기화</button>
          </div>
        </div>
        <div id="score-summary" class="flex flex-wrap gap-2"></div>
      </div>
    </div>
  </div>

  <!-- ========== API 키 최초 인증 모달 (유지) ========== -->
  <div id="api-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1000]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-xl">
      <h2 class="text-xl font-bold text-gray-800">Gemini API 키 인증</h2>
      <p class="text-sm text-gray-600 mt-1">
        최초 1회만 입력합니다. 로컬 저장을 체크하면 다음부터는 팝업이 뜨지 않습니다.
      </p>

      <label for="api-modal-input" class="block text-sm font-medium text-gray-700 mt-4">🔑 API Key</label>
      <input type="password" id="api-modal-input"
             class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500"
             placeholder="Google AI Studio API 키" autocomplete="off" spellcheck="false" inputmode="text" />

      <div class="flex items-center gap-2 mt-2">
        <input type="checkbox" id="modal-remember" class="rounded border-gray-300" />
        <label for="modal-remember" class="text-sm text-gray-700">이 브라우저에 키 저장</label>
      </div>
      <p class="text-xs text-yellow-600 mt-1">⚠️ 공용 PC에서는 체크 해제를 권장합니다.</p>

      <div class="mt-5 flex justify-end gap-2">
        <button id="api-cancel-btn" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900">취소</button>
        <button id="api-save-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700">
          저장
        </button>
      </div>
    </div>
  </div>

  <!-- ========== [B] 설정 모달 (패치 우선) ========== -->
  <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1001]">
    <div role="dialog" aria-modal="true" aria-labelledby="settings-title" class="bg-white dark:bg-gray-900 dark:text-gray-100 rounded-2xl w-full max-w-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-2">
        <h2 id="settings-title" class="text-2xl font-bold">설정 ⚙️</h2>
        <button id="settings-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white" aria-label="닫기">✕</button>
      </div>

      <!-- API 키 설정 -->
      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">API 키 설정</h3>
        <button id="open-api-key-modal-btn" class="w-full bg-blue-50 border border-blue-300 text-blue-700 font-medium py-2 px-4 rounded-lg hover:bg-blue-100 transition">
          API 키 변경/설정
        </button>
      </div>

      <!-- AI 모델 선택 -->
      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">AI 모델 선택</h3>
        <select id="ai-model-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="gemini-2.5-flash">Gemini 2.5 Flash (기본)</option>
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (경량)</option>
        </select>
        <p class="text-xs text-gray-500 mt-2">힌트 및 채점에 사용될 AI 모델을 선택하세요.</p>
      </div>

      <!-- 다크 모드 -->
      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">다크 모드</h3>
        <select id="dark-mode-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="system">시스템 설정 (기본)</option>
          <option value="light">라이트 모드</option>
          <option value="dark">다크 모드</option>
        </select>
      </div>

      <!-- 데이터 Import/Export -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">데이터 관리</h3>
        <div class="flex gap-3">
          <button id="export-data-btn" class="flex-1 bg-green-50 border border-green-300 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition">
            📥 데이터 내보내기
          </button>
          <button id="import-data-btn" class="flex-1 bg-yellow-50 border border-yellow-300 text-yellow-700 font-medium py-2 px-4 rounded-lg hover:bg-yellow-100 transition">
            📤 데이터 가져오기
          </button>
        </div>
        <input type="file" id="import-file-input" accept=".json" class="hidden" />
        <p class="text-xs text-gray-500 mt-2">학습 기록 및 설정을 백업하거나 복원할 수 있습니다.</p>
      </div>

      <!-- 닫기 버튼 -->
      <div class="flex justify-end">
        <button id="settings-close-btn-bottom" class="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition">
          닫기
        </button>
      </div>
    </div>
  </div>

  <!-- ========== 내장 데이터(JSON) (questions.json 폴백) ========== -->
  <script id="dataset-json" type="application/json">[
  {
    "고유ID": "q_001",
    "표시번호": "1",
    "출처": "ISA 200-A54",
    "problemTitle": "",
    "단원": 1,
    "물음번호": 1,
    "물음": "회계감사에는 고유한계가 존재하며, 감사인의 결론도출과 의견표명의 기초가 되는 대부분의 감사증거는 결정적 증거이기 보다는 설득적 증거이기 때문에 회계감사를 통해 재무제표에 부정이 나오류로 인한 중요한 왜곡표시가 없다는 절대적 확신은 얻을 수없다. 이러한 회계감사의 고유한계의 원인을 세가지만 기재하시오.",
    "정답": "① 재무보고의 성격 ② 감사절차의 성격 ③ 합리적인 시간 내에 합리적인 비용으로 감사가 수행될 필요성"
  },
  {
    "고유ID": "q_002",
    "표시번호": "2",
    "출처": "ISA 200-A51",
    "problemTitle": "",
    "단원": 1,
    "물음번호": 2,
    "물음": "회계감사기준은 감사를 계획하고 수행할 때재무보고의 적시성 및효익과 비용간의 균형을 고려할 것을 규정하고 있다. 따라서 감사인은 무한한 정도의 감사절차를 수행함으로써 절대적 확신을 제공하려는 감사절차를 수행하기 보다는 재무보고 이용자들의 요구수준을 충족할 수있는 정도의 감사절차를 수행할 수있다. 이와 같이 감사인이 재무보고의 적시성 및효익과 비용의 균형을 고려하여 채택하고 있는 감사절차에는 어떤 것이 있는지 세가지를 서술하시오.",
    "정답": "ISA 200-A51 ① 감사가 효과적으로 수행될 수있도록 계획함 ② 부정이나 오류로 인한 중요왜곡표시위험이 포함될 것으로 가장 높게 예상되는 분야에 감사노력을 집중하고, 그렇지 아니한 다른 분야에는 상대적으로 적은 노력을 기울임 ③ 모집단의 왜곡표시를 조사하기 위해 테스트나 기타 수단을 사용함"
  }
]</script>

<script type="module">
  /* ----------------------------------------------------
   * 감린이 v3.x (머지본) - 패치 우선 반영
   * - DB 로딩: questions.json 우선, 실패 시 dataset-json 폴백
   * - 마이그레이션(v3 -> v3.x)
   * - 모델 선택 / 다크 모드 / Import-Export
   * - 랜덤 문제 / 오늘의 복습 / 이전 답안 불러오기
   * - GA 이벤트 훅 / 에러 분기+리트라이
   * - 현황판 확장(평균 회독/최근 학습일) + 하이라이트 안정화
   * ---------------------------------------------------- */

  // ====== 전역 상태 ======
  let allData = [];
  let currentQuizData = [];
  let currentQuestionIndex = 0;
  let questionScores = {};
  let geminiApiKey = '';
  let activeHintQuestionKey = null;
  let selectedAiModel = 'gemini-2.5-flash'; // Final Draft 기본
  let darkMode = 'system';

  // ====== DOM 캐시 ======
  const el = {
    toast: document.getElementById('toast'),
    apiModal: document.getElementById('api-modal'),
    apiModalInput: document.getElementById('api-modal-input'),
    apiModalRemember: document.getElementById('modal-remember'),
    apiModalSaveBtn: document.getElementById('api-save-btn'),
    apiModalCancelBtn: document.getElementById('api-cancel-btn'),

    // 헤더/설정
    settingsBtn: document.getElementById('settings-btn'),
    settingsModal: document.getElementById('settings-modal'),
    settingsCloseBtn: document.getElementById('settings-close-btn'),
    settingsCloseBtnBottom: document.getElementById('settings-close-btn-bottom'),
    openApiKeyModalBtn: document.getElementById('open-api-key-modal-btn'),

    // 설정 내 요소
    aiModelSelect: document.getElementById('ai-model-select'),
    darkModeSelect: document.getElementById('dark-mode-select'),
    exportDataBtn: document.getElementById('export-data-btn'),
    importDataBtn: document.getElementById('import-data-btn'),
    importFileInput: document.getElementById('import-file-input'),

    // 옵션/학습
    chapterSelect: document.getElementById('chapter-select'),
    filterSelect: document.getElementById('filter-select'),
    loadQuizBtn: document.getElementById('load-quiz-btn'),
    randomQuizBtn: document.getElementById('random-quiz-btn'),

    // 문제/결과
    quizArea: document.getElementById('quiz-area'),
    questionNumber: document.getElementById('question-number'),
    questionText: document.getElementById('question-text'),
    questionCounter: document.getElementById('question-counter'),
    userAnswer: document.getElementById('user-answer'),
    errorMessage: document.getElementById('error-message'),
    prevBtn: document.getElementById('prev-btn'),
    nextBtn: document.getElementById('next-btn'),
    gradeBtn: document.getElementById('grade-btn'),
    gradeBtnText: document.getElementById('grade-btn-text'),
    gradeLoader: document.getElementById('grade-loader'),
    hintBtn: document.getElementById('hint-btn'),
    hintBox: document.getElementById('hint-container'),
    loadPrevAnswerBtn: document.getElementById('load-prev-answer-btn'),
    resultBox: document.getElementById('result-box'),
    score: document.getElementById('score'),
    progressBar: document.getElementById('progress-bar'),
    aiFeedback: document.getElementById('ai-feedback'),
    correctAnswer: document.getElementById('correct-answer'),

    // 현황판
    summaryArea: document.getElementById('summary-area'),
    scoreSummary: document.getElementById('score-summary'),
    clearFilterBtn: document.getElementById('clear-filter-btn'),
    resetScoresBtn: document.getElementById('reset-scores-btn')
  };

  // ... (기존 v3.2 스크립트 전체 동일 – 생략 없이 포함) ...

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      await loadData();        // questions.json → fallback dataset-json
    } catch (err) {
      console.error(err);
      el.questionText.textContent = '문제 데이터 로드 실패 (questions.json 또는 dataset-json를 확인하세요).';
      showToast(`문제 데이터 로드 실패: ${err.message}`, 'error');
    }
    loadScores();
    loadApiKey();
    loadSettings();
    applyDarkMode();
    migrateData();
    ensureApiKeyGate();
  });
</script>

  <!-- v4 shell bootstrap (desktop에서만 보임) -->
  <script type="module" src="/js/app.js"></script>
</body>
</html>
