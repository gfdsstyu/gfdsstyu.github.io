<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="same-origin" />
  <title>ê°ë¦°ì´ - íšŒê³„ê°ì‚¬ í•™ìŠµ ë„ìš°ë¯¸ v3.3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .summary-btn {
      width: 38px; height: 38px;
      font-size: 0.8rem; line-height: 1;
      display: flex; align-items: center; justify-content: center;
      padding: 0 2px; transition: all 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .summary-btn:hover { transform: scale(1.1); }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    #toast { position: fixed; top: 16px; right: 16px; z-index: 9999; }

    /* ë‹¤í¬ëª¨ë“œ ê¸°ë³¸ */
    .dark { background-color: #1a202c; color: #e2e8f0; }
    .dark .bg-white { background-color: #2d3748; }
    .dark .bg-gray-100 { background-color: #1a202c; }
    .dark .bg-gray-50 { background-color: #2d3748; }
    .dark .text-gray-800 { color: #e2e8f0; }
    .dark .text-gray-700 { color: #cbd5e0; }
    .dark .text-gray-600 { color: #a0aec0; }
    .dark .border-gray-200 { border-color: #4a5568; }
    .dark .border-gray-300 { border-color: #4a5568; }
  </style>

  <!-- ë‹¤í¬ëª¨ë“œ ì ‘ê·¼ì„± ë³´ê°• -->
  <style id="dark-a11y-20251026">
    html.dark { color-scheme: dark; }
    html.dark input, html.dark textarea, html.dark select {
      background-color: #1f2937; color: #e5e7eb; border-color: #4b5563;
    }
    html.dark ::placeholder { color: #9ca3af; }
    html.dark :is(button, a, input, textarea, select):focus-visible { outline: 2px solid #60a5fa; outline-offset: 2px; }
    html.dark .progress-track { background-color: #374151; }
    html.dark #result-box { background-color: #1f2937; border-color: #374151; }
    html.dark #quiz-area .bg-gray-50 { background-color: #111827; }
    html.dark #quiz-area .border-gray-200 { border-color: #374151; }
    html.dark #hint-container { background-color: #1e3a8a; border-color: #334155; color: #e0e7ff; }
    html.dark #summary-area .border { border-color: #374151; }
    html.dark #summary-area .bg-gray-50 { background-color: #111827; }
    html.dark .summary-btn.bg-gray-100 { background-color:#111827; color:#d1d5db; border-color:#374151; }
    html.dark .summary-btn.bg-red-100   { background-color:#7f1d1d; color:#fecaca; border-color:#991b1b; }
    html.dark .summary-btn.bg-yellow-100{ background-color:#78350f; color:#fde68a; border-color:#92400e; }
    html.dark .summary-btn.bg-green-100 { background-color:#14532d; color:#bbf7d0; border-color:#166534; }
  </style>

  <!-- Ctrl] í¬ì»¤ìŠ¤ ëª¨ë“œ -->
  <style id="focus-mode-css">
    html.focus-mode { scroll-behavior: smooth; }
    html.focus-mode #result-box { max-height: none !important; overflow: visible !important; }
  </style>

  <!-- ë³´ì¡° CSS -->
  <style id="layout-css">
    .heatmap-cell { width: 14px; height: 14px; border-radius: 3px; }
    /* ëª¨ë°”ì¼ ë“œë¡œì–´ */
    .drawer-open { overflow: hidden; }
  </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
  <div id="toast" class="hidden"></div>

  <!-- ìƒë‹¨ ë„¤ë¹„ -->
  <header id="fixed-header" class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur border-b border-gray-200 dark:bg-gray-900/80 dark:border-gray-800">
  <div class="mx-auto max-w-[1400px] 2xl:max-w-[1600px] px-4 lg:px-6 xl:px-8 py-2 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-xl font-extrabold tracking-tight text-blue-700 dark:text-blue-400">ê°ë¦°ì´</span>
        <span class="hidden sm:inline text-xs text-gray-500 dark:text-gray-400">íšŒê³„ê°ì‚¬ ì•”ê¸° ë„ìš°ë¯¸ v3.3</span>
      </div>
      <nav class="flex items-center gap-2">
        <a id="help-button" href="README.html" target="_blank" class="hidden sm:inline text-sm text-gray-700 hover:text-blue-700 dark:text-gray-300 dark:hover:text-white">ë„ì›€ë§</a>
        <button id="settings-btn" class="ml-1 inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-haspopup="dialog">
          <span>ì„¤ì •</span><span aria-hidden>âš™ï¸</span>
        </button>
        <button id="hamburger" class="lg:hidden inline-flex items-center justify-center w-9 h-9 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-label="ë©”ë‰´">â‰¡</button>
      </nav>
    </div>
  </header>
  <div class="h-14"></div>

  <!-- ëª¨ë°”ì¼ ë“œë¡œì–´ ë°±ë“œë¡­ -->
  <div id="drawer-backdrop" class="fixed inset-0 bg-black/40 hidden z-[1099]"></div>

  <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
<div id="layout-root" class="pt-2 flex-1 px-4 lg:px-6 xl:px-8">
  <div class="mx-auto max-w-[1400px] 2xl:max-w-[1600px] grid grid-cols-1 lg:grid-cols-12 gap-4 xl:gap-6 2xl:gap-8">
      <!-- LEFT: ëŒ€ì‹œë³´ë“œ (ëª¨ë°”ì¼ ìˆ¨ê¹€â†’í–„ë²„ê±°ë¡œ ë“œë¡œì–´) -->
      <aside id="left-dashboard" class="lg:col-span-4 xl:col-span-3 2xl:col-span-3 space-y-4">
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-lg">í•™ìŠµ ìº˜ë¦°ë”</h3>
            <div id="calendar-month-label" class="text-sm text-gray-500"></div>
          </div>
          <div class="grid grid-cols-7 gap-1 text-[11px] text-gray-500 mb-1">
            <div class="text-center">ì›”</div><div class="text-center">í™”</div><div class="text-center">ìˆ˜</div>
            <div class="text-center">ëª©</div><div class="text-center">ê¸ˆ</div><div class="text-center">í† </div>
            <div class="text-center">ì¼</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
          <div class="mt-2 text-[11px] text-gray-500">ìˆ«ì ë°°ê²½ìƒ‰ = í•´ë‹¹ì¼ í’€ì´ëŸ‰</div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">ì˜¤ëŠ˜ì˜ í†µê³„</h3>
          <div id="stats-overview" class="text-sm space-y-1"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">ì˜¤ëŠ˜ì˜ ë³µìŠµ</h3>
          <label class="text-sm block mb-2">ìš°ì„ ìˆœìœ„</label>
          <select id="review-strategy-select" class="w-full p-2 border rounded">
            <option value="smart">ì§€ëŠ¥í˜• ì¶”ì²œ (ê¸°ë³¸)</option>
            <option value="low">ì ìˆ˜ ë‚®ì€ ìˆœ</option>
            <option value="recentWrong">ìµœê·¼ í‹€ë¦° ìˆœ</option>
            <option value="flag">ì‚¬ìš©ì ì§€ì • ë³µìŠµ ëª©ë¡</option>
          </select>
          <button id="start-review-btn" class="mt-3 w-full bg-blue-600 text-white py-2 rounded-lg">ì˜¤ëŠ˜ì˜ ë³µìŠµ ì‹œì‘</button>
        </div>
      </aside>

      <!-- CENTER: ë©”ì¸ -->
      <main id="center-core" class="lg:col-span-6 xl:col-span-7 2xl:col-span-7">
        <div class="bg-white rounded-2xl shadow-xl w-full p-6 md:p-8">
          <!-- ì˜µì…˜ í–‰ -->
          <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
            <div class="flex-1 w-full">
              <label for="chapter-select" class="block text-sm font-medium text-gray-700 mb-1">ë‹¨ì› ì„ íƒ</label>
              <select id="chapter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
                <option value="">-- ì „ì²´ ë‹¨ì› --</option>
              </select>
            </div>
            <div class="flex-1 w-full">
              <label for="filter-select" class="block text-sm font-medium text-gray-700 mb-1">ë¬¸ì œ í•„í„°</label>
              <select id="filter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-700 dark:text-gray-100 dark:border-gray-700">
                <option value="all">ëª¨ë“  ë¬¸ì œ í’€ê¸°</option>
                <option value="unanswered">ì•„ì§ ì•ˆ í‘¼ ë¬¸ì œ</option>
                <option value="today-review">ì˜¤ëŠ˜ì˜ ë³µìŠµ (ì¶”ì²œ)</option>
                <option value="80">80ì  ë¯¸ë§Œ ë¬¸ì œ</option>
                <option value="60">60ì  ë¯¸ë§Œ ë¬¸ì œ</option>
              </select>
            </div>
            <div class="w-full md:w-auto md:self-end flex gap-2">
              <button id="load-quiz-btn" class="flex-1 bg-blue-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">í•™ìŠµ ì‹œì‘</button>
              <button id="random-quiz-btn" class="flex-1 bg-purple-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-purple-700 transition duration-200">ëœë¤ ë¬¸ì œ</button>
            </div>
          </div>

          <!-- (ì‹ ê·œ) ì¶œì²˜ ê·¸ë£¹ í•„í„° -->
          <div id="source-group-filter" class="mb-6"></div>

          <!-- ë¬¸ì œ ì˜ì—­ -->
          <div id="quiz-area" class="hidden">
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-4">
              <div class="flex justify-between items-center mb-2">
                <h2 id="question-number" class="text-xl font-bold text-blue-700 bg-blue-100 px-3 py-1 rounded-md">ë¬¸í•­</h2>
                <span id="question-counter" class="text-gray-500 font-medium">0 / 0</span>
              </div>
              <div id="db-question-id" class="text-xs text-gray-500 hidden">ID: -</div>

              <p id="question-text" class="text-gray-800 text-base md:text-lg leading-relaxed mt-2">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>

              <div class="mt-3 flex items-center justify-between gap-2">
                <button id="hint-btn" class="text-sm bg-purple-600 text-white px-3 py-1.5 rounded-md shadow hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">íŒíŠ¸</button>
                <button id="review-flag-toggle" class="text-sm px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-100 flex items-center gap-1" aria-pressed="false" title="ë³µìŠµ í•„ìš” í† ê¸€">
                  <span class="text-yellow-500">â˜†</span><span>ë³µìŠµ í•„ìš”</span>
                </button>
              </div>

              <div id="hint-container" class="hidden mt-3 text-sm bg-purple-50 border border-purple-200 text-purple-800 rounded-lg p-3 dark:bg-indigo-900 dark:border-indigo-700 dark:text-indigo-100"></div>
            </div>

            <div class="flex items-center justify-between mb-2">
              <label for="user-answer" class="text-sm font-medium text-gray-700">ë‹µì•ˆ ì…ë ¥</label>
              <button id="load-prev-answer-btn" class="text-xs text-blue-600 hover:underline">ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
            <textarea id="user-answer" class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition dark:bg-gray-800 dark:text-gray-100 dark:placeholder-gray-400 dark:border-gray-700" rows="8" placeholder="ì—¬ê¸°ì— ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”... (Enter=ì±„ì , Shift+Enter=ì¤„ë°”ê¿ˆ, Ctrl+[=ì´ì „ìœ„ì¹˜, Ctrl+]=í¬ì»¤ìŠ¤/í˜„í™©íŒ)"></textarea>
            <p id="error-message" class="text-red-500 text-sm mt-2 hidden">ë‹µì•ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <p id="hotkey-guide" class="text-xs text-gray-500 mt-2">
              ë‹¨ì¶•í‚¤: Ctrl+â†/â†’ ì´ì „/ë‹¤ìŒ Â· Enter ì±„ì  Â· Shift+Enter ì¤„ë°”ê¿ˆ Â· H íŒíŠ¸ Â· Ctrl+[ ì´ì „ Â· Ctrl+] í¬ì»¤ìŠ¤/í˜„í™©íŒ
            </p>

            <div class="flex justify-between items-center my-5">
              <button id="prev-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">ì´ì „</button>
              <button id="grade-btn" class="bg-green-500 text-white font-bold py-2 px-8 rounded-lg shadow-md hover:bg-green-600 transition duration-200 relative min-w-[120px]">
                <span id="grade-btn-text">ì±„ì í•˜ê¸°</span>
                <div id="grade-loader" class="loader absolute inset-0 m-auto hidden" aria-hidden="true"></div>
              </button>
              <button id="next-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">ë‹¤ìŒ</button>
            </div>
          </div>

          <!-- ê²°ê³¼ -->
          <div id="result-box" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-6 mt-6 dark:bg-gray-800 dark:border-gray-700" aria-live="polite">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ì±„ì  ê²°ê³¼</h3>
            <div id="score-display" class="mb-5">
              <p class="text-lg font-medium text-gray-700">
                ìœ ì‚¬ë„ ì ìˆ˜: <span id="score" class="font-bold text-blue-600 text-2xl">0</span><span class="text-gray-600 text-lg">ì </span>
              </p>
              <div class="w-full bg-gray-200 progress-track rounded-full h-4 mt-2 overflow-hidden shadow-inner">
                <div id="progress-bar" class="h-4 rounded-full transition-all duration-500 ease-out" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="width: 0%"></div>
              </div>
            </div>
            <div class="mb-5">
              <h4 class="text-xl font-semibold text-gray-700 mb-2">ğŸ¤– AI ì´í‰</h4>
              <div id="ai-feedback" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 leading-relaxed min-h-[50px]"></div>
            </div>
            <div>
              <h4 class="text-xl font-semibold text-gray-700 mb-2">ğŸ“˜ ëª¨ë²” ë‹µì•ˆ</h4>
              <pre id="correct-answer" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 text-sm font-sans leading-relaxed"></pre>
            </div>
          </div>

          <!-- í•™ìŠµ í˜„í™©íŒ -->
          <div id="summary-area" class="mt-8 pt-6 border-t hidden">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-3">
              <h3 class="text-xl font-bold text-gray-800">í•™ìŠµ í˜„í™©íŒ (í´ë¦­í•˜ì—¬ ì´ë™)</h3>
              <div class="flex flex-wrap gap-3 items-center">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-gray-600">ë³´ê¸°:</span>
                  <button id="summary-view-all" class="px-3 py-1.5 text-sm border rounded bg-gray-100 hover:bg-gray-200">ëª¨ë“  ë‹¨ì›ë³´ê¸°</button>
                  <button id="summary-view-current" class="px-3 py-1.5 text-sm border rounded">í˜„ì¬ í•™ìŠµë‹¨ì›ë³´ê¸°</button>
                </div>
                <div class="flex gap-4">
                  <button id="clear-filter-btn" class="text-sm text-blue-700 hover:underline dark:text-blue-300">í•„í„° í•´ì œ</button>
                  <button id="reset-scores-btn" class="text-sm text-red-600 hover:underline dark:text-red-300">í•™ìŠµ ê¸°ë¡ ì´ˆê¸°í™”</button>
                </div>
              </div>
            </div>
            <div id="score-summary" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
      </main>

      <!-- RIGHT: íƒìƒ‰ íŒ¨ë„ (ëª¨ë°”ì¼ì—ì„  ì¤‘ì•™ ì•„ë˜ë¡œ) -->
      <aside id="right-explorer" class="lg:col-span-2 xl:col-span-2 2xl:col-span-2 space-y-4">
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">í•™ìŠµ ë²”ìœ„ í•„í„°</h3>
          <div id="source-filter-side"></div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">ë‹¨ì› ë„¤ë¹„ê²Œì´í„°</h3>
          <div id="explorer-chapters" class="space-y-2"></div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-lg">ë¬¸ì œ ëª©ë¡</h3>
            <input id="explorer-search" class="border rounded px-2 py-1 text-sm" placeholder="ê²€ìƒ‰...">
          </div>
          <div id="explorer-problems" class="space-y-1 max-h-[60vh] overflow-y-auto pr-1"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- API í‚¤ ëª¨ë‹¬ -->
  <div id="api-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1000]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-xl">
      <h2 class="text-xl font-bold text-gray-800">Gemini API í‚¤ ì¸ì¦</h2>
      <p class="text-sm text-gray-600 mt-1">ìµœì´ˆ 1íšŒë§Œ ì…ë ¥í•©ë‹ˆë‹¤. ë¡œì»¬ ì €ì¥ì„ ì²´í¬í•˜ë©´ ë‹¤ìŒë¶€í„°ëŠ” íŒì—…ì´ ëœ¨ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <p class="text-sm mt-2">ì²˜ìŒ ì‚¬ìš©í•˜ì‹œë‚˜ìš”?
        <a href="README.html" target="_blank" rel="noopener" class="underline text-blue-600 dark:text-blue-300">ë„ì›€ë§(README)</a>ë¥¼ í™•ì¸í•˜ì„¸ìš”.
      </p>

      <label for="api-modal-input" class="block text-sm font-medium text-gray-700 mt-4">ğŸ”‘ API Key</label>
      <input type="password" id="api-modal-input"
             class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-gray-100 dark:placeholder-gray-400 dark:border-gray-700"
             placeholder="Google AI Studio API í‚¤" autocomplete="off" spellcheck="false" inputmode="text" />

      <div class="flex items-center gap-2 mt-2">
        <input type="checkbox" id="modal-remember" class="rounded border-gray-300" />
        <label for="modal-remember" class="text-sm text-gray-700">ì´ ë¸Œë¼ìš°ì €ì— í‚¤ ì €ì¥</label>
      </div>
      <p class="text-xs text-yellow-600 mt-1">âš ï¸ ê³µìš© PCì—ì„œëŠ” ì²´í¬ í•´ì œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</p>

      <div class="mt-5 flex justify-end gap-2">
        <button id="api-cancel-btn" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900">ì·¨ì†Œ</button>
        <button id="api-save-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1001]">
    <div role="dialog" aria-modal="true" aria-labelledby="settings-title" class="bg-white dark:bg-gray-900 dark:text-gray-100 rounded-2xl w-full max-w-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-2">
        <h2 id="settings-title" class="text-2xl font-bold">ì„¤ì • âš™ï¸</h2>
        <button id="settings-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white" aria-label="ë‹«ê¸°">âœ•</button>
      </div>

      <!-- API í‚¤ -->
      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">API í‚¤ ì„¤ì •</h3>
        <button id="open-api-key-modal-btn" class="w-full bg-blue-50 border border-blue-300 text-blue-700 font-medium py-2 px-4 rounded-lg hover:bg-blue-100 transition">API í‚¤ ë³€ê²½/ì„¤ì •</button>
      </div>

      <!-- AI ëª¨ë¸ -->
      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">AI ëª¨ë¸ ì„ íƒ</h3>
        <select id="ai-model-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="gemini-2.5-flash">Gemini 2.5 Flash (ê¸°ë³¸)</option>
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (ê²½ëŸ‰)</option>
        </select>
        <p class="text-xs text-gray-500 mt-2">íŒíŠ¸ ë° ì±„ì ì— ì‚¬ìš©ë  AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”.</p>
      </div>

      <!-- ë‹¤í¬ ëª¨ë“œ -->
      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">ë‹¤í¬ ëª¨ë“œ</h3>
        <select id="dark-mode-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="system">ì‹œìŠ¤í…œ ì„¤ì • (ê¸°ë³¸)</option>
          <option value="light">ë¼ì´íŠ¸ ëª¨ë“œ</option>
          <option value="dark">ë‹¤í¬ ëª¨ë“œ</option>
        </select>
      </div>

      <!-- ë°ì´í„° Import/Export -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">ë°ì´í„° ê´€ë¦¬</h3>
        <div class="flex gap-3">
          <button id="export-data-btn" class="flex-1 bg-green-50 border border-green-300 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition">ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
          <button id="import-data-btn" class="flex-1 bg-yellow-50 border border-yellow-300 text-yellow-700 font-medium py-2 px-4 rounded-lg hover:bg-yellow-100 transition">ğŸ“¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
        </div>
        <input type="file" id="import-file-input" accept=".json" class="hidden" />
        <p class="text-xs text-gray-500 mt-2">í•™ìŠµ ê¸°ë¡ ë° ì„¤ì •ì„ ë°±ì—…í•˜ê±°ë‚˜ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>

      <div class="flex justify-end">
        <button id="settings-close-btn-bottom" class="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë‚´ì¥ ë°ì´í„°(JSON) -->
  <script id="dataset-json" type="application/json">[
    {
      "ê³ ìœ ID": "q_001",
      "í‘œì‹œë²ˆí˜¸": "1",
      "ì¶œì²˜": "S",
      "problemTitle": "íšŒê³„ê°ì‚¬ì˜ ê³ ìœ í•œê³„ ì›ì¸ ì„¸ ê°€ì§€",
      "ë‹¨ì›": 1,
      "ë¬¼ìŒë²ˆí˜¸": 1,
      "ë¬¼ìŒ": "íšŒê³„ê°ì‚¬ì—ëŠ” ê³ ìœ í•œê³„ê°€ ì¡´ì¬í•œë‹¤. ê·¸ ì›ì¸ì„ ì„¸ ê°€ì§€ ì“°ì‹œì˜¤.",
      "ì •ë‹µ": "ISA 200-A47 â‘  ì¬ë¬´ë³´ê³ ì˜ ì„±ê²© â‘¡ ê°ì‚¬ì ˆì°¨ì˜ ì„±ê²© â‘¢ í•©ë¦¬ì  ì‹œê°„Â·ë¹„ìš© ì œì•½"
    },
    {
      "ê³ ìœ ID": "q_002",
      "í‘œì‹œë²ˆí˜¸": "2",
      "ì¶œì²˜": "H",
      "problemTitle": "ì ì‹œì„±ê³¼ ë¹„ìš©-íš¨ìµ ê³ ë ¤ ì‹œ ì±„íƒí•˜ëŠ” ì ˆì°¨",
      "ë‹¨ì›": 1,
      "ë¬¼ìŒë²ˆí˜¸": 2,
      "ë¬¼ìŒ": "ê°ì‚¬ì¸ì€ ì ì‹œì„±ê³¼ ë¹„ìš©-íš¨ìµ ê· í˜•ì„ ê³ ë ¤í•œë‹¤. ì´ì— ë”°ë¼ ì±„íƒí•˜ëŠ” ì ˆì°¨ ì„¸ ê°€ì§€ëŠ”?",
      "ì •ë‹µ": "ISA 200-A51 â‘  íš¨ê³¼ì  ê³„íš â‘¡ ìœ„í—˜ ë†’ì€ ë¶„ì•¼ ì§‘ì¤‘ â‘¢ í…ŒìŠ¤íŠ¸ ë“± í‘œë³¸ ì‚¬ìš©"
    },
    {
      "ê³ ìœ ID": "q_003",
      "í‘œì‹œë²ˆí˜¸": "3",
      "ì¶œì²˜": "SS",
      "problemTitle": "ìƒ˜í”Œ ë¬¸ì œ",
      "ë‹¨ì›": 1,
      "ë¬¼ìŒë²ˆí˜¸": 3,
      "ë¬¼ìŒ": "â€¦",
      "ì •ë‹µ": "â€¦"
    }
  ]</script>

  <script type="module">
    /* =========================================================
     * ê°ë¦°ì´ v3.x + íŒ¨ì¹˜ í†µí•©ë³¸
     * - ì›”~ì¼(ì›”ìš”ì¼ ì‹œì‘) ë‹¬ë ¥: ë‚ ì§œ í‘œì‹œ + ìˆ«ì ë°°ê²½ ìƒ‰ê°•ë„ = í’€ì´ëŸ‰
     * - 'ì˜¤ëŠ˜ì˜ í†µê³„' + ì„¸ëª¨ ë“œë¡­ë‹¤ìš´(ì˜¤ëŠ˜/ì£¼ê°„/ì›”ê°„), ëª©í‘œ/ìŠ¤íŠ¸ë¦­/ì•½í•œ ë‹¨ì›
     * - ëª¨ë°”ì¼ ì„¸ë¡œ: ì¢Œì¸¡íŒ¨ë„ í–„ë²„ê±° ë“œë¡œì–´, ì¤‘ì•™â†’ìš°ì¸¡ ìˆœì„œ, ì¤‘ì•™ í­ í™•ì¥
     * - ìš°ì¸¡ ë¬¸ì œëª©ë¡: problemTitle í‘œì‹œ ë° ê¸¸ì´ ëŒ€ì‘
     * ========================================================= */

    // ===== ì „ì—­ ìƒíƒœ =====
    let allData = [];
    let currentQuizData = [];
    let currentQuestionIndex = 0;
    let questionScores = {};
    let geminiApiKey = '';
    let activeHintQuestionKey = null;
    let selectedAiModel = 'gemini-2.5-flash';
    let darkMode = 'system';
    let prevLoaded = false;
    let summaryViewMode = 'ALL';

    // Stats view (day/week/month)
    const STATS_VIEW_KEY = 'statsView_v1';
    let statsView = localStorage.getItem(STATS_VIEW_KEY) || 'day';
    function setStatsView(v){ statsView = v; localStorage.setItem(STATS_VIEW_KEY, v); renderStats(); }

    // ìº˜ë¦°ë” ë·°(í˜„ì¬ ë‹¬)
    let calendarView = new Date(); // ì˜¤ëŠ˜ ê¸°ì¤€ ì›”

    // Ctrl] / Ctrl[
    let ctrlNavState = 'dashboard';
    let lastScrollYBeforeFocus = 0;

    // ===== DOM =====
    const el = {
      toast: document.getElementById('toast'),
      apiModal: document.getElementById('api-modal'),
      apiModalInput: document.getElementById('api-modal-input'),
      apiModalRemember: document.getElementById('modal-remember'),
      apiModalSaveBtn: document.getElementById('api-save-btn'),
      apiModalCancelBtn: document.getElementById('api-cancel-btn'),
      settingsBtn: document.getElementById('settings-btn'),
      settingsModal: document.getElementById('settings-modal'),
      settingsCloseBtn: document.getElementById('settings-close-btn'),
      settingsCloseBtnBottom: document.getElementById('settings-close-btn-bottom'),
      openApiKeyModalBtn: document.getElementById('open-api-key-modal-btn'),
      aiModelSelect: document.getElementById('ai-model-select'),
      darkModeSelect: document.getElementById('dark-mode-select'),
      exportDataBtn: document.getElementById('export-data-btn'),
      importDataBtn: document.getElementById('import-data-btn'),
      importFileInput: document.getElementById('import-file-input'),

      chapterSelect: document.getElementById('chapter-select'),
      filterSelect: document.getElementById('filter-select'),
      loadQuizBtn: document.getElementById('load-quiz-btn'),
      randomQuizBtn: document.getElementById('random-quiz-btn'),
      quizArea: document.getElementById('quiz-area'),
      questionNumber: document.getElementById('question-number'),
      questionText: document.getElementById('question-text'),
      questionCounter: document.getElementById('question-counter'),
      userAnswer: document.getElementById('user-answer'),
      errorMessage: document.getElementById('error-message'),
      prevBtn: document.getElementById('prev-btn'),
      nextBtn: document.getElementById('next-btn'),
      gradeBtn: document.getElementById('grade-btn'),
      gradeBtnText: document.getElementById('grade-btn-text'),
      gradeLoader: document.getElementById('grade-loader'),
      hintBtn: document.getElementById('hint-btn'),
      hintBox: document.getElementById('hint-container'),
      loadPrevAnswerBtn: document.getElementById('load-prev-answer-btn'),
      resultBox: document.getElementById('result-box'),
      score: document.getElementById('score'),
      progressBar: document.getElementById('progress-bar'),
      aiFeedback: document.getElementById('ai-feedback'),
      correctAnswer: document.getElementById('correct-answer'),
      summaryArea: document.getElementById('summary-area'),
      scoreSummary: document.getElementById('score-summary'),
      clearFilterBtn: document.getElementById('clear-filter-btn'),
      resetScoresBtn: document.getElementById('reset-scores-btn'),
      summaryViewAllBtn: document.getElementById('summary-view-all'),
      summaryViewCurrentBtn: document.getElementById('summary-view-current'),
      dbQuestionId: document.getElementById('db-question-id'),
      fixedHeader: document.getElementById('fixed-header'),

      layoutRoot: document.getElementById('layout-root'),
      // ë‹¬ë ¥
      calendarGrid: document.getElementById('calendar-grid'),
      calendarMonthLabel: document.getElementById('calendar-month-label'),
      // í†µê³„
      statsOverview: document.getElementById('stats-overview'),
      // ë³µìŠµ ì „ëµ
      reviewStrategySelect: document.getElementById('review-strategy-select'),
      startReviewBtn: document.getElementById('start-review-btn'),
      // ì¶œì²˜ í•„í„°
      sourceFilterSide: document.getElementById('source-filter-side'),
      sourceGroupFilter: document.getElementById('source-group-filter'),
      // íƒìƒ‰ íŒ¨ë„
      explorerChapters: document.getElementById('explorer-chapters'),
      explorerProblems: document.getElementById('explorer-problems'),
      explorerSearch: document.getElementById('explorer-search'),
      // ë³µìŠµ í”Œë˜ê·¸
      reviewFlagToggle: document.getElementById('review-flag-toggle'),

      // ëª¨ë°”ì¼ ë“œë¡œì–´
      hamburger: document.getElementById('hamburger'),
      leftDashboard: document.getElementById('left-dashboard'),
      drawerBackdrop: document.getElementById('drawer-backdrop'),
    };

    // ===== ìœ í‹¸ =====
    const clamp = (v, min, max) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return min;
      return Math.max(min, Math.min(max, n));
    };
    const sanitizeModelText = (t) => {
      let s = (t || '').trim();
      if (s.startsWith('```')) s = s.replace(/^```[\s\S]*?\n/, '').replace(/```$/, '').trim();
      s = s.replace(/^\uFEFF/, '');
      const start = s.indexOf('{'), end = s.lastIndexOf('}');
      if (start !== -1 && end !== -1 && end > start) s = s.slice(start, end + 1);
      return s;
    };
    const normId = (v) => String(v).trim();
    const toNum = (v) => { const n = Number(v); return Number.isFinite(n) ? n : null; };
    function showToast(msg, type = 'info') {
      const base = 'px-4 py-2 rounded shadow text-sm mb-2';
      const color = type === 'error' ? 'bg-red-600 text-white' : type === 'warn' ? 'bg-yellow-500 text-white' : 'bg-gray-900 text-white';
      el.toast.classList.remove('hidden');
      const item = document.createElement('div');
      item.className = `${base} ${color}`;
      item.textContent = msg;
      el.toast.appendChild(item);
      setTimeout(() => { item.remove(); if (!el.toast.hasChildNodes()) el.toast.classList.add('hidden'); }, 3500);
    }

    // ìŠ¤í¬ë¡¤ ìœ í‹¸
    function getHeaderOffset() {
      const h = el.fixedHeader;
      return h ? (h.getBoundingClientRect().height || h.offsetHeight || 0) : 0;
    }
    function smoothScrollTo(y) { window.scrollTo({ top: y, behavior: 'smooth' }); }
    function elmTop(e) { const r = e.getBoundingClientRect(); return r.top + window.pageYOffset; }
    function ensureRangeVisible({ topEl, bottomEl, topAlign = true }) {
      const header = getHeaderOffset();
      const margin = 12;
      if (topAlign) {
        const targetY = elmTop(topEl) - header - margin;
        smoothScrollTo(targetY < 0 ? 0 : targetY);
      }
      setTimeout(() => {
        const bottomRect = bottomEl.getBoundingClientRect();
        const shortfall = bottomRect.bottom - (window.innerHeight - margin);
        if (shortfall > 0) smoothScrollTo(window.pageYOffset + shortfall);
      }, 160);
    }

    /* ===== ë‹¨ì› ë¼ë²¨/íŒŒíŠ¸ ===== */
    const CHAPTER_LABELS = {
      1:  "ì œ1ì¥ ê°ì‚¬ì™€ íšŒê³„ê°ì‚¬ì˜ ê¸°ë³¸ê°œë…",
      2:  "ì œ2ì¥ ê°ì‚¬ì¸ì˜ ì˜ë¬´, ì±…ì„ ë° ìê²©ìš”ê±´",
      3:  "ì œ3ì¥ ê°ì‚¬ì¸ì˜ ë…ë¦½ì„±ê³¼ í’ˆì§ˆê´€ë¦¬",
      4:  "ì œ1ì¥ ê°ì‚¬ì¸ì˜ ì„ ì„",
      5:  "ì œ2ì¥ ê°ì‚¬ê³„ì•½",
      6:  "ì œ1ì¥ íšŒê³„ê°ì‚¬ìˆ˜í–‰ì„ ìœ„í•œ ê¸°ì´ˆì§€ì‹",
      7:  "ì œ2ì¥ ìœ„í—˜í‰ê°€ì ˆì°¨ì™€ ê³„íšìˆ˜ë¦½",
      8:  "ì œ1ì¥ í†µì œí…ŒìŠ¤íŠ¸ì™€ ìœ„í—˜í‰ê°€ì˜ í™•ì •",
      9:  "ì œ1-2ì¥ ë°ì´í„°ë¶„ì„",
      10: "ì œ2ì¥ ì‹¤ì¦ì ˆì°¨ì˜ ê¸°ì´ˆ",
      11: "ì œ3ì¥ ê¸°ì´ˆì”ì•¡ê³¼ ê±°ë˜ìœ í˜•ë³„ ì‹¤ì¦ì ˆì°¨",
      12: "ì œ4ì¥ íŠ¹ì •í•­ëª©ë³„ ê°ì‚¬ì ˆì°¨",
      13: "ì œ5ì¥ í…ŒìŠ¤íŠ¸í•­ëª©ì˜ ë²”ìœ„ì™€ í‘œë³¸ê°ì‚¬ ë°ì´í„°ë¶„ì„",
      14: "ì œ6ì¥ ì‹¤ì¦ì ˆì°¨ì˜ ë§ˆë¬´ë¦¬ì ˆì°¨",
      15: "ì œ1ì¥ ë¯¸ìˆ˜ì •ì™œê³¡í‘œì‹œì˜ í‰ê°€ì™€ ê°ì‚¬ì˜ê²¬ì˜ í˜•ì„±",
      16: "ì œ2ì¥ ê°ì‚¬ë³´ê³ ì„œì˜ ì‘ì„±ê³¼ ë³´ê³ ",
      17: "ì œ1ì¥ ì¸ì¦ì—…ë¬´ê°œë…ì²´ê³„ì™€ íŠ¹ì •ëª©ì ì¬ë¬´ë³´ê³ ì²´ê³„, ì œ2ì¥ ê·¸ë£¹ì¬ë¬´ì œí‘œì— ëŒ€í•œ ê°ì‚¬",
      18: "ì œ3ì¥ ë‚´ë¶€íšŒê³„ê´€ë¦¬ì œë„ì— ëŒ€í•œ ê°ì‚¬ì™€ ê²€í† ",
      19: "ì œ4ì¥ ì¤‘ê°„ì¬ë¬´ì œí‘œì— ëŒ€í•œ ê²€í† ",
      20: "ì œ5ì¥ ì†Œê·œëª¨ê¸°ì—… ì¬ë¬´ì œí‘œì— ëŒ€í•œ ê°ì‚¬"
    };
    const PART_INSERTIONS = [
      { before: 1,  label: "Part 1. íšŒê³„ê°ì‚¬ì˜ ê¸°ì´ˆ" },
      { before: 4,  label: "Part 2. ê°ì‚¬ì¸ì˜ ì„ ì„ê³¼ ê°ì‚¬ê³„ì•½" },
      { before: 6,  label: "Part 3. íšŒê³„ê°ì‚¬ì˜ ì‹œì‘ê³¼ ìœ„í—˜í‰ê°€ì ˆì°¨" },
      { before: 8,  label: "Part 4. ìœ„í—˜í‰ê°€ì ˆì°¨ì— ëŒ€í•œ ì¶”ê°€ê°ì‚¬ì ˆì°¨" },
      { before: 15, label: "Part 5. ê°ì‚¬ì˜ê²¬ì˜ í˜•ì„±ê³¼ ê°ì‚¬ë³´ê³ ì„œ" },
      { before: 17, label: "Part 6. ê·¸ë£¹ì¬ë¬´ì œí‘œì— ëŒ€í•œ ê°ì‚¬ì™€ ê¸°íƒ€ì¸ì¦ì—…ë¬´" },
    ];
    function chapterLabelText(chStr) {
      const n = Number(chStr);
      const title = CHAPTER_LABELS[n];
      return Number.isFinite(n) ? (title ? `${n}. ${title}` : `ë‹¨ì› ${n}`) : String(chStr);
    }

    // ===== ë‹¤í¬ ëª¨ë“œ =====
    function applyDarkMode() {
      const mode = localStorage.getItem('darkMode') || 'system';
      darkMode = mode;
      if (el.darkModeSelect) el.darkModeSelect.value = mode;

      if (mode === 'dark') document.documentElement.classList.add('dark');
      else if (mode === 'light') document.documentElement.classList.remove('dark');
      else {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      }
    }
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (darkMode === 'system') applyDarkMode();
      });
    }

    // ===== ë°ì´í„° ë¡œë”© =====
    async function loadData() {
      const CANDIDATES = [
        'questions.json',
        './questions.json',
        './data/questions.json',
        './assets/questions.json'
      ];
      const errs = [];

      for (const path of CANDIDATES) {
        try {
          const res = await fetch(path, { cache: 'no-store' });
          if (!res.ok) { errs.push(`${path}: HTTP ${res.status}`); continue; }
          const arr = await res.json();
          if (!Array.isArray(arr)) { errs.push(`${path}: JSON ìµœìƒìœ„ê°€ ë°°ì—´ ì•„ë‹˜`); continue; }
          const need = ['ê³ ìœ ID','ë‹¨ì›','ë¬¼ìŒ','ì •ë‹µ'];
          const bad = arr.findIndex(r => !r || need.some(k => !(k in r)));
          if (bad !== -1) { errs.push(`${path}: í•„ìˆ˜í‚¤ ëˆ„ë½(index ${bad})`); continue; }
          allData = arr;
          console.info('[questions.json] loaded from', path);
          selfTest();
          populateChapterSelect();
          updateSummary();
          return;
        } catch (e) {
          errs.push(`${path}: ${e.message}`);
        }
      }

      try {
        const node = document.getElementById('dataset-json');
        if (!node) throw new Error('dataset-json ì—†ìŒ');
        const text = (node.textContent || '').trim();
        if (!text) throw new Error('ë‚´ì¥ ë°ì´í„° ë¹„ì–´ ìˆìŒ');
        const parsed = JSON.parse(text);
        if (!Array.isArray(parsed)) throw new Error('ë‚´ì¥ ë°ì´í„° ìµœìƒìœ„ê°€ ë°°ì—´ ì•„ë‹˜');
        allData = parsed;
        console.warn('[questions.json] ëª¨ë“  í›„ë³´ ì‹¤íŒ¨. ë‚´ì¥ ë°ì´í„°ë¡œ í´ë°±í•©ë‹ˆë‹¤.', errs);
        showToast('ì™¸ë¶€ DBë¥¼ ëª» ì½ì–´ ë‚´ì¥ ë°ì´í„°ë¡œ í´ë°±í–ˆìŠµë‹ˆë‹¤(ìì„¸í•œ ì›ì¸ì€ ì½˜ì†”).', 'warn');
        selfTest();
        populateChapterSelect();
        updateSummary();
      } catch (err) {
        console.error('ì§ˆë¬¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ìƒì„¸:', errs, err);
        showToast(`ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ì½˜ì†”ì—ì„œ ì›ì¸ì„ í™•ì¸í•˜ì„¸ìš”.`, 'error');
        const msg = document.getElementById('question-text');
        if (msg) msg.textContent = 'ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (questions.json ë˜ëŠ” dataset-jsonì„ í™•ì¸í•˜ì„¸ìš”).';
      }
    }
    function selfTest() {
      const missing = [];
      allData.forEach((row, i) => {
        if (!(row && 'ê³ ìœ ID' in row && 'ë‹¨ì›' in row && 'ë¬¼ìŒ' in row && 'ì •ë‹µ' in row)) missing.push(i + 1);
      });
      if (missing.length) showToast(`ê²½ê³ : í•„ìˆ˜ í•„ë“œ ëˆ„ë½ ${missing.length}ê°œ`, 'warn');

      const seen = new Set(); const dup = [];
      for (const r of allData) {
        const key = String(r.ê³ ìœ ID).trim();
        if (seen.has(key)) dup.push(key); else seen.add(key);
      }
      if (dup.length) showToast(`ê²½ê³ : ì¤‘ë³µ ê³ ìœ ID ${dup.length}ê°œ ë°œê²¬`, 'warn');
      const uniqChapterCount = new Set(allData.map(r => String(r.ë‹¨ì›).trim())).size;
      if (uniqChapterCount === 0) throw new Error('ë‹¨ì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }

    function populateChapterSelect() {
      while (el.chapterSelect.options.length > 1) el.chapterSelect.remove(1);
      const chapters = [...new Set(allData.map(item => String(item.ë‹¨ì›).trim()))].sort((a, b) => {
        const na = Number(a), nb = Number(b);
        if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;
        if (Number.isFinite(na)) return -1;
        if (Number.isFinite(nb)) return 1;
        return a.localeCompare(b, 'ko');
      });

      const inserted = new Set();
      chapters.forEach(ch => {
        const n = Number(ch);
        if (Number.isFinite(n)) {
          PART_INSERTIONS.forEach(p => {
            if (p.before === n && !inserted.has(p.before)) {
              const sep = document.createElement('option');
              sep.textContent = `â”â” ${p.label} â”â”`;
              sep.disabled = true;
              sep.value = `__part_${p.before}`;
              sep.className = 'text-gray-500';
              el.chapterSelect.appendChild(sep);
              inserted.add(p.before);
            }
          });
        }
        const opt = document.createElement('option');
        opt.value = ch;
        opt.textContent = chapterLabelText(ch);
        el.chapterSelect.appendChild(opt);
      });
    }

    // ===== ìƒíƒœ ë¡œë”© =====
    function loadScores() {
      const savedScores = localStorage.getItem('auditQuizScores');
      if (savedScores) {
        try { questionScores = JSON.parse(savedScores); }
        catch { questionScores = {}; localStorage.removeItem('auditQuizScores'); }
      }
    }
    function loadApiKey() {
      const savedSession = sessionStorage.getItem('geminiApiKey');
      const savedLocal = localStorage.getItem('geminiApiKey');
      geminiApiKey = savedSession || savedLocal || '';
    }
    function loadSettings() {
      selectedAiModel = localStorage.getItem('aiModel') || 'gemini-2.5-flash';
      if (el.aiModelSelect) el.aiModelSelect.value = selectedAiModel;
    }

    // ===== ë§ˆì´ê·¸ë ˆì´ì…˜ =====
    function migrateData() {
      const version = localStorage.getItem('schemaVersion');
      if (version === '2') return;

      try {
        const oldScores = localStorage.getItem('auditQuizScores');
        if (!oldScores) { localStorage.setItem('schemaVersion', '2'); return; }

        const parsed = JSON.parse(oldScores);
        const newScores = {};
        const mapping = {};
        allData.forEach(q => {
          const disp = String(q.í‘œì‹œë²ˆí˜¸ ?? '').trim();
          const num = String(q.ë¬¼ìŒë²ˆí˜¸ ?? '').trim();
          if (disp) mapping[disp] = q.ê³ ìœ ID;
          if (num) mapping[num] = q.ê³ ìœ ID;
        });

        Object.keys(parsed).forEach(oldKey => {
          const newKey = mapping[oldKey] || oldKey;
          const oldValue = parsed[oldKey] || {};
          const hist = Array.isArray(oldValue.solveHistory) ? oldValue.solveHistory
                      : (oldValue.score != null ? [{ date: Date.now(), score: Number(oldValue.score)||0 }] : []);
          newScores[newKey] = {
            score: Number(oldValue.score ?? 0),
            feedback: String(oldValue.feedback ?? ''),
            user_answer: String(oldValue.user_answer ?? ''),
            hintUsed: Boolean(oldValue.hintUsed ?? false),
            isSolved: Boolean(oldValue.isSolved ?? (oldValue.score != null)),
            lastSolvedDate: Number(oldValue.lastSolvedDate ?? (hist.length ? hist[hist.length-1].date : Date.now())),
            solveHistory: hist
          };
        });

        localStorage.setItem('auditQuizScores', JSON.stringify(newScores));
        localStorage.setItem('schemaVersion', '2');
        questionScores = newScores;
        showToast('ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ (v3 â†’ v3.x)', 'info');
      } catch (err) {
        console.error('ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', err);
        showToast('ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
      }
    }

    // ===== API í‚¤ ëª¨ë‹¬ =====
    function openApiModal(initial = false) {
      if (initial) el.apiModalCancelBtn.classList.add('hidden');
      else el.apiModalCancelBtn.classList.remove('hidden');
      el.apiModal.classList.remove('hidden'); el.apiModal.classList.add('flex');
      el.apiModalInput.value = geminiApiKey || '';
      el.apiModalRemember.checked = !!localStorage.getItem('geminiApiKey');
      setTimeout(() => el.apiModalInput.focus(), 0);
    }
    function closeApiModal() { el.apiModal.classList.add('hidden'); el.apiModal.classList.remove('flex'); }
    function ensureApiKeyGate() { if (!geminiApiKey) openApiModal(true); }
    el.apiModalSaveBtn.addEventListener('click', () => {
      const key = (el.apiModalInput.value || '').trim();
      if (!key) { showToast('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error'); el.apiModalInput.focus(); return; }
      geminiApiKey = key;
      sessionStorage.setItem('geminiApiKey', key);
      if (el.apiModalRemember.checked) localStorage.setItem('geminiApiKey', key);
      else localStorage.removeItem('geminiApiKey');
      closeApiModal();
      showToast('API í‚¤ ì €ì¥ ì™„ë£Œ');
    });
    el.apiModalCancelBtn.addEventListener('click', () => closeApiModal());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !el.apiModalCancelBtn.classList.contains('hidden')) {
        if (!el.apiModal.classList.contains('hidden')) closeApiModal();
      }
      if (e.key === 'Escape' && !el.settingsModal.classList.contains('hidden')) closeSettingsModal();
    });

    // ===== ì„¤ì • ëª¨ë‹¬ =====
    function openSettingsModal() {
      el.settingsModal.classList.remove('hidden'); el.settingsModal.classList.add('flex');
      if (el.aiModelSelect) el.aiModelSelect.value = selectedAiModel;
      if (el.darkModeSelect) el.darkModeSelect.value = darkMode;
    }
    function closeSettingsModal() { el.settingsModal.classList.add('hidden'); el.settingsModal.classList.remove('flex'); }
    el.settingsBtn.addEventListener('click', openSettingsModal);
    el.settingsCloseBtn.addEventListener('click', closeSettingsModal);
    el.settingsCloseBtnBottom.addEventListener('click', closeSettingsModal);
    el.openApiKeyModalBtn?.addEventListener('click', () => { closeSettingsModal(); openApiModal(false); });

    el.aiModelSelect?.addEventListener('change', (e) => {
      selectedAiModel = e.target.value;
      localStorage.setItem('aiModel', selectedAiModel);
      showToast(`AI ëª¨ë¸ ë³€ê²½: ${selectedAiModel}`);
    });
    el.darkModeSelect?.addEventListener('change', (e) => {
      localStorage.setItem('darkMode', e.target.value);
      applyDarkMode(); showToast('ë‹¤í¬ ëª¨ë“œ ì„¤ì • ë³€ê²½ë¨');
    });

    // ===== Import/Export =====
    el.exportDataBtn?.addEventListener('click', () => {
      try {
        const data = {
          version: '3.x',
          schemaVersion: Number(localStorage.getItem('schemaVersion') || 2),
          exportDate: new Date().toISOString(),
          auditQuizScores: questionScores,
          geminiApiKey: localStorage.getItem('geminiApiKey') || '',
          aiModel: selectedAiModel,
          darkMode: darkMode
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `gamlini_backup_${Date.now()}.json`; a.click();
        URL.revokeObjectURL(url);
        showToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
      } catch (err) { console.error(err); showToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨', 'error'); }
    });
    el.importDataBtn?.addEventListener('click', () => el.importFileInput.click());
    el.importFileInput?.addEventListener('change', (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          if (!data.auditQuizScores) throw new Error('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
          if (data.auditQuizScores) { localStorage.setItem('auditQuizScores', JSON.stringify(data.auditQuizScores)); questionScores = data.auditQuizScores; }
          if (data.geminiApiKey) { localStorage.setItem('geminiApiKey', data.geminiApiKey); geminiApiKey = data.geminiApiKey; }
          if (data.aiModel) { localStorage.setItem('aiModel', data.aiModel); selectedAiModel = data.aiModel; el.aiModelSelect.value = data.aiModel; }
          if (data.darkMode) { localStorage.setItem('darkMode', data.darkMode); darkMode = data.darkMode; applyDarkMode(); }
          if (data.schemaVersion) localStorage.setItem('schemaVersion', String(data.schemaVersion));
          showToast('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ'); setTimeout(() => location.reload(), 800);
        } catch (err) { console.error(err); showToast(`ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`, 'error'); }
      };
      reader.readAsText(file); e.target.value = '';
    });

    // ===== ì¶œì²˜ ê·¸ë£¹ í•„í„° =====
    const SOURCE_LS = 'sourceFilterSelectionV1';
    const BASIC_TAGS = ['S','H','HS'];
    const ADV_TAGS   = ['SS','P'];
    function buildSourceFilterUI() {
      if (!el.sourceGroupFilter) return;
      el.sourceGroupFilter.innerHTML = `
        <div class="rounded-xl border p-3">
          <div class="text-sm font-semibold mb-2">ì¶œì²˜ë³„ í•„í„°</div>
          <div class="flex flex-wrap gap-3">
            <label class="text-sm flex items-center gap-1">
              <input type="checkbox" value="basic" class="source-filter"> ê¸°ë³¸(S/H/HS)
            </label>
            <label class="text-sm flex items-center gap-1">
              <input type="checkbox" value="advanced" class="source-filter"> ì‹¬í™”(SS/P)
            </label>
            <label class="text-sm flex items-center gap-1">
              <input type="checkbox" value="other" class="source-filter"> ê¸°íƒ€
            </label>
            <button id="source-filter-all" class="ml-auto text-xs px-2 py-1 border rounded">ì „ì²´</button>
            <button id="source-filter-none" class="text-xs px-2 py-1 border rounded">í•´ì œ</button>
          </div>
        </div>
      `;
      const saved = JSON.parse(localStorage.getItem(SOURCE_LS) || '["basic","advanced","other"]');
      el.sourceGroupFilter.querySelectorAll('input.source-filter').forEach(cb=>{
        cb.checked = saved.includes(cb.value);
        cb.addEventListener('change', ()=>{
          const arr = getSelectedSourceGroups();
          localStorage.setItem(SOURCE_LS, JSON.stringify(arr));
          handleLoadQuiz(); updateSummary(); refreshPanels();
        });
      });
      el.sourceGroupFilter.querySelector('#source-filter-all')?.addEventListener('click', ()=>{
        el.sourceGroupFilter.querySelectorAll('input.source-filter').forEach(cb=>cb.checked=true);
        localStorage.setItem(SOURCE_LS, JSON.stringify(['basic','advanced','other']));
        handleLoadQuiz(); updateSummary(); refreshPanels();
      });
      el.sourceGroupFilter.querySelector('#source-filter-none')?.addEventListener('click', ()=>{
        el.sourceGroupFilter.querySelectorAll('input.source-filter').forEach(cb=>cb.checked=false);
        localStorage.setItem(SOURCE_LS, JSON.stringify([]));
        handleLoadQuiz(); updateSummary(); refreshPanels();
      });
    }
    function getSelectedSourceGroups() {
      const boxes = el.sourceGroupFilter?.querySelectorAll('input.source-filter');
      if (!boxes || boxes.length===0) return JSON.parse(localStorage.getItem(SOURCE_LS) || '["basic","advanced","other"]');
      const arr = []; boxes.forEach(cb=>{ if (cb.checked) arr.push(cb.value); }); return arr;
    }
    function detectSourceGroup(srcStr) {
      const s = String(srcStr || '').toUpperCase();
      const tokens = s.split(/\s*[;,\/\s]\s*/).filter(Boolean);
      let hasBasic = tokens.some(t => BASIC_TAGS.includes(t));
      let hasAdv   = tokens.some(t => ADV_TAGS.includes(t));
      if (hasBasic && !hasAdv) return 'basic';
      if (!hasBasic && hasAdv) return 'advanced';
      if (hasBasic && hasAdv)  return 'basic-advanced';
      return 'other';
    }
    function applySourceFilter(dataArr) {
      const selected = new Set(getSelectedSourceGroups());
      if (selected.size === 0 || selected.size === 3) return dataArr;
      return (dataArr || []).filter(q=>{
        const g = detectSourceGroup(q.ì¶œì²˜);
        if (g === 'basic-advanced') return selected.has('basic') || selected.has('advanced');
        return selected.has(g);
      });
    }

    // ===== í•„í„°/í•™ìŠµ ë¡œì§ =====
    el.chapterSelect.addEventListener('change', handleLoadQuiz);
    el.filterSelect.addEventListener('change', handleLoadQuiz);
    el.loadQuizBtn.addEventListener('click', handleLoadQuiz);
    el.randomQuizBtn.addEventListener('click', () => {
      const selectedChapter = el.chapterSelect.value;
      const selectedFilter = el.filterSelect.value;

      let filtered = allData;
      if (selectedChapter) filtered = allData.filter(q => String(q.ë‹¨ì›).trim() === String(selectedChapter));
      filtered = applySourceFilter(filtered);

      filtered = filtered.filter(q => {
        const key = normId(q.ê³ ìœ ID); const saved = questionScores[key];
        if (selectedFilter === 'unanswered') return !saved;
        if (selectedFilter === '80') return !saved || Number(saved.score) < 80;
        if (selectedFilter === '60') return !saved || Number(saved.score) < 60;
        if (selectedFilter === 'today-review') return true;
        return true;
      });
      if (selectedFilter === 'today-review') filtered = prioritizeTodayReview(filtered).slice(0, 10);

      if (filtered.length === 0) { showToast('ì„ íƒí•œ ì¡°ê±´ì— ë§ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.', 'warn'); return; }
      currentQuizData = filtered;
      currentQuestionIndex = Math.floor(Math.random() * filtered.length);
      el.quizArea.classList.remove('hidden');
      el.summaryArea.classList.remove('hidden');
      displayQuestion();
      updateSummary(); refreshPanels();
      showToast('ëœë¤ ë¬¸ì œ ì‹œì‘!');
    });

    function handleLoadQuiz() {
      const selectedChapter = el.chapterSelect.value;
      const selectedFilter = el.filterSelect.value;

      let filtered = allData;
      if (selectedChapter) filtered = allData.filter(q => String(q.ë‹¨ì›).trim() === String(selectedChapter));
      filtered = applySourceFilter(filtered);
      filtered = filtered.filter(q => {
        const key = normId(q.ê³ ìœ ID); const saved = questionScores[key];
        if (selectedFilter === 'unanswered') return !saved;
        if (selectedFilter === '80') return !saved || Number(saved.score) < 80;
        if (selectedFilter === '60') return !saved || Number(saved.score) < 60;
        if (selectedFilter === 'today-review') return true;
        return true;
      });
      if (selectedFilter === 'today-review') filtered = prioritizeTodayReview(filtered).slice(0, 10);

      currentQuizData = filtered; currentQuestionIndex = 0;
      if (currentQuizData.length > 0) {
        el.quizArea.classList.remove('hidden'); el.summaryArea.classList.remove('hidden'); displayQuestion();
      } else {
        el.quizArea.classList.add('hidden'); el.summaryArea.classList.remove('hidden'); showToast('ì„ íƒí•œ ì¡°ê±´ì— ë§ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.', 'warn');
      }
      updateSummary(); refreshPanels();
    }

    // ===== ë¬¸ì œ í‘œì‹œ =====
    function displayQuestion() {
      if (currentQuizData.length === 0) { el.quizArea.classList.add('hidden'); return; }
      el.quizArea.classList.remove('hidden');
      const q = currentQuizData[currentQuestionIndex];
      el.questionNumber.textContent = `ë¬¸í•­ ${q.í‘œì‹œë²ˆí˜¸ || q.ë¬¼ìŒë²ˆí˜¸ || q.ê³ ìœ ID}`;
      el.questionText.textContent = q.ë¬¼ìŒ;
      el.questionCounter.textContent = `${currentQuestionIndex + 1} / ${currentQuizData.length}`;
      if (el.dbQuestionId) el.dbQuestionId.textContent = `ID: ${q.ê³ ìœ ID ?? '-'}`;

      activeHintQuestionKey = null; el.hintBox.classList.add('hidden'); el.hintBox.innerHTML = '';
      el.resultBox.classList.add('hidden'); el.userAnswer.value = '';
      if (el.loadPrevAnswerBtn) { el.loadPrevAnswerBtn.textContent = 'ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°'; el.loadPrevAnswerBtn.removeAttribute('aria-pressed'); prevLoaded = false; }

      const saved = questionScores[normId(q.ê³ ìœ ID)];
      const flagged = !!(saved?.userReviewFlag);
      if (el.reviewFlagToggle) {
        el.reviewFlagToggle.setAttribute('aria-pressed', flagged ? 'true' : 'false');
        el.reviewFlagToggle.querySelector('span').textContent = flagged ? 'â˜…' : 'â˜†';
      }
      if (saved && saved.score !== undefined) showResult(saved.score, saved.feedback, q.ì •ë‹µ);

      el.prevBtn.disabled = currentQuestionIndex === 0;
      el.nextBtn.disabled = currentQuizData.length - 1 === currentQuestionIndex;
      updateSummaryHighlight();
    }

    // ë³µìŠµ í”Œë˜ê·¸
    el.reviewFlagToggle?.addEventListener('click', () => {
      if (currentQuizData.length === 0) return;
      const q = currentQuizData[currentQuestionIndex];
      const key = normId(q.ê³ ìœ ID);
      const rec = questionScores[key] || {};
      const next = !rec.userReviewFlag;
      rec.userReviewFlag = next;
      questionScores[key] = { ...rec };
      try { localStorage.setItem('auditQuizScores', JSON.stringify(questionScores)); } catch {}
      el.reviewFlagToggle.setAttribute('aria-pressed', next ? 'true' : 'false');
      el.reviewFlagToggle.querySelector('span').textContent = next ? 'â˜…' : 'â˜†';
      showToast(next ? 'ë³µìŠµ í•„ìš”ì— ì¶”ê°€' : 'ë³µìŠµ í•„ìš” í•´ì œ');
      refreshPanels();
    });

    // ì´ì „ ë‹µì•ˆ í† ê¸€
    el.loadPrevAnswerBtn.addEventListener('click', () => {
      if (currentQuizData.length === 0) return;
      const q = currentQuizData[currentQuestionIndex];
      const saved = questionScores[normId(q.ê³ ìœ ID)];
      if (!prevLoaded) {
        if (saved && saved.user_answer) {
          el.userAnswer.value = saved.user_answer;
          el.loadPrevAnswerBtn.textContent = 'ë‹µì•ˆ ì§€ìš°ê¸°';
          el.loadPrevAnswerBtn.setAttribute('aria-pressed', 'true');
          prevLoaded = true; showToast('ì´ì „ ë‹µì•ˆì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } else showToast('ì €ì¥ëœ ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤.', 'warn');
      } else {
        el.userAnswer.value = '';
        el.loadPrevAnswerBtn.textContent = 'ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°';
        el.loadPrevAnswerBtn.setAttribute('aria-pressed', 'false');
        prevLoaded = false;
      }
    });

    // ë„¤ë¹„
    el.prevBtn.addEventListener('click', () => { if (currentQuestionIndex > 0) { currentQuestionIndex--; displayQuestion(); } });
    el.nextBtn.addEventListener('click', () => { if (currentQuestionIndex < currentQuizData.length - 1) { currentQuestionIndex++; displayQuestion(); } });
    el.userAnswer.addEventListener('input', () => el.errorMessage.classList.add('hidden'));

    // ì±„ì 
    el.gradeBtn.addEventListener('click', handleGrade);
    async function handleGrade() {
      if (!geminiApiKey) { openApiModal(false); showToast('Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
      const answer = el.userAnswer.value.trim();
      if (!answer) { el.errorMessage.textContent = 'ë‹µì•ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'; el.errorMessage.classList.remove('hidden'); el.userAnswer.focus(); return; }
      el.errorMessage.classList.add('hidden');

      const q = currentQuizData[currentQuestionIndex];
      const qKey = normId(q.ê³ ìœ ID);

      setLoading(true);
      try {
        const result = await callGeminiAPI(answer, q.ì •ë‹µ, geminiApiKey);
        let finalScore = result.score;
        let finalFeedback = result.feedback;
        if (activeHintQuestionKey === qKey) {
          finalScore = Math.min(59, Math.max(0, Math.round(finalScore * 0.8)));
          finalFeedback = `${finalFeedback ? finalFeedback + ' ' : ''}(íŒíŠ¸ì‚¬ìš©ìœ¼ë¡œ ê°ì )`;
        }
        showResult(finalScore, finalFeedback, q.ì •ë‹µ);

        const existing = questionScores[qKey] || {};
        const newHistory = [...(existing.solveHistory || [])];
        newHistory.push({ date: Date.now(), score: finalScore });

        questionScores[qKey] = {
          score: finalScore,
          feedback: finalFeedback,
          user_answer: answer,
          hintUsed: activeHintQuestionKey === qKey,
          isSolved: true,
          lastSolvedDate: Date.now(),
          solveHistory: newHistory,
          userReviewFlag: !!existing.userReviewFlag
        };

        try { localStorage.setItem('auditQuizScores', JSON.stringify(questionScores)); } catch (e) { showToast('localStorage ì €ì¥ ì‹¤íŒ¨ (ìš©ëŸ‰ ì´ˆê³¼ ê°€ëŠ¥)', 'error'); }

        const { increased, uniqueReads } = registerUniqueRead(qKey);
        if (increased) showToast(`íšŒë… +1 (ì´ ë¬¸ì œ ê³ ìœ  ${uniqueReads}íšŒ)`);
        updateSummary(); refreshPanels();
      } catch (e) {
        console.error('ì±„ì  ì˜¤ë¥˜:', e);
        el.aiFeedback.textContent = `ì±„ì  ì¤‘ ì˜¤ë¥˜: ${e.message}`;
        el.score.textContent = 'Error'; el.progressBar.style.width = '0%'; el.resultBox.classList.remove('hidden');
        showToast('ì±„ì  ìš”ì²­ ì‹¤íŒ¨: API í‚¤/ë„¤íŠ¸ì›Œí¬/í• ë‹¹ëŸ‰ í™•ì¸.', 'error');
      } finally { setLoading(false); }
    }
    function setLoading(isLoading) {
      if (isLoading) {
        el.gradeBtnText.classList.add('hidden'); el.gradeLoader.classList.remove('hidden');
        el.gradeBtn.disabled = true; el.resultBox.classList.add('hidden');
      } else {
        el.gradeBtnText.classList.remove('hidden'); el.gradeLoader.classList.add('hidden');
        el.gradeBtn.disabled = false;
      }
    }

    // Gemini í˜¸ì¶œ(ì±„ì )
    async function callGeminiAPI(userAnswer, correctAnswer, apiKey, retries = 2, delay = 1000) {
      const modelMap = { 'gemini-2.5-flash': 'gemini-2.5-flash', 'gemini-2.5-flash-lite': 'gemini-2.5-flash-lite' };
      const model = modelMap[selectedAiModel] || 'gemini-2.5-flash';
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;

      const generationConfig = {
        responseMimeType: 'application/json',
        responseSchema: { type: 'OBJECT', properties: { score: { type: 'NUMBER' }, feedback: { type: 'STRING' } }, required: ['score','feedback'] }
      };
      const BASE_SYSTEM_PROMPT =
`ë‹¹ì‹ ì€ ë§¤ìš° ì—„ê²©í•œ íšŒê³„ê°ì‚¬ ê³¼ëª© ì±„ì  êµìˆ˜ë‹˜ì…ë‹ˆë‹¤.
- ì‚¬ìš©ì ë‹µì•ˆì„ ëª¨ë²”ë‹µì•ˆê³¼ ë¹„êµí•´ 0~100ì˜ "score"(NUMBER)ì™€ "feedback"(STRING, í•œêµ­ì–´)ì„ JSONìœ¼ë¡œë§Œ ë°˜í™˜í•˜ì„¸ìš”.
- ë„ì–´ì“°ê¸°/ì•½ì¹­(CPA, RMM ë“±) í—ˆìš©. í•µì‹¬í‚¤ì›Œë“œ ì¶©ì‹¤ë„ ìœ„ì£¼.
- ë¶ˆí•„ìš”í•œ ë§/ì½”ë“œë¸”ë¡ ê¸ˆì§€. JSON ê°ì²´ë§Œ ë°˜í™˜.`;

      const systemInstruction = { parts: [{ text: BASE_SYSTEM_PROMPT }] };
      const userQuery = `[ëª¨ë²” ë‹µì•ˆ]\n${correctAnswer}\n\n[ì‚¬ìš©ì ë‹µì•ˆ]\n${userAnswer}\n\n[ì±„ì  ìš”ì²­]\n{"score": number, "feedback": string}`;

      const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction, generationConfig };

      try {
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          const msg = body?.error?.message || res.statusText;
          if ((res.status === 404 || res.status === 400) && /model/i.test(msg)) throw new Error(`ëª¨ë¸/ë²„ì „ ë¶ˆì¼ì¹˜: ${msg}`);
          if (res.status === 429) throw new Error(`API í• ë‹¹ëŸ‰ ì´ˆê³¼ (429)`);
          if (res.status >= 500) throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${res.status})`);
          throw new Error(msg);
        }
        const data = await res.json();
        const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text ?? '';
        const cleaned = sanitizeModelText(raw);
        let parsed; try { parsed = JSON.parse(cleaned); } catch { throw new Error(`API ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨`); }
        const scoreNum = clamp(Number(parsed.score), 0, 100);
        const feedbackStr = String(parsed.feedback || '').trim();
        return { score: scoreNum, feedback: feedbackStr || 'í”¼ë“œë°± ì—†ìŒ' };
      } catch (err) {
        if (retries > 0 && (String(err.message).includes('429') || String(err.message).match(/^ì„œë²„ ì˜¤ë¥˜/))) {
          await new Promise(r => setTimeout(r, delay));
          return callGeminiAPI(userAnswer, correctAnswer, apiKey, retries - 1, delay * 2);
        }
        throw err;
      }
    }

    // íŒíŠ¸
    el.hintBtn.addEventListener('click', () => { if (currentQuizData.length === 0) return; handleHint(currentQuizData[currentQuestionIndex]); });
    async function handleHint(q) {
      if (!geminiApiKey) { openApiModal(false); showToast('Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
      const userAns = el.userAnswer.value.trim();
      const qKey = normId(q.ê³ ìœ ID);

      setLoading(true);
      try {
        const hint = await callGeminiHintAPI(userAns, q.ì •ë‹µ, q.ë¬¼ìŒ, geminiApiKey);
        el.hintBox.innerHTML = `<strong class="font-semibold">íŒíŠ¸</strong><br>${String(hint || '').replace(/\n/g, '<br>')}`;
        el.hintBox.classList.remove('hidden'); activeHintQuestionKey = qKey;
        showToast('íŒíŠ¸ë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤. (ì¦‰ì‹œ ì±„ì  ì‹œ ê°ì )', 'warn');
      } catch (e) { console.error(e); showToast(`íŒíŠ¸ ìƒì„± ì‹¤íŒ¨: ${e.message}`, 'error'); }
      finally { setLoading(false); }
    }
    async function callGeminiHintAPI(userAnswer, correctAnswer, questionText, apiKey, retries = 2, delay = 1000) {
      const modelMap = { 'gemini-2.5-flash': 'gemini-2.5-flash', 'gemini-2.5-flash-lite': 'gemini-2.5-flash-lite' };
      const model = modelMap[selectedAiModel] || 'gemini-2.5-flash';
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;

      const generationConfig = {
        responseMimeType: 'application/json',
        responseSchema: { type: 'OBJECT', properties: { hint: { type: 'STRING' } }, required: ['hint'] }
      };
      const systemInstruction = { parts: [{ text:
`ì—­í• : íšŒê³„ê°ì‚¬ í•™ìŠµ íŠœí„°.
ëª©í‘œ: ì •ë‹µì„ ë…¸ì¶œí•˜ì§€ ì•Šê³  í•µì‹¬ ê°œë…ì„ ë– ì˜¬ë¦¬ê²Œ ë§Œë“œëŠ” 2~4ì¤„ íŒíŠ¸ ì œê³µ.
ì¶œë ¥: JSONë§Œ.` }] };
      const userQuery = `[ë¬¸ì œ]\n${questionText}\n\n[ëª¨ë²” ë‹µì•ˆ]\n${correctAnswer}\n\n[ì‚¬ìš©ì ë‹µì•ˆ]\n${userAnswer || '(ë¯¸ì…ë ¥)'}\n\n[ìš”ì²­]\n{"hint": string }`;

      const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction, generationConfig };
      try {
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          const msg = body?.error?.message || res.statusText;
          if ((res.status === 404 || res.status === 400) && /model/i.test(msg)) throw new Error(`ëª¨ë¸/ë²„ì „ ë¶ˆì¼ì¹˜: ${msg}`);
          if (res.status === 429) throw new Error(`API í• ë‹¹ëŸ‰ ì´ˆê³¼ (429)`);
          if (res.status >= 500) throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${res.status})`);
          throw new Error(msg);
        }
        const data = await res.json();
        const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text ?? '';
        const cleaned = sanitizeModelText(raw);
        let parsed; try { parsed = JSON.parse(cleaned); } catch { throw new Error(`API ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨`); }
        return String(parsed.hint || '').trim();
      } catch (err) {
        if (retries > 0 && (String(err.message).includes('429') || String(err.message).match(/^ì„œë²„ ì˜¤ë¥˜/))) {
          await new Promise(r => setTimeout(r, delay));
          return callGeminiHintAPI(userAnswer, correctAnswer, questionText, apiKey, retries - 1, delay * 2);
        }
        throw err;
      }
    }

    // ê²°ê³¼
    function showResult(scoreVal, feedback, correctAnswer) {
      const s = clamp(Number(scoreVal), 0, 100);
      el.score.textContent = s.toFixed(1);
      el.progressBar.style.width = `${s}%`;
      el.progressBar.setAttribute('aria-valuenow', String(Math.round(s)));
      el.progressBar.className = 'h-4 rounded-full transition-all duration-500 ease-out ' + (s < 60 ? 'bg-red-500' : s < 80 ? 'bg-yellow-500' : 'bg-blue-600');
      el.aiFeedback.textContent = String(feedback || ''); el.correctAnswer.textContent = String(correctAnswer || '');
      el.resultBox.classList.remove('hidden');
    }

    // ìš”ì•½íŒ/í•˜ì´ë¼ì´íŠ¸
    el.summaryViewAllBtn?.addEventListener('click', () => { summaryViewMode = 'ALL'; el.summaryViewAllBtn.classList.add('bg-gray-100'); el.summaryViewCurrentBtn.classList.remove('bg-gray-100'); updateSummary(); });
    el.summaryViewCurrentBtn?.addEventListener('click', () => { summaryViewMode = 'CURRENT'; el.summaryViewCurrentBtn.classList.add('bg-gray-100'); el.summaryViewAllBtn.classList.remove('bg-gray-100'); updateSummary(); });

    // íšŒë…ìˆ˜(ê³ ìœ )
    const READ_STORE_KEY = 'readSessions_v2';
    const UNIQUE_WINDOW_MS = 5 * 60 * 1000;
    function loadReadStore() { try { return JSON.parse(localStorage.getItem(READ_STORE_KEY) || '{}'); } catch { return {}; } }
    function saveReadStore(obj) { localStorage.setItem(READ_STORE_KEY, JSON.stringify(obj)); }
    function computeUniqueReadsFromHistory(history) {
      const times = (Array.isArray(history) ? history : []).map(h => Number(h?.date)).filter(Number.isFinite).sort((a,b)=>a-b);
      if (times.length === 0) return { uniqueReads: 0, lastAt: 0 };
      let count = 0; let last = -Infinity;
      for (const t of times) { if (t - last >= UNIQUE_WINDOW_MS) { count++; last = t; } }
      return { uniqueReads: count, lastAt: times[times.length - 1] };
    }
    function backfillReadStoreFromScores(force = false) {
      if (!force && localStorage.getItem('readStoreBackfilled_v2') === '1') return;
      const db = loadReadStore(); let touched = 0;
      for (const [qid, rec] of Object.entries(questionScores || {})) {
        const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : []; if (hist.length === 0) continue;
        const has = db[qid];
        if (!has || !Number.isFinite(has.uniqueReads) || has.uniqueReads === 0) {
          const seed = computeUniqueReadsFromHistory(hist);
          if (seed.uniqueReads > 0) { db[qid] = seed; touched++; }
        }
      }
      if (touched > 0) saveReadStore(db);
      localStorage.setItem('readStoreBackfilled_v2', '1');
    }
    function registerUniqueRead(questionKey) {
      const t = Date.now();
      const db = loadReadStore(); let rec = db[questionKey];
      if (!rec) {
        const hist = questionScores[questionKey]?.solveHistory;
        rec = Array.isArray(hist) && hist.length > 0 ? computeUniqueReadsFromHistory(hist) : { uniqueReads: 0, lastAt: 0 };
      }
      if (t - (rec.lastAt || 0) >= UNIQUE_WINDOW_MS) {
        rec.uniqueReads = (Number(rec.uniqueReads) || 0) + 1; rec.lastAt = t; db[questionKey] = rec; saveReadStore(db);
        return { increased: true, uniqueReads: rec.uniqueReads };
      } else {
        rec.lastAt = t; db[questionKey] = rec; saveReadStore(db);
        return { increased: false, uniqueReads: rec.uniqueReads };
      }
    }

    // í˜„í™©íŒ
    function updateSummary() {
      el.scoreSummary.innerHTML = '';
      const base = (summaryViewMode === 'CURRENT') ? (currentQuizData || []) : (allData || []);
      const groups = new Map();
      for (const q of base) {
        const ch = String(q.ë‹¨ì›).trim();
        if (!groups.has(ch)) groups.set(ch, []);
        groups.get(ch).push(q);
      }
      const chapters = [...groups.keys()].sort((a, b) => {
        const na = Number(a), nb = Number(b);
        if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;
        if (Number.isFinite(na)) return -1; if (Number.isFinite(nb)) return 1; return a.localeCompare(b, 'ko');
      });

      const readStore = loadReadStore();
      const _clamp = (v, min, max) => Math.max(min, Math.min(max, v));

      chapters.forEach(ch => {
        const nCh = Number(ch);
        if (Number.isFinite(nCh)) {
          const hit = PART_INSERTIONS.find(p => p.before === nCh);
          if (hit) {
            const partDiv = document.createElement('div');
            partDiv.className = 'w-full px-3 py-2 mb-2 rounded-lg border-2 bg-blue-50 border-blue-200 text-blue-800 font-bold';
            partDiv.textContent = hit.label;
            el.scoreSummary.appendChild(partDiv);
          }
        }
        const list = groups.get(ch) || [];
        list.sort((a, b) => {
          const na = Number(a.ë¬¼ìŒë²ˆí˜¸ || a.í‘œì‹œë²ˆí˜¸), nb = Number(b.ë¬¼ìŒë²ˆí˜¸ || b.í‘œì‹œë²ˆí˜¸);
          if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;
          return String(a.í‘œì‹œë²ˆí˜¸ || a.ë¬¼ìŒë²ˆí˜¸).localeCompare(String(b.í‘œì‹œë²ˆí˜¸ || b.ë¬¼ìŒë²ˆí˜¸), 'ko');
        });

        let sum = 0, cnt = 0, sumUniqueReads = 0, latestDate = 0;
        list.forEach(q => {
          const qid = String(q.ê³ ìœ ID).trim();
          const s = questionScores[qid];
          if (s && Number.isFinite(Number(s.score))) { sum += Number(s.score); cnt++; }
          const ur = (() => {
            const rs = readStore[qid];
            if (rs && Number.isFinite(Number(rs.uniqueReads))) return Number(rs.uniqueReads);
            const h = questionScores[qid]?.solveHistory;
            if (Array.isArray(h) && h.length) return computeUniqueReadsFromHistory(h).uniqueReads;
            return 0;
          })();
          sumUniqueReads += ur;
          if (s && s.lastSolvedDate && s.lastSolvedDate > latestDate) latestDate = s.lastSolvedDate;
        });

        const avg = cnt ? (sum / cnt) : null;
        const avgRounds = list.length ? (sumUniqueReads / list.length) : 0;
        const recentText = (latestDate > 0)
          ? (()=>{ const d=Math.floor((Date.now()-latestDate)/(24*60*60*1000)); return d===0?'ì˜¤ëŠ˜':(d===1?'ì–´ì œ':`${d}ì¼ ì „`); })()
          : 'í•™ìŠµ ê¸°ë¡ ì—†ìŒ';
        const ratioText = `ì‘ì‹œ ${cnt}/${list.length}`;
        const avgText = (avg === null) ? '-' : avg.toFixed(1);
        const avgRoundsText = avgRounds.toFixed(1);
        const barW = _clamp(avg ?? 0, 0, 100);
        const barCls = (avg === null) ? 'bg-gray-300' : avg < 60 ? 'bg-red-500' : avg < 80 ? 'bg-yellow-500' : 'bg-green-500';

        const header = document.createElement('div'); header.className = 'px-3 py-2 rounded-md border bg-gray-50 mb-2';
        const title = document.createElement('div'); title.className = 'font-semibold text-lg'; title.textContent = chapterLabelText(ch);
        const meta = document.createElement('div'); meta.className = 'text-sm text-gray-700 mt-1 space-y-1';
        const line1 = document.createElement('div'); line1.textContent = `í‰ê·  ${avgText}ì  Â· ${ratioText}`;
        const line2 = document.createElement('div'); line2.textContent = `í‰ê·  ${avgRoundsText}íšŒë… Â· ìµœê·¼ ${recentText}`;
        meta.appendChild(line1); meta.appendChild(line2);
        const mini = document.createElement('div'); mini.className = 'w-28 h-2 bg-gray-200 rounded-full overflow-hidden mt-2';
        const miniFill = document.createElement('div'); miniFill.className = `h-2 ${barCls}`; miniFill.style.width = `${barW}%`; mini.appendChild(miniFill);
        const toggleWrap = document.createElement('div'); toggleWrap.className = 'mt-2 flex justify-end';
        const toggleBtn = document.createElement('button'); toggleBtn.className = 'text-xs text-blue-700 hover:underline'; toggleBtn.textContent = 'ì ‘ê¸°';
        toggleWrap.appendChild(toggleBtn);
        header.appendChild(title); header.appendChild(meta); header.appendChild(mini); header.appendChild(toggleWrap);

        const grid = document.createElement('div'); grid.className = 'flex flex-wrap gap-2 mt-2 mb-4';
        list.forEach(q => {
          const btn = document.createElement('button');
          const displayOnly = (q.í‘œì‹œë²ˆí˜¸ ?? '').toString().trim();
          const fallback    = (q.ë¬¼ìŒë²ˆí˜¸ ?? q.ê³ ìœ ID ?? '').toString().trim();
          const label       = displayOnly || fallback || '';
          btn.textContent   = label;
          if (label.length >= 3) btn.style.fontSize = '0.72rem';
          if (label.length >= 4) { btn.style.fontSize = '0.66rem'; btn.style.letterSpacing = '-0.2px'; }

          const fullMeta = [
            q.problemTitle && String(q.problemTitle).trim(),
            `í‘œì‹œë²ˆí˜¸:${displayOnly || '-'}`,
            `ë¬¼ìŒë²ˆí˜¸:${(q.ë¬¼ìŒë²ˆí˜¸ ?? '').toString().trim() || '-'}`,
            `ID:${(q.ê³ ìœ ID ?? '').toString().trim() || '-'}`].filter(Boolean).join(' | ');
          btn.title = fullMeta; btn.setAttribute('aria-label', fullMeta);
          btn.classList.add('summary-btn', 'font-medium', 'rounded-lg', 'border');

          const saved = questionScores[String(q.ê³ ìœ ID)?.trim()];
          const sc = saved ? Number(saved.score) : NaN;
          const { bg, txt, bd } =
            !Number.isFinite(sc) ? { bg:'bg-gray-100', txt:'text-gray-600', bd:'border-gray-300' }
            : sc < 60 ? { bg:'bg-red-100', txt:'text-red-700', bd:'border-red-300' }
            : sc < 80 ? { bg:'bg-yellow-100', txt:'text-yellow-700', bd:'border-yellow-300' }
                      : { bg:'bg-green-100', txt:'text-green-700', bd:'border-green-300' };
          btn.classList.add(bg, txt, bd);
          btn.dataset.qid = String(q.ê³ ìœ ID).trim();

          btn.addEventListener('click', () => {
            const idxInCurrent = currentQuizData.findIndex(it => String(it.ê³ ìœ ID).trim() === String(q.ê³ ìœ ID).trim());
            if (idxInCurrent === -1) {
              const chVal = String(q.ë‹¨ì›).trim();
              const newSet = allData.filter(it => String(it.ë‹¨ì›).trim() === chVal);
              if (newSet.length) {
                currentQuizData = newSet;
                currentQuestionIndex = newSet.findIndex(it => String(it.ê³ ìœ ID).trim() === String(q.ê³ ìœ ID).trim());
              }
            } else currentQuestionIndex = idxInCurrent;
            if (currentQuestionIndex < 0) currentQuestionIndex = 0;
            el.quizArea.classList.remove('hidden'); displayQuestion();
            showToast(`'${q.í‘œì‹œë²ˆí˜¸ || q.ë¬¼ìŒë²ˆí˜¸ || q.ê³ ìœ ID}'ë²ˆìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);
          });
          grid.appendChild(btn);
        });

        toggleBtn.addEventListener('click', () => {
          const isHidden = grid.classList.toggle('hidden');
          toggleBtn.textContent = isHidden ? 'í¼ì¹˜ê¸°' : 'ì ‘ê¸°';
        });

        const section = document.createElement('div'); section.className = 'w-full space-y-2 mb-3';
        section.appendChild(header); section.appendChild(grid);
        el.scoreSummary.appendChild(section);
      });
      updateSummaryHighlight();
    }
    function updateSummaryHighlight() {
      if (currentQuizData.length === 0) return;
      const currentQ = String(currentQuizData[currentQuestionIndex].ê³ ìœ ID).trim();
      const buttons = el.scoreSummary.querySelectorAll('button.summary-btn');
      buttons.forEach(b => b.classList.remove('ring-2','ring-blue-500','ring-offset-2'));
      buttons.forEach(b => { if (b.dataset.qid === currentQ) b.classList.add('ring-2','ring-blue-500','ring-offset-2'); });
    }

    // í•„í„° ì´ˆê¸°í™”/ë¦¬ì…‹
    el.clearFilterBtn.addEventListener('click', () => {
      el.filterSelect.value = 'all'; el.chapterSelect.value = '';
      el.sourceGroupFilter?.querySelectorAll('input.source-filter')?.forEach(cb => cb.checked = true);
      localStorage.setItem(SOURCE_LS, JSON.stringify(['basic','advanced','other']));
      handleLoadQuiz(); showToast('í•„í„°ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤. ëª¨ë“  ë¬¸ì œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
    });
    el.resetScoresBtn.addEventListener('click', () => {
      if (confirm('ì •ë§ë¡œ ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        questionScores = {}; localStorage.removeItem('auditQuizScores'); localStorage.removeItem('schemaVersion');
        localStorage.removeItem('readSessions_v2'); localStorage.removeItem('readStoreBackfilled_v2');
        updateSummary(); if (currentQuizData.length > 0) { currentQuestionIndex = 0; handleLoadQuiz(); }
        refreshPanels(); showToast('í•™ìŠµ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    });

    // Ctrl] / Ctrl[
    function ensureResultBoxReady() {
      if (currentQuizData.length) {
        const q = currentQuizData[currentQuestionIndex];
        if (!el.correctAnswer.textContent?.trim()) el.correctAnswer.textContent = String(q.ì •ë‹µ || '');
      }
      el.resultBox.classList.remove('hidden');
    }
    function enterFocusMode() {
      if (!el.userAnswer || !el.resultBox) return;
      lastScrollYBeforeFocus = window.pageYOffset;
      document.documentElement.classList.add('focus-mode');
      ensureResultBoxReady();
      ensureRangeVisible({ topEl: el.userAnswer, bottomEl: el.resultBox, topAlign: true });
      ctrlNavState = 'focus';
    }
    function exitToDashboard() {
      document.documentElement.classList.remove('focus-mode');
      if (el.summaryArea) smoothScrollTo(elmTop(el.summaryArea) - getHeaderOffset() - 8);
      else smoothScrollTo(0);
      ctrlNavState = 'dashboard';
    }
    function backFromFocus() {
      document.documentElement.classList.remove('focus-mode');
      smoothScrollTo(Math.max(0, lastScrollYBeforeFocus));
      ctrlNavState = 'dashboard';
    }
    function isEditing(t) { return t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable); }
    function goTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

    document.addEventListener('keydown', (e) => {
      if ((e.key === 'h' || e.key === 'H') && !isEditing(e.target)) { e.preventDefault(); el.hintBtn?.click(); return; }
      if (e.ctrlKey && !e.altKey && !e.metaKey) {
        if (e.key === 'ArrowLeft')  { e.preventDefault(); el.prevBtn?.click(); return; }
        if (e.key === 'ArrowRight') { e.preventDefault(); el.nextBtn?.click(); return; }
        if (e.key === '[') { e.preventDefault(); if (ctrlNavState === 'focus') backFromFocus(); else goTop(); return; }
        if (e.key === ']') { e.preventDefault(); if (ctrlNavState !== 'focus') enterFocusMode(); else exitToDashboard(); return; }
      }
    });
    el.userAnswer?.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); el.gradeBtn?.click(); } });

    /* ===== ìŠ¤ì½”í”„ ë°ì´í„° ===== */
    function getScopeFilteredData() {
      const bySource = applySourceFilter(allData || []);
      const ch = el.chapterSelect?.value || '';
      if (!ch) return bySource;
      return bySource.filter(q => String(q.ë‹¨ì›).trim() === String(ch));
    }

    /* ===== ë‹¬ë ¥: ì›”~ì¼(ì›”ìš”ì¼ ì‹œì‘), ìˆ«ì ë°°ê²½ ìƒ‰ì¹  ===== */
    function renderCalendar() {
      if (!el.calendarGrid || !el.calendarMonthLabel) return;
      const base = getScopeFilteredData();
      const idSet = new Set(base.map(q => String(q.ê³ ìœ ID).trim()));

      // ë‚ ì§œë³„ í’€ì´ìˆ˜ ì¹´ìš´íŠ¸
      const dayCount = new Map(); // 'YYYY-MM-DD' -> count
      for (const [qid, rec] of Object.entries(questionScores || {})) {
        if (!idSet.has(qid)) continue;
        const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
        for (const h of hist) {
          const t = Number(h?.date); if (!Number.isFinite(t)) continue;
          const d = new Date(t); d.setHours(0,0,0,0);
          const key = d.toISOString().slice(0,10);
          dayCount.set(key, (dayCount.get(key)||0) + 1);
        }
      }

      // í˜„ì¬ ë‹¬ ê³„ì‚°
      const y = calendarView.getFullYear();
      const m = calendarView.getMonth(); // 0-11
      const first = new Date(y, m, 1);
      const last = new Date(y, m+1, 0);
      const firstDow = (first.getDay() + 6) % 7; // ì›”=0, ... ì¼=6
      const daysInMonth = last.getDate();

      el.calendarMonthLabel.textContent = `${y}.${String(m+1).padStart(2,'0')}`;
      el.calendarGrid.innerHTML = '';

      // ì•ìª½ ë¹ˆì¹¸: ì´ì „ë‹¬
      for (let i=0;i<firstDow;i++){
        const cell = document.createElement('div');
        cell.className = 'rounded text-center py-2 text-xs text-gray-400 border border-dashed border-gray-200';
        cell.textContent = ' ';
        el.calendarGrid.appendChild(cell);
      }
      // ì´ë²ˆë‹¬ ë‚ ì§œ
      for (let d=1; d<=daysInMonth; d++){
        const dateObj = new Date(y, m, d); dateObj.setHours(0,0,0,0);
        const key = dateObj.toISOString().slice(0,10);
        const c = dayCount.get(key) || 0;
        let bg = 'bg-gray-200', text='text-gray-800', ring='';
        if (c>=1 && c<=1) { bg='bg-green-200'; text='text-gray-800'; }
        else if (c<=3 && c>=2) { bg='bg-green-300'; text='text-gray-900'; }
        else if (c<=6 && c>=4) { bg='bg-green-500'; text='text-white'; }
        else if (c>=7) { bg='bg-green-700'; text='text-white'; }
        // ì˜¤ëŠ˜ í…Œë‘ë¦¬
        const today = new Date(); today.setHours(0,0,0,0);
        if (dateObj.getTime() === today.getTime()) ring='ring-2 ring-blue-500';

        const cell = document.createElement('div');
        cell.className = `rounded text-center py-2 text-sm border ${bg} ${text} ${ring}`;
        cell.title = `${d}ì¼ Â· í’€ì´ ${c}íšŒ`;
        cell.textContent = String(d);
        el.calendarGrid.appendChild(cell);
      }
      // ë’·ìª½ ë¹ˆì¹¸ ì±„ì›Œ 6ì£¼ ê³ ì •(ê°€ë…ì„±)
      const filled = firstDow + daysInMonth;
      const totalCells = Math.ceil(filled / 7) * 7;
      for (let i=filled; i<totalCells; i++){
        const cell = document.createElement('div');
        cell.className = 'rounded text-center py-2 text-xs text-gray-400 border border-dashed border-gray-200';
        cell.textContent = ' ';
        el.calendarGrid.appendChild(cell);
      }
    }

    /* ===== í†µê³„: ì˜¤ëŠ˜/ì£¼ê°„/ì›”ê°„ (ì„¸ëª¨ ë“œë¡­ë‹¤ìš´) ===== */
    function renderStats() {
      if (!el.statsOverview) return;

      // ê¸°ê°„ ê³„ì‚°
      const now = new Date();
      function startOfDay(d){ const t=new Date(d); t.setHours(0,0,0,0); return t; }
      function endOfDay(d){ const t=new Date(d); t.setHours(23,59,59,999); return t; }
      function startOfWeek(d){ const t=startOfDay(d); const dow=(t.getDay()+6)%7; t.setDate(t.getDate()-dow); return t; }
      function startOfMonth(d){ return startOfDay(new Date(d.getFullYear(), d.getMonth(), 1)); }

      let periodTitle='ì˜¤ëŠ˜ì˜ í†µê³„', viewLabel='ì˜¤ëŠ˜', start=startOfDay(now), end=endOfDay(now);
      if (statsView==='week'){ periodTitle='ì£¼ê°„ í†µê³„'; viewLabel='ì£¼ê°„'; start=startOfWeek(now); end=endOfDay(now); }
      if (statsView==='month'){ periodTitle='ì›”ê°„ í†µê³„'; viewLabel='ì›”ê°„'; start=startOfMonth(now); end=endOfDay(now); }

      const base = getScopeFilteredData();
      const idSet = new Set(base.map(q => String(q.ê³ ìœ ID).trim()));

      // ì „ì²´ í‰ê· /ìµœê·¼í•™ìŠµ/ìŠ¤íŠ¸ë¦­
      let solvedCnt=0, sumScore=0, flagged=0, lastSolvedAt=0;
      const daySet = new Set();
      for (const q of base) {
        const qid = String(q.ê³ ìœ ID).trim(); const rec = questionScores[qid];
        if (rec && Number.isFinite(Number(rec.score))) { solvedCnt += 1; sumScore += Number(rec.score); }
        if (rec?.userReviewFlag) flagged += 1;
        if (rec?.lastSolvedDate && rec.lastSolvedDate>lastSolvedAt) lastSolvedAt = rec.lastSolvedDate;
        const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
        hist.forEach(h=>{ const t=Number(h?.date); if(!Number.isFinite(t)) return; const d=new Date(t); d.setHours(0,0,0,0); daySet.add(d.toISOString().slice(0,10)); });
      }
      const avgAll = solvedCnt? (sumScore/solvedCnt) : null;
      const recentTxt = lastSolvedAt ? (()=>{const d=Math.floor((Date.now()-lastSolvedAt)/(86400000)); return d===0?'ì˜¤ëŠ˜':(d===1?'ì–´ì œ':`${d}ì¼ ì „`);})() : 'ê¸°ë¡ ì—†ìŒ';
      function hasSolved(day){ const k=new Date(day); k.setHours(0,0,0,0); return daySet.has(k.toISOString().slice(0,10)); }
      let streak=0, cur=new Date(); cur.setHours(0,0,0,0); while (hasSolved(cur)) { streak+=1; cur.setDate(cur.getDate()-1); }
      const bestStreakKey='bestStreak_v1';
      const best = Math.max(streak, Number(localStorage.getItem(bestStreakKey)||0));
      if (best > Number(localStorage.getItem(bestStreakKey)||0)) localStorage.setItem(bestStreakKey,String(best));

      // ê¸°ê°„ ì§€í‘œ
      let periodSolves=0, periodScoreSum=0;
      const byChapter = new Map();
      function chRec(ch){ if(!byChapter.has(ch)) byChapter.set(ch,{solves:0,sum:0}); return byChapter.get(ch); }

      for (const q of base) {
        const qid = String(q.ê³ ìœ ID).trim(); const ch  = String(q.ë‹¨ì›).trim();
        const rec = questionScores[qid]; const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
        for (const h of hist) {
          const t = Number(h?.date); const sc = Number(h?.score);
          if (!Number.isFinite(t)) continue;
          if (t >= +start && t <= +end) {
            periodSolves += 1;
            if (Number.isFinite(sc)) periodScoreSum += sc;
            const slot = chRec(ch); slot.solves += 1; if (Number.isFinite(sc)) slot.sum += sc;
          }
        }
      }
      const periodAvg = periodSolves? (periodScoreSum/periodSolves) : null;

      // ì•½í•œ ë‹¨ì› Top3
      const weak = []; byChapter.forEach((v,ch)=>{ if(v.solves>=3) weak.push({ch, avg:v.sum/v.solves, cnt:v.solves}); });
      weak.sort((a,b)=> a.avg-b.avg); const weakTop = weak.slice(0,3);

      // ëª©í‘œ
      const baseDaily = Number(localStorage.getItem('dailyTarget_v1')||20);
      if (!localStorage.getItem('weeklyTarget_v1'))  localStorage.setItem('weeklyTarget_v1', String(baseDaily*7));
      if (!localStorage.getItem('monthlyTarget_v1')) localStorage.setItem('monthlyTarget_v1', String(baseDaily*30));
      const targetKey = statsView==='day' ? 'dailyTarget_v1' : (statsView==='week' ? 'weeklyTarget_v1' : 'monthlyTarget_v1');
      const targetLabel = statsView==='day' ? 'ì˜¤ëŠ˜ ëª©í‘œ' : (statsView==='week' ? 'ì´ë²ˆ ì£¼ ëª©í‘œ' : 'ì´ë²ˆ ë‹¬ ëª©í‘œ');
      const targetVal = Number(localStorage.getItem(targetKey) || (statsView==='day'? baseDaily : (statsView==='week'? baseDaily*7 : baseDaily*30)));
      const pct = Math.max(0, Math.min(100, Math.round((periodSolves / Math.max(1,targetVal))*100)));

      const fmt = (v)=> v==null?'-':(Math.round(v*10)/10).toFixed(1);
      const mkChip = (txt)=> `<button data-go-ch="${txt}" class="px-2 py-0.5 text-xs rounded border hover:bg-gray-50">${chapterLabelText(txt)}</button>`;
      const weakHtml = weakTop.length ? weakTop.map(w=>`${mkChip(w.ch)} <span class="text-xs text-red-600 ml-1">${fmt(w.avg)}ì Â·${w.cnt}íšŒ</span>`).join('<br>') : 'ë°ì´í„° ë¶€ì¡±';

      el.statsOverview.innerHTML = `
        <div class="border rounded p-3 relative">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold" id="stats-title">${periodTitle}</h3>
            <div class="relative">
              <button id="stats-view-btn" class="flex items-center gap-1 text-sm px-2 py-1 rounded border hover:bg-gray-50">
                <span id="stats-view-label">${viewLabel}</span>
                <span id="stats-caret" class="inline-block transition-transform">â–¼</span>
              </button>
              <div id="stats-view-menu" class="hidden absolute right-0 mt-1 w-28 bg-white dark:bg-gray-900 border rounded shadow-md overflow-hidden z-10">
                <button data-view="day"   class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">ì˜¤ëŠ˜</button>
                <button data-view="week"  class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">ì£¼ê°„</button>
                <button data-view="month" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">ì›”ê°„</button>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ê¸°ê°„ í’€ì´</div><div class="text-lg font-semibold">${periodSolves} ê°œ</div></div>
            <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ê¸°ê°„ í‰ê· </div><div class="text-lg font-semibold">${fmt(periodAvg)} ì </div></div>
            <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ìŠ¤íŠ¸ë¦­</div><div class="text-lg font-semibold">${streak} ì¼ <span class="text-xs text-gray-500">(ìµœê³  ${best}ì¼)</span></div></div>
            <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ìŠ¤ì½”í”„ í‰ê· </div><div class="text-lg font-semibold">${fmt(avgAll)} ì </div></div>
          </div>

          <div class="mt-3">
            <div class="flex items-center justify-between">
              <div class="text-[12px] text-gray-500">${targetLabel} ${targetVal}ê°œ</div>
              <div class="text-[12px] text-gray-500">${pct}%</div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
              <div class="h-2 ${pct<60?'bg-red-500':(pct<100?'bg-yellow-500':'bg-green-600')}" style="width:${pct}%;"></div>
            </div>
            <div class="flex items-center gap-2 mt-2">
              <label for="stats-target-input" class="text-xs text-gray-500">ëª©í‘œ:</label>
              <input id="stats-target-input" type="number" min="1" class="w-20 px-2 py-1 text-xs border rounded" value="${targetVal}">
              <button id="apply-stats-target" class="text-xs px-2 py-1 border rounded hover:bg-gray-50">ì ìš©</button>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-3 mt-3">
            <div class="p-2 rounded border">
              <div class="text-[12px] text-gray-500 mb-1">ì•½í•œ ë‹¨ì› Top 3 <span class="text-[11px] text-gray-400">(ê¸°ê°„ ê¸°ì¤€)</span></div>
              <div class="text-sm leading-5">${weakHtml}</div>
            </div>
          </div>

          <div class="text-[12px] text-gray-500 mt-2">ìµœê·¼ í•™ìŠµ: <strong class="text-gray-700">${recentTxt}</strong> Â· ë³µìŠµ í•„ìš”(â˜…): <strong class="text-gray-700">${flagged}</strong></div>
        </div>
      `;

      // ë“œë¡­ë‹¤ìš´
      const btn = document.getElementById('stats-view-btn');
      const caret = document.getElementById('stats-caret');
      const menu = document.getElementById('stats-view-menu');
      function openMenu(){ menu.classList.remove('hidden'); caret.style.transform='rotate(180deg)'; }
      function closeMenu(){ menu.classList.add('hidden'); caret.style.transform='rotate(0deg)'; }
      btn?.addEventListener('click',(e)=>{ e.stopPropagation(); if(menu.classList.contains('hidden')) openMenu(); else closeMenu(); });
      document.addEventListener('click', closeMenu, { once:true });
      menu?.querySelectorAll('[data-view]')?.forEach(item=>{
        item.addEventListener('click', ()=>{ const v=item.getAttribute('data-view'); if (v) setStatsView(v); });
      });
      document.getElementById('apply-stats-target')?.addEventListener('click', ()=>{
        const v = Math.max(1, Math.min(9999, Math.round(Number(document.getElementById('stats-target-input')?.value || 1))));
        localStorage.setItem(targetKey, String(v)); renderStats();
      });
      el.statsOverview.querySelectorAll('[data-go-ch]')?.forEach(b=>{
        b.addEventListener('click', ()=>{ const ch = b.getAttribute('data-go-ch') || ''; if (ch) { el.chapterSelect.value = ch; handleLoadQuiz(); showToast(`${chapterLabelText(ch)} ë¡œ ì´ë™`);} });
      });
    }

    /* ===== íƒìƒ‰ íŒ¨ë„ ===== */
    function renderExplorer() {
      if (!el.explorerChapters || !el.explorerProblems) return;
      const base = getScopeFilteredData();

      const group = new Map();
      for (const q of base) {
        const ch = String(q.ë‹¨ì›).trim();
        if (!group.has(ch)) group.set(ch, []);
        group.get(ch).push(q);
      }
      const chapters = [...group.keys()].sort((a,b)=> {
        const na=Number(a), nb=Number(b);
        if (Number.isFinite(na) && Number.isFinite(nb)) return na-nb;
        if (Number.isFinite(na)) return -1; if (Number.isFinite(nb)) return 1;
        return a.localeCompare(b,'ko');
      });

      el.explorerChapters.innerHTML='';
      chapters.forEach(ch=>{
        const btn=document.createElement('button');
        btn.className='w-full text-left px-3 py-2 rounded border hover:bg-gray-50';
        btn.textContent=chapterLabelText(ch);
        btn.addEventListener('click', ()=>{
          const list = group.get(ch) || [];
          if (list.length){ currentQuizData = list; currentQuestionIndex = 0; el.quizArea.classList.remove('hidden'); displayQuestion(); showToast(`${chapterLabelText(ch)} ë¡œ ì´ë™`); updateSummaryHighlight(); }
        });
        el.explorerChapters.appendChild(btn);
      });

      const q = (el.explorerSearch?.value || '').trim();
      const filtered = base.filter(it=>{ const t = `${it.problemTitle||''} ${it.ë¬¼ìŒ||''}`.toLowerCase(); return !q || t.includes(q.toLowerCase()); });

      el.explorerProblems.innerHTML='';
      filtered.sort((a,b)=>{ const na=Number(a.ë¬¼ìŒë²ˆí˜¸||a.í‘œì‹œë²ˆí˜¸), nb=Number(b.ë¬¼ìŒë²ˆí˜¸||b.í‘œì‹œë²ˆí˜¸); if (Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; return String(a.í‘œì‹œë²ˆí˜¸||a.ë¬¼ìŒë²ˆí˜¸).localeCompare(String(b.í‘œì‹œë²ˆí˜¸||b.ë¬¼ìŒë²ˆí˜¸),'ko'); })
      .forEach(qitem=>{
        const rec = questionScores[String(qitem.ê³ ìœ ID).trim()];
        const score = Number.isFinite(Number(rec?.score))? Number(rec.score): null;
        const flagged = !!(rec?.userReviewFlag || rec?.user_review_flag);

        const row=document.createElement('button');
        row.className='w-full flex items-center justify-between gap-2 px-3 py-1.5 rounded hover:bg-gray-50 border';
        const left=document.createElement('div');
        left.className='flex items-center gap-2 text-sm';
        if(flagged){ const star=document.createElement('span'); star.textContent='â˜…'; star.className='text-purple-500'; left.appendChild(star); }
        const title=document.createElement('span');
        const label = (qitem.problemTitle && String(qitem.problemTitle).trim()) || `ë¬¸í•­ ${qitem.í‘œì‹œë²ˆí˜¸||qitem.ë¬¼ìŒë²ˆí˜¸||qitem.ê³ ìœ ID}`;
        title.textContent = label; title.className = 'block max-w-[16rem] md:max-w-[22rem] lg:max-w-[18rem] xl:max-w-[22rem] truncate';
        left.appendChild(title);

        const right=document.createElement('div');
        right.className='text-xs';
        const badge=document.createElement('span');
        badge.className='px-2 py-0.5 rounded-full border ' + (score==null?'text-gray-600 border-gray-300':'text-blue-700 border-blue-300');
        badge.textContent = score==null? 'ë¯¸í’€ì´' : `${score}`;
        right.appendChild(badge);

        row.appendChild(left); row.appendChild(right);
        row.title = `ì¶œì²˜:${qitem.ì¶œì²˜||'-'} | ID:${qitem.ê³ ìœ ID}`;

        row.addEventListener('click',()=>{
          const ch = String(qitem.ë‹¨ì›).trim();
          const list = base.filter(it=>String(it.ë‹¨ì›).trim()===ch);
          currentQuizData = list.length? list : [qitem];
          currentQuestionIndex = list.findIndex(it=>String(it.ê³ ìœ ID).trim()===String(qitem.ê³ ìœ ID).trim());
          if(currentQuestionIndex<0) currentQuestionIndex=0;
          el.quizArea.classList.remove('hidden'); displayQuestion(); showToast(`'${label}' ë¡œ ì´ë™`);
        });

        el.explorerProblems.appendChild(row);
      });
    }

    // ì¶œì²˜í•„í„° ì´ë™
    function moveSourceFilterToSide() {
      if (!el.sourceFilterSide || !el.sourceGroupFilter) return;
      el.sourceFilterSide.innerHTML=''; el.sourceGroupFilter.classList.remove('mb-6'); el.sourceFilterSide.appendChild(el.sourceGroupFilter);
    }

    // ì¢Œ/ìš° íŒ¨ë„ ê°±ì‹ 
    function refreshPanels() {
      renderCalendar();
      renderStats();
      renderExplorer();
    }

    // ì˜¤ëŠ˜ì˜ ë³µìŠµ ì „ëµ
    const REVIEW_STRATEGY_LS = 'reviewStrategy_v1';
    function getReviewStrategy() { return localStorage.getItem(REVIEW_STRATEGY_LS) || 'smart'; }
    function prioritizeTodayReview(list) {
      const strat = getReviewStrategy();
      if (strat === 'flag') {
        const flagged = list.filter(a => (questionScores[normId(a.ê³ ìœ ID)]?.userReviewFlag));
        const rest = list.filter(a => !(questionScores[normId(a.ê³ ìœ ID)]?.userReviewFlag));
        return flagged.concat(rest);
      }
      if (strat === 'low') {
        return [...list].sort((a,b)=>{ const sa = questionScores[normId(a.ê³ ìœ ID)]?.score ?? 101; const sb = questionScores[normId(b.ê³ ìœ ID)]?.score ?? 101; return sa - sb; });
      }
      if (strat === 'recentWrong') {
        return [...list].sort((a,b)=>{ const sa = questionScores[normId(a.ê³ ìœ ID)]; const sb = questionScores[normId(b.ê³ ìœ ID)]; const as = sa?.score ?? 101, bs = sb?.score ?? 101; const ad = sa?.lastSolvedDate ?? 0, bd = sb?.lastSolvedDate ?? 0; return (as - bs) || (ad - bd); });
      }
      return [...list].sort((a, b) => {
        const sa = questionScores[normId(a.ê³ ìœ ID)], sb = questionScores[normId(b.ê³ ìœ ID)];
        const aflag = sa?.userReviewFlag ? 0 : 1; const bflag = sb?.userReviewFlag ? 0 : 1;
        const aUn = sa ? 1 : 0, bUn = sb ? 1 : 0; const aScore = sa?.score ?? 101, bScore = sb?.score ?? 101;
        const aDate = sa?.lastSolvedDate ?? 0, bDate = sb?.lastSolvedDate ?? 0;
        return (aflag - bflag) || (aUn - bUn) || (aScore - bScore) || (aDate - bDate);
      });
    }
    el.reviewStrategySelect?.addEventListener('change', (e)=>{ localStorage.setItem(REVIEW_STRATEGY_LS, e.target.value); showToast(`ì˜¤ëŠ˜ì˜ ë³µìŠµ ì „ëµ: ${e.target.value}`); refreshPanels(); });
    (function syncStrategy(){ const cur = getReviewStrategy(); if (el.reviewStrategySelect) el.reviewStrategySelect.value = cur; })();
    el.startReviewBtn?.addEventListener('click', ()=>{ if (el.filterSelect) el.filterSelect.value = 'today-review'; handleLoadQuiz(); showToast('ì˜¤ëŠ˜ì˜ ë³µìŠµ ì‹œì‘'); });

    // ëª¨ë°”ì¼: ì¢Œì¸¡íŒ¨ë„ ë“œë¡œì–´
    function openDrawer(){
      document.body.classList.add('drawer-open');
      el.drawerBackdrop.classList.remove('hidden');
      el.leftDashboard.classList.remove('hidden');
      el.leftDashboard.classList.add('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900');
    }
    function closeDrawer(){
      document.body.classList.remove('drawer-open');
      el.drawerBackdrop.classList.add('hidden');
      el.leftDashboard.classList.add('hidden');
      el.leftDashboard.classList.remove('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900');
    }
    el.hamburger?.addEventListener('click', ()=> openDrawer());
    el.drawerBackdrop?.addEventListener('click', ()=> closeDrawer());
    window.addEventListener('resize', ()=>{
      if (window.innerWidth >= 1024) { // lg ì´ìƒ
        el.leftDashboard.classList.remove('hidden');
        el.drawerBackdrop.classList.add('hidden');
        document.body.classList.remove('drawer-open');
        el.leftDashboard.classList.remove('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900');
      } else {
        // ëª¨ë°”ì¼ ê¸°ë³¸ ê°ì¶¤
        el.leftDashboard.classList.add('hidden');
      }
    });

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', async () => {
      try { await loadData(); }
      catch (err) {
        console.error(err);
        document.getElementById('question-text').textContent = 'ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (questions.json ë˜ëŠ” dataset-jsonì„ í™•ì¸í•˜ì„¸ìš”).';
        showToast(`ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}`, 'error');
      }
      loadScores(); loadApiKey(); loadSettings(); applyDarkMode(); migrateData();
      backfillReadStoreFromScores(false); ensureApiKeyGate();

      buildSourceFilterUI(); moveSourceFilterToSide();
      el.explorerSearch?.addEventListener('input', renderExplorer);

      refreshPanels();
    });
  </script>
</body>
</html>
