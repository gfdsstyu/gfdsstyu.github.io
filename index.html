

<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-20Q61B31CM"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-20Q61B31CM');
</script>
  <!-- Google Tag Manager -->
<script>(function (w, d, s, l, i) {
    w[l] = w[l] || []; w[l].push({
        'gtm.start':
        new Date().getTime(), event: 'gtm.js'
    }); var f = d.getElementsByTagName(s)[0],
    j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
})(window, document, 'script', 'dataLayer', 'GTM-TC8G7NJD');</script>
<!-- End Google Tag Manager -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="same-origin" />
  <title>ê°ë¦°ì´ - íšŒê³„ê°ì‚¬ í•™ìŠµ ë„ìš°ë¯¸ v3.3</title>

  <!-- Favicon - 404 ì—ëŸ¬ ë°©ì§€ -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .summary-btn{ width:38px;height:38px;font-size:.8rem;line-height:1;display:flex;align-items:center;justify-content:center;padding:0 2px;transition:.2s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis }
    .summary-btn:hover{ transform:scale(1.1) }
    pre{ white-space:pre-wrap; word-wrap:break-word }
    #toast{ position:fixed; top:16px; right:16px; z-index:9999 }
    .no-kr-break{ word-break:keep-all }

    .dark{ background-color:#1a202c; color:#e2e8f0 }
    .dark .bg-white{ background-color:#2d3748 }
    .dark .bg-gray-100{ background-color:#1a202c }
    .dark .bg-gray-50{ background-color:#2d3748 }
    .dark .text-gray-800{ color:#e2e8f0 }
    .dark .text-gray-700{ color:#cbd5e0 }
    .dark .text-gray-600{ color:#a0aec0 }
    .dark .border-gray-200{ border-color:#4a5568 }
    .dark .border-gray-300{ border-color:#4a5568 }
  </style>

  <style id="dark-a11y-20251026">
    html.dark { color-scheme: dark; }
    html.dark input, html.dark textarea, html.dark select { background-color:#1f2937; color:#e5e7eb; border-color:#4b5563 }
    html.dark ::placeholder { color:#9ca3af }
    html.dark :is(button,a,input,textarea,select):focus-visible { outline:2px solid #60a5fa; outline-offset:2px }
    html.dark .progress-track{ background-color:#374151 }
    html.dark #result-box{ background-color:#1f2937; border-color:#374151 }
    html.dark #quiz-area .bg-gray-50{ background-color:#111827 }
    html.dark #quiz-area .border-gray-200{ border-color:#374151 }
    html.dark #hint-container{ background-color:#1e3a8a; border-color:#334155; color:#e0e7ff }
    html.dark #summary-area .border{ border-color:#374151 }
    html.dark #summary-area .bg-gray-50{ background-color:#111827 }
    html.dark .summary-btn.bg-gray-100{ background-color:#111827; color:#d1d5db; border-color:#374151 }
    html.dark .summary-btn.bg-red-100{ background-color:#7f1d1d; color:#fecaca; border-color:#991b1b }
    html.dark .summary-btn.bg-yellow-100{ background-color:#78350f; color:#fde68a; border-color:#92400e }
    html.dark .summary-btn.bg-green-100{ background-color:#14532d; color:#bbf7d0; border-color:#166534 }
    html.dark .summary-btn.bg-blue-100{ background-color:#1e3a8a; color:#bfdbfe; border-color:#1e40af }
  </style>

  <style id="focus-mode-css">
    html.focus-mode { scroll-behavior: smooth; }
    html.focus-mode #result-box { max-height:none!important; overflow:visible!important; }
  </style>

  <style id="layout-css">
    .heatmap-cell{ width:14px; height:14px; border-radius:3px }
    .drawer-open{ overflow:hidden }
    .cal-cell { height: 32px; border-radius: 6px; position: relative; display: grid; place-items: center; font-size: 12px; border: 1px solid rgba(0,0,0,0.06); }
    .cal-cell .cal-day { position: absolute; top: 4px; right: 6px; font-size: 10px; opacity: 0.85; font-weight: 600; }
    .cal-cell.muted { opacity: 0.35; }
  </style>

  <style id="report-css">
    /* Chart container heights */
    #chart-daily-volume { min-height: 250px; max-height: 300px; }
    #chart-score-trend { min-height: 250px; max-height: 300px; }
    #chart-chapter-weakness { min-height: 300px; }
    #chart-chapter-detail { min-height: 250px; max-height: 300px; }

    /* ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ: ì°¨íŠ¸ ë†’ì´ ì¦ê°€ (ì••ì¶• ë°©ì§€) */
    @media (max-width: 768px) {
      #chart-daily-volume,
      #chart-score-trend,
      #chart-chapter-detail {
        min-height: 350px !important;
        max-height: 400px !important;
      }
      #chart-chapter-weakness {
        min-height: 350px !important;
      }
    }

    /* Prose styles for AI analysis */
    .prose { font-size: 0.875rem; line-height: 1.5; }
    .prose h1 { font-size: 1.5rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; }
    .prose h2 { font-size: 1.25rem; font-weight: bold; margin-top: 1.25rem; margin-bottom: 0.5rem; }
    .prose h3 { font-size: 1.125rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
    .prose p { margin-top: 0.75rem; margin-bottom: 0.75rem; }
    .prose ul, .prose ol { margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .prose li { margin-top: 0.25rem; margin-bottom: 0.25rem; }
    .prose strong { font-weight: 600; color: inherit; }
    .prose code { background: rgba(0,0,0,0.05); padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-size: 0.875em; }
    .prose.dark\:prose-invert { color: #e5e7eb; }
    html.dark .prose h1, html.dark .prose h2, html.dark .prose h3 { color: #f3f4f6; }
    html.dark .prose strong { color: #fbbf24; }
    html.dark .prose code { background: rgba(255,255,255,0.1); }

    /* Print styles */
    @media print {
      #report-modal { display: block !important; position: relative; background: white; }
      #report-modal > div { max-height: none; overflow: visible; box-shadow: none; }
      .report-tab, #report-close-btn, #report-refresh-btn,
      #report-save-snapshot-btn, #report-load-snapshot-btn, #report-print-btn { display: none !important; }
      #report-content-2, #report-content-3 { display: block !important; }
      .border-b { page-break-after: avoid; }
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
  <div id="toast" class="hidden"></div>

  <!-- ìƒë‹¨ ë„¤ë¹„ -->
  <header id="fixed-header" class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur border-b border-gray-200 dark:bg-gray-900/80 dark:border-gray-800">
    <div class="mx-auto max-w-[1400px] 2xl:max-w-[1600px] px-4 lg:px-6 xl:px-8 py-2 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-xl font-extrabold tracking-tight text-blue-700 dark:text-blue-400">ê°ë¦°ì´</span>
        <span class="hidden sm:inline text-xs text-gray-500 dark:text-gray-400">Beta</span>
      </div>
      <nav class="flex items-center gap-2">
        <a href="https://docs.google.com/spreadsheets/d/1PEZHUUHIveVD91eZma8MiW2j7_B197o597YjpTY1CRc/edit?usp=sharing" target="_blank" class="hidden sm:inline text-sm font-bold px-3 py-1.5 rounded-lg bg-blue-600 text-white shadow-md hover:bg-blue-700 transition" title="ë¬¸ì œDB êµ¬ì„±ì„ ìœ„í•œ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸">ë¬¸ì œDBêµ¬ì„±ì— ì°¸ì—¬</a>
        <span id="dday-display" class="hidden sm:inline text-sm font-bold px-3 py-1.5 rounded-lg bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-md cursor-pointer hover:from-red-600 hover:to-pink-600 transition" title="ì‹œí—˜ë‚ ì§œ ì„¤ì •ì€ ì„¤ì • ë©”ë‰´ì—ì„œ">D-DAY</span>
        <button id="open-achievements-btn" class="inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-sm font-medium bg-gradient-to-r from-yellow-400 to-amber-500 hover:from-yellow-500 hover:to-amber-600 text-gray-900 shadow-md transition relative" title="ë‚˜ì˜ ì—…ì ">
          <span class="hidden sm:inline">ì—…ì </span><span>ğŸ†</span>
          <span id="new-achievement-badge" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
        </button>
        <a id="help-button" href="README.html" target="_blank" class="hidden sm:inline text-sm text-gray-700 hover:text-blue-700 dark:text-gray-300 dark:hover:text-white">ë„ì›€ë§</a>
        <button id="settings-btn" class="ml-1 inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-haspopup="dialog">
          <span>ì„¤ì •</span><span aria-hidden>âš™ï¸</span>
        </button>
        <button id="hamburger" class="lg:hidden inline-flex items-center justify-center w-9 h-9 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-label="ë©”ë‰´">â‰¡</button>
      </nav>
    </div>
  </header>
  <div class="h-14"></div>

  <div id="drawer-backdrop" class="fixed inset-0 bg-black/40 hidden z-[1099]"></div>

  <div id="layout-root" class="pt-2 flex-1 px-4 lg:px-6 xl:px-8">
    <div class="mx-auto max-w-[1400px] 2xl:max-w-[1600px] grid grid-cols-1 lg:grid-cols-12 gap-4 xl:gap-6 2xl:gap-8">
      <!-- LEFT -->
      <aside id="left-dashboard" class="lg:col-span-3 xl:col-span-3 2xl:col-span-3 space-y-4">
        <button id="drawer-close" class="hidden lg:hidden absolute top-2 right-2 z-[1101] inline-flex items-center justify-center w-9 h-9 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700" aria-label="ë‹«ê¸°">âœ•</button>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-lg">í•™ìŠµ ìº˜ë¦°ë”</h3>
            <div class="flex items-center gap-2">
              <button id="cal-prev" class="w-8 h-8 grid place-items-center rounded-md border hover:bg-gray-50" aria-label="ì´ì „ ë‹¬">â—€</button>
              <div id="cal-title" class="min-w-[96px] text-sm font-semibold text-center">YYYY.MM</div>
              <button id="cal-next" class="w-8 h-8 grid place-items-center rounded-md border hover:bg-gray-50" aria-label="ë‹¤ìŒ ë‹¬">â–¶</button>
            </div>
          </div>
          <div id="calendar-weekdays" class="grid grid-cols-7 text-center text-xs text-gray-500 mb-1">
            <div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div><div>ì¼</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
          <div class="mt-2 text-[11px] text-gray-500">ìƒ‰ = í•´ë‹¹ì¼ í’€ì´ëŸ‰ (ë…¸ë‘â†’ì´ˆë¡â†’íŒŒë‘)</div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <button id="open-report-btn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-3 rounded-lg shadow-md hover:from-blue-600 hover:to-purple-700 transition duration-200 flex items-center justify-center gap-2">
            <span>ğŸ“Š</span>
            <span>í•™ìŠµ ë¦¬í¬íŠ¸ ìƒì„±</span>
          </button>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">ì˜¤ëŠ˜ì˜ í†µê³„</h3>
          <div id="stats-overview" class="text-sm space-y-1"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">ì˜¤ëŠ˜ì˜ ë³µìŠµ</h3>
          <label class="text-sm block mb-2">ìš°ì„ ìˆœìœ„</label>
          <select id="review-strategy-select" class="w-full p-2 border rounded">
            <option value="smart">ì§€ëŠ¥í˜• ì¶”ì²œ (ê¸°ë³¸)</option>
            <option value="hlr">HLR ê¸°ë°˜ (íšŒìƒ í™•ë¥ )</option>
            <option value="low">ì ìˆ˜ ë‚®ì€ ìˆœ</option>
            <option value="recentWrong">ìµœê·¼ í‹€ë¦° ìˆœ</option>
            <option value="flag">ì‚¬ìš©ì ì§€ì • ë³µìŠµ ëª©ë¡</option>
          </select>
          <button id="start-review-btn" class="mt-3 w-full bg-blue-600 text-white py-2 rounded-lg">ì˜¤ëŠ˜ì˜ ë³µìŠµ ì‹œì‘</button>
        </div>
      </aside>

      <!-- CENTER -->
      <main id="center-core" class="lg:col-span-6 xl:col-span-6 2xl:col-span-6">
        <div class="bg-white rounded-2xl shadow-xl w-full p-6 md:p-8">
          <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
            <div class="flex-1 w-full">
              <label for="chapter-select" class="block text-sm font-medium text-gray-700 mb-1">ë‹¨ì› ì„ íƒ</label>
              <select id="chapter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
                <option value="">-- ì „ì²´ ë‹¨ì› --</option>
              </select>
            </div>
            <div class="flex-1 w-full">
              <label for="filter-select" class="block text-sm font-medium text-gray-700 mb-1">ë¬¸ì œ í•„í„°</label>
              <select id="filter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-700 dark:text-gray-100 dark:border-gray-700">
                <option value="all">ëª¨ë“  ë¬¸ì œ í’€ê¸°</option>
                <option value="unanswered">ì•„ì§ ì•ˆ í‘¼ ë¬¸ì œ</option>
                <option value="today-review">ì˜¤ëŠ˜ì˜ ë³µìŠµ (ì¶”ì²œ)</option>
                <option value="80">80ì  ë¯¸ë§Œ ë¬¸ì œ</option>
                <option value="60">60ì  ë¯¸ë§Œ ë¬¸ì œ</option>
              </select>
            </div>
            <div class="w-full md:w-auto md:self-end flex flex-col sm:flex-row gap-2">
              <button id="load-quiz-btn" class="flex-1 bg-blue-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-200 whitespace-nowrap">í•™ìŠµ ì‹œì‘</button>
              <button id="random-quiz-btn" class="flex-1 bg-purple-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-purple-700 transition duration-200 whitespace-nowrap">ëœë¤ ë¬¸ì œ</button>
              <button id="flashcard-mode-btn" class="flex-1 bg-green-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-green-700 transition duration-200 whitespace-nowrap">í”Œë˜ì‹œì¹´ë“œ</button>
            </div>
          </div>

          <div id="source-group-filter" class="mb-6"></div>

          <!-- í”Œë˜ì‹œì¹´ë“œ ì˜ì—­ -->
          <div id="flashcard-area" class="hidden">
            <div class="bg-gradient-to-br from-blue-50 to-purple-50 dark:from-gray-800 dark:to-gray-700 border-2 border-blue-200 dark:border-gray-600 rounded-2xl p-8 mb-6 min-h-[400px] flex flex-col">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-blue-700 dark:text-blue-300">í”Œë˜ì‹œì¹´ë“œ ëª¨ë“œ</h2>
                <span id="flashcard-counter" class="text-gray-600 dark:text-gray-300 font-medium">0 / 0</span>
              </div>

              <div class="flex-1 flex flex-col justify-center space-y-6">
                <div class="bg-white dark:bg-gray-900 rounded-xl p-6 shadow-md">
                  <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">ë¬¸ì œ ì œëª©</h3>
                  <p id="flashcard-title" class="text-lg font-bold text-gray-800 dark:text-gray-100">-</p>
                </div>

                <div class="bg-white dark:bg-gray-900 rounded-xl p-6 shadow-md">
                  <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">ë¬¼ìŒ</h3>
                  <p id="flashcard-question" class="text-base text-gray-700 dark:text-gray-200 leading-relaxed whitespace-pre-wrap">-</p>
                </div>

                <div class="bg-white dark:bg-gray-900 rounded-xl p-6 shadow-md">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400">ë‹µë³€ (ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ í† ê¸€)</h3>
                    <button id="flashcard-toggle-answer" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition">
                      ë‹µë³€ ë³´ê¸° ğŸ‘ï¸
                    </button>
                  </div>
                  <div id="flashcard-answer-box" class="hidden">
                    <p id="flashcard-answer" class="text-base text-gray-700 dark:text-gray-200 leading-relaxed whitespace-pre-wrap">-</p>
                  </div>
                  <div id="flashcard-answer-hidden" class="text-center py-8 text-gray-400">
                    <p>ë‹µë³€ì´ ìˆ¨ê²¨ì ¸ ìˆìŠµë‹ˆë‹¤</p>
                    <p class="text-xs mt-2">ìœ„ ë²„íŠ¼ ë˜ëŠ” ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆŒëŸ¬ í™•ì¸í•˜ì„¸ìš”</p>
                  </div>
                </div>
              </div>

              <div class="space-y-3 mt-6">
                <div class="flex justify-between items-center gap-4">
                  <button id="flashcard-prev-btn" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-bold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">â† ì´ì „</button>
                  <div class="flex gap-2">
                    <button id="flashcard-random-btn" class="px-4 py-3 bg-purple-500 text-white font-medium rounded-lg hover:bg-purple-600 transition">ğŸ² ëœë¤</button>
                    <button id="flashcard-exit-btn" class="px-4 py-3 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition">ì¢…ë£Œ (Esc)</button>
                  </div>
                  <button id="flashcard-next-btn" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-bold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">ë‹¤ìŒ â†’</button>
                </div>
                <div class="text-center text-xs text-gray-500 dark:text-gray-400">
                  ë‹¨ì¶•í‚¤: â† ì´ì „ | â†’ ë‹¤ìŒ | Space ë‹µë³€ë³´ê¸° | Esc ì¢…ë£Œ
                </div>
              </div>
            </div>
          </div>

          <!-- ë¬¸ì œ ì˜ì—­ -->
          <div id="quiz-area" class="hidden">
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-4">
              <div class="flex justify-between items-center mb-2">
                <h2 id="question-number" class="text-xl font-bold text-blue-700 bg-blue-100 px-3 py-1 rounded-md">ë¬¸í•­</h2>
                <span id="question-counter" class="text-gray-500 font-medium">0 / 0</span>
              </div>
              <div id="db-question-id" class="text-xs text-gray-500 hidden">ID: -</div>

              <p id="question-text" class="text-gray-800 text-base md:text-lg leading-relaxed mt-2">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>

              <!-- íŒíŠ¸/ë³µìŠµ ë²„íŠ¼ ì˜ì—­ -->
              <div class="mt-3 flex items-center justify-between gap-2">
                <button id="hint-btn" class="text-sm bg-purple-600 text-white px-3 py-1.5 rounded-md shadow hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">íŒíŠ¸</button>

                <div class="flex items-center gap-2">
                  <!-- ë³µìŠµì¶”ê°€(â˜…) -->
                  <button id="review-flag-toggle" class="text-sm px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-100 flex items-center gap-1" aria-pressed="false" title="ë³µìŠµ í•„ìš” í† ê¸€">
                    <span class="text-yellow-500">â˜†</span><span>ë³µìŠµ ì¶”ê°€</span>
                  </button>

                  <!-- ë³µìŠµ ì œì™¸(â–) -->
                  <button id="review-exclude-toggle" class="text-sm px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-100 flex items-center gap-1" aria-pressed="false" title="ì˜¤ëŠ˜ì˜ ë³µìŠµì—ì„œ ì œì™¸/í•´ì œ">
                    <span class="text-gray-600">â–</span><span>ë³µìŠµ ì œì™¸</span>
                  </button>
                </div>
              </div>

              <div id="hint-container" class="hidden mt-3 text-sm bg-purple-50 border border-purple-200 text-purple-800 rounded-lg p-3 dark:bg-indigo-900 dark:border-indigo-700 dark:text-indigo-100"></div>
            </div>

            <div class="flex items-center justify-between mb-2">
              <label for="user-answer" class="text-sm font-medium text-gray-700">ë‹µì•ˆ ì…ë ¥</label>
              <button id="load-prev-answer-btn" class="text-xs text-blue-600 hover:underline">ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
            <textarea id="user-answer" class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition dark:bg-gray-800 dark:text-gray-100 dark:placeholder-gray-400 dark:border-gray-700" rows="8" placeholder="ì—¬ê¸°ì— ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”... (Enter=ì±„ì , Shift+Enter=ì¤„ë°”ê¿ˆ, Ctrl+[=ì´ì „ìœ„ì¹˜, Ctrl+]=í¬ì»¤ìŠ¤/í˜„í™©íŒ)"></textarea>
            <p id="error-message" class="text-red-500 text-sm mt-2 hidden">ë‹µì•ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <p id="hotkey-guide" class="text-xs text-gray-500 mt-2">
              ë‹¨ì¶•í‚¤: Ctrl+â†/â†’ ì´ì „/ë‹¤ìŒ Â· Enter/G ì±„ì  Â· H íŒíŠ¸ Â· L ì´ì „ë‹µì•ˆ Â· R ëœë¤ Â· X ë³µìŠµì œì™¸ Â· S í˜„í™©íŒ Â· Ctrl+[ ì´ì „ìœ„ì¹˜ Â· Ctrl+] í¬ì»¤ìŠ¤
            </p>

            <div class="flex justify-between items-center my-5">
              <button id="prev-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">ì´ì „</button>
              <button id="grade-btn" class="bg-green-500 text-white font-bold py-2 px-8 rounded-lg shadow-md hover:bg-green-600 transition duration-200 relative min-w-[120px]">
                <span id="grade-btn-text">ì±„ì í•˜ê¸°</span>
                <div id="grade-loader" class="loader absolute inset-0 m-auto hidden" aria-hidden="true"></div>
              </button>
              <button id="next-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">ë‹¤ìŒ</button>
            </div>
          </div>

          <!-- ì±„ì  ê²°ê³¼ -->
          <div id="result-box" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-6 mt-6 dark:bg-gray-800 dark:border-gray-700" aria-live="polite">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ì±„ì  ê²°ê³¼</h3>
            <div id="score-display" class="mb-5">
              <p class="text-lg font-medium text-gray-700">
                ìœ ì‚¬ë„ ì ìˆ˜: <span id="score" class="font-bold text-blue-600 text-2xl">0</span><span class="text-gray-600 text-lg">ì </span>
              </p>
              <div class="w-full bg-gray-200 progress-track rounded-full h-4 mt-2 overflow-hidden shadow-inner">
                <div id="progress-bar" class="h-4 rounded-full transition-all duration-500 ease-out" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <h4 class="text-xl font-semibold text-gray-700 mb-2">ğŸ¤– AI ì´í‰</h4>
              <div id="ai-feedback" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 leading-relaxed min-h-[50px]"></div>
            </div>
          </div>

          <!-- ëª¨ë²” ë‹µì•ˆ -->
          <div id="model-answer-box" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-6 mt-6 dark:bg-gray-800 dark:border-gray-700">
            <h4 class="text-xl font-semibold text-gray-700 mb-2">ğŸ“˜ ëª¨ë²” ë‹µì•ˆ</h4>
            <pre id="correct-answer" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 text-sm font-sans leading-relaxed"></pre>
          </div>

          <!-- í•™ìŠµ í˜„í™©íŒ -->
          <div id="summary-area" class="mt-8 pt-6 border-t hidden">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-3">
              <h3 class="text-xl font-bold text-gray-800">í•™ìŠµ í˜„í™©íŒ (í´ë¦­í•˜ì—¬ ì´ë™)</h3>
              <div class="flex flex-wrap gap-3 items-center">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-gray-600">ë³´ê¸°:</span>
                  <button id="summary-view-all" class="px-3 py-1.5 text-sm border rounded bg-gray-100 hover:bg-gray-200">ëª¨ë“  ë‹¨ì›ë³´ê¸°</button>
                  <button id="summary-view-current" class="px-3 py-1.5 text-sm border rounded">í˜„ì¬ í•™ìŠµë‹¨ì›ë³´ê¸°</button>
                </div>
                <div class="flex gap-4">
                  <button id="clear-filter-btn" class="text-sm text-blue-700 hover:underline dark:text-blue-300">í•„í„° í•´ì œ</button>
                  <button id="reset-scores-btn" class="text-sm text-red-600 hover:underline dark:text-red-300">í•™ìŠµ ê¸°ë¡ ì´ˆê¸°í™”</button>
                </div>
              </div>
            </div>
            <div id="score-summary" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
      </main>

      <!-- RIGHT -->
      <aside id="right-explorer" class="lg:col-span-3 xl:col-span-3 2xl:col-span-3 space-y-4">
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">í•™ìŠµ ë²”ìœ„ í•„í„°</h3>
          <div id="source-filter-side"></div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">ë‹¨ì› ë„¤ë¹„ê²Œì´í„°</h3>
          <div id="explorer-chapters" class="space-y-2"></div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-lg whitespace-nowrap no-kr-break">ë¬¸ì œ ëª©ë¡</h3>
            <input id="explorer-search" class="border rounded px-2 py-1 text-sm" placeholder="ê²€ìƒ‰...">
          </div>
          <div id="explorer-problems" class="space-y-1 max-h-[60vh] overflow-y-auto pr-1"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- API í‚¤ ëª¨ë‹¬ -->
  <div id="api-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1000]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-xl">
      <h2 class="text-xl font-bold text-gray-800">Gemini API í‚¤ ì¸ì¦</h2>
      <p class="text-sm text-gray-600 mt-1">ìµœì´ˆ 1íšŒë§Œ ì…ë ¥í•©ë‹ˆë‹¤. ë¡œì»¬ ì €ì¥ì„ ì²´í¬í•˜ë©´ ë‹¤ìŒë¶€í„°ëŠ” íŒì—…ì´ ëœ¨ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <p class="text-sm mt-2">ì²˜ìŒ ì‚¬ìš©í•˜ì‹œë‚˜ìš”?
        <a href="README.html" target="_blank" rel="noopener" class="underline text-blue-600 dark:text-blue-300">ë„ì›€ë§(README)</a>ë¥¼ í™•ì¸í•˜ì„¸ìš”.
      </p>

      <label for="api-modal-input" class="block text-sm font-medium text-gray-700 mt-4">ğŸ”‘ API Key</label>
      <input type="password" id="api-modal-input"
             class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-gray-100 dark:placeholder-gray-400 dark:border-gray-700"
             placeholder="Google AI Studio API í‚¤" autocomplete="off" spellcheck="false" inputmode="text" />

      <div class="flex items-center gap-2 mt-2">
        <input type="checkbox" id="modal-remember" class="rounded border-gray-300" />
        <label for="modal-remember" class="text-sm text-gray-700">ì´ ë¸Œë¼ìš°ì €ì— í‚¤ ì €ì¥</label>
      </div>
      <p class="text-xs text-yellow-600 mt-1">âš ï¸ ê³µìš© PCì—ì„œëŠ” ì²´í¬ í•´ì œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</p>

      <div class="mt-5 flex justify-end gap-2">
        <button id="api-cancel-btn" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900">ì·¨ì†Œ</button>
        <button id="api-save-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì—…ì  ëª¨ë‹¬ -->
  <div id="achievements-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1002] p-4 overflow-y-auto">
    <div role="dialog" aria-modal="true" aria-labelledby="achievements-title" class="bg-white dark:bg-gray-900 dark:text-gray-100 rounded-2xl w-full max-w-4xl shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between rounded-t-2xl">
        <h2 id="achievements-title" class="text-2xl font-bold">ğŸ† ë‚˜ì˜ ì—…ì </h2>
        <button id="achievements-close-btn" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl leading-none" aria-label="ë‹«ê¸°">Ã—</button>
      </div>

      <div class="p-6">
        <!-- ì—…ì  í†µê³„ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-gradient-to-br from-yellow-50 to-amber-50 dark:from-gray-800 dark:to-gray-700 rounded-lg p-4 text-center border border-yellow-200 dark:border-gray-600">
            <div class="text-3xl font-bold text-yellow-600 dark:text-yellow-400"><span id="achievement-count-total">0</span></div>
            <div class="text-sm text-gray-600 dark:text-gray-400">ì „ì²´ ì—…ì </div>
          </div>
          <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-gray-800 dark:to-gray-700 rounded-lg p-4 text-center border border-green-200 dark:border-gray-600">
            <div class="text-3xl font-bold text-green-600 dark:text-green-400"><span id="achievement-count-unlocked">0</span></div>
            <div class="text-sm text-gray-600 dark:text-gray-400">ë‹¬ì„± ì™„ë£Œ</div>
          </div>
          <div class="bg-gradient-to-br from-blue-50 to-sky-50 dark:from-gray-800 dark:to-gray-700 rounded-lg p-4 text-center border border-blue-200 dark:border-gray-600">
            <div class="text-3xl font-bold text-blue-600 dark:text-blue-400"><span id="achievement-progress-percent">0</span>%</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">ë‹¬ì„±ë¥ </div>
          </div>
          <div class="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-gray-800 dark:to-gray-700 rounded-lg p-4 text-center border border-purple-200 dark:border-gray-600">
            <div class="text-3xl font-bold text-purple-600 dark:text-purple-400"><span id="achievement-points">0</span>P</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">ì—…ì  í¬ì¸íŠ¸</div>
          </div>
        </div>

        <!-- í‹°ì–´ í•„í„° -->
        <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
          <button class="achievement-tier-filter px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600" data-tier="all">ì „ì²´</button>
          <button class="achievement-tier-filter px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400 hover:bg-amber-200" data-tier="bronze">ğŸ¥‰ ë¸Œë¡ ì¦ˆ</button>
          <button class="achievement-tier-filter px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap bg-gray-300 text-gray-800 dark:bg-gray-600 dark:text-gray-200 hover:bg-gray-400" data-tier="silver">ğŸ¥ˆ ì‹¤ë²„</button>
          <button class="achievement-tier-filter px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400 hover:bg-yellow-200" data-tier="gold">ğŸ¥‡ ê³¨ë“œ</button>
          <button class="achievement-tier-filter px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400 hover:bg-purple-200" data-tier="hidden">ğŸ¤« íˆë“ </button>
        </div>

        <!-- ì—…ì  ë¦¬ìŠ¤íŠ¸ -->
        <div id="achievements-list" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1001]">
    <div role="dialog" aria-modal="true" aria-labelledby="settings-title" class="bg-white dark:bg-gray-900 dark:text-gray-100 rounded-2xl w-full max-w-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-2">
        <h2 id="settings-title" class="text-2xl font-bold">ì„¤ì • âš™ï¸</h2>
        <button id="settings-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white" aria-label="ë‹«ê¸°">âœ•</button>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">API í‚¤ ì„¤ì •</h3>
        <button id="open-api-key-modal-btn" class="w-full bg-blue-50 border border-blue-300 text-blue-700 font-medium py-2 px-4 rounded-lg hover:bg-blue-100 transition">API í‚¤ ë³€ê²½/ì„¤ì •</button>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">ğŸ“… ì‹œí—˜ ë‚ ì§œ (D-DAY)</h3>
        <input type="date" id="exam-date-input" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-100" />
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">ì‹œí—˜ ë‚ ì§œë¥¼ ì„¤ì •í•˜ë©´ ìƒë‹¨ë°”ì— D-DAYê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
        <button id="save-exam-date-btn" class="mt-3 w-full bg-red-50 border border-red-300 text-red-700 font-medium py-2 px-4 rounded-lg hover:bg-red-100 transition">D-DAY ì €ì¥</button>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">AI ëª¨ë¸ ì„ íƒ</h3>
        <select id="ai-model-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="gemini-2.5-flash">Gemini 2.5 Flash (ê¸°ë³¸)</option>
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (ê²½ëŸ‰)</option>
        </select>
        <p class="text-xs text-gray-500 mt-2">íŒíŠ¸ ë° ì±„ì ì— ì‚¬ìš©ë  AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”.</p>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">ë‹¤í¬ ëª¨ë“œ</h3>
        <select id="dark-mode-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="system">ì‹œìŠ¤í…œ ì„¤ì • (ê¸°ë³¸)</option>
          <option value="light">ë¼ì´íŠ¸ ëª¨ë“œ</option>
          <option value="dark">ë‹¤í¬ ëª¨ë“œ</option>
        </select>
      </div>

      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">ë°ì´í„° ê´€ë¦¬</h3>
        <div class="flex gap-3 mb-2">
          <button id="export-data-btn" class="flex-1 bg-green-50 border border-green-300 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition">ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
          <button id="import-data-btn" class="flex-1 bg-yellow-50 border border-yellow-300 text-yellow-700 font-medium py-2 px-4 rounded-lg hover:bg-yellow-100 transition">ğŸ“¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
        </div>
        <div class="flex gap-3">
          <button id="merge-data-btn" class="flex-1 bg-blue-50 border border-blue-300 text-blue-700 font-medium py-2 px-4 rounded-lg hover:bg-blue-100 transition">ğŸ”€ ë°ì´í„° ë³‘í•© ê°€ì ¸ì˜¤ê¸°</button>
        </div>
        <input type="file" id="import-file-input" accept=".json" class="hidden" />
        <input type="file" id="merge-file-input" accept=".json" class="hidden" />
        <p class="text-xs text-gray-500 mt-2">í•™ìŠµ ê¸°ë¡ ë° ì„¤ì •ì„ ë°±ì—…í•˜ê±°ë‚˜ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³‘í•© ê°€ì ¸ì˜¤ê¸°ëŠ” ê¸°ì¡´ ë°ì´í„°ì™€ ìƒˆ ë°ì´í„°ë¥¼ í•©ì¹©ë‹ˆë‹¤.</p>
      </div>

      <div class="flex justify-end">
        <button id="settings-close-btn-bottom" class="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Deep-Learning Report ëª¨ë‹¬ -->
  <div id="report-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1002] p-4 overflow-y-auto">
    <div role="dialog" aria-modal="true" aria-labelledby="report-title" class="bg-white dark:bg-gray-900 dark:text-gray-100 rounded-2xl w-full max-w-5xl shadow-xl max-h-[90vh] overflow-y-auto" style="-webkit-overflow-scrolling: touch;">
      <!-- í—¤ë” -->
      <div class="sticky top-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 p-6 z-10">
  <div class="flex items-center justify-between mb-4">
    
    <h2 id="report-title" class="text-2xl font-bold text-gray-900 dark:text-white">ğŸ“Š ë”¥-ëŸ¬ë‹ ë¦¬í¬íŠ¸ (Deep-Learning Report)</h2>

    <button id="report-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white text-2xl" aria-label="ë‹«ê¸°">âœ•</button>
  </div>
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
          <div class="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-3">
            <div class="flex items-center gap-2">
              <label for="report-period-select" class="text-sm font-medium whitespace-nowrap">ë°ì´í„° ë²”ìœ„:</label>
              <select id="report-period-select" class="px-3 py-1.5 text-sm border rounded-lg dark:bg-gray-800 dark:border-gray-700">
                <option value="30">ìµœê·¼ 30ì¼</option>
                <option value="60">ìµœê·¼ 60ì¼</option>
                <option value="90">ìµœê·¼ 90ì¼</option>
                <option value="all">ì „ì²´ ê¸°ê°„</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label for="report-threshold-select" class="text-sm font-medium whitespace-nowrap">ë¶„ì„ ëŒ€ìƒ:</label>
              <select id="report-threshold-select" class="px-3 py-1.5 text-sm border rounded-lg dark:bg-gray-800 dark:border-gray-700">
                <option value="60">60ì  ë¯¸ë§Œ</option>
                <option value="70">70ì  ë¯¸ë§Œ</option>
                <option value="80">80ì  ë¯¸ë§Œ</option>
              </select>
            </div>
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <button id="report-refresh-btn" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 whitespace-nowrap">ìƒˆë¡œê³ ì¹¨</button>
            <button id="report-save-snapshot-btn" class="px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 whitespace-nowrap">ğŸ’¾ ì €ì¥</button>
            <button id="report-load-snapshot-btn" class="px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 whitespace-nowrap">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <input type="file" id="report-load-snapshot-input" accept=".json" style="display: none;">
            <button id="report-print-btn" class="px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 whitespace-nowrap">ğŸ“¤ ë‚´ë³´ë‚´ê¸°/ê³µìœ </button>
          </div>
        </div>
      </div>

      <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
      <div class="border-b border-gray-200 dark:border-gray-700 px-6">
        <nav class="flex gap-4" role="tablist">
          <button id="report-tab-1" class="report-tab py-3 px-4 font-medium border-b-2 border-blue-600 text-blue-600" role="tab" aria-selected="true" data-tab="1">1. ìš”ì•½ ë° ì°¨íŠ¸</button>
          <button id="report-tab-2" class="report-tab py-3 px-4 font-medium border-b-2 border-transparent text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white" role="tab" aria-selected="false" data-tab="2">2. AI ì‹¬ì¸µ ë¶„ì„</button>
          <button id="report-tab-3" class="report-tab py-3 px-4 font-medium border-b-2 border-transparent text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white" role="tab" aria-selected="false" data-tab="3">3. ì•¡ì…˜ í”Œëœ</button>
        </nav>
      </div>

      <!-- íƒ­ ì½˜í…ì¸  -->
      <div class="p-6">
        <!-- íƒ­ 1: ìš”ì•½ ë° ì°¨íŠ¸ -->
        <div id="report-content-1" class="report-content">
          <div class="space-y-6">
            <div>
              <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-bold">í•™ìŠµ ì„±ê³¼ ì¶”ì´</h3>
                <div class="flex items-center gap-2">
                  <label class="text-sm text-gray-600 dark:text-gray-400">ì°¨íŠ¸ ìŠ¤ì½”í”„:</label>
                  <select id="chart-scope-select" class="px-2 py-1 text-sm border rounded-lg dark:bg-gray-800 dark:border-gray-700">
                    <option value="daily">ì¼ê°„</option>
                    <option value="weekly">ì£¼ê°„</option>
                    <option value="monthly">ì›”ê°„</option>
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="border rounded-lg p-4">
                  <h4 class="text-sm font-semibold mb-2">ì¼ì¼ í•™ìŠµëŸ‰</h4>
                  <canvas id="chart-daily-volume"></canvas>
                </div>
                <div class="border rounded-lg p-4">
                  <div class="flex justify-between items-center mb-2">
                    <h4 class="text-sm font-semibold">ì „ì²´ ì ìˆ˜ ì¶”ì´</h4>
                    <a href="trendhelp.html" target="_blank" class="text-xs text-blue-600 hover:underline dark:text-blue-400">ë„ì›€ë§</a>
                  </div>
                  <canvas id="chart-score-trend"></canvas>
                </div>
              </div>
            </div>
            <div>
              <h3 class="text-lg font-bold mb-3">ë‹¨ì›ë³„ ì·¨ì•½ì  ë¶„ì„</h3>
              <div class="border rounded-lg p-4 overflow-x-auto">
                <canvas id="chart-chapter-weakness"></canvas>
              </div>
              <div id="chapter-detail-chart" class="hidden border rounded-lg p-4 mt-4">
                <h4 class="text-sm font-semibold mb-2">ì„ íƒí•œ ë‹¨ì›ì˜ ì ìˆ˜ ì¶”ì´</h4>
                <canvas id="chart-chapter-detail"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- íƒ­ 2: AI ì‹¬ì¸µ ë¶„ì„ -->
        <div id="report-content-2" class="report-content hidden">
          <div class="text-center py-8">
            <button id="ai-analysis-start-btn" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">
              ğŸ¤– Gemini Proë¡œ ì‹¬ì¸µ ë¶„ì„ ì‹œì‘
            </button>
            <p class="text-sm text-gray-700 dark:text-gray-300 mt-2">AIê°€ ì˜¤ë‹µ íŒ¨í„´ê³¼ ê°œë… ì•½ì ì„ ë¶„ì„í•©ë‹ˆë‹¤</p>
          </div>
          <div id="ai-analysis-result" class="hidden">
            <div class="flex justify-end mb-4">
              <button id="ai-analysis-copy-btn" class="px-4 py-2 text-sm border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800">ğŸ“‹ ë¶„ì„ ë‚´ìš© ë³µì‚¬</button>
            </div>
            <div class="border rounded-lg p-6 bg-white dark:bg-gray-800">
              <div id="ai-error-pattern" class="prose max-w-none dark:prose-invert !text-black dark:!text-white whitespace-pre-wrap"></div>
            </div>
          </div>
          <div id="ai-analysis-loading" class="hidden text-center py-12">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-600">AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
          </div>
        </div>

        <!-- íƒ­ 3: ì•¡ì…˜ í”Œëœ -->
        <div id="report-content-3" class="report-content hidden">
          <div class="space-y-6">
            <div class="border rounded-lg p-6">
              <h3 class="text-lg font-bold mb-3">ë§ê° ê³¡ì„  ê¸°ë°˜ ë³µìŠµ í”Œë˜ë„ˆ</h3>
              <div class="space-y-4">
                <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                  <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">ğŸš¨ ê¸´ê¸‰ ë³µìŠµ (ì˜¤ëŠ˜ ì¦‰ì‹œ)</h4>
                  <div id="action-urgent-list" class="space-y-1"></div>
                </div>
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                  <h4 class="font-semibold text-yellow-700 dark:text-yellow-400 mb-2">âš ï¸ ì£¼ê¸°ì  ë³µìŠµ (ì´ë²ˆ ì£¼ ë‚´)</h4>
                  <div id="action-weekly-list" class="space-y-1"></div>
                </div>
                <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                  <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">ğŸ§  ì¥ê¸° ê¸°ì–µí™” (ë‹¤ìŒ ì£¼)</h4>
                  <div id="action-longterm-list" class="space-y-1"></div>
                </div>
              </div>
            </div>
            <div class="border rounded-lg p-6">
              <h3 class="text-lg font-bold mb-3">ì¸í„°ë™í‹°ë¸Œ ì˜¤ë‹µë…¸íŠ¸</h3>
              <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">í´ë¦­í•˜ì—¬ ëª¨ë²” ë‹µì•ˆê³¼ AI ì´í‰ì„ í™•ì¸í•˜ì„¸ìš”</p>
              <div id="action-wrong-answers" class="space-y-3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë‚´ì¥ ë°ì´í„°(JSON) -->
  <script id="dataset-json" type="application/json">[
    {"ê³ ìœ ID":"q_001","í‘œì‹œë²ˆí˜¸":"1","ì¶œì²˜":"S","problemTitle":"íšŒê³„ê°ì‚¬ì˜ ê³ ìœ í•œê³„ ì›ì¸ ì„¸ ê°€ì§€","ë‹¨ì›":1,"ë¬¼ìŒë²ˆí˜¸":1,"ë¬¼ìŒ":"íšŒê³„ê°ì‚¬ì—ëŠ” ê³ ìœ í•œê³„ê°€ ì¡´ì¬í•œë‹¤. ê·¸ ì›ì¸ì„ ì„¸ ê°€ì§€ ì“°ì‹œì˜¤.","ì •ë‹µ":"ISA 200-A47 â‘  ì¬ë¬´ë³´ê³ ì˜ ì„±ê²© â‘¡ ê°ì‚¬ì ˆì°¨ì˜ ì„±ê²© â‘¢ í•©ë¦¬ì  ì‹œê°„Â·ë¹„ìš© ì œì•½"},
    {"ê³ ìœ ID":"q_002","í‘œì‹œë²ˆí˜¸":"2","ì¶œì²˜":"H","problemTitle":"ì ì‹œì„±ê³¼ ë¹„ìš©-íš¨ìµ ê³ ë ¤ ì‹œ ì±„íƒí•˜ëŠ” ì ˆì°¨","ë‹¨ì›":1,"ë¬¼ìŒë²ˆí˜¸":2,"ë¬¼ìŒ":"ê°ì‚¬ì¸ì€ ì ì‹œì„±ê³¼ ë¹„ìš©-íš¨ìµ ê· í˜•ì„ ê³ ë ¤í•œë‹¤. ì´ì— ë”°ë¼ ì±„íƒí•˜ëŠ” ì ˆì°¨ ì„¸ ê°€ì§€ëŠ”?","ì •ë‹µ":"ISA 200-A51 â‘  íš¨ê³¼ì  ê³„íš â‘¡ ìœ„í—˜ ë†’ì€ ë¶„ì•¼ ì§‘ì¤‘ â‘¢ í…ŒìŠ¤íŠ¸ ë“± í‘œë³¸ ì‚¬ìš©"},
    {"ê³ ìœ ID":"q_003","í‘œì‹œë²ˆí˜¸":"3","ì¶œì²˜":"SS","problemTitle":"ìƒ˜í”Œ ë¬¸ì œ","ë‹¨ì›":1,"ë¬¼ìŒë²ˆí˜¸":3,"ë¬¼ìŒ":"â€¦","ì •ë‹µ":"â€¦"}
  ]</script>

  <!-- ========================================
       ê°ë¦°ì´ v4.0 ë¦¬íŒ©í† ë§ ëª¨ë“ˆ ë¡œë“œ (ë¨¼ì € ë¡œë“œë¨)
       ======================================== -->
  <script type="module" src="js/app.js"></script>

  <script type="module">
    // ========================================
    // âš ï¸ CRITICAL: app.jsë¥¼ ë¨¼ì € importí•˜ì—¬ ì „ì—­ í•¨ìˆ˜ë“¤ì´ ì •ì˜ë˜ë„ë¡ ë³´ì¥
    // ========================================
    import './js/app.js';

    // ========================================
    // [ë¦¬íŒ©í† ë§] ìƒìˆ˜ëŠ” js/config/config.jsë¡œ ì´ë™ë¨
    // app.jsë¥¼ í†µí•´ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œë¨
    // ========================================
    /*
    const BASE_SYSTEM_PROMPT = ... (â†’ js/config/config.js)
    const LITE_STRICT_ADDENDUM = ... (â†’ js/config/config.js)
    */

    // ============================================================
    // âœ‚ï¸ REFACTORED - ì „ì—­ ë³€ìˆ˜ëŠ” app.jsì˜ Object.definePropertyë¡œ ê´€ë¦¬ë¨
    // ============================================================
    // ì´ì „ì—ëŠ” ì—¬ê¸°ì„œ letìœ¼ë¡œ ì„ ì–¸í–ˆì§€ë§Œ, ì´ê²ƒì´ window ì „ì—­ ë³€ìˆ˜ë¥¼ ê°€ë¦¼(shadowing)
    // í•´ê²°: ë¡œì»¬ ë³€ìˆ˜ ì„ ì–¸ ì œê±°, window.allData ë“±ì„ ì§ì ‘ ì‚¬ìš©
    // app.jsì—ì„œ Object.definePropertyë¡œ StateManagerì™€ ìë™ ë™ê¸°í™”ë¨
    // ============================================================

    /* [ì´ì „ ì½”ë“œ - ë¡œì»¬ ë³€ìˆ˜ ì„ ì–¸ ì œê±°ë¨]
    let allData = [];
    let currentQuizData = [];
    let currentQuestionIndex = 0;
    let questionScores = {};
    let geminiApiKey = '';
    let activeHintQuestionKey = null;
    let selectedAiModel = 'gemini-2.5-flash';
    let darkMode = 'system';
    let prevLoaded = false;
    let summaryViewMode = 'ALL';
    let statsView = 'day';
    [ì´ì „ ì½”ë“œ ì¢…ë£Œ] */
    let ctrlNavState='dashboard', lastScrollYBeforeFocus=0;

    let calRefDate = (() => { const d = new Date(); d.setHours(0,0,0,0); d.setDate(1); return d; })();

// âš ï¸ CRITICAL: statsRefDateëŠ” ë¡œì»¬ ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ì§€ ì•ŠìŒ
// window.statsRefDate (app.jsì—ì„œ StorageManagerì™€ ì—°ê²°ë¨)ë¥¼ ì‚¬ìš©
// ë¡œì»¬ ì„ ì–¸ ì‹œ window ë³€ìˆ˜ë¥¼ ê°€ë ¤ì„œ(shadowing) ë™ê¸°í™” ì‹¤íŒ¨
/* [ì´ì „ ì½”ë“œ - ë¡œì»¬ ë³€ìˆ˜ ì„ ì–¸ ì œê±°ë¨]
let statsRefDate = new Date();
statsRefDate.setHours(0,0,0,0);
[ì´ì „ ì½”ë“œ ì¢…ë£Œ] */

// ============================================================
// âœ‚ï¸ REFACTORED â†’ js/core/storageManager.js
// ============================================================
// function initStatsDate() â†’ js/core/storageManager.js
// function saveStatsDate() â†’ js/core/storageManager.js
// function loadExamDate() â†’ js/core/storageManager.js
// function saveExamDate() â†’ js/core/storageManager.js
// function calculateDDay() â†’ js/core/storageManager.js
// function updateDDayDisplay() â†’ js/core/storageManager.js
// function migrateData() â†’ js/core/storageManager.js
// function enforceExclusiveFlagsOnAll() â†’ js/core/storageManager.js
// function setFlagState() â†’ js/core/storageManager.js
// loadReadStore, saveReadStore, etc. â†’ js/core/storageManager.js

/* [ì´ì „ ì½”ë“œ - ì‚­ì œë¨]
function initStatsDate() {
  const saved = localStorage.getItem(STATS_DATE_KEY);
  if (saved) {
    const d = new Date(saved + 'T00:00:00');
    if (!isNaN(d.getTime())) {
      statsRefDate = d;
      return;
    }
  }
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  statsRefDate = now;
}

function saveStatsDate() {
  const y = statsRefDate.getFullYear();
  const m = String(statsRefDate.getMonth() + 1).padStart(2, '0');
  const d = String(statsRefDate.getDate()).padStart(2, '0');
  localStorage.setItem(STATS_DATE_KEY, `${y}-${m}-${d}`);
}

// D-DAY ê´€ë ¨ í•¨ìˆ˜
function loadExamDate() {
  const saved = localStorage.getItem(EXAM_DATE_KEY);
  if (saved) {
    return saved; // YYYY-MM-DD format
  }
  return '2026-06-27'; // ê¸°ë³¸ê°’
}

function saveExamDate(dateStr) {
  localStorage.setItem(EXAM_DATE_KEY, dateStr);
}

function calculateDDay(examDateStr) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const examDate = new Date(examDateStr + 'T00:00:00');
  if (isNaN(examDate.getTime())) {
    return null;
  }

  const diffTime = examDate.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

  return diffDays;
}

function updateDDayDisplay() {
  if (!el.ddayDisplay) return;

  const examDate = loadExamDate();
  const dday = calculateDDay(examDate);

  if (dday === null) {
    el.ddayDisplay.textContent = 'D-DAY';
    return;
  }

  if (dday > 0) {
    el.ddayDisplay.textContent = `D-${dday}`;
  } else if (dday === 0) {
    el.ddayDisplay.textContent = 'D-DAY';
  } else {
    el.ddayDisplay.textContent = `D+${Math.abs(dday)}`;
  }
}
[ì´ì „ ì½”ë“œ ê³„ì†...] */

    const $ = id=>document.getElementById(id);
    // ============================================================
    // âœ‚ï¸ REFACTORED - el ê°ì²´ëŠ” app.jsì—ì„œ ì´ˆê¸°í™”ë¨
    // ============================================================
    // ì´ì „ì—ëŠ” ì—¬ê¸°ì„œ const el = { ... }ë¡œ ì„ ì–¸í–ˆì§€ë§Œ,
    // ì´ê²ƒì´ window.elì„ ê°€ë¦¬ëŠ”(shadowing) ë¬¸ì œê°€ ë°œìƒ
    // í•´ê²°: ë¡œì»¬ const el ì„ ì–¸ ì œê±°, window.el ì‚¬ìš©
    // app.jsì˜ initElements()ê°€ window.elì„ ìƒì„±í•˜ê³  StateManagerì— ë“±ë¡í•¨
    // ============================================================

    /* [ì´ì „ ì½”ë“œ - el ë¡œì»¬ ì„ ì–¸ ì œê±°ë¨]
    const el = {
      toast: $('toast'), apiModal:$('api-modal'), ...
    };
    [ì´ì „ ì½”ë“œ ì¢…ë£Œ] */

    // index.htmlì˜ el ê°ì²´ ì´ˆê¸°í™”
    // âš ï¸ ì´ ê°ì²´ëŠ” app.jsì˜ window.elê³¼ëŠ” ë³„ê°œë¡œ ìƒì„±ë¨
    // í•˜ì§€ë§Œ ì–‘ìª½ ëª¨ë‘ ê°™ì€ DOM ìš”ì†Œë¥¼ ì°¸ì¡°í•˜ë¯€ë¡œ ë™ì¼í•˜ê²Œ ë™ì‘í•¨
    const el = {
      toast: $('toast'), apiModal:$('api-modal'), apiModalInput:$('api-modal-input'), apiModalRemember:$('modal-remember'),
      apiModalSaveBtn:$('api-save-btn'), apiModalCancelBtn:$('api-cancel-btn'),
      settingsBtn:$('settings-btn'), settingsModal:$('settings-modal'),
      settingsCloseBtn:$('settings-close-btn'), settingsCloseBtnBottom:$('settings-close-btn-bottom'),
      openApiKeyModalBtn:$('open-api-key-modal-btn'), aiModelSelect:$('ai-model-select'), darkModeSelect:$('dark-mode-select'),
      exportDataBtn:$('export-data-btn'), importDataBtn:$('import-data-btn'), importFileInput:$('import-file-input'),
      mergeDataBtn:$('merge-data-btn'), mergeFileInput:$('merge-file-input'),
      chapterSelect:$('chapter-select'), filterSelect:$('filter-select'), loadQuizBtn:$('load-quiz-btn'), randomQuizBtn:$('random-quiz-btn'),
      quizArea:$('quiz-area'), questionNumber:$('question-number'), questionText:$('question-text'), questionCounter:$('question-counter'),
      userAnswer:$('user-answer'), errorMessage:$('error-message'), prevBtn:$('prev-btn'), nextBtn:$('next-btn'),
      gradeBtn:$('grade-btn'), gradeBtnText:$('grade-btn-text'), gradeLoader:$('grade-loader'), hintBtn:$('hint-btn'), hintBox:$('hint-container'),
      loadPrevAnswerBtn:$('load-prev-answer-btn'), resultBox:$('result-box'), modelAnswerBox:$('model-answer-box'), score:$('score'), progressBar:$('progress-bar'),
      aiFeedback:$('ai-feedback'), correctAnswer:$('correct-answer'), summaryArea:$('summary-area'), scoreSummary:$('score-summary'),
      clearFilterBtn:$('clear-filter-btn'), resetScoresBtn:$('reset-scores-btn'), summaryViewAllBtn:$('summary-view-all'), summaryViewCurrentBtn:$('summary-view-current'),
      dbQuestionId:$('db-question-id'), fixedHeader:$('fixed-header'), layoutRoot:$('layout-root'),
      statsOverview:$('stats-overview'),
      reviewStrategySelect:$('review-strategy-select'), startReviewBtn:$('start-review-btn'),
      sourceFilterSide:$('source-filter-side'), sourceGroupFilter:$('source-group-filter'),
      explorerChapters:$('explorer-chapters'), explorerProblems:$('explorer-problems'), explorerSearch:$('explorer-search'),
      reviewFlagToggle:$('review-flag-toggle'), reviewExcludeToggle:$('review-exclude-toggle'),
      hamburger:$('hamburger'), leftDashboard:$('left-dashboard'), drawerBackdrop:$('drawer-backdrop'), drawerClose:$('drawer-close'),
      calPrev:$('cal-prev'), calNext:$('cal-next'), calTitle:$('cal-title'), calendarGrid:$('calendar-grid'),
      openReportBtn:$('open-report-btn'), reportModal:$('report-modal'), reportCloseBtn:$('report-close-btn'),
      reportPeriodSelect:$('report-period-select'), reportThresholdSelect:$('report-threshold-select'),
      chartScopeSelect:$('chart-scope-select'),
      reportRefreshBtn:$('report-refresh-btn'), reportSaveSnapshotBtn:$('report-save-snapshot-btn'), reportLoadSnapshotBtn:$('report-load-snapshot-btn'), reportLoadSnapshotInput:$('report-load-snapshot-input'), reportPrintBtn:$('report-print-btn'),
      aiAnalysisStartBtn:$('ai-analysis-start-btn'), aiAnalysisResult:$('ai-analysis-result'), aiAnalysisLoading:$('ai-analysis-loading'),
      aiAnalysisCopyBtn:$('ai-analysis-copy-btn'), aiErrorPattern:$('ai-error-pattern'), aiConceptWeakness:$('ai-concept-weakness'),
      openAchievementsBtn:$('open-achievements-btn'), achievementsModal:$('achievements-modal'), achievementsCloseBtn:$('achievements-close-btn'),
      achievementCountTotal:$('achievement-count-total'), achievementCountUnlocked:$('achievement-count-unlocked'),
      achievementProgressPercent:$('achievement-progress-percent'), achievementPoints:$('achievement-points'), achievementsList:$('achievements-list'),
      flashcardModeBtn:$('flashcard-mode-btn'), flashcardArea:$('flashcard-area'), flashcardTitle:$('flashcard-title'),
      flashcardQuestion:$('flashcard-question'), flashcardAnswer:$('flashcard-answer'), flashcardCounter:$('flashcard-counter'),
      flashcardToggleAnswer:$('flashcard-toggle-answer'), flashcardAnswerBox:$('flashcard-answer-box'), flashcardAnswerHidden:$('flashcard-answer-hidden'),
      flashcardPrevBtn:$('flashcard-prev-btn'), flashcardNextBtn:$('flashcard-next-btn'), flashcardRandomBtn:$('flashcard-random-btn'), flashcardExitBtn:$('flashcard-exit-btn'),
      ddayDisplay:$('dday-display'), examDateInput:$('exam-date-input'), saveExamDateBtn:$('save-exam-date-btn')
    };

    // [ë¦¬íŒ©í† ë§] ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ëŠ” js/utils/helpers.jsë¡œ ì´ë™ë¨
    // const clamp = ... â†’ js/utils/helpers.js
    // const normId = ... â†’ js/utils/helpers.js
    // const sanitizeModelText = ... â†’ js/utils/helpers.js
    // [ë¦¬íŒ©í† ë§] DOM ìœ í‹¸ë¦¬í‹°ëŠ” js/ui/domUtils.jsë¡œ ì´ë™ë¨
    // const showToast = ... â†’ js/ui/domUtils.js
    // const getHeaderOffset = ... â†’ js/ui/domUtils.js
    // const smoothScrollTo = ... â†’ js/ui/domUtils.js
    // const elmTop = ... â†’ js/ui/domUtils.js

    // [ë¦¬íŒ©í† ë§] ìƒ‰ìƒ ë° ë‚ ì§œ ìœ í‹¸ë¦¬í‹°ëŠ” js/utils/helpers.jsë¡œ ì´ë™ë¨
    // function hslToHex(...) â†’ js/utils/helpers.js
    // function colorForCount(...) â†’ js/utils/helpers.js
    // const ymd = ... â†’ js/utils/helpers.js
    // const dowMon0 = ... â†’ js/utils/helpers.js

    // [ë¦¬íŒ©í† ë§] ë‹¨ì›/íŒŒíŠ¸ ìƒìˆ˜ ë° í—¬í¼ëŠ” js/config/config.jsë¡œ ì´ë™ë¨
    // const CHAPTER_LABELS = { ... } â†’ js/config/config.js
    // const PART_INSERTIONS = [ ... ] â†’ js/config/config.js
    // const chapterLabelText = ... â†’ js/config/config.js
    // const PART_VALUE = ... â†’ js/config/config.js
    // const isPartValue = ... â†’ js/config/config.js
    // const parsePartValue = ... â†’ js/config/config.js
    // [ë¦¬íŒ©í† ë§] ë‹¨ì› ì²˜ë¦¬ í•¨ìˆ˜ëŠ” js/utils/helpers.jsë¡œ ì´ë™ë¨
    // ============================================================
    // âœ‚ï¸ REFACTORED â†’ js/core/dataManager.js
    // ============================================================
    // const getAllChapterNums = ... â†’ js/core/dataManager.js
    // ============================================================
    // âœ‚ï¸ REFACTORED â†’ js/core/dataManager.js
    // ============================================================
    // async function loadData() â†’ js/core/dataManager.js
    // function selfTest() â†’ js/core/dataManager.js
    // function populateChapterSelect() â†’ js/core/dataManager.js
    //
    // ìœ„ í•¨ìˆ˜ë“¤ì€ app.jsë¥¼ í†µí•´ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œë¨:
    // window.getAllChapterNums, window.loadData, window.selfTest, window.populateChapterSelect

    // ============================================================
    // âœ‚ï¸ REFACTORED â†’ js/core/stateManager.js
    // ============================================================
    // function loadScores() - StateManager.initializeState()ì—ì„œ ì²˜ë¦¬
    // function loadApiKey() - StateManager.initializeState()ì—ì„œ ì²˜ë¦¬
    //
    // loadSettings()ëŠ” UI ë™ê¸°í™”ë§Œ ìˆ˜í–‰ (ê°’ì€ ì´ë¯¸ StateManagerì— ë¡œë“œë¨)
    function loadSettings(){
      if(el.aiModelSelect) el.aiModelSelect.value = getSelectedAiModel();
    }

    // ============================================================
    // âœ‚ï¸ REFACTORED â†’ js/core/storageManager.js
    // ============================================================
    // function migrateData() â†’ storageManager.js
    // function enforceExclusiveFlagsOnAll() â†’ storageManager.js
    // function setFlagState() â†’ storageManager.js
    //
    // ìœ„ í•¨ìˆ˜ë“¤ì€ app.jsë¥¼ í†µí•´ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œë¨

    function openApiModal(initial=false){ if(initial) el.apiModalCancelBtn.classList.add('hidden'); else el.apiModalCancelBtn.classList.remove('hidden');
      el.apiModal.classList.remove('hidden'); el.apiModal.classList.add('flex'); el.apiModalInput.value=geminiApiKey||''; el.apiModalRemember.checked=!!localStorage.getItem('geminiApiKey'); setTimeout(()=>el.apiModalInput.focus(),0);
    }
    const closeApiModal=()=>{ el.apiModal.classList.add('hidden'); el.apiModal.classList.remove('flex'); };
    const ensureApiKeyGate=()=>{ if(!window.geminiApiKey && !window.getGeminiApiKey?.()) openApiModal(true); };
    el.apiModalSaveBtn.addEventListener('click',()=>{
      const key=(el.apiModalInput.value||'').trim(); if(!key){ showToast('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.','error'); el.apiModalInput.focus(); return; }
      geminiApiKey=key; sessionStorage.setItem('geminiApiKey',key); if(el.apiModalRemember.checked) localStorage.setItem('geminiApiKey',key); else localStorage.removeItem('geminiApiKey'); closeApiModal(); showToast('API í‚¤ ì €ì¥ ì™„ë£Œ');
    });
    el.apiModalCancelBtn.addEventListener('click',closeApiModal);

    // Global Escape key handler (priority: highest z-index first)
    document.addEventListener('keydown',e=>{
      if(e.key==='Escape'){
        // Priority 1: Flashcard mode (handled separately in flashcard section)
        if(!el.flashcardArea?.classList.contains('hidden')) return;

        // Priority 2: Report modal
        if(!el.reportModal?.classList.contains('hidden')){ closeReportModal(); return; }

        // Priority 3: Settings modal
        if(!el.settingsModal?.classList.contains('hidden')){ closeSettingsModal(); return; }

        // Priority 4: API modal
        if(!el.apiModalCancelBtn?.classList.contains('hidden') && !el.apiModal?.classList.contains('hidden')){ closeApiModal(); return; }
      }
    });

    function openSettingsModal(){
      el.settingsModal.classList.remove('hidden');
      el.settingsModal.classList.add('flex');
      if(el.aiModelSelect) el.aiModelSelect.value=selectedAiModel;
      if(el.darkModeSelect) el.darkModeSelect.value=darkMode;
      if(el.examDateInput) el.examDateInput.value=loadExamDate();
    }
    function closeSettingsModal(){ el.settingsModal.classList.add('hidden'); el.settingsModal.classList.remove('flex'); }
    el.settingsBtn.addEventListener('click',openSettingsModal);
    el.settingsCloseBtn.addEventListener('click',closeSettingsModal);
    el.settingsCloseBtnBottom.addEventListener('click',closeSettingsModal);
    el.openApiKeyModalBtn?.addEventListener('click',()=>{ closeSettingsModal(); openApiModal(false); });
    el.aiModelSelect?.addEventListener('change',e=>{ selectedAiModel=e.target.value; localStorage.setItem('aiModel',selectedAiModel); showToast(`AI ëª¨ë¸ ë³€ê²½: ${selectedAiModel}`); });
    el.darkModeSelect?.addEventListener('change',e=>{ localStorage.setItem('darkMode',e.target.value); applyDarkMode(); showToast('ë‹¤í¬ ëª¨ë“œ ì„¤ì • ë³€ê²½ë¨'); });

    // D-DAY ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    el.saveExamDateBtn?.addEventListener('click', () => {
      const dateStr = el.examDateInput?.value;
      if (!dateStr) {
        showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'warn');
        return;
      }
      saveExamDate(dateStr);
      updateDDayDisplay();
      showToast('ì‹œí—˜ ë‚ ì§œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    });

    el.ddayDisplay?.addEventListener('click', () => {
      openSettingsModal();
    });

    el.exportDataBtn?.addEventListener('click',()=>{
      try{
        const data={ version:'3.x', schemaVersion:+(localStorage.getItem('schemaVersion')||2), exportDate:new Date().toISOString(), auditQuizScores:questionScores, geminiApiKey:localStorage.getItem('geminiApiKey')||'', aiModel:selectedAiModel, darkMode:darkMode };
        const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=`gamlini_backup_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url); showToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
      }catch(err){ console.error(err); showToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨','error'); }
    });
    el.importDataBtn?.addEventListener('click',()=>el.importFileInput.click());
    el.importFileInput?.addEventListener('change',e=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        try{
          const data=JSON.parse(ev.target.result);
          if(!data.auditQuizScores) throw new Error('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
          localStorage.setItem('auditQuizScores',JSON.stringify(data.auditQuizScores)); questionScores=data.auditQuizScores;
          if(data.geminiApiKey){ localStorage.setItem('geminiApiKey',data.geminiApiKey); geminiApiKey=data.geminiApiKey; }
          if(data.aiModel){ localStorage.setItem('aiModel',data.aiModel); selectedAiModel=data.aiModel; if(el.aiModelSelect) el.aiModelSelect.value=data.aiModel; }
          if(data.darkMode){ localStorage.setItem('darkMode',data.darkMode); darkMode=data.darkMode; applyDarkMode(); }
          if(data.schemaVersion) localStorage.setItem('schemaVersion',String(data.schemaVersion));
          // ê°€ì ¸ì˜¤ìë§ˆì ìƒí˜¸ë°°íƒ€ ë³´ì •
          enforceExclusiveFlagsOnAll();
          showToast('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ'); setTimeout(()=>location.reload(),600);
        }catch(err){ console.error(err); showToast(`ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`,'error'); }
      };
      reader.readAsText(file); e.target.value='';
    });

    // ë³‘í•© ê°€ì ¸ì˜¤ê¸° ê¸°ëŠ¥
    function mergeQuizScores(existing, imported){
      const result={...existing};
      for(const [qid,importedData] of Object.entries(imported)){
        if(!result[qid]){
          // ìƒˆë¡œìš´ ë¬¸ì œ ID - ê·¸ëƒ¥ ì¶”ê°€
          result[qid]=importedData;
        }else{
          // ê¸°ì¡´ ë¬¸ì œ ID - ë³‘í•© (ìµœì‹  í’€ì´ ë°ì´í„° ìš°ì„ )
          const existingData=result[qid];
          const useImported=(importedData.lastSolvedDate||0)>(existingData.lastSolvedDate||0);
          // solveHistory ë³‘í•© (ë‚ ì§œ ê¸°ì¤€ ì¤‘ë³µ ì œê±°)
          const combinedHistory=[...(existingData.solveHistory||[]),...(importedData.solveHistory||[])];
          const uniqueHistory=Array.from(new Map(combinedHistory.map(h=>[h.date,h])).values()).sort((a,b)=>a.date-b.date);
          result[qid]={
            score:useImported?(importedData.score||0):(existingData.score||0),
            feedback:useImported?importedData.feedback:existingData.feedback,
            user_answer:useImported?importedData.user_answer:existingData.user_answer,
            hintUsed:useImported?importedData.hintUsed:existingData.hintUsed,
            isSolved:existingData.isSolved||importedData.isSolved,
            lastSolvedDate:Math.max(existingData.lastSolvedDate||0,importedData.lastSolvedDate||0),
            solveHistory:uniqueHistory,
            userReviewFlag:existingData.userReviewFlag||importedData.userReviewFlag,
            userReviewExclude:existingData.userReviewExclude||importedData.userReviewExclude
          };
        }
      }
      return result;
    }

    el.mergeDataBtn?.addEventListener('click',()=>el.mergeFileInput.click());
    el.mergeFileInput?.addEventListener('change',e=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        try{
          const data=JSON.parse(ev.target.result);
          if(!data.auditQuizScores) throw new Error('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
          // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©
          const mergedScores=mergeQuizScores(questionScores,data.auditQuizScores);
          localStorage.setItem('auditQuizScores',JSON.stringify(mergedScores)); questionScores=mergedScores;
          // ì„¤ì •ì€ ê°€ì ¸ì˜¨ íŒŒì¼ì˜ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ìˆëŠ” ê²½ìš°)
          if(data.geminiApiKey){ localStorage.setItem('geminiApiKey',data.geminiApiKey); geminiApiKey=data.geminiApiKey; }
          if(data.aiModel){ localStorage.setItem('aiModel',data.aiModel); selectedAiModel=data.aiModel; if(el.aiModelSelect) el.aiModelSelect.value=data.aiModel; }
          if(data.darkMode){ localStorage.setItem('darkMode',data.darkMode); darkMode=data.darkMode; applyDarkMode(); }
          if(data.schemaVersion) localStorage.setItem('schemaVersion',String(data.schemaVersion));
          // ë³‘í•© í›„ ìƒí˜¸ë°°íƒ€ ë³´ì •
          enforceExclusiveFlagsOnAll();
          showToast('ë°ì´í„° ë³‘í•© ì™„ë£Œ'); setTimeout(()=>location.reload(),600);
        }catch(err){ console.error(err); showToast(`ë³‘í•© ì‹¤íŒ¨: ${err.message}`,'error'); }
      };
      reader.readAsText(file); e.target.value='';
    });

    // ============================================================
    // âœ‚ï¸ REFACTORED â†’ js/features/filter/filterCore.js
    // ============================================================
    // function buildSourceFilterUI() â†’ filterCore.js
    // function getSelectedSourceGroups() â†’ filterCore.js
    // function detectSourceGroup() â†’ filterCore.js
    // function applySourceFilter() â†’ filterCore.js
    // function filterByChapterSelection() â†’ filterCore.js
    // function getFilteredByUI() â†’ filterCore.js
    //
    // ìœ„ í•¨ìˆ˜ë“¤ì€ app.jsë¥¼ í†µí•´ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œë¨

    // ============================================================
    // âœ‚ï¸ REFACTORED â†’ js/features/quiz/quizCore.js
    // ============================================================
    // function reloadAndRefresh() â†’ quizCore.js
    // function displayQuestion() â†’ quizCore.js
    // function updateFlagButtonsUI() â†’ quizCore.js
    // function startRandomQuiz() â†’ quizCore.js
    //
    // ìœ„ í•¨ìˆ˜ë“¤ì€ app.jsë¥¼ í†µí•´ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œë¨

    el.chapterSelect.addEventListener('change', reloadAndRefresh);
    el.filterSelect.addEventListener('change', reloadAndRefresh);
    el.loadQuizBtn.addEventListener('click', reloadAndRefresh);
    el.randomQuizBtn.addEventListener('click', startRandomQuiz);

    // ë³µìŠµì¶”ê°€(â˜…) í´ë¦­ â†’ ì œì™¸(â–)ì™€ ìƒí˜¸ë°°íƒ€
    el.reviewFlagToggle.addEventListener('click',()=>{
      const cqd = getCurrentQuizData(); const cqi = getCurrentQuestionIndex();
      if(!cqd.length) return;
      const q=cqd[cqi], key=normId(q.ê³ ìœ ID), rec=questionScores[key]||{};
      const willFlag = !(rec.userReviewFlag && !rec.userReviewExclude); // ì‹œê°ìƒ Flag í™œì„± ì—¬ë¶€
      if (willFlag) {
        // ì¶”ê°€ë¡œ ì „í™˜: ì œì™¸ë¥¼ í•´ì œ
        setFlagState(key, { flag:true, exclude:false });
        showToast('ë³µìŠµ ì¶”ê°€ë¡œ ì „í™˜(â– í•´ì œ)');
      } else {
        // ì¶”ê°€ í•´ì œ
        setFlagState(key, { flag:false, exclude:!!rec.userReviewExclude });
        showToast('ë³µìŠµ ì¶”ê°€ í•´ì œ');
      }
      updateFlagButtonsUI(questionScores[key]);
      refreshPanels();
    });

    // ë³µìŠµì œì™¸(â–) í´ë¦­ â†’ ì¶”ê°€(â˜…)ì™€ ìƒí˜¸ë°°íƒ€
    el.reviewExcludeToggle?.addEventListener('click', ()=>{
      const cqd = getCurrentQuizData(); const cqi = getCurrentQuestionIndex();
      if(!cqd.length) return;
      const q=cqd[cqi], key=normId(q.ê³ ìœ ID), rec=questionScores[key]||{};
      const willExclude = !rec.userReviewExclude;
      if (willExclude) {
        // ì œì™¸ë¡œ ì „í™˜: ì¶”ê°€ë¥¼ í•´ì œ
        setFlagState(key, { flag:false, exclude:true });
        showToast('ì˜¤ëŠ˜ì˜ ë³µìŠµì—ì„œ ì œì™¸ë¡œ ì „í™˜(â˜… í•´ì œ)');
      } else {
        // ì œì™¸ í•´ì œ (í•„ìš”ì‹œ ì‚¬ìš©ìê°€ ë³„ë„ë¡œ â˜… ì¶”ê°€)
        setFlagState(key, { flag:!!rec.userReviewFlag, exclude:false });
        showToast('ë³µìŠµ ì œì™¸ í•´ì œ');
      }
      updateFlagButtonsUI(questionScores[key]);
      refreshPanels();
    });

    el.loadPrevAnswerBtn.addEventListener('click',()=>{
      const cqd = getCurrentQuizData(); const cqi = getCurrentQuestionIndex();
      if(!cqd.length) return;
      const q=cqd[cqi], saved=questionScores[normId(q.ê³ ìœ ID)];
      if(!prevLoaded){
        if(saved?.user_answer){ el.userAnswer.value=saved.user_answer; el.loadPrevAnswerBtn.textContent='ë‹µì•ˆ ì§€ìš°ê¸°'; el.loadPrevAnswerBtn.setAttribute('aria-pressed','true'); prevLoaded=true; showToast('ì´ì „ ë‹µì•ˆì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.'); }
        else showToast('ì €ì¥ëœ ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤.','warn');
      }else{
        el.userAnswer.value=''; el.loadPrevAnswerBtn.textContent='ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°'; el.loadPrevAnswerBtn.setAttribute('aria-pressed','false'); prevLoaded=false;
      }
    });

    el.prevBtn.addEventListener('click', handlePrevQuestion);
    el.nextBtn.addEventListener('click', handleNextQuestion);
    /* [ì´ì „ ì½”ë“œ - navigation.jsë¡œ ì´ë™ë¨]
    el.prevBtn.addEventListener('click',()=>{ if(currentQuestionIndex>0){ currentQuestionIndex--; displayQuestion(); } });
    el.nextBtn.addEventListener('click',()=>{ if(currentQuestionIndex<currentQuizData.length-1){ currentQuestionIndex++; displayQuestion(); } });
    [ì´ì „ ì½”ë“œ ì¢…ë£Œ] */
    el.userAnswer.addEventListener('input',()=> el.errorMessage.classList.add('hidden'));
    el.userAnswer.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); el.gradeBtn.click(); } });

    // ============================================================
    // âœ‚ï¸ REFACTORED â†’ js/features/quiz/grading.js
    // ============================================================
    // async function handleGrade() â†’ js/features/quiz/grading.js
    // function setGradeLoading() â†’ js/features/quiz/grading.js (ì´ì „ setLoadingì—ì„œ ì´ë¦„ ë³€ê²½)
    // async function handleHint() â†’ js/features/quiz/grading.js
    // function showResult() â†’ js/features/quiz/grading.js
    //
    // ìœ„ í•¨ìˆ˜ë“¤ì€ app.jsë¥¼ í†µí•´ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œë¨

    el.gradeBtn.addEventListener('click',handleGrade);


    // [ë¦¬íŒ©í† ë§] Gemini API í•¨ìˆ˜ëŠ” js/services/geminiApi.jsë¡œ ì´ë™ë¨
    // async function callGeminiAPI(...) â†’ js/services/geminiApi.js
    // selectedAiModelì„ íŒŒë¼ë¯¸í„°ë¡œ ë°›ë„ë¡ ìˆ˜ì •ë¨

    el.hintBtn.addEventListener('click',()=>{ const cqd = getCurrentQuizData(); const cqi = getCurrentQuestionIndex(); if(cqd.length) handleHint(cqd[cqi]); });

    /* [ì´ì „ ì½”ë“œ - grading.jsë¡œ ì´ë™ë¨]
    el.hintBtn.addEventListener('click',()=>{ if(currentQuizData.length) handleHint(currentQuizData[currentQuestionIndex]); });
    async function handleHint(q){
      if(!geminiApiKey){ openApiModal(false); showToast('Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.','error'); return; }
      setLoading(true);
      try{
        const hint=await callGeminiHintAPI(el.userAnswer.value.trim(), q.ì •ë‹µ, q.ë¬¼ìŒ, geminiApiKey);
        el.hintBox.innerHTML=`<strong class="font-semibold">íŒíŠ¸</strong><br>${String(hint||'').replace(/\n/g,'<br>')}`;
        el.hintBox.classList.remove('hidden'); activeHintQuestionKey=normId(q.ê³ ìœ ID); showToast('íŒíŠ¸ë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤. (ì¦‰ì‹œ ì±„ì  ì‹œ ê°ì )','warn');
      }catch(e){ console.error(e); showToast(`íŒíŠ¸ ìƒì„± ì‹¤íŒ¨: ${e.message}`,'error'); }
      finally{ setLoading(false); }
    }
    [ì´ì „ ì½”ë“œ ì¢…ë£Œ] */
    // [ë¦¬íŒ©í† ë§] Gemini Hint API í•¨ìˆ˜ë„ js/services/geminiApi.jsë¡œ ì´ë™ë¨
    // async function callGeminiHintAPI(...) â†’ js/services/geminiApi.js

    // [ë¦¬íŒ©í† ë§] Gemini Text API í•¨ìˆ˜ë„ js/services/geminiApi.jsë¡œ ì´ë™ë¨
    // async function callGeminiTextAPI(...) â†’ js/services/geminiApi.js

    /* [ì´ì „ ì½”ë“œ - grading.jsë¡œ ì´ë™ë¨]
    function showResult(scoreVal, feedback){
      const s=clamp(+scoreVal,0,100);
      el.score.textContent=s.toFixed(1); el.progressBar.style.width=`${s}%`; el.progressBar.setAttribute('aria-valuenow',String(Math.round(s)));
    function backfillReadStoreFromScores(force=false){
      if(!force && localStorage.getItem('readStoreBackfilled_v2')==='1') return;
      const db=loadReadStore(); let touched=0;
      for(const [qid,rec] of Object.entries(questionScores||{})){ const hist=Array.isArray(rec?.solveHistory)?rec.solveHistory:[]; if(!hist.length) continue; const has=db[qid];
        if(!has || !Number.isFinite(+has.uniqueReads) || +has.uniqueReads===0){ const seed=computeUniqueReadsFromHistory(hist); if(seed.uniqueReads>0){ db[qid]=seed; touched++; } }
      }
    [ì´ì „ ì½”ë“œ ì¢…ë£Œ] */

    // ============================================================
    // âœ‚ï¸ REFACTORED â†’ js/features/summary/summaryCore.js
    // - updateSummary()
    // - updateSummaryHighlight()
    // ============================================================

    el.clearFilterBtn.addEventListener('click',()=>{
      el.filterSelect.value='all'; el.chapterSelect.value='';
      el.sourceGroupFilter?.querySelectorAll('input.source-filter')?.forEach(cb=>cb.checked=true);
      localStorage.setItem(SOURCE_LS,JSON.stringify(['basic','advanced','other']));
      reloadAndRefresh(); showToast('í•„í„° í•´ì œ: ëª¨ë“  ë¬¸ì œ í‘œì‹œ');
    });
    el.resetScoresBtn.addEventListener('click',()=>{
      if(confirm('ì •ë§ë¡œ ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
        questionScores={}; localStorage.removeItem('auditQuizScores'); localStorage.removeItem('schemaVersion'); localStorage.removeItem('readSessions_v2'); localStorage.removeItem('readStoreBackfilled_v2');
        updateSummary(); if(currentQuizData.length){ currentQuestionIndex=0; reloadAndRefresh(); } refreshPanels(); showToast('í•™ìŠµ ê¸°ë¡ ì´ˆê¸°í™” ì™„ë£Œ');
      }
    });

    // âœ‚ï¸ REFACTORED â†’ js/features/summary/summaryCore.js: ensureResultBoxReady()

    function enterFocusMode(){
      lastScrollYBeforeFocus=window.pageYOffset;
      document.documentElement.classList.add('focus-mode');
      ensureResultBoxReady();

      const headerHeight = el.fixedHeader?.getBoundingClientRect().height || 0;
      const margin = 12;
      const viewportHeight = window.innerHeight;

      // userAnswer ìƒë‹¨ ìœ„ì¹˜
      const userAnswerTop = el.userAnswer.getBoundingClientRect().top + window.pageYOffset - headerHeight - margin;

      // ëª¨ë²”ë‹µì•ˆ ë°•ìŠ¤ê°€ í‘œì‹œë˜ì–´ ìˆìœ¼ë©´, ëª¨ë²”ë‹µì•ˆ ë°•ìŠ¤ í•˜ë‹¨ê¹Œì§€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
      if(el.modelAnswerBox && !el.modelAnswerBox.classList.contains('hidden')){
        const modelAnswerBottom = el.modelAnswerBox.getBoundingClientRect().bottom + window.pageYOffset;
        const contentHeight = modelAnswerBottom - (el.userAnswer.getBoundingClientRect().top + window.pageYOffset);

        // ì „ì²´ ì½˜í…ì¸ ê°€ viewportë³´ë‹¤ í¬ë©´, userAnswer ìƒë‹¨ì„ ê¸°ì¤€ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        // ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ëª¨ë²”ë‹µì•ˆ ë°•ìŠ¤ í•˜ë‹¨ì´ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤
        if(contentHeight > viewportHeight - headerHeight - margin * 2){
          window.scrollTo({top:Math.max(0, userAnswerTop), behavior:'smooth'});
        } else {
          const targetScroll = modelAnswerBottom - viewportHeight + margin;
          window.scrollTo({top:Math.max(0, Math.max(userAnswerTop, targetScroll)), behavior:'smooth'});
        }
      } else {
        window.scrollTo({top:Math.max(0, userAnswerTop), behavior:'smooth'});
      }

      ctrlNavState='focus';
    }
    function exitToDashboard(){ document.documentElement.classList.remove('focus-mode'); if(el.summaryArea) window.scrollTo({top:el.summaryArea.getBoundingClientRect().top + window.pageYOffset - (el.fixedHeader?.getBoundingClientRect().height||0) - 8, behavior:'smooth'}); else window.scrollTo({top:0,behavior:'smooth'}); ctrlNavState='dashboard'; }
    function backFromFocus(){ document.documentElement.classList.remove('focus-mode'); window.scrollTo({top:Math.max(0,lastScrollYBeforeFocus),behavior:'smooth'}); ctrlNavState='dashboard'; }
    const isEditing=t=> t && (t.tagName==='INPUT' || t.tagName==='TEXTAREA' || t.isContentEditable);
    document.addEventListener('keydown',e=>{
      // H: íŒíŠ¸
      if((e.key==='h'||e.key==='H') && !isEditing(e.target)){ e.preventDefault(); el.hintBtn?.click(); return; }
      // R: ëœë¤ ë¬¸ì œ
      if((e.key==='r'||e.key==='R') && !isEditing(e.target)){ e.preventDefault(); el.randomQuizBtn?.click(); return; }
      // L: ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°
      if((e.key==='l'||e.key==='L') && !isEditing(e.target)){ e.preventDefault(); el.loadPrevAnswerBtn?.click(); return; }
      // X: ë³µìŠµ ì œì™¸ í† ê¸€
      if((e.key==='x'||e.key==='X') && !isEditing(e.target)){ e.preventDefault(); el.reviewExcludeToggle?.click(); return; }
      // S: í•™ìŠµ í˜„í™©íŒìœ¼ë¡œ ìŠ¤í¬ë¡¤
      if((e.key==='s'||e.key==='S') && !isEditing(e.target)){ e.preventDefault(); if(el.summaryArea && !el.summaryArea.classList.contains('hidden')) window.scrollTo({top:el.summaryArea.getBoundingClientRect().top + window.pageYOffset - (el.fixedHeader?.getBoundingClientRect().height||0) - 8, behavior:'smooth'}); return; }
      // G: ì±„ì í•˜ê¸° (textareaì— í¬ì»¤ìŠ¤ ì—†ì„ ë•Œ)
      if((e.key==='g'||e.key==='G') && !isEditing(e.target)){ e.preventDefault(); el.gradeBtn?.click(); return; }
      if(e.ctrlKey && !e.altKey && !e.metaKey){
        if(e.key==='ArrowLeft'){ e.preventDefault(); el.prevBtn?.click(); return; }
        if(e.key==='ArrowRight'){ e.preventDefault(); el.nextBtn?.click(); return; }
        if(e.key==='['){ e.preventDefault(); if(ctrlNavState==='focus') backFromFocus(); else window.scrollTo({top:0,behavior:'smooth'}); return; }
        if(e.key===']'){ e.preventDefault(); if(ctrlNavState!=='focus') enterFocusMode(); else exitToDashboard(); return; }
      }
    });

    const getScopeFilteredData=()=> filterByChapterSelection(applySourceFilter(allData||[]));

    function renderCalendarMonth() {
      const grid = el.calendarGrid, title = el.calTitle; if (!grid || !title) return;
      title.textContent = `${calRefDate.getFullYear()}.${String(calRefDate.getMonth()+1).padStart(2,'0')}`;
      const base = getScopeFilteredData(); const idSet = new Set(base.map(q => String(q.ê³ ìœ ID).trim()));
      const counts = new Map();
      // âš ï¸ CRITICAL: window.questionScoresë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš© (Object.definePropertyë¡œ ì—°ê²°ë¨)
      const scores = window.questionScores || window.getQuestionScores?.() || {};
      for (const [qid, rec] of Object.entries(scores)) {
        if (!idSet.has(qid)) continue;
        const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
        for (const h of hist) {
          const t = Number(h?.date); if (!Number.isFinite(t)) continue;
          const d = new Date(t); d.setHours(0,0,0,0);
          const k = ymd(d);
          counts.set(k, (counts.get(k)||0) + 1);
        }
      }
      const first = new Date(calRefDate); const firstDow = dowMon0(first);
      const start = new Date(first); start.setDate(first.getDate() - firstDow);
      const lastDay = new Date(calRefDate.getFullYear(), calRefDate.getMonth()+1, 0);
      const lastDow = dowMon0(lastDay);
      const end = new Date(lastDay); end.setDate(lastDay.getDate() + (6 - lastDow));

      grid.innerHTML = '';
      for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
        const inMonth = (d.getMonth() === calRefDate.getMonth() && d.getFullYear() === calRefDate.getFullYear());
        const key = ymd(d);
        const c = counts.get(key) || 0;
        const { bg, fg } = colorForCount(c);
        const cell = document.createElement('div');
        cell.className = `cal-cell` + (inMonth ? '' : ' muted');
        cell.title = `${key} Â· í’€ì´ ${c}íšŒ`;
        cell.style.backgroundColor = bg;
        cell.style.color = fg;
        const day = document.createElement('div');
        day.className = 'cal-day';
        day.textContent = String(d.getDate());
        cell.appendChild(day);
        grid.appendChild(cell);
      }
      bindCalendarDateClick();
    }
      function bindCalendarDateClick() {
  const cells = el.calendarGrid?.querySelectorAll('.cal-cell');
  cells?.forEach(cell => {
    cell.style.cursor = 'pointer';
    
    cell.addEventListener('click', (e) => {
      const title = cell.title;
      if (!title) return;
      
      const dateStr = title.split(' ')[0];
      const clickedDate = new Date(dateStr + 'T00:00:00');
      if (isNaN(clickedDate.getTime())) return;
      
      statsRefDate = clickedDate;
      saveStatsDate();
      renderStats();
      
      showToast(`${dateStr} í†µê³„ë¡œ ì´ë™`, 'info');
      
      setTimeout(() => {
        const offset = getHeaderOffset();
        const statsBox = el.statsOverview?.closest('.bg-white');
        if (statsBox) {
          const y = statsBox.getBoundingClientRect().top + window.pageYOffset - offset - 8;
          window.scrollTo({ top: Math.max(0, y), behavior: 'smooth' });
        }
      }, 100);
    });
  });
}

    el.calPrev?.addEventListener('click', () => { calRefDate.setMonth(calRefDate.getMonth()-1); renderCalendarMonth(); });
    el.calNext?.addEventListener('click', () => { calRefDate.setMonth(calRefDate.getMonth()+1); renderCalendarMonth(); });

function renderStatsDateNav() {
  const existingNav = el.statsOverview?.querySelector('#stats-date-nav');
  if (existingNav) existingNav.remove();
  
  const nav = document.createElement('div');
  nav.id = 'stats-date-nav';
  nav.className = 'flex items-center justify-between mb-3 pb-3 border-b';
  
  const displayY = statsRefDate.getFullYear();
  const displayM = String(statsRefDate.getMonth() + 1).padStart(2, '0');
  const displayD = String(statsRefDate.getDate()).padStart(2, '0');
  const displayStr = `${displayY}-${displayM}-${displayD}`;
  
  nav.innerHTML = `
    <div class="flex items-center gap-2">
      <button id="stats-prev-day" class="w-7 h-7 flex items-center justify-center rounded border hover:bg-gray-100 text-sm" title="ì´ì „ ë‚ ">â—€</button>
      <input id="stats-date-input" type="date" class="px-2 py-1 border rounded text-sm" value="${displayStr}">
      <button id="stats-next-day" class="w-7 h-7 flex items-center justify-center rounded border hover:bg-gray-100 text-sm" title="ë‹¤ìŒ ë‚ ">â–¶</button>
    </div>
    <button id="stats-today-btn" class="text-xs px-2 py-1 border rounded hover:bg-gray-100">ì˜¤ëŠ˜</button>
  `;
  
  el.statsOverview.insertBefore(nav, el.statsOverview.firstChild);
  
  const prevBtn = el.statsOverview.querySelector('#stats-prev-day');
  const nextBtn = el.statsOverview.querySelector('#stats-next-day');
  const todayBtn = el.statsOverview.querySelector('#stats-today-btn');
  const dateInput = el.statsOverview.querySelector('#stats-date-input');
  
  prevBtn?.addEventListener('click', () => {
    statsRefDate.setDate(statsRefDate.getDate() - 1);
    saveStatsDate();
    renderStats();
  });
  
  nextBtn?.addEventListener('click', () => {
    statsRefDate.setDate(statsRefDate.getDate() + 1);
    saveStatsDate();
    renderStats();
  });
  
  todayBtn?.addEventListener('click', () => {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    statsRefDate = now;
    saveStatsDate();
    renderStats();
  });
  
  dateInput?.addEventListener('change', (e) => {
    if (e.target.value) {
      const newDate = new Date(e.target.value + 'T00:00:00');
      if (!isNaN(newDate.getTime())) {
        statsRefDate = newDate;
        saveStatsDate();
        renderStats();
      }
    }
  });
}
function renderStats(){
  if(!el.statsOverview) return;
  
  renderStatsDateNav();
  
  const startOfDay=d=>{const t=new Date(d); t.setHours(0,0,0,0); return t;};
  const endOfDay=d=>{const t=new Date(d); t.setHours(23,59,59,999); return t;};
  
  // âœ… ì£¼ê°„: ì›”ìš”ì¼ ì‹œì‘ ~ ì¼ìš”ì¼ ë
  const startOfWeek=d=>{
    const t=new Date(d); 
    t.setHours(0,0,0,0);
    const dow = (t.getDay() + 6) % 7; // 0=ì›”, 6=ì¼
    t.setDate(t.getDate() - dow);
    return t;
  };
  
  const endOfWeek=d=>{
    const t=new Date(d);
    t.setHours(23,59,59,999);
    const dow = (t.getDay() + 6) % 7;
    t.setDate(t.getDate() + (6 - dow));
    return t;
  };
  
  // âœ… ì›”ê°„: í•´ë‹¹ ì›”ì˜ 1ì¼ ì‹œì‘ ~ ë§ˆì§€ë§‰ì¼ ë
  const startOfMonth=d=>{
    const t=new Date(d.getFullYear(), d.getMonth(), 1);
    t.setHours(0,0,0,0);
    return t;
  };
  
  const endOfMonth=d=>{
    const t=new Date(d.getFullYear(), d.getMonth() + 1, 0); // ë‹¤ìŒ ë‹¬ 0ì¼ = ì´ë²ˆ ë‹¬ ë§ˆì§€ë§‰ ë‚ 
    t.setHours(23,59,59,999);
    return t;
  };
  
  // âœ… ê¸°ê°„ ì„¤ì • (ë³€ê²½ëœ ë¶€ë¶„)
  let title='ì˜¤ëŠ˜ì˜ í†µê³„', label='ì˜¤ëŠ˜', start=startOfDay(statsRefDate), end=endOfDay(statsRefDate);
  
  if(statsView==='week'){ 
    title='ì£¼ê°„ í†µê³„'; 
    label='ì£¼ê°„'; 
    start=startOfWeek(statsRefDate);
    end=endOfWeek(statsRefDate);
  }
  
  if(statsView==='month'){ 
    title='ì›”ê°„ í†µê³„'; 
    label='ì›”ê°„'; 
    start=startOfMonth(statsRefDate);
    end=endOfMonth(statsRefDate);
  }

  // ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ë™ì¼...
  const base=getScopeFilteredData(), idSet=new Set(base.map(q=>String(q.ê³ ìœ ID).trim()));
  let solved=0,sum=0, flagged=0,last=0; const daySet=new Set();

  // âš ï¸ CRITICAL: window.questionScoresë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš© (Object.definePropertyë¡œ ì—°ê²°ë¨)
  const scores = window.questionScores || window.getQuestionScores?.() || {};

  for(const q of base){
    const id=String(q.ê³ ìœ ID).trim(), rec=scores[id];
    if(rec && Number.isFinite(+rec.score)){ solved++; sum+=+rec.score; }
    if(rec?.userReviewFlag && !rec.userReviewExclude) flagged++;
    if(rec?.lastSolvedDate && rec.lastSolvedDate>last) last=rec.lastSolvedDate;
    (Array.isArray(rec?.solveHistory)?rec.solveHistory:[]).forEach(h=>{ 
      const t=+h?.date; 
      if(!Number.isFinite(t)) return; 
      const d=new Date(t); 
      d.setHours(0,0,0,0); 
      daySet.add(ymd(d)); 
    });
  }
  
  const avgAll=solved?(sum/solved):null;
  const recentTxt= last? ((d=>d===0?'ì˜¤ëŠ˜':d===1?'ì–´ì œ':`${d}ì¼ ì „`)(Math.floor((Date.now()-last)/86400000))):'ê¸°ë¡ ì—†ìŒ';
  const hasSolved=dayKey=> daySet.has(dayKey);
  
  let streak=0, cur=new Date(); 
  cur.setHours(0,0,0,0);
  while(hasSolved(ymd(cur))){ streak++; cur.setDate(cur.getDate()-1); }
  
  const bestKey='bestStreak_v1', best=Math.max(streak, +(localStorage.getItem(bestKey)||0)); 
  if(best>+(localStorage.getItem(bestKey)||0)) localStorage.setItem(bestKey,String(best));

  // âœ… ê¸°ê°„ ë‚´ í’€ì´ ì§‘ê³„ (ë³€ê²½ëœ ë¶€ë¶„ - startì™€ end ì‚¬ìš©)
  let periodSolves=0, periodSum=0; 
  const byCh=new Map(), chRec=ch=>{ 
    if(!byCh.has(ch)) byCh.set(ch,{solves:0,sum:0}); 
    return byCh.get(ch); 
  };
  
  for(const q of base){
    const id=String(q.ê³ ìœ ID).trim(), ch=String(q.ë‹¨ì›).trim(), rec=scores[id];
    const hist=Array.isArray(rec?.solveHistory)?rec.solveHistory:[];
    
    for(const h of hist){ 
      const t=+h?.date, sc=+h?.score; 
      if(!Number.isFinite(t)) continue; 
      
      // âœ… ê¸°ê°„ ì²´í¬: start <= t <= end
      if(t >= +start && t <= +end){ 
        periodSolves++; 
        if(Number.isFinite(sc)) periodSum+=sc; 
        const slot=chRec(ch); 
        slot.solves++; 
        if(Number.isFinite(sc)) slot.sum+=sc; 
      } 
    }
  }
  
  const periodAvg=periodSolves? (periodSum/periodSolves):null;

  const weak=[];
  byCh.forEach((v,ch)=>{
    if(v.solves>=3) weak.push({ch,avg:v.sum/v.solves,cnt:v.solves});
  });
  weak.sort((a,b)=>a.avg-b.avg);
  const weakTop=weak.slice(0,3);

  // HLR í†µê³„ ê³„ì‚°
  let hlrDataCount=0, hlrRecallSum=0, hlrForgetting=0;
  for(const q of base){
    const id=String(q.ê³ ìœ ID).trim();
    const hlrData = calculateRecallProbability(id);
    if(hlrData){
      hlrDataCount++;
      hlrRecallSum += hlrData.p_current;
      if(hlrData.p_current < 0.5) hlrForgetting++;
    }
  }
  const hlrAvgRecall = hlrDataCount > 0 ? (hlrRecallSum / hlrDataCount) : 0;

  const baseDaily=+(localStorage.getItem('dailyTarget_v1')||20);
  if(!localStorage.getItem('weeklyTarget_v1')) localStorage.setItem('weeklyTarget_v1', String(baseDaily*7));
  if(!localStorage.getItem('monthlyTarget_v1')) localStorage.setItem('monthlyTarget_v1', String(baseDaily*30));
  
  const targetKey= statsView==='day'?'dailyTarget_v1': statsView==='week'?'weeklyTarget_v1':'monthlyTarget_v1';
  
  // âœ… ëª©í‘œ ë¼ë²¨ ë³€ê²½
  const targetLabel= statsView==='day'?'ì˜¤ëŠ˜ ëª©í‘œ': statsView==='week'?'ì´ë²ˆ ì£¼ ëª©í‘œ (ì›”~ì¼)':'ì´ë²ˆ ë‹¬ ëª©í‘œ';
  
  const targetVal= +(localStorage.getItem(targetKey) || (statsView==='day'?baseDaily: (statsView==='week'? baseDaily*7: baseDaily*30)));
  const pct=Math.max(0,Math.min(100,Math.round((periodSolves/Math.max(1,targetVal))*100)));
  const fmt=v=> v==null?'-':(Math.round(v*10)/10).toFixed(1);
  const chip=txt=>`<button data-go-ch="${txt}" class="px-2 py-0.5 text-xs rounded border hover:bg-gray-50">${chapterLabelText(txt)}</button>`;
  const weakHtml= weakTop.length? weakTop.map(w=>`${chip(w.ch)} <span class="text-xs text-red-600 ml-1">${fmt(w.avg)}ì Â·${w.cnt}íšŒ</span>`).join('<br>'):'ë°ì´í„° ë¶€ì¡±';

  // âœ… ê¸°ê°„ í‘œì‹œ ì¶”ê°€ (ì„ íƒì‚¬í•­)
  let periodInfo = '';
  if(statsView === 'week') {
    const startStr = `${start.getMonth()+1}/${start.getDate()}`;
    const endStr = `${end.getMonth()+1}/${end.getDate()}`;
    periodInfo = `<div class="text-[11px] text-gray-400 mb-1">${startStr} ~ ${endStr}</div>`;
  } else if(statsView === 'month') {
    periodInfo = `<div class="text-[11px] text-gray-400 mb-1">${statsRefDate.getFullYear()}ë…„ ${statsRefDate.getMonth()+1}ì›”</div>`;
  }

  // ê¸°ì¡´ HTML ë Œë”ë§ ì½”ë“œì— periodInfo ì¶”ê°€
  const existingNav = el.statsOverview.querySelector('#stats-date-nav');
  const statsContent = document.createElement('div');
  statsContent.id = 'stats-content';
  statsContent.innerHTML = `
    <div class="border rounded p-3 relative">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h3 class="font-bold" id="stats-title">${title}</h3>
          ${periodInfo}
        </div>
        <div class="relative">
          <button id="stats-view-btn" class="flex items-center gap-1 text-sm px-2 py-1 rounded border hover:bg-gray-50">
            <span id="stats-view-label">${label}</span>
            <span id="stats-caret" class="inline-block transition-transform">â–¼</span>
          </button>
          <div id="stats-view-menu" class="hidden absolute right-0 mt-1 w-28 bg-white dark:bg-gray-900 border rounded shadow-md overflow-hidden z-10">
            <button data-view="day" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">ì˜¤ëŠ˜</button>
            <button data-view="week" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">ì£¼ê°„</button>
            <button data-view="month" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">ì›”ê°„</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ê¸°ê°„ í’€ì´</div><div class="text-lg font-semibold">${periodSolves} ê°œ</div></div>
        <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ê¸°ê°„ í‰ê· </div><div class="text-lg font-semibold">${fmt(periodAvg)} ì </div></div>
        <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ì¶œì„</div><div class="text-lg font-semibold">${streak} ì¼ì§¸ <span class="text-xs text-gray-500">(ìµœê³  ${best}ì¼)</span></div></div>
        <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ìŠ¤ì½”í”„ í‰ê· </div><div class="text-lg font-semibold">${fmt(avgAll)} ì </div></div>
      </div>

      <div class="mt-3">
        <div class="flex items-center justify-between"><div class="text-[12px] text-gray-500">${targetLabel} ${targetVal}ê°œ</div><div class="text-[12px] text-gray-500">${pct}%</div></div>
        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div class="h-2 ${pct<60?'bg-red-500':(pct<100?'bg-yellow-500':'bg-green-600')}" style="width:${pct}%"></div></div>
        <div class="flex items-center gap-2 mt-2">
          <label for="stats-target-input" class="text-xs text-gray-500">ëª©í‘œ:</label>
          <input id="stats-target-input" type="number" min="1" class="w-20 px-2 py-1 text-xs border rounded" value="${targetVal}">
          <button id="apply-stats-target" class="text-xs px-2 py-1 border rounded hover:bg-gray-50">ì ìš©</button>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-3 mt-3">
        <div class="p-2 rounded border">
          <div class="text-[12px] text-gray-500 mb-1">ì•½í•œ ë‹¨ì› Top 3 <span class="text-[11px] text-gray-400">(ê¸°ê°„ ê¸°ì¤€)</span></div>
          <div class="text-sm leading-5">${weakHtml}</div>
        </div>
      </div>

      <div class="text-[12px] text-gray-500 mt-2">
        ìµœê·¼ í•™ìŠµ: <strong class="text-gray-700">${recentTxt}</strong> Â· ë³µìŠµ ì¶”ê°€(â˜…): <strong class="text-gray-700">${flagged}</strong>
        ${hlrDataCount > 0 ? `<br>HLR: í‰ê·  íšŒìƒ <strong class="text-gray-700">${(hlrAvgRecall*100).toFixed(0)}%</strong> Â· ë§ê° ì„ë°• <strong class="text-red-600">${hlrForgetting}</strong>ê°œ` : ''}
      </div>
    </div>`;

  // ê¸°ì¡´ stats-content ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
  const oldContent = el.statsOverview.querySelector('#stats-content');
  if (oldContent) oldContent.remove();
  el.statsOverview.appendChild(statsContent);

  const btn=$('stats-view-btn'), caret=$('stats-caret'), menu=$('stats-view-menu');
  const openMenu=()=>{ menu.classList.remove('hidden'); caret.style.transform='rotate(180deg)'; };
  const closeMenu=()=>{ menu.classList.add('hidden'); caret.style.transform='rotate(0deg)'; };
  btn?.addEventListener('click',e=>{ e.stopPropagation(); if(menu.classList.contains('hidden')) openMenu(); else closeMenu(); });
  document.addEventListener('click', closeMenu, {once:true});
  menu?.querySelectorAll('[data-view]')?.forEach(i=> i.addEventListener('click',()=>{ const v=i.getAttribute('data-view'); statsView=v; localStorage.setItem('statsView_v1',v); renderStats(); }) );
  $('apply-stats-target')?.addEventListener('click',()=>{ const v=Math.max(1,Math.min(9999,Math.round(+($('stats-target-input')?.value||1)))); localStorage.setItem(targetKey,String(v)); renderStats(); });
  el.statsOverview.querySelectorAll('[data-go-ch]')?.forEach(b=> b.addEventListener('click',()=>{ const ch=b.getAttribute('data-go-ch')||''; if(ch){ el.chapterSelect.value=ch; reloadAndRefresh(); showToast(`${chapterLabelText(ch)} ë¡œ ì´ë™`);} }));
}
    function renderExplorer(){
      if(!el.explorerChapters||!el.explorerProblems) return;
      const base=getScopeFilteredData(), group=new Map();
      for(const q of base){ const ch=String(q.ë‹¨ì›).trim(); if(!group.has(ch)) group.set(ch,[]); group.get(ch).push(q); }
      const chapters=[...group.keys()].sort((a,b)=>{ const na=+a, nb=+b; if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; if(Number.isFinite(na)) return -1; if(Number.isFinite(nb)) return 1; return a.localeCompare(b,'ko'); });

      el.explorerChapters.innerHTML='';
      chapters.forEach(ch=>{
        const btn=document.createElement('button'); btn.className='w-full text-left px-3 py-2 rounded border hover:bg-gray-50'; btn.textContent=chapterLabelText(ch);
        btn.addEventListener('click',()=>{
          const list=group.get(ch)||[];
          if(!list.length) return;

          if (isFlashcardMode) {
            // Flashcard mode: update flashcard data
            flashcardData = list;
            flashcardIndex = 0;
            displayFlashcard();
            updateSummaryHighlight();
            showToast(`${chapterLabelText(ch)} í”Œë˜ì‹œì¹´ë“œë¡œ ì´ë™`);
          } else {
            // Quiz mode: update quiz data
            currentQuizData = list;
            currentQuestionIndex = 0;
            el.quizArea.classList.remove('hidden');
            displayQuestion();
            updateSummaryHighlight();
            showToast(`${chapterLabelText(ch)} ë¡œ ì´ë™`);
          }
        });
        el.explorerChapters.appendChild(btn);
      });

      const q=(el.explorerSearch?.value||'').trim().toLowerCase();
      const filtered=base.filter(it=> (it.problemTitle||'').toLowerCase().includes(q) || (it.ë¬¼ìŒ||'').toLowerCase().includes(q) );
      el.explorerProblems.innerHTML='';
      filtered.sort((a,b)=>{ const na=+(a.ë¬¼ìŒë²ˆí˜¸||a.í‘œì‹œë²ˆí˜¸), nb=+(b.ë¬¼ìŒë²ˆí˜¸||b.í‘œì‹œë²ˆí˜¸); if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; return String(a.í‘œì‹œë²ˆí˜¸||a.ë¬¼ìŒë²ˆí˜¸).localeCompare(String(b.í‘œì‹œë²ˆí˜¸||b.ë¬¼ìŒë²ˆí˜¸),'ko'); })
      .forEach(it=>{
        const rec=questionScores[String(it.ê³ ìœ ID).trim()]||{};
        const score= Number.isFinite(+rec?.score)? +rec.score : null;
        const excluded=!!rec.userReviewExclude;
        const flagged=!!rec.userReviewFlag && !excluded; // ì œì™¸ ìš°ì„ 

        const row=document.createElement('button'); row.className='w-full flex items-center justify-between gap-2 px-3 py-1.5 rounded hover:bg-gray-50 border text-left';

        const left=document.createElement('div'); left.className='flex items-center gap-2 text-sm';
        if(flagged){ const star=document.createElement('span'); star.textContent='â˜…'; star.className='text-purple-500'; left.appendChild(star); }
        if(excluded){ const minus=document.createElement('span'); minus.textContent='â–'; minus.className='text-gray-500'; left.appendChild(minus); }

        const title=document.createElement('span'); const label=(it.problemTitle && String(it.problemTitle).trim())||`ë¬¸í•­ ${it.í‘œì‹œë²ˆí˜¸||it.ë¬¼ìŒë²ˆí˜¸||it.ê³ ìœ ID}`;
        title.textContent=label; title.className='block max-w-[18rem] xl:max-w-[22rem] line-clamp-2 overflow-hidden'; title.style.display='-webkit-box'; title.style.webkitLineClamp='2'; title.style.webkitBoxOrient='vertical'; left.appendChild(title);

        const right=document.createElement('div'); right.className='text-xs'; const badge=document.createElement('span'); badge.className='px-2 py-0.5 rounded-full border '+(score==null?'text-gray-600 border-gray-300':'text-blue-700 border-blue-300'); badge.textContent= score==null?'X':`${score}`; right.appendChild(badge);

        row.appendChild(left); row.appendChild(right); row.title=`ì¶œì²˜:${it.ì¶œì²˜||'-'} | ID:${it.ê³ ìœ ID}`;
        row.addEventListener('click',()=>{
          const ch = String(it.ë‹¨ì›).trim();
          const list = base.filter(x => String(x.ë‹¨ì›).trim() === ch);

          if (isFlashcardMode) {
            // Flashcard mode
            flashcardData = list.length ? list : [it];
            flashcardIndex = list.findIndex(x => String(x.ê³ ìœ ID).trim() === String(it.ê³ ìœ ID).trim());
            if (flashcardIndex < 0) flashcardIndex = 0;
            displayFlashcard();
            updateSummaryHighlight();
            showToast(`'${label}' í”Œë˜ì‹œì¹´ë“œë¡œ ì´ë™`);
          } else {
            // Quiz mode
            currentQuizData = list.length ? list : [it];
            currentQuestionIndex = list.findIndex(x => String(x.ê³ ìœ ID).trim() === String(it.ê³ ìœ ID).trim());
            if (currentQuestionIndex < 0) currentQuestionIndex = 0;
            el.quizArea.classList.remove('hidden');
            displayQuestion();
            updateSummaryHighlight();
            showToast(`'${label}' ë¡œ ì´ë™`);
          }
        });
        el.explorerProblems.appendChild(row);
      });
    }
    const moveSourceFilterToSide=()=>{ if(!el.sourceFilterSide||!el.sourceGroupFilter) return; el.sourceFilterSide.innerHTML=''; el.sourceGroupFilter.classList.remove('mb-6'); el.sourceFilterSide.appendChild(el.sourceGroupFilter); };
    const refreshPanels=()=>{ renderCalendarMonth(); renderStats(); renderExplorer(); };

    // âš ï¸ CRITICAL: quizCore.jsì—ì„œ ì´ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ windowì— ë…¸ì¶œ í•„ìš”
    window.refreshPanels = refreshPanels;

    /* ========================================
     * HLR (Half-Life Regression) ë³µìŠµ ì•Œê³ ë¦¬ì¦˜
     * ======================================== */

    /**
     * HLR ë°ì´í„°ì…‹ ìƒì„±: solveHistoryë¥¼ HLR í•™ìŠµìš© í”¼ì²˜ë¡œ ë³€í™˜
     * @returns {Array} HLR í•™ìŠµìš© ë ˆì½”ë“œ ë°°ì—´
     */
    function buildHLRDataset() {
      const records = [];
      const now = Date.now();

      for (const [qid, rec] of Object.entries(questionScores || {})) {
        const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
        if (hist.length < 1) continue;

        // ì‹œê°„ìˆœ ì •ë ¬
        hist.sort((a, b) => (+a?.date || 0) - (+b?.date || 0));

        let prevDate = null;
        let totalReviews = 0;
        let correctCount = 0;
        let incorrectCount = 0;
        const scores = [];

        for (let i = 0; i < hist.length; i++) {
          const h = hist[i];
          const date = +h?.date;
          const score = clamp(+h?.score || 0, 0, 100);

          if (!Number.isFinite(date)) continue;

          scores.push(score);
          totalReviews++;
          if (score >= 80) correctCount++;
          else incorrectCount++;

          // i >= 1: ì´ì „ í•™ìŠµ ê¸°ë¡ì´ ìˆì–´ì•¼ Î” ê³„ì‚° ê°€ëŠ¥
          if (prevDate && i >= 1) {
            const delta = (date - prevDate) / (1000 * 86400); // ì¼ ë‹¨ìœ„
            if (delta <= 0) continue; // ê°™ì€ ë‚  ì—°ì† í’€ì´ëŠ” skip

            let p_observed = score / 100.0;
            p_observed = Math.max(0.01, Math.min(0.99, p_observed)); // log(0) ë°©ì§€

            // h ê³„ì‚°: p = 2^(-Î”/h) â†’ h = -Î” / logâ‚‚(p)
            const h_true = -delta / Math.log2(p_observed);
            const y = Math.log2(h_true); // íƒ€ê²Ÿ: logâ‚‚(h)

            // í”¼ì²˜ ë²¡í„° x
            const x = {
              bias: 1,
              total_reviews: totalReviews,
              mean_score: scores.reduce((a, b) => a + b, 0) / scores.length,
              last_score: score,
              correct_count: correctCount,
              incorrect_count: incorrectCount,
              correct_ratio: correctCount / totalReviews,
              last_is_correct: score >= 80 ? 1 : 0,
              time_since_first: (date - hist[0].date) / (1000 * 86400),
              first_solve_quality: hist[0].score / 100.0
            };

            records.push({ qid, y, x, delta, p_observed, h_true });
          }

          prevDate = date;
        }
      }

      return records;
    }

    /**
     * HLR ë°ì´í„°ì…‹ CSV ë‚´ë³´ë‚´ê¸°
     */
    function exportHLRDataset() {
      const records = buildHLRDataset();
      const csv = [
        ['qid', 'y(log2h)', 'delta', 'p_observed', 'h_true', 'total_reviews', 'mean_score', 'last_score', 'correct_count', 'incorrect_count'].join(','),
        ...records.map(r => [
          r.qid,
          r.y.toFixed(4),
          r.delta.toFixed(2),
          r.p_observed.toFixed(2),
          r.h_true.toFixed(2),
          r.x.total_reviews,
          r.x.mean_score.toFixed(2),
          r.x.last_score,
          r.x.correct_count,
          r.x.incorrect_count
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hlr_dataset_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('HLR ë°ì´í„°ì…‹ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
    }

    /**
     * LocalHLRPredictor í´ë˜ìŠ¤: ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜ HLR ëª¨ë¸
     */
    class LocalHLRPredictor {
      constructor() {
        // ì´ˆê¸° ê°€ì¤‘ì¹˜ (ê²½í—˜ì  ê¸°ë³¸ê°’)
        this.modelWeights = {
          bias: 4.0,              // logâ‚‚(h) ê¸°ë³¸ê°’ â‰ˆ h=16ì¼
          total_reviews: 0.15,    // ë¦¬ë·° ë§ì„ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
          mean_score: 0.008,      // í‰ê·  ì ìˆ˜ ë†’ì„ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
          last_score: 0.005,      // ìµœê·¼ ì ìˆ˜ ë†’ì„ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
          correct_count: 0.1,     // ì •ë‹µ íšŸìˆ˜ ë§ì„ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
          incorrect_count: -0.12, // ì˜¤ë‹µ íšŸìˆ˜ ë§ì„ìˆ˜ë¡ ë°˜ê°ê¸° ê°ì†Œ
          time_since_first: 0.02, // ì²« í’€ì´ë¶€í„° ì˜¤ë˜ë ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
          first_solve_quality: 0.5 // ì²« í’€ì´ ì ìˆ˜ ë†’ì„ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
        };
      }

      predict(features) {
        let log2h = this.modelWeights.bias;

        for (const [key, weight] of Object.entries(this.modelWeights)) {
          if (key === 'bias') continue;
          const val = features[key] || 0;
          log2h += weight * val;
        }

        // logâ‚‚(h)ë¥¼ hë¡œ ë³€í™˜
        const h = Math.pow(2, log2h);
        return Math.max(1, Math.min(365, h)); // 1ì¼~1ë…„ ì‚¬ì´ë¡œ ì œí•œ
      }

      getNextReviewDelta(h, targetRetrieval = 0.9) {
        // p = 2^(-Î”/h) = R_target
        // Î” = -h * logâ‚‚(R_target)
        const log2_R = Math.log2(targetRetrieval);
        const delta = -h * log2_R;
        return delta; // ì¼ ë‹¨ìœ„
      }
    }

    // HLR Predictor ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
    const hlrPredictor = new LocalHLRPredictor();

    /**
     * íŠ¹ì • ë¬¸ì œì˜ HLR í”¼ì²˜ ìƒì„±
     * @param {string} qid - ë¬¸ì œ ê³ ìœ  ID
     * @returns {object} HLR í”¼ì²˜ ê°ì²´
     */
    function buildFeaturesForQID(qid) {
      const rec = questionScores[normId(qid)];
      if (!rec) return null;

      const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
      if (hist.length < 1) return null;

      hist.sort((a, b) => (+a?.date || 0) - (+b?.date || 0));

      const now = Date.now();
      const scores = hist.map(h => clamp(+h?.score || 0, 0, 100));
      const totalReviews = hist.length;
      const correctCount = scores.filter(s => s >= 80).length;
      const incorrectCount = scores.filter(s => s < 80).length;

      return {
        bias: 1,
        total_reviews: totalReviews,
        mean_score: scores.reduce((a, b) => a + b, 0) / scores.length,
        last_score: scores[scores.length - 1],
        correct_count: correctCount,
        incorrect_count: incorrectCount,
        correct_ratio: correctCount / totalReviews,
        last_is_correct: scores[scores.length - 1] >= 80 ? 1 : 0,
        time_since_first: (now - (+hist[0]?.date || now)) / (1000 * 86400),
        first_solve_quality: scores[0] / 100.0
      };
    }

    /**
     * HLR ê¸°ë°˜ íšŒìƒ í™•ë¥  ê³„ì‚°
     * @param {string} qid - ë¬¸ì œ ê³ ìœ  ID
     * @returns {object} { h_pred, p_current, timeSinceLastReview } ë˜ëŠ” null
     */
    function calculateRecallProbability(qid) {
      const rec = questionScores[normId(qid)];
      if (!rec) return null;

      const features = buildFeaturesForQID(qid);
      if (!features) return null;

      // HLR ë°˜ê°ê¸° ì˜ˆì¸¡
      const h_pred = hlrPredictor.predict(features);

      // ë§ˆì§€ë§‰ í’€ì´ í›„ ê²½ê³¼ ì‹œê°„
      const lastReview = rec?.lastSolvedDate || 0;
      const now = Date.now();
      const timeSinceLastReview = (now - lastReview) / (1000 * 86400); // ì¼ ë‹¨ìœ„

      // í˜„ì¬ íšŒìƒ í™•ë¥ : p = 2^(-Î”/h)
      const p_current = Math.pow(2, -timeSinceLastReview / h_pred);

      return { h_pred, p_current, timeSinceLastReview };
    }

    const REVIEW_STRATEGY_LS='reviewStrategy_v1';
    const getReviewStrategy=()=> localStorage.getItem(REVIEW_STRATEGY_LS)||'smart';
    function prioritizeTodayReview(list){
      list = (list||[]).filter(a => !questionScores[normId(a.ê³ ìœ ID)]?.userReviewExclude);
      const strat=getReviewStrategy();

      // HLR ì „ëµ: íšŒìƒ í™•ë¥  ê¸°ë°˜ ì •ë ¬
      if(strat==='hlr') {
        const now = Date.now();
        const scored = list.map(q => {
          const qid = normId(q.ê³ ìœ ID);
          const rec = questionScores[qid];

          // ìš°ì„ ìˆœìœ„ ì ìˆ˜ ê³„ì‚° (ë‚®ì„ìˆ˜ë¡ ë†’ì€ ìš°ì„ ìˆœìœ„)
          let priority = 0;

          // 1. ë³µìŠµ í”Œë˜ê·¸ ìµœìƒìœ„
          if (rec?.userReviewFlag && !rec?.userReviewExclude) priority -= 1000;

          // 2. HLR íšŒìƒ í™•ë¥  ê³„ì‚°
          const hlrData = calculateRecallProbability(qid);
          if (hlrData) {
            // íšŒìƒ í™•ë¥  ë‚®ì„ìˆ˜ë¡ ìš°ì„ ìˆœìœ„ ë†’ìŒ (ë§ê° ì„ë°•)
            priority += hlrData.p_current * 100; // 0~100

            // ë§ˆì§€ë§‰ í’€ì´ ì˜¤ë˜ëœ ìˆœ
            priority += hlrData.timeSinceLastReview * 0.5;
          } else {
            // HLR ë°ì´í„° ì—†ìœ¼ë©´ (ë¯¸í’€ì´) ì¤‘ê°„ ìš°ì„ ìˆœìœ„
            priority += 50;
          }

          // 3. í‰ê·  ì ìˆ˜ ë‚®ì€ ìˆœ
          const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
          if (hist.length > 0) {
            const scores = hist.map(h => clamp(+h?.score || 0, 0, 100));
            const meanScore = scores.reduce((a, b) => a + b, 0) / scores.length;
            priority += (100 - meanScore) * 0.1;
          } else {
            priority += 5; // ë¯¸í’€ì´ëŠ” ë‚®ì€ ê°€ì¤‘ì¹˜
          }

          return { q, priority, hlrData };
        });

        return scored.sort((a, b) => a.priority - b.priority).map(s => s.q);
      }

      if(strat==='flag'){ const f=list.filter(a=>questionScores[normId(a.ê³ ìœ ID)]?.userReviewFlag && !questionScores[normId(a.ê³ ìœ ID)]?.userReviewExclude); const r=list.filter(a=>!(questionScores[normId(a.ê³ ìœ ID)]?.userReviewFlag && !questionScores[normId(a.ê³ ìœ ID)]?.userReviewExclude)); return f.concat(r); }
      if(strat==='low'){ return [...list].sort((a,b)=>{ const sa=questionScores[normId(a.ê³ ìœ ID)]?.score??101, sb=questionScores[normId(b.ê³ ìœ ID)]?.score??101; return sa-sb; }); }
      if(strat==='recentWrong'){ return [...list].sort((a,b)=>{ const sa=questionScores[normId(a.ê³ ìœ ID)], sb=questionScores[normId(b.ê³ ìœ ID)], as=sa?.score??101, bs=sb?.score??101, ad=sa?.lastSolvedDate??0, bd=sb?.lastSolvedDate??0; return (as-bs)||(ad-bd); }); }
      return [...list].sort((a,b)=>{ const sa=questionScores[normId(a.ê³ ìœ ID)], sb=questionScores[normId(b.ê³ ìœ ID)], af=(sa?.userReviewFlag && !sa?.userReviewExclude)?0:1, bf=(sb?.userReviewFlag && !sb?.userReviewExclude)?0:1, aUn=sa?1:0, bUn=sb?1:0, aS=sa?.score??101, bS=sb?.score??101, aD=sa?.lastSolvedDate??0, bD=sb?.lastSolvedDate??0; return (af-bf)||(aUn-bUn)||(aS-bS)||(aD-bD); });
    }
    el.reviewStrategySelect?.addEventListener('change',e=>{ localStorage.setItem(REVIEW_STRATEGY_LS, e.target.value); showToast(`ì˜¤ëŠ˜ì˜ ë³µìŠµ ì „ëµ: ${e.target.value}`); refreshPanels(); });
    (function syncStrategy(){ const cur=getReviewStrategy(); if(el.reviewStrategySelect) el.reviewStrategySelect.value=cur; })();
    el.startReviewBtn?.addEventListener('click',()=>{ if(el.filterSelect) el.filterSelect.value='today-review'; reloadAndRefresh(); showToast('ì˜¤ëŠ˜ì˜ ë³µìŠµ ì‹œì‘'); });

    function openDrawer(){ 
      //document.body.classList.add('drawer-open'); 
      el.drawerBackdrop.classList.remove('hidden'); 
      el.leftDashboard.classList.remove('hidden'); el.leftDashboard.classList.add('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900','relative'); 
      el.drawerClose.classList.remove('hidden'); }
    function closeDrawer(){
      //document.body.classList.remove('drawer-open'); 
      el.drawerBackdrop.classList.add('hidden'); 
      el.leftDashboard.classList.add('hidden'); el.leftDashboard.classList.remove('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900','relative'); 
      el.drawerClose.classList.add('hidden'); }
    el.hamburger?.addEventListener('click', openDrawer);
    el.drawerBackdrop?.addEventListener('click', closeDrawer);
    el.drawerClose?.addEventListener('click', closeDrawer);
    window.addEventListener('resize',()=>{
      if(window.innerWidth>=1024){
        el.leftDashboard.classList.remove('hidden'); el.drawerBackdrop.classList.add('hidden'); document.body.classList.remove('drawer-open');
        el.leftDashboard.classList.remove('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900','relative'); el.drawerClose.classList.add('hidden');
      }else{ el.leftDashboard.classList.add('hidden'); }
    });

    /* ========================================
     * DEEP-LEARNING REPORT
     * ======================================== */
    let reportCharts = {};
    let reportData = { period: 30, threshold: 60 };

    function openReportModal() {
      // Close hamburger menu if open (mobile)
      closeDrawer();

      el.reportModal?.classList.remove('hidden');
      el.reportModal?.classList.add('flex');
      // Delay chart generation to ensure modal is rendered
      setTimeout(() => generateReport(), 50);
    }

    function closeReportModal() {
      el.reportModal?.classList.add('hidden');
      el.reportModal?.classList.remove('flex');
      // Destroy all charts
      Object.values(reportCharts).forEach(chart => chart?.destroy());
      reportCharts = {};

      // Restore left sidebar visibility on desktop
      if (window.innerWidth >= 1024) {
        el.leftDashboard?.classList.remove('hidden');
        el.drawerBackdrop?.classList.add('hidden');
        el.leftDashboard?.classList.remove('fixed', 'inset-0', 'z-[1100]', 'p-4', 'overflow-y-auto', 'bg-white', 'dark:bg-gray-900', 'relative');
        el.drawerClose?.classList.add('hidden');
      }
    }

    function switchReportTab(tabNum) {
      const tabs = document.querySelectorAll('.report-tab');
      const contents = document.querySelectorAll('.report-content');
      tabs.forEach((tab, i) => {
        const num = i + 1;
        if (num === tabNum) {
          tab.classList.add('border-blue-600', 'text-blue-600');
          tab.classList.remove('border-transparent', 'text-gray-500');
          tab.setAttribute('aria-selected', 'true');
        } else {
          tab.classList.remove('border-blue-600', 'text-blue-600');
          tab.classList.add('border-transparent', 'text-gray-500');
          tab.setAttribute('aria-selected', 'false');
        }
      });
      contents.forEach((content, i) => {
        if (i + 1 === tabNum) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
    }

    function getReportData() {
      const period = reportData.period;
      const threshold = reportData.threshold;
      const now = Date.now();
      const cutoffDate = period === 'all' ? 0 : now - (period * 24 * 60 * 60 * 1000);

      const dailyData = new Map(); // date -> {count, scores[]}
      const chapterData = new Map(); // chapter -> {scores[], dates[]}
      const weakProblems = []; // problems below threshold

      for (const [qid, rec] of Object.entries(questionScores || {})) {
        const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
        for (const h of hist) {
          const date = +h?.date;
          const score = clamp(+h?.score || 0, 0, 100);
          if (!Number.isFinite(date) || date < cutoffDate) continue;

          // Daily data
          const dateKey = new Date(date).toISOString().slice(0, 10);
          if (!dailyData.has(dateKey)) dailyData.set(dateKey, { count: 0, scores: [] });
          dailyData.get(dateKey).count++;
          dailyData.get(dateKey).scores.push(score);

          // Find problem
          const problem = allData.find(q => normId(q.ê³ ìœ ID) === qid);
          if (problem) {
            const chapter = problem.ë‹¨ì› || 'ê¸°íƒ€';
            if (!chapterData.has(chapter)) chapterData.set(chapter, { scores: [], dates: [] });
            chapterData.get(chapter).scores.push(score);
            chapterData.get(chapter).dates.push(date);

            // Weak problems
            if (score < threshold) {
              weakProblems.push({ qid, problem, score, date });
            }
          }
        }
      }

      return { dailyData, chapterData, weakProblems };
    }

    function generateReport() {
      reportData.period = el.reportPeriodSelect?.value === 'all' ? 'all' : +el.reportPeriodSelect?.value || 30;
      reportData.threshold = +el.reportThresholdSelect?.value || 60;

      const data = getReportData();

      // Clear previous charts
      Object.values(reportCharts).forEach(chart => chart?.destroy());
      reportCharts = {};

      renderDailyVolumeChart(data.dailyData);
      renderScoreTrendChart(data.dailyData);
      renderChapterWeaknessChart(data.chapterData);
      renderActionPlan(data.weakProblems);
    }

    // Helper: Fill missing dates with zero
    function fillMissingDates(dailyData) {
      if (dailyData.size === 0) return new Map();

      const sorted = Array.from(dailyData.entries()).sort((a, b) => a[0].localeCompare(b[0]));
      const startDate = new Date(sorted[0][0]);
      const endDate = new Date(sorted[sorted.length - 1][0]);

      const filled = new Map();
      const currentDate = new Date(startDate);

      while (currentDate <= endDate) {
        const dateStr = currentDate.toISOString().slice(0, 10);
        if (dailyData.has(dateStr)) {
          filled.set(dateStr, dailyData.get(dateStr));
        } else {
          filled.set(dateStr, { count: 0, scores: [] });
        }
        currentDate.setDate(currentDate.getDate() + 1);
      }

      return filled;
    }

    function renderDailyVolumeChart(dailyData) {
      const ctx = $('chart-daily-volume');
      if (!ctx || !window.Chart) return;

      const filledData = fillMissingDates(dailyData);
      const sorted = Array.from(filledData.entries()).sort((a, b) => a[0].localeCompare(b[0]));
      const labels = sorted.map(([date]) => date.slice(5));
      const data = sorted.map(([, v]) => v.count);

      reportCharts.dailyVolume = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'ë¬¸ì œ ìˆ˜',
            data,
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    // Helper: Calculate moving average
    function calculateMovingAverage(data, period) {
      const result = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period - 1) {
          result.push(null); // Not enough data for this period
        } else {
          const slice = data.slice(i - period + 1, i + 1);
          const avg = slice.reduce((a, b) => a + b, 0) / slice.length;
          result.push(Math.round(avg * 10) / 10);
        }
      }
      return result;
    }

    function renderScoreTrendChart(dailyData) {
      const ctx = $('chart-score-trend');
      if (!ctx || !window.Chart) return;

      // Only use days with actual data (no empty days)
      const sorted = Array.from(dailyData.entries())
        .filter(([, v]) => v.scores.length > 0)
        .sort((a, b) => a[0].localeCompare(b[0]));
      const labels = sorted.map(([date]) => date.slice(5));
      const avgScores = sorted.map(([, v]) => {
        const avg = v.scores.reduce((a, b) => a + b, 0) / v.scores.length;
        return Math.round(avg * 10) / 10;
      });

      // Calculate cumulative average (ì´ëˆ„ì í‰ê· ì„ )
      const cumulativeAvg = [];
      let sum = 0;
      for (let i = 0; i < avgScores.length; i++) {
        sum += avgScores[i];
        cumulativeAvg.push(Math.round((sum / (i + 1)) * 10) / 10);
      }

      // Calculate moving averages
      const ma5 = calculateMovingAverage(avgScores, 5);
      const ma20 = calculateMovingAverage(avgScores, 20);
      const ma60 = calculateMovingAverage(avgScores, 60);

      // Detect Golden Cross and Dead Cross points
      const goldenCross = [], deadCross = [];
      for (let i = 1; i < ma5.length; i++) {
        if (ma5[i] !== null && ma20[i] !== null && ma5[i-1] !== null && ma20[i-1] !== null) {
          // Golden Cross: MA5 crosses above MA20
          if (ma5[i-1] <= ma20[i-1] && ma5[i] > ma20[i]) {
            goldenCross.push({ x: i, y: ma5[i] });
          }
          // Dead Cross: MA5 crosses below MA20
          if (ma5[i-1] >= ma20[i-1] && ma5[i] < ma20[i]) {
            deadCross.push({ x: i, y: ma5[i] });
          }
        }
      }

      // Check perfect order (ì •ë°°ì—´) at last point
      const lastIdx = ma5.length - 1;
      const isPerfectOrder = ma5[lastIdx] && ma20[lastIdx] && ma60[lastIdx] &&
                            ma5[lastIdx] > ma20[lastIdx] && ma20[lastIdx] > ma60[lastIdx];

      reportCharts.scoreTrend = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'ì¼ì¼ í‰ê· ',
              data: avgScores,
              borderColor: 'rgba(59, 130, 246, 1)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.1,
              pointRadius: 2,
              borderWidth: 2
            },
            {
              label: 'MA5 (ë‹¨ê¸°)',
              data: ma5,
              borderColor: 'rgba(34, 197, 94, 0.8)',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 0,
              fill: false
            },
            {
              label: 'MA20 (ì¤‘ê¸°â˜…)',
              data: ma20,
              borderColor: 'rgba(234, 179, 8, 0.8)',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 0,
              fill: false
            },
            {
              label: 'MA60 (ì¥ê¸°)',
              data: ma60,
              borderColor: 'rgba(239, 68, 68, 0.8)',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 0,
              fill: false
            },
            {
              label: 'ì´ëˆ„ì í‰ê· ',
              data: cumulativeAvg,
              borderColor: 'rgba(107, 114, 128, 0.5)',
              borderWidth: 1.5,
              borderDash: [5, 5],
              tension: 0.3,
              pointRadius: 0,
              fill: false
            },
            // Golden Cross markers
            {
              label: 'ê³¨ë“  í¬ë¡œìŠ¤',
              data: goldenCross,
              type: 'scatter',
              pointRadius: 8,
              pointHoverRadius: 10,
              pointBackgroundColor: 'rgba(34, 197, 94, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              showLine: false
            },
            // Dead Cross markers
            {
              label: 'ë°ë“œ í¬ë¡œìŠ¤',
              data: deadCross,
              type: 'scatter',
              pointRadius: 8,
              pointHoverRadius: 10,
              pointBackgroundColor: 'rgba(239, 68, 68, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              showLine: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              onClick: (e, legendItem, legend) => {
                const index = legendItem.datasetIndex;
                // Disable click for golden/dead cross markers (indices 5 and 6)
                if (index === 5 || index === 6) return;
                // Default behavior for other datasets
                const chart = legend.chart;
                const meta = chart.getDatasetMeta(index);
                meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                chart.update();
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                footer: (items) => {
                  const idx = items[0].dataIndex;
                  if (isPerfectOrder && idx === lastIdx) {
                    return '\nğŸš€ ì •ë°°ì—´ ìƒíƒœ!';
                  }
                  return '';
                }
              }
            },
            title: {
              display: isPerfectOrder,
              text: 'ğŸš€ í˜„ì¬ ì •ë°°ì—´ ìƒíƒœ! (5ì¼ > 20ì¼ > 60ì¼)',
              color: 'rgba(34, 197, 94, 1)',
              font: { size: 14, weight: 'bold' }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { stepSize: 10 }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          },
          zoom: {
            zoom: {
              wheel: {
                enabled: true,
                speed: 0.1
              },
              pinch: {
                enabled: true
              },
              mode: 'x'
            },
            pan: {
              enabled: true,
              mode: 'x'
            },
            limits: {
              x: { min: 'original', max: 'original' }
            }
          }
        },
        onDoubleClick: (event, activeElements, chart) => {
          chart.resetZoom();
        }
      });
    }

    function renderChapterWeaknessChart(chapterData) {
      const ctx = $('chart-chapter-weakness');
      if (!ctx || !window.Chart) return;

      const chapters = Array.from(chapterData.entries()).map(([chapter, data]) => {
        const avgScore = data.scores.reduce((a, b) => a + b, 0) / data.scores.length;
        return { chapter, avgScore };
      }).sort((a, b) => a.avgScore - b.avgScore).slice(0, 10);

      const labels = chapters.map(c => chapterLabelText(c.chapter));
      const data = chapters.map(c => Math.round(c.avgScore));

      reportCharts.chapterWeakness = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'í‰ê·  ì ìˆ˜',
            data,
            backgroundColor: data.map(score =>
              score < 60 ? 'rgba(239, 68, 68, 0.5)' :
              score < 80 ? 'rgba(251, 146, 60, 0.5)' :
              'rgba(34, 197, 94, 0.5)'
            ),
            borderColor: data.map(score =>
              score < 60 ? 'rgba(239, 68, 68, 1)' :
              score < 80 ? 'rgba(251, 146, 60, 1)' :
              'rgba(34, 197, 94, 1)'
            ),
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { beginAtZero: true, max: 100 }
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const chapter = chapters[index].chapter;
              showChapterDetail(chapter, chapterData.get(chapter));
            }
          }
        }
      });
      ctx.style.height = `${Math.max(300, chapters.length * 40)}px`;
    }

    function showChapterDetail(chapter, data) {
      const container = $('chapter-detail-chart');
      if (!container) return;
      container.classList.remove('hidden');

      const ctx = $('chart-chapter-detail');
      if (!ctx || !window.Chart) return;

      // Group by date and calculate daily average
      const dailyMap = new Map();
      data.dates.forEach((timestamp, i) => {
        const dateStr = new Date(timestamp).toISOString().slice(0, 10);
        if (!dailyMap.has(dateStr)) {
          dailyMap.set(dateStr, []);
        }
        dailyMap.get(dateStr).push(data.scores[i]);
      });

      // Calculate daily averages
      const dailyData = Array.from(dailyMap.entries())
        .map(([date, scores]) => ({
          date,
          avg: scores.reduce((a, b) => a + b, 0) / scores.length
        }))
        .sort((a, b) => a.date.localeCompare(b.date));

      const labels = dailyData.map(d => d.date.slice(5));
      const avgScores = dailyData.map(d => Math.round(d.avg * 10) / 10);

      // Calculate cumulative average
      const cumulativeAvg = [];
      let sum = 0;
      for (let i = 0; i < avgScores.length; i++) {
        sum += avgScores[i];
        cumulativeAvg.push(Math.round((sum / (i + 1)) * 10) / 10);
      }

      // Calculate moving averages
      const ma5 = calculateMovingAverage(avgScores, 5);
      const ma20 = calculateMovingAverage(avgScores, 20);
      const ma60 = calculateMovingAverage(avgScores, 60);

      // Detect Golden Cross and Dead Cross
      const goldenCross = [], deadCross = [];
      for (let i = 1; i < ma5.length; i++) {
        if (ma5[i] !== null && ma20[i] !== null && ma5[i-1] !== null && ma20[i-1] !== null) {
          if (ma5[i-1] <= ma20[i-1] && ma5[i] > ma20[i]) {
            goldenCross.push({ x: i, y: ma5[i] });
          }
          if (ma5[i-1] >= ma20[i-1] && ma5[i] < ma20[i]) {
            deadCross.push({ x: i, y: ma5[i] });
          }
        }
      }

      // Check perfect order
      const lastIdx = ma5.length - 1;
      const isPerfectOrder = ma5[lastIdx] && ma20[lastIdx] && ma60[lastIdx] &&
                            ma5[lastIdx] > ma20[lastIdx] && ma20[lastIdx] > ma60[lastIdx];

      if (reportCharts.chapterDetail) reportCharts.chapterDetail.destroy();

      reportCharts.chapterDetail = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'ì¼í‰ê· ',
              data: avgScores,
              borderColor: 'rgba(147, 51, 234, 1)',
              backgroundColor: 'rgba(147, 51, 234, 0.1)',
              tension: 0.1,
              pointRadius: 2,
              borderWidth: 2
            },
            {
              label: 'MA5 (ë‹¨ê¸°)',
              data: ma5,
              borderColor: 'rgba(34, 197, 94, 0.8)',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 0,
              fill: false
            },
            {
              label: 'MA20 (ì¤‘ê¸°â˜…)',
              data: ma20,
              borderColor: 'rgba(234, 179, 8, 0.8)',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 0,
              fill: false
            },
            {
              label: 'MA60 (ì¥ê¸°)',
              data: ma60,
              borderColor: 'rgba(239, 68, 68, 0.8)',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 0,
              fill: false
            },
            {
              label: 'ì´ëˆ„ì í‰ê· ',
              data: cumulativeAvg,
              borderColor: 'rgba(107, 114, 128, 0.5)',
              borderWidth: 1.5,
              borderDash: [5, 5],
              tension: 0.3,
              pointRadius: 0,
              fill: false
            },
            {
              label: 'ê³¨ë“  í¬ë¡œìŠ¤',
              data: goldenCross,
              type: 'scatter',
              pointRadius: 8,
              pointHoverRadius: 10,
              pointBackgroundColor: 'rgba(34, 197, 94, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              showLine: false
            },
            {
              label: 'ë°ë“œ í¬ë¡œìŠ¤',
              data: deadCross,
              type: 'scatter',
              pointRadius: 8,
              pointHoverRadius: 10,
              pointBackgroundColor: 'rgba(239, 68, 68, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              showLine: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              onClick: (e, legendItem, legend) => {
                const index = legendItem.datasetIndex;
                // Disable click for golden/dead cross markers (indices 5 and 6)
                if (index === 5 || index === 6) return;
                // Default behavior for other datasets
                const chart = legend.chart;
                const meta = chart.getDatasetMeta(index);
                meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                chart.update();
              }
            },
            title: {
              display: true,
              text: chapterLabelText(chapter) + ' - ì ìˆ˜ ì¶”ì´ (ì¼í‰ê· )' + (isPerfectOrder ? ' ğŸš€ ì •ë°°ì—´!' : '')
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                footer: (items) => {
                  const idx = items[0].dataIndex;
                  if (isPerfectOrder && idx === lastIdx) {
                    return '\nğŸš€ ì •ë°°ì—´ ìƒíƒœ!';
                  }
                  return '';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { stepSize: 10 }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          },
          zoom: {
            zoom: {
              wheel: {
                enabled: true,
                speed: 0.1
              },
              pinch: {
                enabled: true
              },
              mode: 'x'
            },
            pan: {
              enabled: true,
              mode: 'x'
            },
            limits: {
              x: { min: 'original', max: 'original' }
            }
          }
        },
        onDoubleClick: (event, activeElements, chart) => {
          chart.resetZoom();
        }
      });
    }

    function renderActionPlan(weakProblems) {
      const now = Date.now();
      const urgent = [], weekly = [], longterm = [];

      for (const wp of weakProblems) {
        const daysSince = (now - wp.date) / (1000 * 60 * 60 * 24);
        if (daysSince <= 3) {
          urgent.push(wp);
        } else if (daysSince <= 10) {
          weekly.push(wp);
        } else {
          longterm.push(wp);
        }
      }

      const urgentList = $('action-urgent-list');
      const weeklyList = $('action-weekly-list');
      const longtermList = $('action-longterm-list');

      if (urgentList) {
        urgentList.innerHTML = urgent.length ? urgent.slice(0, 10).map(wp =>
          `<div class="text-sm">â€¢ ${wp.problem.problemTitle || wp.problem.ë¬¼ìŒ?.slice(0, 30) + '...'} (${wp.score}ì )</div>`
        ).join('') : '<div class="text-sm text-gray-500">ì—†ìŒ</div>';
      }

      if (weeklyList) {
        weeklyList.innerHTML = weekly.length ? weekly.slice(0, 10).map(wp =>
          `<div class="text-sm">â€¢ ${wp.problem.problemTitle || wp.problem.ë¬¼ìŒ?.slice(0, 30) + '...'} (${wp.score}ì )</div>`
        ).join('') : '<div class="text-sm text-gray-500">ì—†ìŒ</div>';
      }

      if (longtermList) {
        longtermList.innerHTML = longterm.length ? longterm.slice(0, 10).map(wp =>
          `<div class="text-sm">â€¢ ${wp.problem.problemTitle || wp.problem.ë¬¼ìŒ?.slice(0, 30) + '...'} (${wp.score}ì )</div>`
        ).join('') : '<div class="text-sm text-gray-500">ì—†ìŒ</div>';
      }

      // Interactive wrong answers
      const wrongAnswers = $('action-wrong-answers');
      if (wrongAnswers) {
        const uniqueProblems = new Map();
        for (const wp of weakProblems) {
          if (!uniqueProblems.has(wp.qid) || uniqueProblems.get(wp.qid).score > wp.score) {
            uniqueProblems.set(wp.qid, wp);
          }
        }

        wrongAnswers.innerHTML = Array.from(uniqueProblems.values()).slice(0, 20).map(wp => {
          const rec = questionScores[wp.qid];
          const userAnswer = rec?.user_answer || '(ë‹µì•ˆ ì—†ìŒ)';
          const aiFeedback = rec?.feedback || '(í”¼ë“œë°± ì—†ìŒ)';
          return `
            <div class="border rounded-lg p-4">
              <div class="flex justify-between items-start mb-2">
                <h4 class="font-semibold">${wp.problem.problemTitle || 'ë¬¸í•­ ' + wp.problem.í‘œì‹œë²ˆí˜¸}</h4>
                <span class="text-xs px-2 py-1 rounded-full ${wp.score < 60 ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${wp.score}ì </span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-2"><strong>ë¬¼ìŒ:</strong> ${wp.problem.ë¬¼ìŒ}</p>
              <p class="text-sm mb-2"><strong>ë‚´ ë‹µì•ˆ:</strong> ${userAnswer}</p>
              <button class="show-answer-btn text-sm text-blue-600 hover:underline" data-qid="${wp.qid}">
                ğŸ§  ëª¨ë²” ë‹µì•ˆ ë° AI ì´í‰ ë³´ê¸°
              </button>
              <div class="answer-detail hidden mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded">
                <p class="text-sm mb-2"><strong>ëª¨ë²” ë‹µì•ˆ:</strong> ${wp.problem.ì •ë‹µ}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400"><strong>AI ì´í‰:</strong> ${aiFeedback}</p>
              </div>
            </div>
          `;
        }).join('');

        // Add toggle listeners
        wrongAnswers.querySelectorAll('.show-answer-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const detail = e.target.nextElementSibling;
            if (detail) {
              detail.classList.toggle('hidden');
              e.target.textContent = detail.classList.contains('hidden') ?
                'ğŸ§  ëª¨ë²” ë‹µì•ˆ ë° AI ì´í‰ ë³´ê¸°' : 'ğŸ™ˆ ë‹µì•ˆ ìˆ¨ê¸°ê¸°';
            }
          });
        });
      }
    }

    // Simple markdown to HTML converter
    function markdownToHtml(md) {
      if (!md) return '';
      let html = md;

      // Headers
      html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

      // Bold
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

      // Lists
      html = html.replace(/^\* (.+)$/gm, '<li>$1</li>');
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');

      // Numbered lists
      html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

      // Paragraphs
      html = html.split('\n\n').map(para => {
        if (para.startsWith('<h') || para.startsWith('<ul') || para.startsWith('<ol')) {
          return para;
        }
        return para.trim() ? `<p>${para.trim()}</p>` : '';
      }).join('\n');

      return html;
    }

    async function startAIAnalysis() {
      const startBtn = $('ai-analysis-start-btn');
      const loading = $('ai-analysis-loading');
      const result = $('ai-analysis-result');

      // Check API key first
      if(!geminiApiKey){
        openApiModal(false);
        showToast('Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.','error');
        return;
      }

      if (startBtn) startBtn.parentElement.classList.add('hidden');
      if (loading) loading.classList.remove('hidden');

      try {
        const data = getReportData();

        if (data.weakProblems.length === 0) {
          showToast('ë¶„ì„í•  ì˜¤ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warn');
          if (loading) loading.classList.add('hidden');
          if (startBtn) startBtn.parentElement.classList.remove('hidden');
          return;
        }

        // Prepare prompt with actual user answers from solve history
        const weakProblemsSummary = data.weakProblems.slice(0, 20).map(wp => {
          const scoreData = questionScores[wp.qid];
          const solveHistory = scoreData?.solveHistory || [];
          const latestSolve = solveHistory[solveHistory.length - 1];

          return {
            ë¬¸ì œ: wp.problem.ë¬¼ìŒ,
            ì •ë‹µ: wp.problem.ì •ë‹µ,
            ë‚´ë‹µì•ˆ: latestSolve?.user_answer || scoreData?.user_answer || '(ë‹µë³€ ì—†ìŒ)',
            ì ìˆ˜: wp.score
          };
        });

        const prompt = `[ì‹œìŠ¤í…œ ì—­í•  ì •ì˜]

ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ CPA 2ì°¨ íšŒê³„ê°ì‚¬ ì‹œí—˜ í•©ê²©ì„ ë•ëŠ” AI í•™ìŠµ ì½”ì¹˜ì…ë‹ˆë‹¤.
ë‹¨, ë‹¹ì‹ ì˜ ì „ë¬¸ì  í˜ë¥´ì†Œë‚˜ëŠ” ë‹¤ìŒ ë‘ ì—­í• ì„ ê²°í•©í•©ë‹ˆë‹¤:

20ë…„ ì°¨ í˜„ì§ íšŒê³„ì‚¬(CPA)

í’ë¶€í•œ ì‹¤ë¬´ ê²½í—˜ê³¼ ê¸°ì¤€ì„œÂ·ì„¸ë²•Â·ê°ì‚¬ì ˆì°¨ì— ì •í†µí•œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

íšŒê³„ê°ì‚¬ 2ì°¨ ì‹œí—˜ â€˜ì±„ì ìœ„ì›â€™

ë‹µì•ˆì„ ê¸°ì¤€ì„œì  ë¬¸êµ¬ì™€ ì‹¤ì œ í‰ê°€ ê¸°ì¤€ìœ¼ë¡œ ëƒ‰ì² íˆ íŒë‹¨í•  ìˆ˜ ìˆëŠ” í‰ê°€ìì…ë‹ˆë‹¤.

[í•µì‹¬ ì–´ì¡° ì§€ì¹¨]

ë‹¹ì‹ ì˜ ê¸°ë³¸ ì–´ì¡°ëŠ” ë”°ëœ»í•˜ê³  ê²©ë ¤ì ì…ë‹ˆë‹¤.

ë‹¨, ì§„ë‹¨ ë° ì±„ì í‰ì„ ì œì‹œí•  ë•ŒëŠ” ëƒ‰ì² í•˜ê³  ê°ê´€ì ì¸ ì±„ì ìœ„ì›ì˜ ì‹œì„ ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.

â€œê²©ë ¤ì™€ ì±„ì â€ì€ ë°˜ë“œì‹œ ì„¹ì…˜ë³„ë¡œ êµ¬ë¶„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

ì •ëŸ‰ë¶„ì„(ì„±ê³¼ ìš”ì•½): ê¸ì •ì Â·ê²©ë ¤ ì¤‘ì‹¬

ì •ì„±ë¶„ì„(ë‹µì•ˆí‰ê°€Â·ì²¨ì‚­): ë¶„ì„ì Â·ë¹„íŒì 

í”¼ë“œë°±ì€ â€œë¶„ì„ì ì´ë˜ í¬ë§ì ì¸ ì–´ì¡°â€ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.
ì¦‰, ì˜ëª»ì„ ì§€ì í•˜ë˜ ì‚¬ìš©ìê°€ â€œë°”ë¡œì¡ì„ ìˆ˜ ìˆë‹¤â€ëŠ” ê°€ëŠ¥ì„±ì„ ì—´ì–´ë‘¡ë‹ˆë‹¤.

[ì‘ë™ ì›ë¦¬: ë”¥ëŸ¬ë‹ ë¦¬í¬íŠ¸ í”„ë¡œì„¸ìŠ¤]

ì…ë ¥ìœ¼ë¡œ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ ë˜ëŠ” ë‘˜ ëª¨ë‘ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

ëˆ„ì ëœ ì‹œê³„ì—´ í•™ìŠµ ê¸°ë¡

ì˜¤ë‹µ ë°ì´í„°(JSON)

ì¶œë ¥ ì „ ë‹¨ê³„ë³„ ì‘ì—…:
1ï¸âƒ£ ì…ë ¥ ë°ì´í„°ë¥¼ ìš”ì•½í•˜ê³  ì£¼ìš” íŠ¸ë Œë“œÂ·íŒ¨í„´ì„ íŒŒì•…í•©ë‹ˆë‹¤.
2ï¸âƒ£ ê·¸ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¨ê³„ë³„ Markdown í˜•ì‹ì˜ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
3ï¸âƒ£ ë¦¬í¬íŠ¸ ë‚´ ê° ì„¹ì…˜ì€ â€œë¬´ì—‡(What)â€ â†’ â€œì™œ(Why)â€ â†’ â€œì–´ë–»ê²Œ(How)â€ êµ¬ì¡°ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤.

[ì¶œë ¥ í˜•ì‹ (Markdown)]
ğŸ¤– AI ì±„ì ìœ„ì› ë”¥ëŸ¬ë‹ ë¦¬í¬íŠ¸

ì•ˆë…•í•˜ì„¸ìš”. ìµœê·¼ í•™ìŠµ ë°ì´í„°ë¥¼ ì±„ì ìœ„ì›ì˜ ì‹œê°ìœ¼ë¡œ ë©´ë°€íˆ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.
ê°ê´€ì  ë°ì´í„°ë¡œ â€˜í˜„ì¬ ìœ„ì¹˜â€™ë¥¼ ì§„ë‹¨í•˜ê³ , ì„±ì¥ ë°©í–¥ì„ í•¨ê»˜ ì„¤ê³„í•´ë³´ê² ìŠµë‹ˆë‹¤.

1ï¸âƒ£ ì •ëŸ‰ì  í•™ìŠµ ì„±ê³¼ (Quantitative Performance)

ì„¹ì…˜ ì–´ì¡°: ê²©ë ¤ ì¤‘ì‹¬

í•™ìŠµëŸ‰ ë¶„ì„:
â€œì§€ë‚œì£¼ ëŒ€ë¹„ ì´ í•™ìŠµëŸ‰ì´ {{learning_increase_percent}}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤! ğŸ”¥ ê¾¸ì¤€í•¨ì´ ì‹¤ë ¥ìœ¼ë¡œ ì „í™˜ë˜ê³  ìˆìŠµë‹ˆë‹¤.â€

ì ìˆ˜ ì¶”ì´:
â€œìµœê·¼ 7ì¼ í‰ê·  ì ìˆ˜ê°€ {{old_score}}ì  â†’ {{new_score}}ì ìœ¼ë¡œ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤! ğŸš€ ê°œë… ì´í•´ê°€ ëšœë ·ì´ ê°œì„ ë˜ê³  ìˆë„¤ìš”.â€

ì·¨ì•½ ì±•í„°:
â€œâ€˜{{weak_chapter}}â€™ì˜ í‰ê·  ì ìˆ˜ê°€ {{weak_score}}ì ìœ¼ë¡œ ë‚®ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. í•´ë‹¹ ì£¼ì œë¥¼ ì¤‘ì  ê´€ë¦¬ ëŒ€ìƒìœ¼ë¡œ ì„¤ì •í•©ì‹œë‹¤.â€

ë‹¤ìŒ ëª©í‘œ ì œì•ˆ:
â€œí˜„ì¬ í•˜ë£¨ í‰ê·  {{current_daily_questions}}ë¬¸ì œë¥¼ í‘¸ì…¨ìŠµë‹ˆë‹¤.
ì´ë²ˆ ì£¼ëŠ” â€˜{{weak_chapter}}â€™ ì¤‘ì‹¬ìœ¼ë¡œ í•˜ë£¨ {{target_daily_questions}}ë¬¸ì œ í’€ì´ì— ë„ì „í•´ë³´ì„¸ìš”.â€

2ï¸âƒ£ ë‹µì•ˆ ì„œìˆ  ëŠ¥ë ¥ ì§„ë‹¨ (Qualitative Diagnosis)

ì„¹ì…˜ ì–´ì¡°: ì±„ì ìœ„ì› ëª¨ë“œ (ë¶„ì„ ì¤‘ì‹¬)

ì§„ë‹¨ ë“±ê¸‰: [ ìƒ / ì¤‘ / í•˜ ì¤‘ íƒì¼ ]
í•µì‹¬ ì§„ë‹¨:
â€œ{{qualitative_diagnosis}}â€

ì˜ˆì‹œ:

â€œê°œë…ì˜ ë°©í–¥ì€ ì´í•´í–ˆìœ¼ë‚˜, ê¸°ì¤€ì„œê°€ ìš”êµ¬í•˜ëŠ” â€˜í•µì‹¬ í‚¤ì›Œë“œ ì¸ì¶œë ¥â€™ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.
ë˜í•œ â€˜ì§ˆë¬¸ì˜ ìš”êµ¬ì‚¬í•­â€™ì„ êµ¬ì¡°ì ìœ¼ë¡œ ë¹ ëœ¨ë¦¬ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤.â€

3ï¸âƒ£ í–‰ë™ íŒ¨í„´ ë¶„ì„ (Behavioral Pattern)

ì˜¤ë‹µ ìœ í˜•ì„ 3ê°œ íŒ¨í„´ìœ¼ë¡œ ë¶„ë¥˜í–ˆìŠµë‹ˆë‹¤. ê° í•­ëª©ì€ ê°œì„  ìš°ì„ ìˆœìœ„ íŒë‹¨ì— í™œìš©í•˜ì‹­ì‹œì˜¤.

ìœ í˜•	ë¹„ìœ¨	ì¦ìƒ	ì§„ë‹¨
ì´í•´ ë¶€ì¡± (Comprehension)	{{understanding_error_percent}}%	ê°œë…ì˜ ì •ì˜ë‚˜ ì£¼ì²´ë¥¼ í˜¼ë™	ê¸°ë³¸ ê°œë… êµ¬ì¡° ë³µìŠµ í•„ìš”
ì•”ê¸° ë¶€ì¡± (Recall)	{{recall_error_percent}}%	ì •í™•í•œ ìš©ì–´ ì¸ì¶œ ì‹¤íŒ¨	ê¸°ì¤€ì„œ ë¬¸êµ¬ ì¤‘ì‹¬ ì•”ê¸°í›ˆë ¨ í•„ìš”
ì„œìˆ  ë¶ˆì™„ì „ (Structure)	{{structure_error_percent}}%	ë¬¸í•­ ìš”êµ¬ì‚¬í•­ ëˆ„ë½	ë‹µì•ˆ êµ¬ì„± ìŠ¤í‚¬ ë³´ì™„ í•„ìš”
4ï¸âƒ£ Top 3 êµì • ë…¸íŠ¸ (ì±„ì ìœ„ì› ì²¨ì‚­)

ì„¹ì…˜ ì–´ì¡°: ëƒ‰ì² í•œ ë¶„ì„ + ì‹¤ì§ˆì  ì²˜ë°©

â‘  [{{topic_1}}]

[í•™ìƒ ë‹µì•ˆ]
{{student_answer_1}}

[ëª¨ë²” ë‹µì•ˆ]
{{model_answer_1}}

[ì±„ì í‰]

(ê°œë… ì§„ë‹¨ ğŸ‘): {{concept_feedback_1}}

(ì„œìˆ  ì§„ë‹¨ ğŸ‘): {{writing_feedback_1}}

[ì²˜ë°©ì „ ğŸ’¡]

(ì•”ê¸°): {{memorization_tip_1}}

(ì„œìˆ ): {{writing_tip_1}}

â‘¡ [{{topic_2}}]

(ë™ì¼ í˜•ì‹ ë°˜ë³µ)

â‘¢ [{{topic_3}}]

(ë™ì¼ í˜•ì‹ ë°˜ë³µ)

ğŸ§¾ ì´í‰ (Encouragement & Next Steps)

ì„¹ì…˜ ì–´ì¡°: ë”°ëœ»í•œ ì½”ì¹˜ ëª¨ë“œ

ì´ë²ˆ ë¦¬í¬íŠ¸ì—ì„œ ë“œëŸ¬ë‚œ ì•½ì (í‚¤ì›Œë“œ ëˆ„ë½, ë‹µì•ˆ êµ¬ì¡° ë¯¸í¡)ì€ ëª¨ë‘ ì„±ì¥ì˜ ì¤‘ê°„ ê³¼ì •ì¼ ë¿ì…ë‹ˆë‹¤.
ì´ë¯¸ í•µì‹¬ ê°œë…ì„ ì´í•´í•˜ê³  ìˆìœ¼ë¯€ë¡œ, ë‚¨ì€ ê²ƒì€ â€˜í‘œí˜„ë ¥ê³¼ ì™„ì„±ë„â€™ì˜ í›ˆë ¨ì…ë‹ˆë‹¤.

ë‹¤ìŒ ì£¼ì—ëŠ”

(1) ì·¨ì•½ ì±•í„° ë³´ì™„

(2) êµ¬ì¡°ì  ë‹µì•ˆ ì—°ìŠµ

(3) í•µì‹¬ í‚¤ì›Œë“œ ì•”ê¸° ê°•í™”
ì´ ì„¸ ê°€ì§€ë¥¼ ëª©í‘œë¡œ ì§‘ì¤‘í•´ë´…ì‹œë‹¤.

ë‹¹ì‹ ì˜ í•™ìŠµ ê³¡ì„ ì€ ê¾¸ì¤€íˆ ìƒìŠ¹ ì¤‘ì…ë‹ˆë‹¤.
ì €ëŠ” ëƒ‰ì •í•œ ì±„ì ìœ„ì›ì´ì, ë™ì‹œì— ë‹¹ì‹ ì˜ ë“ ë“ í•œ ì½”ì¹˜ë¡œì„œ ëê¹Œì§€ í•¨ê»˜í•˜ê² ìŠµë‹ˆë‹¤. ğŸŒ±

[ì¶”ê°€ ê¸°ìˆ  ì§€ì¹¨]

{{placeholder}} í˜•íƒœì˜ ë³€ìˆ˜ëŠ” ì‹¤ì œ ì…ë ¥ ë°ì´í„°ë¡œ ìë™ ì¹˜í™˜ë©ë‹ˆë‹¤.

ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° í•´ë‹¹ í•­ëª©ì€ ìƒëµí•©ë‹ˆë‹¤.(ì…ë ¥ë‹µì•ˆì´ ì—†ê±°ë‚˜ ë¬´ì˜ë¯¸í•œ ìˆ˜ì¤€ì¸ ê²½ìš°)

ë³´ê³ ì„œ ìƒì„±ì€ í•­ìƒ ë‹¤ìŒ ìˆœì„œë¡œ ì§„í–‰í•©ë‹ˆë‹¤:
â‘  ë°ì´í„° ìš”ì•½ â†’ â‘¡ ì •ëŸ‰ ë¶„ì„ â†’ â‘¢ ì •ì„± ë¶„ì„ â†’ â‘£ ì²¨ì‚­ â†’ â‘¤ ì´í‰

ëª¨ë“  ë¬¸ì¥ì€ ëª…í™•ì„±Â·ê°ê´€ì„±Â·ì‹¤ì§ˆì„±ì„ ìš°ì„ í•©ë‹ˆë‹¤.

ê°ì •ì  í‘œí˜„ì€ â€œê²©ë ¤ ì„¹ì…˜â€ì—ì„œë§Œ í—ˆìš©ë©ë‹ˆë‹¤.
ë°ì´í„°:
${JSON.stringify(weakProblemsSummary, null, 2)}

ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”.`;

        const response = await callGeminiTextAPI(prompt, geminiApiKey);

        if (loading) loading.classList.add('hidden');
        if (result) result.classList.remove('hidden');

        // Display full analysis in one section
        if (el.aiErrorPattern) {
          el.aiErrorPattern.innerHTML = markdownToHtml(response);
        }

      } catch (err) {
        if (loading) loading.classList.add('hidden');
        if (startBtn) startBtn.parentElement.classList.remove('hidden');
        showToast('AI ë¶„ì„ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    function copyAIAnalysis() {
      const errorPattern = $('ai-error-pattern')?.innerText || '';
      const conceptWeakness = $('ai-concept-weakness')?.innerText || '';
      const text = `# ì‹¤ìˆ˜ ìœ í˜• ë¶„ì„\n\n${errorPattern}\n\n# ì£¼ìš” ê°œë… ì•½ì \n\n${conceptWeakness}`;

      navigator.clipboard.writeText(text).then(() => {
        showToast('ë¶„ì„ ë‚´ìš©ì„ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤');
      }).catch(() => {
        showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error');
      });
    }

    // Event listeners
    el.openReportBtn?.addEventListener('click', openReportModal);
    el.reportCloseBtn?.addEventListener('click', closeReportModal);
    el.reportRefreshBtn?.addEventListener('click', generateReport);
    el.chartScopeSelect?.addEventListener('change', () => {
      // TODO: Implement daily/weekly/monthly aggregation
      generateReport();
    });
    el.aiAnalysisStartBtn?.addEventListener('click', startAIAnalysis);
    el.aiAnalysisCopyBtn?.addEventListener('click', copyAIAnalysis);

    // Tab switching
    document.querySelectorAll('.report-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabNum = +tab.getAttribute('data-tab');
        switchReportTab(tabNum);
      });
    });

    // Save snapshot functionality - AI Analysis & Action Plan only
    el.reportSaveSnapshotBtn?.addEventListener('click', () => {
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
      const snapshot = {
        timestamp: new Date().toISOString(),
        period: reportData.period,
        threshold: reportData.threshold,
        aiAnalysis: {
          errorPattern: document.getElementById('ai-error-pattern')?.innerHTML || null,
          conceptWeakness: document.getElementById('ai-concept-weakness')?.innerHTML || null
        },
        actionPlan: document.getElementById('report-content-3')?.innerHTML || null
      };

      const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `í•™ìŠµë¶„ì„_${timestamp}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('AI ë¶„ì„ ë° ì•¡ì…˜ í”Œëœì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    });

    // Load snapshot functionality
    el.reportLoadSnapshotBtn?.addEventListener('click', () => {
      el.reportLoadSnapshotInput?.click();
    });

    el.reportLoadSnapshotInput?.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      try {
        const text = await file.text();
        const snapshot = JSON.parse(text);

        // Validate snapshot structure (new format: AI analysis + action plan)
        if (!snapshot.timestamp || !snapshot.aiAnalysis) {
          showToast('ì˜¬ë°”ë¥¸ í•™ìŠµ ë¶„ì„ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤', 'error');
          return;
        }

        // Restore AI analysis
        if (snapshot.aiAnalysis.errorPattern) {
          const aiErrorPattern = $('ai-error-pattern');
          if (aiErrorPattern) {
            aiErrorPattern.innerHTML = snapshot.aiAnalysis.errorPattern;
          }
        }

        if (snapshot.aiAnalysis.conceptWeakness) {
          const aiConceptWeakness = $('ai-concept-weakness');
          if (aiConceptWeakness) {
            aiConceptWeakness.innerHTML = snapshot.aiAnalysis.conceptWeakness;
          }
        }

        // Show AI analysis section
        const aiResult = $('ai-analysis-result');
        const aiLoading = $('ai-analysis-loading');
        if (aiResult) aiResult.classList.remove('hidden');
        if (aiLoading) aiLoading.classList.add('hidden');

        // Restore action plan
        if (snapshot.actionPlan) {
          const actionPlanContent = $('report-content-3');
          if (actionPlanContent) {
            actionPlanContent.innerHTML = snapshot.actionPlan;
          }
        }

        // Update report metadata
        reportData.period = snapshot.period;
        reportData.threshold = snapshot.threshold;

        // Switch to AI analysis tab
        switchReportTab(2);

        const snapshotDate = new Date(snapshot.timestamp).toLocaleString('ko-KR');
        showToast(`í•™ìŠµ ë¶„ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ (ì €ì¥ ì‹œê°: ${snapshotDate})`);

        // Reset file input for next use
        e.target.value = '';

      } catch (err) {
        showToast('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + err.message, 'error');
        e.target.value = '';
      }
    });

    // Print functionality - only print report modal content
    el.reportPrintBtn?.addEventListener('click', () => {
      const printContent = document.getElementById('report-modal');
      const originalDisplay = printContent.style.display;

      // Temporarily show modal for printing
      printContent.style.display = 'block';
      printContent.style.position = 'relative';
      printContent.style.background = 'white';

      window.print();

      // Restore original state
      printContent.style.display = originalDisplay;
      printContent.style.position = '';
      printContent.style.background = '';
    });

    /* ========================================
     * FLASHCARD MODE
     * ======================================== */
    let flashcardData = [];
    let flashcardIndex = 0;
    let flashcardAnswerVisible = false;
    /* [ì´ì „ ì½”ë“œ - ë¡œì»¬ ë³€ìˆ˜ ì„ ì–¸ ì œê±°ë¨]
    let isFlashcardMode = false;
    [ì´ì „ ì½”ë“œ ì¢…ë£Œ] */

    function startFlashcardMode() {
      // Use current quiz data if already loaded, otherwise get filtered data
      let dataToUse = currentQuizData && currentQuizData.length > 0
        ? currentQuizData
        : getFilteredByUI();

      if (!dataToUse || dataToUse.length === 0) {
        showToast('ì„ íƒí•œ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤', 'warn');
        return;
      }

      flashcardData = dataToUse;
      // Start from current problem if viewing quiz, otherwise start from beginning
      flashcardIndex = (currentQuizData && currentQuizData.length > 0 && currentQuestionIndex >= 0)
        ? currentQuestionIndex
        : 0;
      flashcardAnswerVisible = false;
      isFlashcardMode = true;

      // Hide quiz area, show flashcard area and summary
      el.quizArea?.classList.add('hidden');
      el.flashcardArea?.classList.remove('hidden');
      el.resultBox?.classList.add('hidden');
      el.summaryArea?.classList.remove('hidden');  // Keep summary visible for problem list navigation

      displayFlashcard();
      updateSummaryHighlight();  // Highlight current flashcard in problem list
      showToast(`í”Œë˜ì‹œì¹´ë“œ ëª¨ë“œ ì‹œì‘ (${flashcardData.length}ê°œ ë¬¸ì œ)`);
    }

    function refreshFlashcardData() {
      if (!isFlashcardMode) return;

      // Get updated data based on current filter settings
      const newData = getFilteredByUI();

      if (!newData || newData.length === 0) {
        showToast('ì„ íƒí•œ ì¡°ê±´ì— ë§ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤', 'warn');
        return;
      }

      // Try to maintain current position if possible
      const currentId = flashcardData[flashcardIndex]?.ê³ ìœ ID;
      flashcardData = newData;

      // Find current card in new data
      if (currentId) {
        const newIndex = flashcardData.findIndex(q => q.ê³ ìœ ID === currentId);
        flashcardIndex = newIndex >= 0 ? newIndex : 0;
      } else {
        flashcardIndex = 0;
      }

      displayFlashcard();
      showToast(`í”Œë˜ì‹œì¹´ë“œ ì—…ë°ì´íŠ¸ (${flashcardData.length}ê°œ ë¬¸ì œ)`);
    }

    function displayFlashcard() {
      if (!flashcardData.length) return;

      const card = flashcardData[flashcardIndex];

      if (el.flashcardTitle) {
        el.flashcardTitle.textContent = card.problemTitle || `ë¬¸í•­ ${card.í‘œì‹œë²ˆí˜¸ || card.ë¬¼ìŒë²ˆí˜¸}`;
      }

      if (el.flashcardQuestion) {
        el.flashcardQuestion.textContent = card.ë¬¼ìŒ || '(ë¬¼ìŒ ì—†ìŒ)';
      }

      if (el.flashcardAnswer) {
        el.flashcardAnswer.textContent = card.ì •ë‹µ || '(ì •ë‹µ ì—†ìŒ)';
      }

      if (el.flashcardCounter) {
        el.flashcardCounter.textContent = `${flashcardIndex + 1} / ${flashcardData.length}`;
      }

      // Reset answer visibility
      hideFlashcardAnswer();

      // Update button states
      if (el.flashcardPrevBtn) {
        el.flashcardPrevBtn.disabled = flashcardIndex === 0;
        el.flashcardPrevBtn.style.opacity = flashcardIndex === 0 ? '0.5' : '1';
      }

      if (el.flashcardNextBtn) {
        el.flashcardNextBtn.disabled = flashcardIndex === flashcardData.length - 1;
        el.flashcardNextBtn.style.opacity = flashcardIndex === flashcardData.length - 1 ? '0.5' : '1';
      }

      // Update problem list highlight
      updateSummaryHighlight();
    }

    function toggleFlashcardAnswer() {
      if (flashcardAnswerVisible) {
        hideFlashcardAnswer();
      } else {
        showFlashcardAnswer();
      }
    }

    function showFlashcardAnswer() {
      flashcardAnswerVisible = true;
      el.flashcardAnswerBox?.classList.remove('hidden');
      el.flashcardAnswerHidden?.classList.add('hidden');
      if (el.flashcardToggleAnswer) {
        el.flashcardToggleAnswer.textContent = 'ë‹µë³€ ìˆ¨ê¸°ê¸° ğŸ™ˆ';
      }
    }

    function hideFlashcardAnswer() {
      flashcardAnswerVisible = false;
      el.flashcardAnswerBox?.classList.add('hidden');
      el.flashcardAnswerHidden?.classList.remove('hidden');
      if (el.flashcardToggleAnswer) {
        el.flashcardToggleAnswer.textContent = 'ë‹µë³€ ë³´ê¸° ğŸ‘ï¸';
      }
    }

    function flashcardPrev() {
      if (flashcardIndex > 0) {
        flashcardIndex--;
        displayFlashcard();
      }
    }

    function flashcardNext() {
      if (flashcardIndex < flashcardData.length - 1) {
        flashcardIndex++;
        displayFlashcard();
      }
    }

    function flashcardRandom() {
      if (flashcardData.length > 0) {
        flashcardIndex = Math.floor(Math.random() * flashcardData.length);
        displayFlashcard();
        showToast('ëœë¤ ë¬¸ì œë¡œ ì´ë™');
      }
    }

    function exitFlashcardMode() {
      el.flashcardArea?.classList.add('hidden');
      el.quizArea?.classList.remove('hidden');
      el.summaryArea?.classList.remove('hidden');
      flashcardData = [];
      flashcardIndex = 0;
      flashcardAnswerVisible = false;
      isFlashcardMode = false;

      // Refresh quiz area and panels
      if (currentQuizData && currentQuizData.length > 0) {
        displayQuestion();
      } else {
        el.quizArea?.classList.add('hidden');
      }

      updateSummary();
      refreshPanels();

      showToast('í”Œë˜ì‹œì¹´ë“œ ëª¨ë“œ ì¢…ë£Œ');
    }

    // Flashcard event listeners
    el.flashcardModeBtn?.addEventListener('click', startFlashcardMode);
    el.flashcardToggleAnswer?.addEventListener('click', toggleFlashcardAnswer);
    el.flashcardPrevBtn?.addEventListener('click', flashcardPrev);
    el.flashcardNextBtn?.addEventListener('click', flashcardNext);
    el.flashcardRandomBtn?.addEventListener('click', flashcardRandom);
    el.flashcardExitBtn?.addEventListener('click', exitFlashcardMode);

    // Keyboard shortcuts for flashcard mode
    document.addEventListener('keydown', (e) => {
      // Only in flashcard mode
      if (!el.flashcardArea?.classList.contains('hidden')) {
        if (e.key === 'ArrowLeft' && !isEditing(e.target)) {
          e.preventDefault();
          flashcardPrev();
        } else if (e.key === 'ArrowRight' && !isEditing(e.target)) {
          e.preventDefault();
          flashcardNext();
        } else if (e.key === ' ' && !isEditing(e.target)) {
          e.preventDefault();
          toggleFlashcardAnswer();
        } else if (e.key === 'Escape') {
          exitFlashcardMode();
        }
      }
    });

    /* ========================================
     * ACHIEVEMENT SYSTEM
     * ======================================== */
    // [ë¦¬íŒ©í† ë§] ì—…ì  ìƒìˆ˜ëŠ” js/config/config.jsë¡œ ì´ë™ë¨
    // const ACHIEVEMENTS_LS_KEY = 'achievements_v1'; â†’ js/config/config.js
    let achievementsData = {};

    // [ë¦¬íŒ©í† ë§] ì—…ì  ì •ì˜ëŠ” js/config/config.jsë¡œ ì´ë™ë¨
    // const ACHIEVEMENTS = { ... } â†’ js/config/config.js
    /*
    const ACHIEVEMENTS_backup = {
      // Bronze - Basic achievements
      first_problem: { id: 'first_problem', name: 'ì²«ê±¸ìŒ', desc: 'ì²« ë²ˆì§¸ ë¬¸ì œ í’€ì´ ë° ì±„ì  ì™„ë£Œ', icon: 'ğŸ¯', tier: 'bronze', points: 10 },
      first_80: { id: 'first_80', name: 'ì²« 80ì ', desc: 'ìµœì´ˆë¡œ AI ì±„ì  80ì  ì´ìƒ ë‹¬ì„±', icon: 'ğŸ“ˆ', tier: 'bronze', points: 10 },
      problems_100: { id: 'problems_100', name: 'ì„±ì‹¤ì˜ ì¦í‘œ', desc: 'ì´ í’€ì´ ë¬¸ì œ 100ê°œ ëŒíŒŒ', icon: 'ğŸ“š', tier: 'bronze', points: 20 },
      streak_3: { id: 'streak_3', name: 'ë¶ˆíƒ€ëŠ” 3ì¼', desc: '3ì¼ ì—°ì† í•™ìŠµ', icon: 'ğŸ”¥', tier: 'bronze', points: 10 },
      streak_7: { id: 'streak_7', name: 'ì¼ì£¼ì¼ì˜ ìŠµê´€', desc: '7ì¼ ì—°ì† í•™ìŠµ', icon: 'ğŸ“…', tier: 'bronze', points: 20 },
      daily_20: { id: 'daily_20', name: 'ì¼ì¼ í€˜ìŠ¤íŠ¸', desc: 'í•˜ë£¨ì— 20ë¬¸ì œ ì´ìƒ í’€ì´ ì™„ë£Œ', icon: 'ğŸ“', tier: 'bronze', points: 10 },
      basic_source: { id: 'basic_source', name: 'ê¸°ë³¸ì˜ ì™•ë„', desc: 'ê¸°ë³¸ë°˜ ì¶œì²˜(H, S, HS)ì˜ ëª¨ë“  ë¬¸ì œë¥¼ 1íšŒ ì´ìƒ í•™ìŠµ', icon: 'ğŸ“–', tier: 'bronze', points: 30 },
      advanced_source: { id: 'advanced_source', name: 'ì‹¬í™”ë°˜', desc: 'SS ë˜ëŠ” P ì¶œì²˜ ë¬¸ì œ 10ê°œ ì´ìƒ í’€ì´', icon: 'ğŸ“', tier: 'bronze', points: 20 },
      review_master: { id: 'review_master', name: 'ë³µìŠµì˜ ë‹¬ì¸', desc: 'ì˜¤ëŠ˜ì˜ ë³µìŠµ ê¸°ëŠ¥ 10íšŒ ì´ìƒ ì‚¬ìš©', icon: 'ğŸ”„', tier: 'bronze', points: 15 },
      flagged_20: { id: 'flagged_20', name: 'ì˜¤ë‹µë…¸íŠ¸', desc: 'ë³µìŠµ ì¶”ê°€(â˜…) í”Œë˜ê·¸ 20ê°œ ì´ìƒ ì„¤ì •', icon: 'â­', tier: 'bronze', points: 10 },

      // Silver - Intermediate achievements
      first_90: { id: 'first_90', name: 'ê³ ìˆ˜ì˜ ë°˜ì—´', desc: 'ìµœì´ˆë¡œ 90ì  ì´ìƒ ë‹¬ì„±', icon: 'ğŸ–ï¸', tier: 'silver', points: 20 },
      first_100: { id: 'first_100', name: 'ì™„ë²½í•œ ì´í•´', desc: 'ìµœì´ˆë¡œ 100ì  ë‹¬ì„±', icon: 'ğŸ’¯', tier: 'silver', points: 30 },
      problems_1000: { id: 'problems_1000', name: 'ì²œë¦¬ê¸¸', desc: 'ì´ í’€ì´ ë¬¸ì œ 1,000ê°œ ëŒíŒŒ', icon: 'ğŸŒŸ', tier: 'silver', points: 100 },
      streak_30: { id: 'streak_30', name: 'í•œ ë‹¬ì˜ ëˆê¸°', desc: '30ì¼ ì—°ì† í•™ìŠµ', icon: 'ğŸ’ª', tier: 'silver', points: 50 },
      streak_60: { id: 'streak_60', name: 'ë‘ ë‹¬ì˜ ì§‘ë…', desc: '60ì¼ ì—°ì† í•™ìŠµ', icon: 'ğŸƒ', tier: 'silver', points: 80 },
      weekly_100: { id: 'weekly_100', name: 'ì£¼ê°„ ì •ë³µì', desc: 'ì¼ì£¼ì¼ ë™ì•ˆ 100ë¬¸ì œ ì´ìƒ í’€ì´ ì™„ë£Œ', icon: 'ğŸ“Š', tier: 'silver', points: 30 },
      overcome_weakness: { id: 'overcome_weakness', name: 'ì•½ì  ê·¹ë³µ', desc: '60ì  ë¯¸ë§Œì´ì—ˆë˜ ë¬¸ì œë¥¼ ë³µìŠµí•˜ì—¬ 85ì  ì´ìƒìœ¼ë¡œ ê°±ì‹ ', icon: 'ğŸ’ª', tier: 'silver', points: 25 },
      perfect_day: { id: 'perfect_day', name: 'í¼í™íŠ¸ ë°ì´', desc: 'í•˜ë£¨ì— í‘¼ 10ê°œ ì´ìƒì˜ ë¬¸ì œ ëª¨ë‘ 80ì  ì´ìƒ ë‹¬ì„±', icon: 'âœ¨', tier: 'silver', points: 30 },
      avg_80: { id: 'avg_80', name: 'ì•ˆì •ê¶Œ ì§„ì…', desc: 'ì „ì²´ ë¬¸ì œ ëˆ„ì  í‰ê·  ì ìˆ˜ 80ì  ëŒíŒŒ', icon: 'ğŸ¯', tier: 'silver', points: 30 },
      chapter_master: { id: 'chapter_master', name: 'ì±•í„° ë§ˆìŠ¤í„°', desc: 'íŠ¹ì • ë‹¨ì›ì˜ ëª¨ë“  ë¬¸ì œ í‰ê·  80ì  ë‹¬ì„±', icon: 'ğŸ‘‘', tier: 'silver', points: 40 },
      first_completion: { id: 'first_completion', name: '1íšŒë… ì™„ë£Œ', desc: 'questions.jsonì˜ ëª¨ë“  ë‹¨ì›ì„ 1ë¬¸ì œ ì´ìƒ í•™ìŠµ', icon: 'ğŸ“š', tier: 'silver', points: 50 },

      // Gold - Advanced achievements
      avg_90: { id: 'avg_90', name: 'ì¹­í˜¸: ì˜ˆë¹„ íšŒê³„ì‚¬', desc: 'ì „ì²´ ë¬¸ì œ ëˆ„ì  í‰ê·  ì ìˆ˜ 90ì  ëŒíŒŒ', icon: 'ğŸ†', tier: 'gold', points: 100 },
      avg_95: { id: 'avg_95', name: 'ì¹­í˜¸: ê¸°ì¤€ì„œ í”„ë¦°í„°', desc: 'ì „ì²´ ë¬¸ì œ ëˆ„ì  í‰ê·  ì ìˆ˜ 95ì  ëŒíŒŒ', icon: 'ğŸŒŸ', tier: 'gold', points: 150 },
      streak_90: { id: 'streak_90', name: 'ì„¸ ë‹¬ì˜ ê²½ì§€', desc: '90ì¼ ì—°ì† í•™ìŠµ', icon: 'ğŸ”¥', tier: 'gold', points: 120 },
      streak_120: { id: 'streak_120', name: '120ì¼ì˜ ì „ë¬¸ê°€', desc: '120ì¼ ì—°ì† í•™ìŠµ', icon: 'ğŸ‘¨â€ğŸ“', tier: 'gold', points: 200 },
      monthly_300: { id: 'monthly_300', name: 'ì›”ê°„ ì •ë³µì', desc: 'í•œ ë‹¬ ë™ì•ˆ 300ë¬¸ì œ ì´ìƒ í’€ì´ ì™„ë£Œ', icon: 'ğŸ“ˆ', tier: 'gold', points: 80 },

      // Hidden - Special achievements
      comeback: { id: 'comeback', name: 'ì¹ ì „íŒ”ê¸°', desc: '60ì  ë¯¸ë§Œìœ¼ë¡œ 3íšŒ ì´ìƒ ê¸°ë¡í•œ ë¬¸ì œë¥¼ ë§ˆì¹¨ë‚´ 85ì  ì´ìƒìœ¼ë¡œ í†µê³¼', icon: 'ğŸ¦…', tier: 'hidden', points: 50 },
      flagged_50: { id: 'flagged_50', name: 'ë°˜ì„±ì˜ ê¸°ë¡', desc: 'ë³µìŠµ ì¶”ê°€(â˜…) í”Œë˜ê·¸ê°€ 50ê°œ ì´ìƒ í™œì„±í™”ë¨', icon: 'ğŸ“', tier: 'hidden', points: 30 },
      dawn_learner: { id: 'dawn_learner', name: 'ìƒˆë²½ì˜ ê°ë¦°ì´', desc: 'ì˜¤ì „ 5:00 ~ 7:00 ì‚¬ì´ì— 10ë¬¸ì œ ì´ìƒ í’€ì´', icon: 'ğŸŒ…', tier: 'hidden', points: 25 },
      night_owl: { id: 'night_owl', name: 'ì˜¬ë¹¼ë¯¸', desc: 'ë‹¤í¬ ëª¨ë“œ ìƒíƒœë¡œ ì˜¤ì „ 1:00 ~ 4:00 ì‚¬ì´ì— 10ë¬¸ì œ ì´ìƒ í’€ì´', icon: 'ğŸ¦‰', tier: 'hidden', points: 25 },

      // Chapter 1st Completion (Bronze - 10 points each)
      ch1_1st: { id: 'ch1_1st', name: 'ê°ì‚¬ì˜ ì²«ê±¸ìŒ', desc: 'ì œ1ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch2_1st: { id: 'ch2_1st', name: 'ë¬´ê±°ìš´ ì™•ê´€', desc: 'ì œ2ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ê°ì‚¬ì¸ì˜ ì±…ì„ê³¼ ì˜ë¬´)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch3_1st: { id: 'ch3_1st', name: 'ì„±ê³µë³´ìˆ˜?', desc: 'ì œ3ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ë…ë¦½ì„±)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch4_1st: { id: 'ch4_1st', name: 'ëˆ„ê°€ í•  ê²ƒì¸ê°€', desc: 'ì œ4ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ê°ì‚¬ì¸ ì„ ì„)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch5_1st: { id: 'ch5_1st', name: 'ê³„ì•½ì„œì— ì„œëª…', desc: 'ì œ5ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ê°ì‚¬ê³„ì•½)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch6_1st: { id: 'ch6_1st', name: 'ì¤‘ìš”í•œ ê²Œ ë­”ë°?', desc: 'ì œ6ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ì¤‘ìš”ì„±, ê°ì‚¬ìœ„í—˜)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch7_1st: { id: 'ch7_1st', name: 'ì „ëµ ìˆ˜ë¦½', desc: 'ì œ7ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ê°ì‚¬ê³„íš, RMM)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch8_1st: { id: 'ch8_1st', name: 'í†µì œ, ë„ˆ ë¯¿ì–´ë„ ë¼?', desc: 'ì œ8ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (í†µì œí…ŒìŠ¤íŠ¸)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch10_1st: { id: 'ch10_1st', name: 'ì‹¤ì¦ì˜ ì²«ë°œ', desc: 'ì œ10ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch11_1st: { id: 'ch11_1st', name: 'ì¬ê³  ì„¸ëŠ” ë‚ ', desc: 'ì œ11ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ì¬ê³ ìì‚° ì‹¤ì‚¬)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch12_1st: { id: 'ch12_1st', name: 'ê¹Œë‹¤ë¡œìš´ ë…€ì„ë“¤', desc: 'ì œ12ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ë¶€ì •, ì¶”ì •ì¹˜, íŠ¹ìˆ˜ê´€ê³„ì)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch13_1st: { id: 'ch13_1st', name: 'ëª‡ ê°œë§Œ ë½‘ì•„ë³¼ê¹Œ', desc: 'ì œ13ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (í‘œë³¸ê°ì‚¬)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch14_1st: { id: 'ch14_1st', name: 'ì§‘ì— ê°€ê¸° ì „ì—', desc: 'ì œ14ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ê³„ì†ê¸°ì—…, í›„ì†ì‚¬ê±´)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch15_1st: { id: 'ch15_1st', name: 'ì˜ê²¬ì„ ì •í•  ì‹œê°„', desc: 'ì œ15ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch16_1st: { id: 'ch16_1st', name: 'ë³´ê³ ì„œ ì“°ê¸°', desc: 'ì œ16ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (KAM, ê°•ì¡°ì‚¬í•­)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch17_1st: { id: 'ch17_1st', name: 'ê·¸ë£¹ ì „ì²´ ë³´ê¸°', desc: 'ì œ17ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ê·¸ë£¹ê°ì‚¬)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch18_1st: { id: 'ch18_1st', name: 'ì•ˆì‚´ë¦¼ ì—¿ë³´ê¸°', desc: 'ì œ18ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ë‚´ë¶€íšŒê³„)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },
      ch20_1st: { id: 'ch20_1st', name: 'ì‘ì§€ë§Œ ì†Œì¤‘í•´', desc: 'ì œ20ì¥(ê¸°ë³¸) 1íšŒë… ì™„ë£Œ (ì†Œê·œëª¨ê¸°ì—…)', icon: 'ğŸ“–', tier: 'bronze', points: 10 },

      // Chapter Mastery (Silver - 20 points each)
      ch1_master: { id: 'ch1_master', name: 'ì´ ì •ë„ëŠ” ì´ì œ..', desc: 'ì œ1ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch2_master: { id: 'ch2_master', name: 'ì„±ê³µë¹„ì „ì „', desc: 'ì œ2ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch3_master: { id: 'ch3_master', name: 'ì² ë²½ì˜ í’ˆì§ˆê´€ë¦¬ì', desc: 'ì œ3ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch4_master: { id: 'ch4_master', name: 'ì„ ì„ ì ˆì°¨ ì „ë¬¸ê°€', desc: 'ì œ4ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch5_master: { id: 'ch5_master', name: 'ê°ì‚¬ê³„ì•½ í˜‘ìƒê°€', desc: 'ì œ5ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch6_master: { id: 'ch6_master', name: 'ê°ì‚¬ì¦ê±°ì˜ ì´í•´ì', desc: 'ì œ6ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch7_master: { id: 'ch7_master', name: 'RMM í‰ê°€ì', desc: 'ì œ7ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch8_master: { id: 'ch8_master', name: 'TOC ì„¤ê³„ì', desc: 'ì œ8ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch10_master: { id: 'ch10_master', name: 'ì”ì—¬ê¸°ê°„ ì „ë¬¸ê°€', desc: 'ì œ10ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch11_master: { id: 'ch11_master', name: 'ì´ˆë„ê°ì‚¬ ì „ë¬¸ê°€', desc: 'ì œ11ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch12_master: { id: 'ch12_master', name: 'ë¶€ì •ê°ì‚¬ ìŠ¤í˜ì…œë¦¬ìŠ¤íŠ¸', desc: 'ì œ12ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch13_master: { id: 'ch13_master', name: 'í‘œë³¸ì„¤ê³„ ë§ˆìŠ¤í„°', desc: 'ì œ13ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch14_master: { id: 'ch14_master', name: 'ê³„ì†ê¸°ì—… í‰ê°€ì', desc: 'ì œ14ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch15_master: { id: 'ch15_master', name: 'ì™œê³¡í‘œì‹œ í‰ê°€ì', desc: 'ì œ15ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch16_master: { id: 'ch16_master', name: 'KAM ì„ ì • ì „ë¬¸ê°€', desc: 'ì œ16ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch17_master: { id: 'ch17_master', name: 'ê·¸ë£¹ê°ì‚¬ ì§€íœ˜ì', desc: 'ì œ17ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch18_master: { id: 'ch18_master', name: 'ë‚´ë¶€í†µì œ í‰ê°€ì', desc: 'ì œ18ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 },
      ch20_master: { id: 'ch20_master', name: 'ì†Œê·œëª¨ ì „ë¬¸ê°€', desc: 'ì œ20ì¥ í‰ê·  85ì  ë‹¬ì„±', icon: 'ğŸ“', tier: 'silver', points: 20 }
    };
    */

    function loadAchievements() {
      const stored = localStorage.getItem(ACHIEVEMENTS_LS_KEY);
      if (stored) {
        try {
          achievementsData = JSON.parse(stored);
        } catch {}
      }
    }

    function saveAchievements() {
      try {
        localStorage.setItem(ACHIEVEMENTS_LS_KEY, JSON.stringify(achievementsData));
      } catch {}
    }

    function unlockAchievement(achievementId) {
      if (achievementsData[achievementId]) return; // Already unlocked

      const achievement = ACHIEVEMENTS[achievementId];
      if (!achievement) return;

      achievementsData[achievementId] = {
        unlockedAt: Date.now(),
        seen: false
      };

      saveAchievements();

      // Show notification
      showAchievementNotification(achievement);

      // Update badge
      updateAchievementBadge();
    }

    function showAchievementNotification(achievement) {
      console.log('ğŸ‰ ì—…ì  íŒì—… í‘œì‹œ:', achievement.name, achievement.desc);

      const tierColors = {
        bronze: 'from-amber-500 to-yellow-600',
        silver: 'from-gray-400 to-gray-500',
        gold: 'from-yellow-400 to-amber-500',
        hidden: 'from-purple-500 to-pink-600'
      };

      const notification = document.createElement('div');
      notification.className = `fixed top-20 right-4 bg-gradient-to-r ${tierColors[achievement.tier]} text-white px-6 py-4 rounded-lg shadow-2xl animate-bounce`;
      notification.style.zIndex = '99999'; // ìµœìƒë‹¨ ë³´ì¥
      notification.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="text-3xl">${achievement.icon}</span>
          <div>
            <div class="font-bold">ì—…ì  ë‹¬ì„±!</div>
            <div class="text-sm">${achievement.name}</div>
            <div class="text-xs opacity-90">${achievement.desc}</div>
          </div>
        </div>
      `;

      document.body.appendChild(notification);
      console.log('âœ… íŒì—… DOM ì¶”ê°€ ì™„ë£Œ (4ì´ˆê°„ í‘œì‹œ)');

      setTimeout(() => {
        notification.classList.remove('animate-bounce');
        notification.classList.add('opacity-0', 'transition-opacity');
        setTimeout(() => {
          notification.remove();
          console.log('âœ… íŒì—… ì œê±° ì™„ë£Œ');
        }, 500);
      }, 4000);
    }

    function updateAchievementBadge() {
      const unseenCount = Object.keys(achievementsData).filter(id => !achievementsData[id].seen).length;
      const badge = document.getElementById('new-achievement-badge');
      if (badge) {
        if (unseenCount > 0) {
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }

    function checkAchievements() {
      // Check first problem
      if (Object.keys(questionScores).length >= 1) {
        unlockAchievement('first_problem');
      }

      // Check score achievements
      const scores = Object.values(questionScores).map(s => s.score).filter(s => s !== undefined);
      if (scores.length > 0) {
        const maxScore = Math.max(...scores);
        if (maxScore >= 80) unlockAchievement('first_80');
        if (maxScore >= 90) unlockAchievement('first_90');
        if (maxScore === 100) unlockAchievement('first_100');
      }

      // Check problem count
      const totalProblems = Object.keys(questionScores).length;
      if (totalProblems >= 100) unlockAchievement('problems_100');
      if (totalProblems >= 1000) unlockAchievement('problems_1000');

      // Check average score
      if (scores.length > 0) {
        const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
        if (avgScore >= 80) unlockAchievement('avg_80');
        if (avgScore >= 90) unlockAchievement('avg_90');
        if (avgScore >= 95) unlockAchievement('avg_95');
      }

      // Check streaks
      checkStreakAchievements();

      // Check daily/weekly/monthly goals
      checkVolumeAchievements();

      // Check source-based achievements
      checkSourceAchievements();

      // Check flag-based achievements
      const flagCount = Object.values(questionScores).filter(s => s.userReviewFlag && !s.userReviewExclude).length;
      if (flagCount >= 20) unlockAchievement('flagged_20');
      if (flagCount >= 50) unlockAchievement('flagged_50');

      // Check overcome weakness
      checkOvercomeWeakness();

      // Check comeback achievement
      checkComeback();

      // Check perfect day
      checkPerfectDay();

      // Check chapter master
      checkChapterMaster();

      // Check 1íšŒë… ì™„ë£Œ
      check1stCompletion();

      // Check time-based achievements
      checkTimeBased();

      // Check chapter-specific achievements
      checkChapter1stCompletionPerChapter();
      checkChapterMasteryPerChapter();
    }

    function checkStreakAchievements() {
      try {
        const calData = JSON.parse(localStorage.getItem('auditQuizScores') || '{}');
        const dates = new Set();
        Object.values(calData).forEach(record => {
          if (record.solveHistory && Array.isArray(record.solveHistory)) {
            record.solveHistory.forEach(h => {
              if (h.date) {
                const d = new Date(h.date);
                dates.add(d.toDateString());
              }
            });
          }
        });

        const sortedDates = Array.from(dates).sort((a, b) => new Date(a) - new Date(b));
        let currentStreak = 0;
        let maxStreak = 0;
        let prevDate = null;

        sortedDates.forEach(dateStr => {
          const d = new Date(dateStr);
          if (prevDate) {
            const diff = Math.floor((d - prevDate) / (1000 * 60 * 60 * 24));
            if (diff === 1) {
              currentStreak++;
            } else if (diff > 1) {
              currentStreak = 1;
            }
          } else {
            currentStreak = 1;
          }
          maxStreak = Math.max(maxStreak, currentStreak);
          prevDate = d;
        });

        if (maxStreak >= 3) unlockAchievement('streak_3');
        if (maxStreak >= 7) unlockAchievement('streak_7');
        if (maxStreak >= 30) unlockAchievement('streak_30');
        if (maxStreak >= 60) unlockAchievement('streak_60');
        if (maxStreak >= 90) unlockAchievement('streak_90');
        if (maxStreak >= 120) unlockAchievement('streak_120');
      } catch {}
    }

    function checkVolumeAchievements() {
      try {
        const now = Date.now();
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const todayTime = today.getTime();
        const weekAgo = todayTime - 7 * 24 * 60 * 60 * 1000;
        const monthAgo = todayTime - 30 * 24 * 60 * 60 * 1000;

        let todayCount = 0;
        let weekCount = 0;
        let monthCount = 0;

        Object.values(questionScores).forEach(record => {
          if (record.solveHistory && Array.isArray(record.solveHistory)) {
            record.solveHistory.forEach(h => {
              const hDate = new Date(h.date);
              hDate.setHours(0, 0, 0, 0);
              const hTime = hDate.getTime();

              if (hTime === todayTime) todayCount++;
              if (hTime >= weekAgo) weekCount++;
              if (hTime >= monthAgo) monthCount++;
            });
          }
        });

        if (todayCount >= 20) unlockAchievement('daily_20');
        if (weekCount >= 100) unlockAchievement('weekly_100');
        if (monthCount >= 300) unlockAchievement('monthly_300');
      } catch {}
    }

    function checkSourceAchievements() {
      try {
        if (!allData || !allData.length) return;

        // Basic sources: H, S, HS
        const basicSources = allData.filter(q => ['H', 'S', 'HS'].includes(q.ì¶œì²˜));
        const basicSolved = basicSources.filter(q => questionScores[normId(q.ê³ ìœ ID)]);
        if (basicSources.length > 0 && basicSolved.length === basicSources.length) {
          unlockAchievement('basic_source');
        }

        // Advanced sources: SS, P
        const advancedSolved = Object.keys(questionScores).filter(id => {
          const q = allData.find(item => normId(item.ê³ ìœ ID) === id);
          return q && ['SS', 'P'].includes(q.ì¶œì²˜);
        });
        if (advancedSolved.length >= 10) unlockAchievement('advanced_source');
      } catch {}
    }

    function checkOvercomeWeakness() {
      try {
        Object.entries(questionScores).forEach(([id, record]) => {
          if (!record.solveHistory || record.solveHistory.length < 2) return;

          const scores = record.solveHistory.map(h => h.score).filter(s => s !== undefined);
          const hadLow = scores.some(s => s < 60);
          const latestScore = record.score;

          if (hadLow && latestScore >= 85) {
            unlockAchievement('overcome_weakness');
          }
        });
      } catch {}
    }

    function checkComeback() {
      try {
        Object.entries(questionScores).forEach(([id, record]) => {
          if (!record.solveHistory || record.solveHistory.length < 4) return;

          const scores = record.solveHistory.map(h => h.score).filter(s => s !== undefined);
          const lowScores = scores.filter(s => s < 60);
          const latestScore = record.score;

          if (lowScores.length >= 3 && latestScore >= 85) {
            unlockAchievement('comeback');
          }
        });
      } catch {}
    }

    function checkPerfectDay() {
      try {
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const todayTime = today.getTime();
        const todayProblems = [];

        Object.values(questionScores).forEach(record => {
          if (!record.solveHistory || !Array.isArray(record.solveHistory)) return;

          record.solveHistory.forEach(h => {
            const hDate = new Date(h.date);
            hDate.setHours(0, 0, 0, 0);
            if (hDate.getTime() === todayTime && h.score !== undefined) {
              todayProblems.push(h.score);
            }
          });
        });

        if (todayProblems.length >= 10 && todayProblems.every(s => s >= 80)) {
          unlockAchievement('perfect_day');
        }
      } catch {}
    }

    function checkChapterMaster() {
      try {
        if (!allData || !allData.length) return;

        const chapters = {};
        allData.forEach(q => {
          const ch = String(q.ë‹¨ì›).trim();
          if (!chapters[ch]) chapters[ch] = [];
          chapters[ch].push(q);
        });

        Object.entries(chapters).forEach(([chapter, problems]) => {
          const solvedProblems = problems.filter(q => {
            const score = questionScores[normId(q.ê³ ìœ ID)]?.score;
            return score !== undefined;
          });

          if (solvedProblems.length === problems.length && solvedProblems.length > 0) {
            const avgScore = solvedProblems.reduce((sum, q) => sum + questionScores[normId(q.ê³ ìœ ID)].score, 0) / solvedProblems.length;
            if (avgScore >= 80) {
              unlockAchievement('chapter_master');
            }
          }
        });
      } catch {}
    }

    function check1stCompletion() {
      try {
        if (!allData || !allData.length) return;

        const chapters = new Set(allData.map(q => String(q.ë‹¨ì›).trim()));
        const solvedChapters = new Set();

        allData.forEach(q => {
          if (questionScores[normId(q.ê³ ìœ ID)]) {
            solvedChapters.add(String(q.ë‹¨ì›).trim());
          }
        });

        if (chapters.size > 0 && chapters.size === solvedChapters.size) {
          unlockAchievement('first_completion');
        }
      } catch {}
    }

    function checkTimeBased() {
      try {
        const hour = new Date().getHours();
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const todayTime = today.getTime();

        const todayByHour = {};
        Object.values(questionScores).forEach(record => {
          if (!record.solveHistory || !Array.isArray(record.solveHistory)) return;

          record.solveHistory.forEach(h => {
            const hDate = new Date(h.date);
            const hDateOnly = new Date(hDate);
            hDateOnly.setHours(0, 0, 0, 0);

            if (hDateOnly.getTime() === todayTime) {
              const hHour = hDate.getHours();
              if (!todayByHour[hHour]) todayByHour[hHour] = 0;
              todayByHour[hHour]++;
            }
          });
        });

        // Dawn learner (5-7)
        let dawnCount = 0;
        for (let h = 5; h <= 6; h++) {
          dawnCount += (todayByHour[h] || 0);
        }
        if (dawnCount >= 10) unlockAchievement('dawn_learner');

        // Night owl (1-4) with dark mode
        const isDarkMode = document.documentElement.classList.contains('dark');
        if (isDarkMode) {
          let nightCount = 0;
          for (let h = 1; h <= 4; h++) {
            nightCount += (todayByHour[h] || 0);
          }
          if (nightCount >= 10) unlockAchievement('night_owl');
        }
      } catch {}
    }

    function checkChapter1stCompletionPerChapter() {
      try {
        if (!allData || !allData.length) return;

        // Chapter list: 1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20
        const chapters = [1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20];

        chapters.forEach(chNum => {
          const chStr = String(chNum);
          // Get all basic range problems (H, S, HS) for this chapter
          const basicProblems = allData.filter(q =>
            String(q.ë‹¨ì›).trim() === chStr && ['H', 'S', 'HS'].includes(q.ì¶œì²˜)
          );

          if (basicProblems.length === 0) return;

          // Check if all basic problems have been solved at least once
          const allSolved = basicProblems.every(q => {
            const record = questionScores[normId(q.ê³ ìœ ID)];
            return record !== undefined; // At least attempted once
          });

          if (allSolved) {
            unlockAchievement(`ch${chNum}_1st`);
          }
        });
      } catch {}
    }

    function checkChapterMasteryPerChapter() {
      try {
        if (!allData || !allData.length) return;

        // Chapter list: 1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20
        const chapters = [1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20];

        chapters.forEach(chNum => {
          const chStr = String(chNum);
          // Get ALL problems for this chapter (including advanced)
          const chapterProblems = allData.filter(q => String(q.ë‹¨ì›).trim() === chStr);

          if (chapterProblems.length === 0) return;

          // Get solved problems with scores
          const solvedWithScores = chapterProblems.filter(q => {
            const record = questionScores[normId(q.ê³ ìœ ID)];
            return record && record.score !== undefined;
          }).map(q => questionScores[normId(q.ê³ ìœ ID)].score);

          // Need at least some problems solved to calculate average
          if (solvedWithScores.length === 0) return;

          // Calculate average score
          const avgScore = solvedWithScores.reduce((sum, score) => sum + score, 0) / solvedWithScores.length;

          // Unlock if average is 85 or higher
          if (avgScore >= 85) {
            unlockAchievement(`ch${chNum}_master`);
          }
        });
      } catch {}
    }

    function openAchievementsModal() {
      loadAchievements();
      renderAchievements();
      el.achievementsModal?.classList.remove('hidden');
      el.achievementsModal?.classList.add('flex');

      // Mark all as seen
      Object.keys(achievementsData).forEach(id => {
        achievementsData[id].seen = true;
      });
      saveAchievements();
      updateAchievementBadge();
    }

    function closeAchievementsModal() {
      el.achievementsModal?.classList.add('hidden');
      el.achievementsModal?.classList.remove('flex');
    }

    function renderAchievements(filterTier = 'all') {
      const list = el.achievementsList;
      if (!list) return;

      list.innerHTML = '';

      // Filter achievements - hide locked hidden achievements
      let achievementsList = Object.values(ACHIEVEMENTS).filter(a => {
        // If it's a hidden achievement and not unlocked, don't show it at all
        if (a.tier === 'hidden' && !achievementsData[a.id]) {
          return false;
        }
        // Otherwise apply tier filter
        return filterTier === 'all' || a.tier === filterTier;
      });

      const unlocked = achievementsList.filter(a => achievementsData[a.id]);
      const locked = achievementsList.filter(a => !achievementsData[a.id]);

      // Update stats - exclude locked hidden achievements from total
      const visibleTotal = Object.values(ACHIEVEMENTS).filter(a => a.tier !== 'hidden' || achievementsData[a.id]).length;
      const unlockedCount = Object.keys(achievementsData).length;
      const progressPercent = visibleTotal > 0 ? Math.round((unlockedCount / visibleTotal) * 100) : 0;

      // Calculate actual points
      const totalPoints = Object.keys(achievementsData).reduce((sum, id) => {
        return sum + (ACHIEVEMENTS[id]?.points || 0);
      }, 0);

      if (el.achievementCountTotal) el.achievementCountTotal.textContent = visibleTotal;
      if (el.achievementCountUnlocked) el.achievementCountUnlocked.textContent = unlockedCount;
      if (el.achievementProgressPercent) el.achievementProgressPercent.textContent = progressPercent;
      if (el.achievementPoints) el.achievementPoints.textContent = totalPoints;

      // Render unlocked first
      unlocked.forEach(achievement => {
        const card = createAchievementCard(achievement, true);
        list.appendChild(card);
      });

      // Then locked (hidden achievements won't be here)
      locked.forEach(achievement => {
        const card = createAchievementCard(achievement, false);
        list.appendChild(card);
      });
    }

    function createAchievementCard(achievement, isUnlocked) {
      const div = document.createElement('div');
      const tierColors = {
        bronze: 'from-amber-100 to-yellow-100 border-amber-300',
        silver: 'from-gray-200 to-gray-300 border-gray-400',
        gold: 'from-yellow-100 to-amber-200 border-yellow-400',
        hidden: 'from-purple-100 to-pink-100 border-purple-300'
      };

      const tierIcons = {
        bronze: 'ğŸ¥‰',
        silver: 'ğŸ¥ˆ',
        gold: 'ğŸ¥‡',
        hidden: 'ğŸ¤«'
      };

      div.className = `bg-gradient-to-r ${tierColors[achievement.tier]} dark:from-gray-800 dark:to-gray-700 border rounded-lg p-4 ${isUnlocked ? '' : 'opacity-50 grayscale'}`;
      div.innerHTML = `
        <div class="flex items-start gap-3">
          <span class="text-4xl">${achievement.icon}</span>
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <h3 class="font-bold text-gray-900 dark:text-gray-100">${achievement.name}</h3>
              <span class="text-xs">${tierIcons[achievement.tier]}</span>
              ${isUnlocked ? '<span class="text-xs bg-green-500 text-white px-2 py-0.5 rounded-full">ë‹¬ì„±</span>' : ''}
            </div>
            <p class="text-sm text-gray-700 dark:text-gray-300">${achievement.desc}</p>
            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">+ ${achievement.points}P</div>
          </div>
        </div>
      `;

      return div;
    }

    // Event listeners
    el.openAchievementsBtn?.addEventListener('click', openAchievementsModal);
    el.achievementsCloseBtn?.addEventListener('click', closeAchievementsModal);

    document.querySelectorAll('.achievement-tier-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        const tier = btn.getAttribute('data-tier');
        renderAchievements(tier);
      });
    });

    document.addEventListener('DOMContentLoaded', async ()=>{
      // âœ… StateManager.initializeState()ëŠ” app.jsì—ì„œ ì´ë¯¸ í˜¸ì¶œë¨
      // âœ… ëª¨ë“  ì „ì—­ ë³€ìˆ˜ëŠ” Object.definePropertyë¡œ StateManagerì™€ ìë™ ë™ê¸°í™”ë¨
      // âœ… el ê°ì²´ëŠ” ëª¨ë“ˆ ë¡œë“œ ì‹œì ì— ì´ë¯¸ ì´ˆê¸°í™”ë¨ (line 825)
      // ë³„ë„ ë³µì‚¬ ë¶ˆí•„ìš” - window.questionScores, window.allData ë“±ì„ ì§ì ‘ ì‚¬ìš©

      try{
        await loadData();
        // âœ… loadData()ê°€ StateManagerì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³ , window ì „ì—­ ë³€ìˆ˜ë¡œ ë…¸ì¶œë¨
        // Object.definePropertyë¡œ ìë™ ë™ê¸°í™”ë˜ë¯€ë¡œ ë³„ë„ í• ë‹¹ ë¶ˆí•„ìš”
        console.log('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', window.allData?.length || 0, 'ë¬¸ì œ');
      }catch(err){ console.error(err); $('question-text').textContent='ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (questions.json ë˜ëŠ” dataset-json í™•ì¸).'; showToast(`ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}`,'error'); }

      loadSettings(); // UI ë™ê¸°í™”ë§Œ ìˆ˜í–‰
      initStatsDate();
      updateDDayDisplay();
      applyDarkMode();
      migrateData();

      // ìƒí˜¸ë°°íƒ€ ì •í•©ì„± 1ì°¨ ë³´ì •
      enforceExclusiveFlagsOnAll();
      backfillReadStoreFromScores(false);
      ensureApiKeyGate();
      buildSourceFilterUI(); moveSourceFilterToSide();

      // í€´ì¦ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ëª¨ë“ˆ ë¡œë“œ ì‹œì ì— ì´ë¯¸ ë“±ë¡ë¨ (line 1232-1235)
      el.explorerSearch?.addEventListener('input', renderExplorer);
      refreshPanels();

      // Initialize achievement system
      loadAchievements();
      checkAchievements();
      updateAchievementBadge();
    });
  </script>

</body>
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TC8G7NJD"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
</html>






