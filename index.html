

<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-20Q61B31CM"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-20Q61B31CM');
</script>
  <!-- Google Tag Manager -->
<script>(function (w, d, s, l, i) {
    w[l] = w[l] || []; w[l].push({
        'gtm.start':
        new Date().getTime(), event: 'gtm.js'
    }); var f = d.getElementsByTagName(s)[0],
    j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
})(window, document, 'script', 'dataLayer', 'GTM-TC8G7NJD');</script>
<!-- End Google Tag Manager -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="same-origin" />
  <title>ê°ë¦°ì´ - íšŒê³„ê°ì‚¬ í•™ìŠµ ë„ìš°ë¯¸ v3.3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .summary-btn{ width:38px;height:38px;font-size:.8rem;line-height:1;display:flex;align-items:center;justify-content:center;padding:0 2px;transition:.2s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis }
    .summary-btn:hover{ transform:scale(1.1) }
    pre{ white-space:pre-wrap; word-wrap:break-word }
    #toast{ position:fixed; top:16px; right:16px; z-index:9999 }
    .no-kr-break{ word-break:keep-all }

    .dark{ background-color:#1a202c; color:#e2e8f0 }
    .dark .bg-white{ background-color:#2d3748 }
    .dark .bg-gray-100{ background-color:#1a202c }
    .dark .bg-gray-50{ background-color:#2d3748 }
    .dark .text-gray-800{ color:#e2e8f0 }
    .dark .text-gray-700{ color:#cbd5e0 }
    .dark .text-gray-600{ color:#a0aec0 }
    .dark .border-gray-200{ border-color:#4a5568 }
    .dark .border-gray-300{ border-color:#4a5568 }
  </style>

  <style id="dark-a11y-20251026">
    html.dark { color-scheme: dark; }
    html.dark input, html.dark textarea, html.dark select { background-color:#1f2937; color:#e5e7eb; border-color:#4b5563 }
    html.dark ::placeholder { color:#9ca3af }
    html.dark :is(button,a,input,textarea,select):focus-visible { outline:2px solid #60a5fa; outline-offset:2px }
    html.dark .progress-track{ background-color:#374151 }
    html.dark #result-box{ background-color:#1f2937; border-color:#374151 }
    html.dark #quiz-area .bg-gray-50{ background-color:#111827 }
    html.dark #quiz-area .border-gray-200{ border-color:#374151 }
    html.dark #hint-container{ background-color:#1e3a8a; border-color:#334155; color:#e0e7ff }
    html.dark #summary-area .border{ border-color:#374151 }
    html.dark #summary-area .bg-gray-50{ background-color:#111827 }
    html.dark .summary-btn.bg-gray-100{ background-color:#111827; color:#d1d5db; border-color:#374151 }
    html.dark .summary-btn.bg-red-100{ background-color:#7f1d1d; color:#fecaca; border-color:#991b1b }
    html.dark .summary-btn.bg-yellow-100{ background-color:#78350f; color:#fde68a; border-color:#92400e }
    html.dark .summary-btn.bg-green-100{ background-color:#14532d; color:#bbf7d0; border-color:#166534 }
  </style>

  <style id="focus-mode-css">
    html.focus-mode { scroll-behavior: smooth; }
    html.focus-mode #result-box { max-height:none!important; overflow:visible!important; }
  </style>

  <style id="layout-css">
    .heatmap-cell{ width:14px; height:14px; border-radius:3px }
    .drawer-open{ overflow:hidden }
    .cal-cell { height: 32px; border-radius: 6px; position: relative; display: grid; place-items: center; font-size: 12px; border: 1px solid rgba(0,0,0,0.06); }
    .cal-cell .cal-day { position: absolute; top: 4px; right: 6px; font-size: 10px; opacity: 0.85; font-weight: 600; }
    .cal-cell.muted { opacity: 0.35; }
  </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
  <div id="toast" class="hidden"></div>

  <!-- ìƒë‹¨ ë„¤ë¹„ -->
  <header id="fixed-header" class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur border-b border-gray-200 dark:bg-gray-900/80 dark:border-gray-800">
    <div class="mx-auto max-w-[1400px] 2xl:max-w-[1600px] px-4 lg:px-6 xl:px-8 py-2 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-xl font-extrabold tracking-tight text-blue-700 dark:text-blue-400">ê°ë¦°ì´</span>
        <span class="hidden sm:inline text-xs text-gray-500 dark:text-gray-400">íšŒê³„ê°ì‚¬ ì•”ê¸° ë„ìš°ë¯¸ v3.3</span>
      </div>
      <nav class="flex items-center gap-2">
        <a id="help-button" href="README.html" target="_blank" class="hidden sm:inline text-sm text-gray-700 hover:text-blue-700 dark:text-gray-300 dark:hover:text-white">ë„ì›€ë§</a>
        <button id="settings-btn" class="ml-1 inline-flex items-center gap-1 rounded-lg px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-haspopup="dialog">
          <span>ì„¤ì •</span><span aria-hidden>âš™ï¸</span>
        </button>
        <button id="hamburger" class="lg:hidden inline-flex items-center justify-center w-9 h-9 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600" aria-label="ë©”ë‰´">â‰¡</button>
      </nav>
    </div>
  </header>
  <div class="h-14"></div>

  <div id="drawer-backdrop" class="fixed inset-0 bg-black/40 hidden z-[1099]"></div>

  <div id="layout-root" class="pt-2 flex-1 px-4 lg:px-6 xl:px-8">
    <div class="mx-auto max-w-[1400px] 2xl:max-w-[1600px] grid grid-cols-1 lg:grid-cols-12 gap-4 xl:gap-6 2xl:gap-8">
      <!-- LEFT -->
      <aside id="left-dashboard" class="lg:col-span-3 xl:col-span-3 2xl:col-span-3 space-y-4">
        <button id="drawer-close" class="hidden lg:hidden absolute top-2 right-2 z-[1101] inline-flex items-center justify-center w-9 h-9 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700" aria-label="ë‹«ê¸°">âœ•</button>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-lg">í•™ìŠµ ìº˜ë¦°ë”</h3>
            <div class="flex items-center gap-2">
              <button id="cal-prev" class="w-8 h-8 grid place-items-center rounded-md border hover:bg-gray-50" aria-label="ì´ì „ ë‹¬">â—€</button>
              <div id="cal-title" class="min-w-[96px] text-sm font-semibold text-center">YYYY.MM</div>
              <button id="cal-next" class="w-8 h-8 grid place-items-center rounded-md border hover:bg-gray-50" aria-label="ë‹¤ìŒ ë‹¬">â–¶</button>
            </div>
          </div>
          <div id="calendar-weekdays" class="grid grid-cols-7 text-center text-xs text-gray-500 mb-1">
            <div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div><div>ì¼</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
          <div class="mt-2 text-[11px] text-gray-500">ìƒ‰ = í•´ë‹¹ì¼ í’€ì´ëŸ‰ (ë…¸ë‘â†’ì´ˆë¡â†’íŒŒë‘)</div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">ì˜¤ëŠ˜ì˜ í†µê³„</h3>
          <div id="stats-overview" class="text-sm space-y-1"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">ì˜¤ëŠ˜ì˜ ë³µìŠµ</h3>
          <label class="text-sm block mb-2">ìš°ì„ ìˆœìœ„</label>
          <select id="review-strategy-select" class="w-full p-2 border rounded">
            <option value="smart">ì§€ëŠ¥í˜• ì¶”ì²œ (ê¸°ë³¸)</option>
            <option value="hlr">HLR ê¸°ë°˜ (íšŒìƒ í™•ë¥ )</option>
            <option value="low">ì ìˆ˜ ë‚®ì€ ìˆœ</option>
            <option value="recentWrong">ìµœê·¼ í‹€ë¦° ìˆœ</option>
            <option value="flag">ì‚¬ìš©ì ì§€ì • ë³µìŠµ ëª©ë¡</option>
          </select>
          <button id="start-review-btn" class="mt-3 w-full bg-blue-600 text-white py-2 rounded-lg">ì˜¤ëŠ˜ì˜ ë³µìŠµ ì‹œì‘</button>
        </div>
      </aside>

      <!-- CENTER -->
      <main id="center-core" class="lg:col-span-6 xl:col-span-6 2xl:col-span-6">
        <div class="bg-white rounded-2xl shadow-xl w-full p-6 md:p-8">
          <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
            <div class="flex-1 w-full">
              <label for="chapter-select" class="block text-sm font-medium text-gray-700 mb-1">ë‹¨ì› ì„ íƒ</label>
              <select id="chapter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">
                <option value="">-- ì „ì²´ ë‹¨ì› --</option>
              </select>
            </div>
            <div class="flex-1 w-full">
              <label for="filter-select" class="block text-sm font-medium text-gray-700 mb-1">ë¬¸ì œ í•„í„°</label>
              <select id="filter-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-700 dark:text-gray-100 dark:border-gray-700">
                <option value="all">ëª¨ë“  ë¬¸ì œ í’€ê¸°</option>
                <option value="unanswered">ì•„ì§ ì•ˆ í‘¼ ë¬¸ì œ</option>
                <option value="today-review">ì˜¤ëŠ˜ì˜ ë³µìŠµ (ì¶”ì²œ)</option>
                <option value="80">80ì  ë¯¸ë§Œ ë¬¸ì œ</option>
                <option value="60">60ì  ë¯¸ë§Œ ë¬¸ì œ</option>
              </select>
            </div>
            <div class="w-full md:w-auto md:self-end flex gap-2">
              <button id="load-quiz-btn" class="flex-1 bg-blue-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">í•™ìŠµ ì‹œì‘</button>
              <button id="random-quiz-btn" class="flex-1 bg-purple-600 text-white font-bold p-3 rounded-lg shadow-md hover:bg-purple-700 transition duration-200">ëœë¤ ë¬¸ì œ</button>
            </div>
          </div>

          <div id="source-group-filter" class="mb-6"></div>

          <!-- ë¬¸ì œ ì˜ì—­ -->
          <div id="quiz-area" class="hidden">
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-4">
              <div class="flex justify-between items-center mb-2">
                <h2 id="question-number" class="text-xl font-bold text-blue-700 bg-blue-100 px-3 py-1 rounded-md">ë¬¸í•­</h2>
                <span id="question-counter" class="text-gray-500 font-medium">0 / 0</span>
              </div>
              <div id="db-question-id" class="text-xs text-gray-500 hidden">ID: -</div>

              <p id="question-text" class="text-gray-800 text-base md:text-lg leading-relaxed mt-2">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>

              <!-- íŒíŠ¸/ë³µìŠµ ë²„íŠ¼ ì˜ì—­ -->
              <div class="mt-3 flex items-center justify-between gap-2">
                <button id="hint-btn" class="text-sm bg-purple-600 text-white px-3 py-1.5 rounded-md shadow hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">íŒíŠ¸</button>

                <div class="flex items-center gap-2">
                  <!-- ë³µìŠµì¶”ê°€(â˜…) -->
                  <button id="review-flag-toggle" class="text-sm px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-100 flex items-center gap-1" aria-pressed="false" title="ë³µìŠµ í•„ìš” í† ê¸€">
                    <span class="text-yellow-500">â˜†</span><span>ë³µìŠµ ì¶”ê°€</span>
                  </button>

                  <!-- ë³µìŠµ ì œì™¸(â–) -->
                  <button id="review-exclude-toggle" class="text-sm px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-100 flex items-center gap-1" aria-pressed="false" title="ì˜¤ëŠ˜ì˜ ë³µìŠµì—ì„œ ì œì™¸/í•´ì œ">
                    <span class="text-gray-600">â–</span><span>ë³µìŠµ ì œì™¸</span>
                  </button>
                </div>
              </div>

              <div id="hint-container" class="hidden mt-3 text-sm bg-purple-50 border border-purple-200 text-purple-800 rounded-lg p-3 dark:bg-indigo-900 dark:border-indigo-700 dark:text-indigo-100"></div>
            </div>

            <div class="flex items-center justify-between mb-2">
              <label for="user-answer" class="text-sm font-medium text-gray-700">ë‹µì•ˆ ì…ë ¥</label>
              <button id="load-prev-answer-btn" class="text-xs text-blue-600 hover:underline">ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
            <textarea id="user-answer" class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition dark:bg-gray-800 dark:text-gray-100 dark:placeholder-gray-400 dark:border-gray-700" rows="8" placeholder="ì—¬ê¸°ì— ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”... (Enter=ì±„ì , Shift+Enter=ì¤„ë°”ê¿ˆ, Ctrl+[=ì´ì „ìœ„ì¹˜, Ctrl+]=í¬ì»¤ìŠ¤/í˜„í™©íŒ)"></textarea>
            <p id="error-message" class="text-red-500 text-sm mt-2 hidden">ë‹µì•ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <p id="hotkey-guide" class="text-xs text-gray-500 mt-2">
              ë‹¨ì¶•í‚¤: Ctrl+â†/â†’ ì´ì „/ë‹¤ìŒ Â· Enter ì±„ì  Â· Shift+Enter ì¤„ë°”ê¿ˆ Â· H íŒíŠ¸ Â· Ctrl+[ ì´ì „ Â· Ctrl+] í¬ì»¤ìŠ¤/í˜„í™©íŒ
            </p>

            <div class="flex justify-between items-center my-5">
              <button id="prev-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">ì´ì „</button>
              <button id="grade-btn" class="bg-green-500 text-white font-bold py-2 px-8 rounded-lg shadow-md hover:bg-green-600 transition duration-200 relative min-w-[120px]">
                <span id="grade-btn-text">ì±„ì í•˜ê¸°</span>
                <div id="grade-loader" class="loader absolute inset-0 m-auto hidden" aria-hidden="true"></div>
              </button>
              <button id="next-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">ë‹¤ìŒ</button>
            </div>
          </div>

          <!-- ê²°ê³¼ -->
          <div id="result-box" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-6 mt-6 dark:bg-gray-800 dark:border-gray-700" aria-live="polite">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ì±„ì  ê²°ê³¼</h3>
            <div id="score-display" class="mb-5">
              <p class="text-lg font-medium text-gray-700">
                ìœ ì‚¬ë„ ì ìˆ˜: <span id="score" class="font-bold text-blue-600 text-2xl">0</span><span class="text-gray-600 text-lg">ì </span>
              </p>
              <div class="w-full bg-gray-200 progress-track rounded-full h-4 mt-2 overflow-hidden shadow-inner">
                <div id="progress-bar" class="h-4 rounded-full transition-all duration-500 ease-out" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="width: 0%"></div>
              </div>
            </div>
            <div class="mb-5">
              <h4 class="text-xl font-semibold text-gray-700 mb-2">ğŸ¤– AI ì´í‰</h4>
              <div id="ai-feedback" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 leading-relaxed min-h-[50px]"></div>
            </div>
            <div>
              <h4 class="text-xl font-semibold text-gray-700 mb-2">ğŸ“˜ ëª¨ë²” ë‹µì•ˆ</h4>
              <pre id="correct-answer" class="bg-white p-4 border border-gray-200 rounded-lg text-gray-600 text-sm font-sans leading-relaxed"></pre>
            </div>
          </div>

          <!-- í•™ìŠµ í˜„í™©íŒ -->
          <div id="summary-area" class="mt-8 pt-6 border-t hidden">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-3">
              <h3 class="text-xl font-bold text-gray-800">í•™ìŠµ í˜„í™©íŒ (í´ë¦­í•˜ì—¬ ì´ë™)</h3>
              <div class="flex flex-wrap gap-3 items-center">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-gray-600">ë³´ê¸°:</span>
                  <button id="summary-view-all" class="px-3 py-1.5 text-sm border rounded bg-gray-100 hover:bg-gray-200">ëª¨ë“  ë‹¨ì›ë³´ê¸°</button>
                  <button id="summary-view-current" class="px-3 py-1.5 text-sm border rounded">í˜„ì¬ í•™ìŠµë‹¨ì›ë³´ê¸°</button>
                </div>
                <div class="flex gap-4">
                  <button id="clear-filter-btn" class="text-sm text-blue-700 hover:underline dark:text-blue-300">í•„í„° í•´ì œ</button>
                  <button id="reset-scores-btn" class="text-sm text-red-600 hover:underline dark:text-red-300">í•™ìŠµ ê¸°ë¡ ì´ˆê¸°í™”</button>
                </div>
              </div>
            </div>
            <div id="score-summary" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
      </main>

      <!-- RIGHT -->
      <aside id="right-explorer" class="lg:col-span-3 xl:col-span-3 2xl:col-span-3 space-y-4">
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">í•™ìŠµ ë²”ìœ„ í•„í„°</h3>
          <div id="source-filter-side"></div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <h3 class="font-bold text-lg mb-2">ë‹¨ì› ë„¤ë¹„ê²Œì´í„°</h3>
          <div id="explorer-chapters" class="space-y-2"></div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-lg whitespace-nowrap no-kr-break">ë¬¸ì œ ëª©ë¡</h3>
            <input id="explorer-search" class="border rounded px-2 py-1 text-sm" placeholder="ê²€ìƒ‰...">
          </div>
          <div id="explorer-problems" class="space-y-1 max-h-[60vh] overflow-y-auto pr-1"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- API í‚¤ ëª¨ë‹¬ -->
  <div id="api-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1000]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-xl">
      <h2 class="text-xl font-bold text-gray-800">Gemini API í‚¤ ì¸ì¦</h2>
      <p class="text-sm text-gray-600 mt-1">ìµœì´ˆ 1íšŒë§Œ ì…ë ¥í•©ë‹ˆë‹¤. ë¡œì»¬ ì €ì¥ì„ ì²´í¬í•˜ë©´ ë‹¤ìŒë¶€í„°ëŠ” íŒì—…ì´ ëœ¨ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <p class="text-sm mt-2">ì²˜ìŒ ì‚¬ìš©í•˜ì‹œë‚˜ìš”?
        <a href="README.html" target="_blank" rel="noopener" class="underline text-blue-600 dark:text-blue-300">ë„ì›€ë§(README)</a>ë¥¼ í™•ì¸í•˜ì„¸ìš”.
      </p>

      <label for="api-modal-input" class="block text-sm font-medium text-gray-700 mt-4">ğŸ”‘ API Key</label>
      <input type="password" id="api-modal-input"
             class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-gray-100 dark:placeholder-gray-400 dark:border-gray-700"
             placeholder="Google AI Studio API í‚¤" autocomplete="off" spellcheck="false" inputmode="text" />

      <div class="flex items-center gap-2 mt-2">
        <input type="checkbox" id="modal-remember" class="rounded border-gray-300" />
        <label for="modal-remember" class="text-sm text-gray-700">ì´ ë¸Œë¼ìš°ì €ì— í‚¤ ì €ì¥</label>
      </div>
      <p class="text-xs text-yellow-600 mt-1">âš ï¸ ê³µìš© PCì—ì„œëŠ” ì²´í¬ í•´ì œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.</p>

      <div class="mt-5 flex justify-end gap-2">
        <button id="api-cancel-btn" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900">ì·¨ì†Œ</button>
        <button id="api-save-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[1001]">
    <div role="dialog" aria-modal="true" aria-labelledby="settings-title" class="bg-white dark:bg-gray-900 dark:text-gray-100 rounded-2xl w-full max-w-2xl p-6 shadow-xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-2">
        <h2 id="settings-title" class="text-2xl font-bold">ì„¤ì • âš™ï¸</h2>
        <button id="settings-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white" aria-label="ë‹«ê¸°">âœ•</button>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">API í‚¤ ì„¤ì •</h3>
        <button id="open-api-key-modal-btn" class="w-full bg-blue-50 border border-blue-300 text-blue-700 font-medium py-2 px-4 rounded-lg hover:bg-blue-100 transition">API í‚¤ ë³€ê²½/ì„¤ì •</button>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">AI ëª¨ë¸ ì„ íƒ</h3>
        <select id="ai-model-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="gemini-2.5-flash">Gemini 2.5 Flash (ê¸°ë³¸)</option>
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (ê²½ëŸ‰)</option>
        </select>
        <p class="text-xs text-gray-500 mt-2">íŒíŠ¸ ë° ì±„ì ì— ì‚¬ìš©ë  AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”.</p>
      </div>

      <div class="mb-6 pb-6 border-b">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">ë‹¤í¬ ëª¨ë“œ</h3>
        <select id="dark-mode-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
          <option value="system">ì‹œìŠ¤í…œ ì„¤ì • (ê¸°ë³¸)</option>
          <option value="light">ë¼ì´íŠ¸ ëª¨ë“œ</option>
          <option value="dark">ë‹¤í¬ ëª¨ë“œ</option>
        </select>
      </div>

      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">ë°ì´í„° ê´€ë¦¬</h3>
        <div class="flex gap-3 mb-2">
          <button id="export-data-btn" class="flex-1 bg-green-50 border border-green-300 text-green-700 font-medium py-2 px-4 rounded-lg hover:bg-green-100 transition">ğŸ“¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
          <button id="import-data-btn" class="flex-1 bg-yellow-50 border border-yellow-300 text-yellow-700 font-medium py-2 px-4 rounded-lg hover:bg-yellow-100 transition">ğŸ“¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
        </div>
        <div class="flex gap-3">
          <button id="merge-data-btn" class="flex-1 bg-blue-50 border border-blue-300 text-blue-700 font-medium py-2 px-4 rounded-lg hover:bg-blue-100 transition">ğŸ”€ ë°ì´í„° ë³‘í•© ê°€ì ¸ì˜¤ê¸°</button>
        </div>
        <input type="file" id="import-file-input" accept=".json" class="hidden" />
        <input type="file" id="merge-file-input" accept=".json" class="hidden" />
        <p class="text-xs text-gray-500 mt-2">í•™ìŠµ ê¸°ë¡ ë° ì„¤ì •ì„ ë°±ì—…í•˜ê±°ë‚˜ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³‘í•© ê°€ì ¸ì˜¤ê¸°ëŠ” ê¸°ì¡´ ë°ì´í„°ì™€ ìƒˆ ë°ì´í„°ë¥¼ í•©ì¹©ë‹ˆë‹¤.</p>
      </div>

      <div class="flex justify-end">
        <button id="settings-close-btn-bottom" class="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 border dark:border-gray-600">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë‚´ì¥ ë°ì´í„°(JSON) -->
  <script id="dataset-json" type="application/json">[
    {"ê³ ìœ ID":"q_001","í‘œì‹œë²ˆí˜¸":"1","ì¶œì²˜":"S","problemTitle":"íšŒê³„ê°ì‚¬ì˜ ê³ ìœ í•œê³„ ì›ì¸ ì„¸ ê°€ì§€","ë‹¨ì›":1,"ë¬¼ìŒë²ˆí˜¸":1,"ë¬¼ìŒ":"íšŒê³„ê°ì‚¬ì—ëŠ” ê³ ìœ í•œê³„ê°€ ì¡´ì¬í•œë‹¤. ê·¸ ì›ì¸ì„ ì„¸ ê°€ì§€ ì“°ì‹œì˜¤.","ì •ë‹µ":"ISA 200-A47 â‘  ì¬ë¬´ë³´ê³ ì˜ ì„±ê²© â‘¡ ê°ì‚¬ì ˆì°¨ì˜ ì„±ê²© â‘¢ í•©ë¦¬ì  ì‹œê°„Â·ë¹„ìš© ì œì•½"},
    {"ê³ ìœ ID":"q_002","í‘œì‹œë²ˆí˜¸":"2","ì¶œì²˜":"H","problemTitle":"ì ì‹œì„±ê³¼ ë¹„ìš©-íš¨ìµ ê³ ë ¤ ì‹œ ì±„íƒí•˜ëŠ” ì ˆì°¨","ë‹¨ì›":1,"ë¬¼ìŒë²ˆí˜¸":2,"ë¬¼ìŒ":"ê°ì‚¬ì¸ì€ ì ì‹œì„±ê³¼ ë¹„ìš©-íš¨ìµ ê· í˜•ì„ ê³ ë ¤í•œë‹¤. ì´ì— ë”°ë¼ ì±„íƒí•˜ëŠ” ì ˆì°¨ ì„¸ ê°€ì§€ëŠ”?","ì •ë‹µ":"ISA 200-A51 â‘  íš¨ê³¼ì  ê³„íš â‘¡ ìœ„í—˜ ë†’ì€ ë¶„ì•¼ ì§‘ì¤‘ â‘¢ í…ŒìŠ¤íŠ¸ ë“± í‘œë³¸ ì‚¬ìš©"},
    {"ê³ ìœ ID":"q_003","í‘œì‹œë²ˆí˜¸":"3","ì¶œì²˜":"SS","problemTitle":"ìƒ˜í”Œ ë¬¸ì œ","ë‹¨ì›":1,"ë¬¼ìŒë²ˆí˜¸":3,"ë¬¼ìŒ":"â€¦","ì •ë‹µ":"â€¦"}
  ]</script>

  <script type="module">
    const BASE_SYSTEM_PROMPT =
`ë‹¹ì‹ ì€ ë§¤ìš° ì—„ê²©í•œ íšŒê³„ê°ì‚¬ ê³¼ëª© ì±„ì  êµìˆ˜ë‹˜ì…ë‹ˆë‹¤.
- ì‚¬ìš©ì ë‹µì•ˆì„ ëª¨ë²”ë‹µì•ˆê³¼ ë¹„êµí•´ 0~100ì˜ "score"(NUMBER)ì™€ "feedback"(STRING, í•œêµ­ì–´)ì„ JSONìœ¼ë¡œë§Œ ë°˜í™˜í•˜ì„¸ìš”.
- ì±„ì  ê¸°ì¤€ì„ ë§¤ìš° ì—„ê²©í•˜ê²Œ(strictly) ì ìš©í•©ë‹ˆë‹¤.
- ëŒ€ì‹  ë„ì–´ì“°ê¸°ë‚˜ ë§ì¶¤ë²• ì‹¤ìˆ˜ ê°™ì€ ë‹¨ìˆœí•œ íƒ€ì´í•‘ì‹¤ìˆ˜ëŠ” ë´ì¤ë‹ˆë‹¤. ë˜í•œ ì¤‘ìš”ì™œê³¡í‘œì‹œìœ„í—˜ì„ RMMìœ¼ë¡œ, ì„±ê²©Â·ì‹œê¸°Â·ë²”ìœ„ë¥¼ ì„±ì‹œë²”ìœ¼ë¡œ, ê³µì¸íšŒê³„ì‚¬ë¥¼ CPAë¡œ ì¤„ì—¬ì“°ëŠ” ì •ë„ì˜ ìˆ˜í—˜ìƒ í•©ì˜ëœ ì–¸ì–´ëŠ” ë´ì¤ë‹ˆë‹¤.

[ì±„ì  ê¸°ì¤€]
1. ëª¨ë²” ë‹µì•ˆì˜ í•µì‹¬ í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€
2. í•µì‹¬ í‚¤ì›Œë“œ ëŒ€ë¶€ë¶„ ëˆ„ë½: 50ì  ë¯¸ë§Œ
3. ì¼ë¶€ í¬í•¨ì´ë‚˜ ì„¤ëª… ë¶€ì •í™•: 50~80ì 
4. ëª¨ë“  í•µì‹¬ í‚¤ì›Œë“œ + ì˜ë„ ì¼ì¹˜: 80ì  ì´ìƒ
5. ì¡°ì‚¬ê¹Œì§€ ë™ì¼í•  ë•Œë§Œ 100ì 
6. í‚¤ì›Œë“œëŠ” ëª¨ë²”ë‹µì•ˆì—ì„œ ìŠ¤ìŠ¤ë¡œ ì¶”ì¶œí•˜ë˜, í•œêµ­ íšŒê³„ê°ì‚¬ ê¸°ì¤€Â·ê·œì •(ISA, KSA, ì™¸ë¶€ê°ì‚¬ë²•, ìœ¤ë¦¬ê¸°ì¤€)ì— ë§ëŠ” ë™ì˜ì–´Â·í‘œí˜„ ë³€í˜•ì„ í—ˆìš©
7. ë¬¼ìŒì—ì„œì˜ ë¬¼ìŒ ë¶€ë¶„ì´ êµ³ì´ ë‹µë³€ì— í¬í•¨ë˜ì§€ ì•Šì•„ë„ ë¨(ë¬¼ìŒì˜ ë‚´ìš©ì´ ëª¨ë²”ë‹µì•ˆì— ì¬ì§„ìˆ ë˜ì–´ìˆë‹¤ê³ í•´ì„œ êµ³ì´ ì‚¬ìš©ì ë‹µì•ˆì— í•´ë‹¹ ë‚´ìš©ì´ í¬í•¨ë˜ì§€ ì•Šì•„ë„ë¨)

- ë¶ˆí•„ìš”í•œ ë§/ì½”ë“œë¸”ë¡ ê¸ˆì§€. JSON ê°ì²´ë§Œ ë°˜í™˜.`;

    const LITE_STRICT_ADDENDUM =
`[ì—„ê²© ëª¨ë“œ ì§€ì¹¨(ë¼ì´íŠ¸ ì „ìš©)]
- ëª¨í˜¸/ì¶”ì •/í™•ì¥ ì„œìˆ ì€ ê°ì .
- ì ìˆ˜ ì§œê²Œì¤€ë‹¤.
- í•„ìˆ˜ í‚¤ì›Œë“œê°€ ë¬¸ì¥ ë‚´ ëª…ì‹œì ìœ¼ë¡œ ì—†ìœ¼ë©´ í° ê°ì .
- ë ˆí¼ëŸ°ìŠ¤ ë°– ì£¼ì¥ì€ ê·¼ê±° ì—†ìœ¼ë©´ ê°ì .
- ë„ì¶œí•œ ì ìˆ˜ë³´ë‹¤ 7ì  ê¹ì•„ì„œ ì œì‹œí•  ê²ƒ`;

    let allData=[], currentQuizData=[], currentQuestionIndex=0, questionScores={};
    let geminiApiKey='', activeHintQuestionKey=null, selectedAiModel='gemini-2.5-flash', darkMode='system';
    let prevLoaded=false, summaryViewMode='ALL', statsView=localStorage.getItem('statsView_v1')||'day';
    let ctrlNavState='dashboard', lastScrollYBeforeFocus=0;

    let calRefDate = (() => { const d = new Date(); d.setHours(0,0,0,0); d.setDate(1); return d; })();
let statsRefDate = new Date();
statsRefDate.setHours(0,0,0,0);

// â†“ ì•„ë˜ ì½”ë“œ ì¶”ê°€
const STATS_DATE_KEY = 'statsDisplayDate_v1';

function initStatsDate() {
  const saved = localStorage.getItem(STATS_DATE_KEY);
  if (saved) {
    const d = new Date(saved + 'T00:00:00');
    if (!isNaN(d.getTime())) {
      statsRefDate = d;
      return;
    }
  }
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  statsRefDate = now;
}

function saveStatsDate() {
  const y = statsRefDate.getFullYear();
  const m = String(statsRefDate.getMonth() + 1).padStart(2, '0');
  const d = String(statsRefDate.getDate()).padStart(2, '0');
  localStorage.setItem(STATS_DATE_KEY, `${y}-${m}-${d}`);
}
 

    const $ = id=>document.getElementById(id);
    const el = {
      toast: $('toast'), apiModal:$('api-modal'), apiModalInput:$('api-modal-input'), apiModalRemember:$('modal-remember'),
      apiModalSaveBtn:$('api-save-btn'), apiModalCancelBtn:$('api-cancel-btn'),
      settingsBtn:$('settings-btn'), settingsModal:$('settings-modal'),
      settingsCloseBtn:$('settings-close-btn'), settingsCloseBtnBottom:$('settings-close-btn-bottom'),
      openApiKeyModalBtn:$('open-api-key-modal-btn'), aiModelSelect:$('ai-model-select'), darkModeSelect:$('dark-mode-select'),
      exportDataBtn:$('export-data-btn'), importDataBtn:$('import-data-btn'), importFileInput:$('import-file-input'),
      mergeDataBtn:$('merge-data-btn'), mergeFileInput:$('merge-file-input'),
      chapterSelect:$('chapter-select'), filterSelect:$('filter-select'), loadQuizBtn:$('load-quiz-btn'), randomQuizBtn:$('random-quiz-btn'),
      quizArea:$('quiz-area'), questionNumber:$('question-number'), questionText:$('question-text'), questionCounter:$('question-counter'),
      userAnswer:$('user-answer'), errorMessage:$('error-message'), prevBtn:$('prev-btn'), nextBtn:$('next-btn'),
      gradeBtn:$('grade-btn'), gradeBtnText:$('grade-btn-text'), gradeLoader:$('grade-loader'), hintBtn:$('hint-btn'), hintBox:$('hint-container'),
      loadPrevAnswerBtn:$('load-prev-answer-btn'), resultBox:$('result-box'), score:$('score'), progressBar:$('progress-bar'),
      aiFeedback:$('ai-feedback'), correctAnswer:$('correct-answer'), summaryArea:$('summary-area'), scoreSummary:$('score-summary'),
      clearFilterBtn:$('clear-filter-btn'), resetScoresBtn:$('reset-scores-btn'), summaryViewAllBtn:$('summary-view-all'), summaryViewCurrentBtn:$('summary-view-current'),
      dbQuestionId:$('db-question-id'), fixedHeader:$('fixed-header'), layoutRoot:$('layout-root'),
      statsOverview:$('stats-overview'),
      reviewStrategySelect:$('review-strategy-select'), startReviewBtn:$('start-review-btn'),
      sourceFilterSide:$('source-filter-side'), sourceGroupFilter:$('source-group-filter'),
      explorerChapters:$('explorer-chapters'), explorerProblems:$('explorer-problems'), explorerSearch:$('explorer-search'),
      reviewFlagToggle:$('review-flag-toggle'), reviewExcludeToggle:$('review-exclude-toggle'),
      hamburger:$('hamburger'), leftDashboard:$('left-dashboard'), drawerBackdrop:$('drawer-backdrop'), drawerClose:$('drawer-close'),
      calPrev:$('cal-prev'), calNext:$('cal-next'), calTitle:$('cal-title'), calendarGrid:$('calendar-grid')
    };

    const clamp=(v,min,max)=>Math.max(min,Math.min(max,Number(v)||0));
    const normId=v=>String(v).trim();
    const sanitizeModelText=t=>{ let s=(t||'').trim(); if(s.startsWith('```')) s=s.replace(/^```[\s\S]*?\n/,'').replace(/```$/,'').trim(); s=s.replace(/^\uFEFF/,''); const a=s.indexOf('{'), b=s.lastIndexOf('}'); if(a!==-1&&b!==-1&&b>a) s=s.slice(a,b+1); return s; };
    const showToast=(msg,type='info')=>{
      const base='px-4 py-2 rounded shadow text-sm mb-2';
      const color= type==='error'?'bg-red-600 text-white': type==='warn'?'bg-yellow-500 text-white':'bg-gray-900 text-white';
      el.toast.classList.remove('hidden');
      const item=document.createElement('div'); item.className=`${base} ${color}`; item.textContent=msg; el.toast.appendChild(item);
      setTimeout(()=>{ item.remove(); if(!el.toast.hasChildNodes()) el.toast.classList.add('hidden'); }, 2500);
    };
    const getHeaderOffset=()=>el.fixedHeader?.getBoundingClientRect().height||0;
    const smoothScrollTo=y=>window.scrollTo({top:y,behavior:'smooth'});
    const elmTop=e=>e.getBoundingClientRect().top + window.pageYOffset;

    function hslToHex(h, s, l) { s/=100; l/=100; const k=n=>(n+h/30)%12; const a=s*Math.min(l,1-l); const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1))); const toHex=x=>Math.round(x*255).toString(16).padStart(2,'0'); return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`; }
    function colorForCount(c) {
      if (!Number.isFinite(c) || c <= 0) return { bg: '#e5e7eb', fg: '#111827' };
      const fgForL = (l) => (l < 55 ? '#ffffff' : '#111827');
      if (c >= 1 && c <= 6) { const steps=6, idx=c-1, h=50, s=95, lStart=92, lEnd=55; const l=lStart+(lEnd-lStart)*(idx/(steps-1)); return { bg:hslToHex(h,s,l), fg:fgForL(l) }; }
      if (c >= 7 && c <= 15){ const steps=9, idx=c-7, h=140, s=85, lStart=92, lEnd=45; const l=lStart+(lEnd-lStart)*(idx/(steps-1)); return { bg:hslToHex(h,s,l), fg:fgForL(l) }; }
      if (c >= 16 && c <= 30){ const steps=15, idx=c-16, h=210, s=85, lStart=92, lEnd=40; const l=lStart+(lEnd-lStart)*(idx/(steps-1)); return { bg:hslToHex(h,s,l), fg:fgForL(l) }; }
      return { bg: '#1e40af', fg: '#ffffff' };
    }
    const ymd=(d)=>{ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; };
    const dowMon0=d=> (d.getDay()+6)%7;

    const CHAPTER_LABELS={ 1:"ì œ1ì¥ ê°ì‚¬ì™€ íšŒê³„ê°ì‚¬ì˜ ê¸°ë³¸ê°œë…", 2:"ì œ2ì¥ ê°ì‚¬ì¸ì˜ ì˜ë¬´, ì±…ì„ ë° ìê²©ìš”ê±´", 3:"ì œ3ì¥ ê°ì‚¬ì¸ì˜ ë…ë¦½ì„±ê³¼ í’ˆì§ˆê´€ë¦¬", 4:"ì œ1ì¥ ê°ì‚¬ì¸ì˜ ì„ ì„", 5:"ì œ2ì¥ ê°ì‚¬ê³„ì•½", 6:"ì œ1ì¥ íšŒê³„ê°ì‚¬ìˆ˜í–‰ì„ ìœ„í•œ ê¸°ì´ˆì§€ì‹", 7:"ì œ2ì¥ ìœ„í—˜í‰ê°€ì ˆì°¨ì™€ ê³„íšìˆ˜ë¦½", 8:"ì œ1ì¥ í†µì œí…ŒìŠ¤íŠ¸ì™€ ìœ„í—˜í‰ê°€ì˜ í™•ì •", 9:"ì œ1-2ì¥ ë°ì´í„°ë¶„ì„", 10:"ì œ2ì¥ ì‹¤ì¦ì ˆì°¨ì˜ ê¸°ì´ˆ", 11:"ì œ3ì¥ ê¸°ì´ˆì”ì•¡ê³¼ ê±°ë˜ìœ í˜•ë³„ ì‹¤ì¦ì ˆì°¨", 12:"ì œ4ì¥ íŠ¹ì •í•­ëª©ë³„ ê°ì‚¬ì ˆì°¨", 13:"ì œ5ì¥ í…ŒìŠ¤íŠ¸í•­ëª©ì˜ ë²”ìœ„ì™€ í‘œë³¸ê°ì‚¬ ë°ì´í„°ë¶„ì„", 14:"ì œ6ì¥ ì‹¤ì¦ì ˆì°¨ì˜ ë§ˆë¬´ë¦¬ì ˆì°¨", 15:"ì œ1ì¥ ë¯¸ìˆ˜ì •ì™œê³¡í‘œì‹œì˜ í‰ê°€ì™€ ê°ì‚¬ì˜ê²¬ì˜ í˜•ì„±", 16:"ì œ2ì¥ ê°ì‚¬ë³´ê³ ì„œì˜ ì‘ì„±ê³¼ ë³´ê³ ", 17:"ì œ1ì¥ ì¸ì¦ì—…ë¬´ê°œë…ì²´ê³„ì™€ íŠ¹ì •ëª©ì ì¬ë¬´ë³´ê³ ì²´ê³„, ì œ2ì¥ ê·¸ë£¹ì¬ë¬´ì œí‘œì— ëŒ€í•œ ê°ì‚¬", 18:"ì œ3ì¥ ë‚´ë¶€íšŒê³„ê´€ë¦¬ì œë„ì— ëŒ€í•œ ê°ì‚¬ì™€ ê²€í† ", 19:"ì œ4ì¥ ì¤‘ê°„ì¬ë¬´ì œí‘œì— ëŒ€í•œ ê²€í† ", 20:"ì œ5ì¥ ì†Œê·œëª¨ê¸°ì—… ì¬ë¬´ì œí‘œì— ëŒ€í•œ ê°ì‚¬" };
    const PART_INSERTIONS=[ {before:1,label:"Part 1. íšŒê³„ê°ì‚¬ì˜ ê¸°ì´ˆ"}, {before:4,label:"Part 2. ê°ì‚¬ì¸ì˜ ì„ ì„ê³¼ ê°ì‚¬ê³„ì•½"}, {before:6,label:"Part 3. íšŒê³„ê°ì‚¬ì˜ ì‹œì‘ê³¼ ìœ„í—˜í‰ê°€ì ˆì°¨"}, {before:8,label:"Part 4. ìœ„í—˜í‰ê°€ì ˆì°¨ì— ëŒ€í•œ ì¶”ê°€ê°ì‚¬ì ˆì°¨"}, {before:15,label:"Part 5. ê°ì‚¬ì˜ê²¬ì˜ í˜•ì„±ê³¼ ê°ì‚¬ë³´ê³ ì„œ"}, {before:17,label:"Part 6. ê·¸ë£¹ì¬ë¬´ì œí‘œì— ëŒ€í•œ ê°ì‚¬ì™€ ê¸°íƒ€ì¸ì¦ì—…ë¬´"} ];
    const chapterLabelText=chStr=>{ const n=Number(chStr), t=CHAPTER_LABELS[n]; return Number.isFinite(n)? (t?`${n}. ${t}`:`ë‹¨ì› ${n}`):String(chStr); };

    const PART_VALUE=(s,e)=>`PART:${s}-${e}`;
    const isPartValue=v=>/^PART:\d+-\d+$/.test(v||'');
    const parsePartValue=v=>{ const m=String(v||'').match(/^PART:(\d+)-(\d+)$/); return m?{start:+m[1], end:+m[2]}:null; };
    const getAllChapterNums=()=>[...new Set(allData.map(i=>+i.ë‹¨ì›).filter(Number.isFinite))].sort((a,b)=>a-b);
    function computePartRanges(chapterNums){
      if(!chapterNums.length) return [];
      const parts=[...PART_INSERTIONS].sort((a,b)=>a.before-b.before);
      const maxCh=Math.max(...chapterNums);
      const ranges=[];
      for(let i=0;i<parts.length;i++){
        const start=parts[i].before;
        const end=(i+1<parts.length)? (parts[i+1].before-1) : maxCh;
        if(chapterNums.some(n=>n>=start && n<=end)) ranges.push({start,end,label:parts[i].label});
      }
      return ranges;
    }

    function applyDarkMode(){
      const mode=localStorage.getItem('darkMode')||'system'; darkMode=mode;
      if(el.darkModeSelect) el.darkModeSelect.value=mode;
      if(mode==='dark') document.documentElement.classList.add('dark');
      else if(mode==='light') document.documentElement.classList.remove('dark');
      else{
        if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      }
    }
    if(window.matchMedia){ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',()=>{ if(darkMode==='system') applyDarkMode(); }); }

    async function loadData(){
      const CAND=['questions.json','./questions.json','./data/questions.json','./assets/questions.json'];
      const errs=[];
      for(const path of CAND){
        try{
          const res=await fetch(path,{cache:'no-store'}); if(!res.ok){ errs.push(`${path}: HTTP ${res.status}`); continue; }
          const arr=await res.json(); if(!Array.isArray(arr)){ errs.push(`${path}: JSON ìµœìƒìœ„ê°€ ë°°ì—´ ì•„ë‹˜`); continue; }
          const need=['ê³ ìœ ID','ë‹¨ì›','ë¬¼ìŒ','ì •ë‹µ']; const bad=arr.findIndex(r=>!r||need.some(k=>!(k in r)));
          if(bad!==-1){ errs.push(`${path}: í•„ìˆ˜í‚¤ ëˆ„ë½(index ${bad})`); continue; }
          allData=arr; console.info('[questions.json] loaded from',path); selfTest(); populateChapterSelect(); updateSummary(); return;
        }catch(e){ errs.push(`${path}: ${e.message}`); }
      }
      try{
        const node=$('dataset-json'); if(!node) throw new Error('dataset-json ì—†ìŒ');
        const text=(node.textContent||'').trim(); if(!text) throw new Error('ë‚´ì¥ ë°ì´í„° ë¹„ì–´ ìˆìŒ');
        const parsed=JSON.parse(text); if(!Array.isArray(parsed)) throw new Error('ë‚´ì¥ ë°ì´í„° ìµœìƒìœ„ê°€ ë°°ì—´ ì•„ë‹˜');
        allData=parsed; console.warn('[questions.json] ëª¨ë“  í›„ë³´ ì‹¤íŒ¨. ë‚´ì¥ ë°ì´í„°ë¡œ í´ë°±',errs); showToast('ì™¸ë¶€ DB ì‹¤íŒ¨ â†’ ë‚´ì¥ ë°ì´í„° ì‚¬ìš©','warn');
        selfTest(); populateChapterSelect(); updateSummary();
      }catch(err){ console.error('ì§ˆë¬¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:',errs,err); showToast('ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ì½˜ì†” í™•ì¸','error'); $('question-text').textContent='ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (questions.json ë˜ëŠ” dataset-json í™•ì¸).'; }
    }
    function selfTest(){
      const miss=[]; allData.forEach((r,i)=>{ if(!(r&&'ê³ ìœ ID'in r && 'ë‹¨ì›'in r && 'ë¬¼ìŒ'in r && 'ì •ë‹µ'in r)) miss.push(i+1); });
      if(miss.length) showToast(`ê²½ê³ : í•„ìˆ˜ í•„ë“œ ëˆ„ë½ ${miss.length}ê°œ`,'warn');
      const seen=new Set(), dup=[]; for(const r of allData){ const k=String(r.ê³ ìœ ID).trim(); if(seen.has(k)) dup.push(k); else seen.add(k); }
      if(dup.length) showToast(`ê²½ê³ : ì¤‘ë³µ ê³ ìœ ID ${dup.length}ê°œ`,'warn');
      if(!new Set(allData.map(r=>String(r.ë‹¨ì›).trim())).size) throw new Error('ë‹¨ì› ë°ì´í„° ì—†ìŒ');
    }

    function populateChapterSelect(){
      while(el.chapterSelect.options.length>1) el.chapterSelect.remove(1);
      const chNums=getAllChapterNums(); const ranges=computePartRanges(chNums);
      for(const r of ranges){
        const opt=document.createElement('option'); opt.value=PART_VALUE(r.start,r.end);
        opt.textContent=`--- ${r.label} (${r.start}~${r.end}ì¥) ---`; opt.className='text-gray-700';
        el.chapterSelect.appendChild(opt);
        chNums.filter(n=>n>=r.start && n<=r.end).forEach(n=>{
          const copt=document.createElement('option'); copt.value=String(n); copt.textContent=chapterLabelText(n);
          el.chapterSelect.appendChild(copt);
        });
      }
    }

    function loadScores(){ try{ questionScores=JSON.parse(localStorage.getItem('auditQuizScores')||'{}'); }catch{ questionScores={}; localStorage.removeItem('auditQuizScores'); } }
    function loadApiKey(){ geminiApiKey=sessionStorage.getItem('geminiApiKey')||localStorage.getItem('geminiApiKey')||''; }
    function loadSettings(){ selectedAiModel=localStorage.getItem('aiModel')||'gemini-2.5-flash'; if(el.aiModelSelect) el.aiModelSelect.value=selectedAiModel; }

    function migrateData(){
      const version=localStorage.getItem('schemaVersion'); if(version==='2') return;
      try{
        const old=localStorage.getItem('auditQuizScores'); if(!old){ localStorage.setItem('schemaVersion','2'); return; }
        const parsed=JSON.parse(old), newScores={}, map={};
        allData.forEach(q=>{ const disp=String(q.í‘œì‹œë²ˆí˜¸??'').trim(), num=String(q.ë¬¼ìŒë²ˆí˜¸??'').trim(); if(disp) map[disp]=q.ê³ ìœ ID; if(num) map[num]=q.ê³ ìœ ID; });
        Object.keys(parsed).forEach(k=>{
          const nk=map[k]||k, ov=parsed[k]||{}, hist=Array.isArray(ov.solveHistory)?ov.solveHistory:(ov.score!=null?[{date:Date.now(),score:+ov.score||0}]:[]);
          newScores[nk]={ score:+(ov.score??0), feedback:String(ov.feedback??''), user_answer:String(ov.user_answer??''), hintUsed:!!ov.hintUsed, isSolved:!!(ov.isSolved||(ov.score!=null)), lastSolvedDate:+(ov.lastSolvedDate??(hist.at(-1)?.date||Date.now())), solveHistory:hist, userReviewFlag:!!ov.userReviewFlag, userReviewExclude: !!ov.userReviewExclude };
        });
        localStorage.setItem('auditQuizScores',JSON.stringify(newScores)); localStorage.setItem('schemaVersion','2'); questionScores=newScores; showToast('ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ','info');
      }catch(e){ console.error(e); showToast('ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜','error'); }
    }

    /* === ìƒí˜¸ë°°íƒ€(â˜… vs â–) ì •í•©ì„± ë³´ì • === */
    function enforceExclusiveFlagsOnAll() {
      let changed=0;
      for (const [qid, rec] of Object.entries(questionScores||{})) {
        if (rec?.userReviewFlag && rec?.userReviewExclude) {
          // ì •ì±…: 'ì œì™¸(â–) ìš°ì„ '
          rec.userReviewFlag = false;
          changed++;
        }
      }
      if (changed) {
        try { localStorage.setItem('auditQuizScores', JSON.stringify(questionScores)); } catch {}
      }
    }
    function setFlagState(qid, {flag=false, exclude=false, silent=false}) {
      const rec = questionScores[qid] || {};
      // ìƒí˜¸ë°°íƒ€ ì ìš©
      if (exclude) flag = false;
      if (flag) exclude = false;
      questionScores[qid] = { ...rec, userReviewFlag: !!flag, userReviewExclude: !!exclude };
      try { localStorage.setItem('auditQuizScores', JSON.stringify(questionScores)); } catch {}
      if (!silent) refreshPanels(); // ì¢Œ/ìš° íŒ¨ë„ ë™ê¸°í™”
    }

    function openApiModal(initial=false){ if(initial) el.apiModalCancelBtn.classList.add('hidden'); else el.apiModalCancelBtn.classList.remove('hidden');
      el.apiModal.classList.remove('hidden'); el.apiModal.classList.add('flex'); el.apiModalInput.value=geminiApiKey||''; el.apiModalRemember.checked=!!localStorage.getItem('geminiApiKey'); setTimeout(()=>el.apiModalInput.focus(),0);
    }
    const closeApiModal=()=>{ el.apiModal.classList.add('hidden'); el.apiModal.classList.remove('flex'); };
    const ensureApiKeyGate=()=>{ if(!geminiApiKey) openApiModal(true); };
    el.apiModalSaveBtn.addEventListener('click',()=>{
      const key=(el.apiModalInput.value||'').trim(); if(!key){ showToast('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.','error'); el.apiModalInput.focus(); return; }
      geminiApiKey=key; sessionStorage.setItem('geminiApiKey',key); if(el.apiModalRemember.checked) localStorage.setItem('geminiApiKey',key); else localStorage.removeItem('geminiApiKey'); closeApiModal(); showToast('API í‚¤ ì €ì¥ ì™„ë£Œ');
    });
    el.apiModalCancelBtn.addEventListener('click',closeApiModal);
    document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ if(!el.apiModalCancelBtn.classList.contains('hidden') && !el.apiModal.classList.contains('hidden')) closeApiModal(); if(!el.settingsModal.classList.contains('hidden')) closeSettingsModal(); } });

    function openSettingsModal(){ el.settingsModal.classList.remove('hidden'); el.settingsModal.classList.add('flex'); if(el.aiModelSelect) el.aiModelSelect.value=selectedAiModel; if(el.darkModeSelect) el.darkModeSelect.value=darkMode; }
    function closeSettingsModal(){ el.settingsModal.classList.add('hidden'); el.settingsModal.classList.remove('flex'); }
    el.settingsBtn.addEventListener('click',openSettingsModal);
    el.settingsCloseBtn.addEventListener('click',closeSettingsModal);
    el.settingsCloseBtnBottom.addEventListener('click',closeSettingsModal);
    el.openApiKeyModalBtn?.addEventListener('click',()=>{ closeSettingsModal(); openApiModal(false); });
    el.aiModelSelect?.addEventListener('change',e=>{ selectedAiModel=e.target.value; localStorage.setItem('aiModel',selectedAiModel); showToast(`AI ëª¨ë¸ ë³€ê²½: ${selectedAiModel}`); });
    el.darkModeSelect?.addEventListener('change',e=>{ localStorage.setItem('darkMode',e.target.value); applyDarkMode(); showToast('ë‹¤í¬ ëª¨ë“œ ì„¤ì • ë³€ê²½ë¨'); });

    el.exportDataBtn?.addEventListener('click',()=>{
      try{
        const data={ version:'3.x', schemaVersion:+(localStorage.getItem('schemaVersion')||2), exportDate:new Date().toISOString(), auditQuizScores:questionScores, geminiApiKey:localStorage.getItem('geminiApiKey')||'', aiModel:selectedAiModel, darkMode:darkMode };
        const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=`gamlini_backup_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url); showToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
      }catch(err){ console.error(err); showToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨','error'); }
    });
    el.importDataBtn?.addEventListener('click',()=>el.importFileInput.click());
    el.importFileInput?.addEventListener('change',e=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        try{
          const data=JSON.parse(ev.target.result);
          if(!data.auditQuizScores) throw new Error('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
          localStorage.setItem('auditQuizScores',JSON.stringify(data.auditQuizScores)); questionScores=data.auditQuizScores;
          if(data.geminiApiKey){ localStorage.setItem('geminiApiKey',data.geminiApiKey); geminiApiKey=data.geminiApiKey; }
          if(data.aiModel){ localStorage.setItem('aiModel',data.aiModel); selectedAiModel=data.aiModel; if(el.aiModelSelect) el.aiModelSelect.value=data.aiModel; }
          if(data.darkMode){ localStorage.setItem('darkMode',data.darkMode); darkMode=data.darkMode; applyDarkMode(); }
          if(data.schemaVersion) localStorage.setItem('schemaVersion',String(data.schemaVersion));
          // ê°€ì ¸ì˜¤ìë§ˆì ìƒí˜¸ë°°íƒ€ ë³´ì •
          enforceExclusiveFlagsOnAll();
          showToast('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ'); setTimeout(()=>location.reload(),600);
        }catch(err){ console.error(err); showToast(`ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${err.message}`,'error'); }
      };
      reader.readAsText(file); e.target.value='';
    });

    // ë³‘í•© ê°€ì ¸ì˜¤ê¸° ê¸°ëŠ¥
    function mergeQuizScores(existing, imported){
      const result={...existing};
      for(const [qid,importedData] of Object.entries(imported)){
        if(!result[qid]){
          // ìƒˆë¡œìš´ ë¬¸ì œ ID - ê·¸ëƒ¥ ì¶”ê°€
          result[qid]=importedData;
        }else{
          // ê¸°ì¡´ ë¬¸ì œ ID - ë³‘í•© (ìµœì‹  í’€ì´ ë°ì´í„° ìš°ì„ )
          const existingData=result[qid];
          const useImported=(importedData.lastSolvedDate||0)>(existingData.lastSolvedDate||0);
          // solveHistory ë³‘í•© (ë‚ ì§œ ê¸°ì¤€ ì¤‘ë³µ ì œê±°)
          const combinedHistory=[...(existingData.solveHistory||[]),...(importedData.solveHistory||[])];
          const uniqueHistory=Array.from(new Map(combinedHistory.map(h=>[h.date,h])).values()).sort((a,b)=>a.date-b.date);
          result[qid]={
            score:useImported?(importedData.score||0):(existingData.score||0),
            feedback:useImported?importedData.feedback:existingData.feedback,
            user_answer:useImported?importedData.user_answer:existingData.user_answer,
            hintUsed:useImported?importedData.hintUsed:existingData.hintUsed,
            isSolved:existingData.isSolved||importedData.isSolved,
            lastSolvedDate:Math.max(existingData.lastSolvedDate||0,importedData.lastSolvedDate||0),
            solveHistory:uniqueHistory,
            userReviewFlag:existingData.userReviewFlag||importedData.userReviewFlag,
            userReviewExclude:existingData.userReviewExclude||importedData.userReviewExclude
          };
        }
      }
      return result;
    }

    el.mergeDataBtn?.addEventListener('click',()=>el.mergeFileInput.click());
    el.mergeFileInput?.addEventListener('change',e=>{
      const file=e.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        try{
          const data=JSON.parse(ev.target.result);
          if(!data.auditQuizScores) throw new Error('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
          // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©
          const mergedScores=mergeQuizScores(questionScores,data.auditQuizScores);
          localStorage.setItem('auditQuizScores',JSON.stringify(mergedScores)); questionScores=mergedScores;
          // ì„¤ì •ì€ ê°€ì ¸ì˜¨ íŒŒì¼ì˜ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ìˆëŠ” ê²½ìš°)
          if(data.geminiApiKey){ localStorage.setItem('geminiApiKey',data.geminiApiKey); geminiApiKey=data.geminiApiKey; }
          if(data.aiModel){ localStorage.setItem('aiModel',data.aiModel); selectedAiModel=data.aiModel; if(el.aiModelSelect) el.aiModelSelect.value=data.aiModel; }
          if(data.darkMode){ localStorage.setItem('darkMode',data.darkMode); darkMode=data.darkMode; applyDarkMode(); }
          if(data.schemaVersion) localStorage.setItem('schemaVersion',String(data.schemaVersion));
          // ë³‘í•© í›„ ìƒí˜¸ë°°íƒ€ ë³´ì •
          enforceExclusiveFlagsOnAll();
          showToast('ë°ì´í„° ë³‘í•© ì™„ë£Œ'); setTimeout(()=>location.reload(),600);
        }catch(err){ console.error(err); showToast(`ë³‘í•© ì‹¤íŒ¨: ${err.message}`,'error'); }
      };
      reader.readAsText(file); e.target.value='';
    });

    const SOURCE_LS='sourceFilterSelectionV1', BASIC_TAGS=['S','H','HS'], ADV_TAGS=['SS','P'];
    function buildSourceFilterUI(){
      if(!el.sourceGroupFilter) return;
      el.sourceGroupFilter.innerHTML=`
        <div class="rounded-xl border p-3">
          <div class="text-sm font-semibold mb-2">ì¶œì²˜ë³„ í•„í„°</div>
          <div class="flex flex-wrap gap-3">
            <label class="text-sm flex items-center gap-1"><input type="checkbox" value="basic" class="source-filter"> ê¸°ë³¸(S/H/HS)</label>
            <label class="text-sm flex items-center gap-1"><input type="checkbox" value="advanced" class="source-filter"> ì‹¬í™”(SS/P)</label>
            <label class="text-sm flex items-center gap-1"><input type="checkbox" value="other" class="source-filter"> ê¸°íƒ€</label>
            <button id="source-filter-all" class="ml-auto text-xs px-2 py-1 border rounded">ì „ì²´</button>
            <button id="source-filter-none" class="text-xs px-2 py-1 border rounded">í•´ì œ</button>
          </div>
        </div>`;
      const saved=JSON.parse(localStorage.getItem(SOURCE_LS)||'["basic","advanced","other"]');
      el.sourceGroupFilter.querySelectorAll('input.source-filter').forEach(cb=>{
        cb.checked=saved.includes(cb.value);
        cb.addEventListener('change',()=>{ localStorage.setItem(SOURCE_LS,JSON.stringify(getSelectedSourceGroups())); reloadAndRefresh(); });
      });
      el.sourceGroupFilter.querySelector('#source-filter-all')?.addEventListener('click',()=>{ setAllGroups(['basic','advanced','other']); });
      el.sourceGroupFilter.querySelector('#source-filter-none')?.addEventListener('click',()=>{ setAllGroups([]); });
      function setAllGroups(arr){ el.sourceGroupFilter.querySelectorAll('input.source-filter').forEach(cb=>cb.checked=arr.includes(cb.value)); localStorage.setItem(SOURCE_LS,JSON.stringify(arr)); reloadAndRefresh(); }
    }
    const getSelectedSourceGroups=()=>{ const boxes=el.sourceGroupFilter?.querySelectorAll('input.source-filter'); if(!boxes||boxes.length===0) return JSON.parse(localStorage.getItem(SOURCE_LS)||'["basic","advanced","other"]'); const arr=[]; boxes.forEach(cb=>{ if(cb.checked) arr.push(cb.value); }); return arr; };
    const detectSourceGroup=src=>{ const s=String(src||'').toUpperCase(), tok=s.split(/\s*[;,\/\s]\s*/).filter(Boolean); const hasBasic=tok.some(t=>BASIC_TAGS.includes(t)), hasAdv=tok.some(t=>ADV_TAGS.includes(t)); if(hasBasic && !hasAdv) return 'basic'; if(!hasBasic && hasAdv) return 'advanced'; if(hasBasic && hasAdv) return 'basic-advanced'; return 'other'; };
    const applySourceFilter=arr=>{ const selected=new Set(getSelectedSourceGroups()); if(selected.size===0||selected.size===3) return arr; return (arr||[]).filter(q=>{ const g=detectSourceGroup(q.ì¶œì²˜); if(g==='basic-advanced') return selected.has('basic')||selected.has('advanced'); return selected.has(g); }); };

    function filterByChapterSelection(list){
      const sel=el.chapterSelect?.value||'';
      if(!sel) return list;
      if(isPartValue(sel)){
        const pr=parsePartValue(sel); if(!pr) return list;
        return list.filter(q=>{ const n=+q.ë‹¨ì›; return Number.isFinite(n) && n>=pr.start && n<=pr.end; });
      }
      return list.filter(q=>String(q.ë‹¨ì›).trim()===String(sel));
    }

    function getFilteredByUI(){
      const filter=el.filterSelect.value;
      let list=applySourceFilter(allData);
      list=filterByChapterSelection(list);

      list=list.filter(q=>{
        const key=normId(q.ê³ ìœ ID), s=questionScores[key];
        if(filter==='unanswered') return !s;
        if(filter==='80') return !s || +s.score<80;
        if(filter==='60') return !s || +s.score<60;
        return true;
      });

      if(filter==='today-review') {
        // ì œì™¸ í‘œì‹œëŠ” ì˜¤ëŠ˜ì˜ ë³µìŠµ í›„ë³´ì—ì„œ ì œê±°
        list = list.filter(q => !questionScores[normId(q.ê³ ìœ ID)]?.userReviewExclude);
        list = prioritizeTodayReview(list).slice(0,10);
      }
      return list;
    }
    function reloadAndRefresh(){
      if(isPartValue(el.chapterSelect.value)){
        summaryViewMode='CURRENT';
        el.summaryViewCurrentBtn?.classList.add('bg-gray-100');
        el.summaryViewAllBtn?.classList.remove('bg-gray-100');
      }
      currentQuizData=getFilteredByUI(); currentQuestionIndex=0;
      if(currentQuizData.length){ el.quizArea.classList.remove('hidden'); el.summaryArea.classList.remove('hidden'); displayQuestion(); }
      else{ el.quizArea.classList.add('hidden'); el.summaryArea.classList.remove('hidden'); showToast('ì„ íƒí•œ ì¡°ê±´ì— ë§ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.','warn'); }
      updateSummary(); refreshPanels();
    }

    el.chapterSelect.addEventListener('change', reloadAndRefresh);
    el.filterSelect.addEventListener('change', reloadAndRefresh);
    el.loadQuizBtn.addEventListener('click', reloadAndRefresh);
    el.randomQuizBtn.addEventListener('click',()=>{
      const list=getFilteredByUI(); if(!list.length){ showToast('ì„ íƒ ì¡°ê±´ì— ë§ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.','warn'); return; }
      currentQuizData=list; currentQuestionIndex=Math.floor(Math.random()*list.length);
      el.quizArea.classList.remove('hidden'); el.summaryArea.classList.remove('hidden'); displayQuestion(); updateSummary(); refreshPanels(); showToast('ëœë¤ ë¬¸ì œ ì‹œì‘!');
    });

    function updateFlagButtonsUI(saved) {
      const flagged = !!(saved?.userReviewFlag);
      const excluded = !!(saved?.userReviewExclude);
      // ìƒí˜¸ë°°íƒ€: excludedê°€ trueë©´ flaggedëŠ” falseì²˜ëŸ¼ í‘œí˜„
      const flagVisual = flagged && !excluded;

      // â˜…/â˜† í‘œì‹œ
      const starEl = el.reviewFlagToggle?.querySelector('span');
      if (starEl) starEl.textContent = flagVisual ? 'â˜…' : 'â˜†';
      el.reviewFlagToggle?.setAttribute('aria-pressed', flagVisual ? 'true':'false');
      el.reviewExcludeToggle?.setAttribute('aria-pressed', excluded ? 'true':'false');
    }

    function displayQuestion(){
      if(!currentQuizData.length){ el.quizArea.classList.add('hidden'); return; }
      const q=currentQuizData[currentQuestionIndex];
      el.quizArea.classList.remove('hidden');
      el.questionNumber.textContent=`ë¬¸í•­ ${q.í‘œì‹œë²ˆí˜¸||q.ë¬¼ìŒë²ˆí˜¸||q.ê³ ìœ ID}`;
      el.questionText.textContent=q.ë¬¼ìŒ;
      el.questionCounter.textContent=`${currentQuestionIndex+1} / ${currentQuizData.length}`;
      el.dbQuestionId.textContent=`ID: ${q.ê³ ìœ ID??'-'}`;
      activeHintQuestionKey=null; el.hintBox.classList.add('hidden'); el.hintBox.innerHTML='';
      el.resultBox.classList.add('hidden'); el.userAnswer.value='';
      el.loadPrevAnswerBtn.textContent='ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°'; el.loadPrevAnswerBtn.removeAttribute('aria-pressed'); prevLoaded=false;

      const saved=questionScores[normId(q.ê³ ìœ ID)];
      updateFlagButtonsUI(saved);

      if(saved && saved.score!==undefined) showResult(saved.score, saved.feedback, q.ì •ë‹µ);
      el.prevBtn.disabled=(currentQuestionIndex===0);
      el.nextBtn.disabled=(currentQuizData.length-1===currentQuestionIndex);
      updateSummaryHighlight();
    }

    // ë³µìŠµì¶”ê°€(â˜…) í´ë¦­ â†’ ì œì™¸(â–)ì™€ ìƒí˜¸ë°°íƒ€
    el.reviewFlagToggle.addEventListener('click',()=>{
      if(!currentQuizData.length) return;
      const q=currentQuizData[currentQuestionIndex], key=normId(q.ê³ ìœ ID), rec=questionScores[key]||{};
      const willFlag = !(rec.userReviewFlag && !rec.userReviewExclude); // ì‹œê°ìƒ Flag í™œì„± ì—¬ë¶€
      if (willFlag) {
        // ì¶”ê°€ë¡œ ì „í™˜: ì œì™¸ë¥¼ í•´ì œ
        setFlagState(key, { flag:true, exclude:false });
        showToast('ë³µìŠµ ì¶”ê°€ë¡œ ì „í™˜(â– í•´ì œ)');
      } else {
        // ì¶”ê°€ í•´ì œ
        setFlagState(key, { flag:false, exclude:!!rec.userReviewExclude });
        showToast('ë³µìŠµ ì¶”ê°€ í•´ì œ');
      }
      updateFlagButtonsUI(questionScores[key]);
      refreshPanels();
    });

    // ë³µìŠµì œì™¸(â–) í´ë¦­ â†’ ì¶”ê°€(â˜…)ì™€ ìƒí˜¸ë°°íƒ€
    el.reviewExcludeToggle?.addEventListener('click', ()=>{
      if(!currentQuizData.length) return;
      const q=currentQuizData[currentQuestionIndex], key=normId(q.ê³ ìœ ID), rec=questionScores[key]||{};
      const willExclude = !rec.userReviewExclude;
      if (willExclude) {
        // ì œì™¸ë¡œ ì „í™˜: ì¶”ê°€ë¥¼ í•´ì œ
        setFlagState(key, { flag:false, exclude:true });
        showToast('ì˜¤ëŠ˜ì˜ ë³µìŠµì—ì„œ ì œì™¸ë¡œ ì „í™˜(â˜… í•´ì œ)');
      } else {
        // ì œì™¸ í•´ì œ (í•„ìš”ì‹œ ì‚¬ìš©ìê°€ ë³„ë„ë¡œ â˜… ì¶”ê°€)
        setFlagState(key, { flag:!!rec.userReviewFlag, exclude:false });
        showToast('ë³µìŠµ ì œì™¸ í•´ì œ');
      }
      updateFlagButtonsUI(questionScores[key]);
      refreshPanels();
    });

    el.loadPrevAnswerBtn.addEventListener('click',()=>{
      if(!currentQuizData.length) return;
      const q=currentQuizData[currentQuestionIndex], saved=questionScores[normId(q.ê³ ìœ ID)];
      if(!prevLoaded){
        if(saved?.user_answer){ el.userAnswer.value=saved.user_answer; el.loadPrevAnswerBtn.textContent='ë‹µì•ˆ ì§€ìš°ê¸°'; el.loadPrevAnswerBtn.setAttribute('aria-pressed','true'); prevLoaded=true; showToast('ì´ì „ ë‹µì•ˆì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.'); }
        else showToast('ì €ì¥ëœ ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤.','warn');
      }else{
        el.userAnswer.value=''; el.loadPrevAnswerBtn.textContent='ì´ì „ ë‹µì•ˆ ë¶ˆëŸ¬ì˜¤ê¸°'; el.loadPrevAnswerBtn.setAttribute('aria-pressed','false'); prevLoaded=false;
      }
    });

    el.prevBtn.addEventListener('click',()=>{ if(currentQuestionIndex>0){ currentQuestionIndex--; displayQuestion(); } });
    el.nextBtn.addEventListener('click',()=>{ if(currentQuestionIndex<currentQuizData.length-1){ currentQuestionIndex++; displayQuestion(); } });
    el.userAnswer.addEventListener('input',()=> el.errorMessage.classList.add('hidden'));
    el.userAnswer.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); el.gradeBtn.click(); } });

    el.gradeBtn.addEventListener('click',handleGrade);
    async function handleGrade(){
      if(!geminiApiKey){ openApiModal(false); showToast('Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.','error'); return; }
      const answer=el.userAnswer.value.trim(); if(!answer){ el.errorMessage.textContent='ë‹µì•ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'; el.errorMessage.classList.remove('hidden'); el.userAnswer.focus(); return; }
      el.errorMessage.classList.add('hidden');
      const q=currentQuizData[currentQuestionIndex], qKey=normId(q.ê³ ìœ ID);
      setLoading(true);
      try{
        let {score, feedback}=await callGeminiAPI(answer, q.ì •ë‹µ, geminiApiKey);
        if (selectedAiModel === 'gemini-2.5-flash-lite') score = clamp(score - 7, 0, 100);
        const usedHint=(activeHintQuestionKey===qKey);
        const finalScore= usedHint? Math.min(59, Math.round(score*0.8)) : score;
        const finalFeedback= usedHint? `${feedback?feedback+' ':''}(íŒíŠ¸ì‚¬ìš©ìœ¼ë¡œ ê°ì )` : feedback;
        showResult(finalScore, finalFeedback, q.ì •ë‹µ);

        const existing=questionScores[qKey]||{}, newHistory=[...(existing.solveHistory||[]), {date:Date.now(), score:finalScore}];
        questionScores[qKey]={ score:finalScore, feedback:finalFeedback, user_answer:answer, hintUsed:usedHint, isSolved:true, lastSolvedDate:Date.now(), solveHistory:newHistory, userReviewFlag:!!existing.userReviewFlag, userReviewExclude: !!existing.userReviewExclude };
        // ìƒí˜¸ë°°íƒ€ ì¬ë³´ì •(í˜¹ì‹œë¼ë„ ì™¸ë¶€ ë°±ì—… ë³µì›ìœ¼ë¡œ ë‘˜ë‹¤ trueëœ ê²½ìš°)
        enforceExclusiveFlagsOnAll();
        try{ localStorage.setItem('auditQuizScores',JSON.stringify(questionScores)); }catch{ showToast('localStorage ì €ì¥ ì‹¤íŒ¨(ìš©ëŸ‰)','error'); }

        const {increased, uniqueReads}=registerUniqueRead(qKey); if(increased) showToast(`íšŒë… +1 (ì´ ë¬¸ì œ ê³ ìœ  ${uniqueReads}íšŒ)`);
        updateSummary(); refreshPanels();
      }catch(e){
        console.error('ì±„ì  ì˜¤ë¥˜:',e); el.aiFeedback.textContent=`ì±„ì  ì¤‘ ì˜¤ë¥˜: ${e.message}`; el.score.textContent='Error'; el.progressBar.style.width='0%'; el.resultBox.classList.remove('hidden');
        showToast('ì±„ì  ìš”ì²­ ì‹¤íŒ¨: API í‚¤/ë„¤íŠ¸ì›Œí¬/í• ë‹¹ëŸ‰ í™•ì¸.','error');
      }finally{ setLoading(false); }
    }
    function setLoading(v){ if(v){ el.gradeBtnText.classList.add('hidden'); el.gradeLoader.classList.remove('hidden'); el.gradeBtn.disabled=true; el.resultBox.classList.add('hidden'); } else { el.gradeBtnText.classList.remove('hidden'); el.gradeLoader.classList.add('hidden'); el.gradeBtn.disabled=false; } }

    async function callGeminiAPI(userAnswer, correctAnswer, apiKey, retries=2, delay=800){
      const modelMap={'gemini-2.5-flash':'gemini-2.5-flash','gemini-2.5-flash-lite':'gemini-2.5-flash-lite'};
      const model=modelMap[selectedAiModel]||'gemini-2.5-flash';
      const url=`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
      const generationConfig={ responseMimeType:'application/json', responseSchema:{ type:'OBJECT', properties:{score:{type:'NUMBER'}, feedback:{type:'STRING'}}, required:['score','feedback'] } };

      const systemText = (model === 'gemini-2.5-flash-lite') ? `${BASE_SYSTEM_PROMPT}\n\n${LITE_STRICT_ADDENDUM}` : BASE_SYSTEM_PROMPT;
      const systemInstruction={ parts:[{ text: systemText }] };
      const userQuery=`[ëª¨ë²” ë‹µì•ˆ]\n${correctAnswer}\n\n[ì‚¬ìš©ì ë‹µì•ˆ]\n${userAnswer}\n\n[ì±„ì  ìš”ì²­]\n{"score": number, "feedback": string}`;
      const payload={ contents:[{ parts:[{ text:userQuery }] }], systemInstruction, generationConfig };

      try{
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        if(!res.ok){ const body=await res.json().catch(()=>({})); const msg=body?.error?.message||res.statusText;
          if((res.status===404||res.status===400)&&/model/i.test(msg)) throw new Error(`ëª¨ë¸/ë²„ì „ ë¶ˆì¼ì¹˜: ${msg}`);
          if(res.status===429) throw new Error(`API í• ë‹¹ëŸ‰ ì´ˆê³¼ (429)`); if(res.status>=500) throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${res.status})`); throw new Error(msg);
        }
        const data=await res.json(); const raw=data?.candidates?.[0]?.content?.parts?.[0]?.text??''; const cleaned=sanitizeModelText(raw);
        let parsed; try{ parsed=JSON.parse(cleaned); }catch{ throw new Error('API ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨'); }
        return { score:clamp(+parsed.score,0,100), feedback:String(parsed.feedback||'í”¼ë“œë°± ì—†ìŒ').trim() };
      }catch(err){
        if(retries>0 && (String(err.message).includes('429') || /^ì„œë²„ ì˜¤ë¥˜/.test(String(err.message)))){ await new Promise(r=>setTimeout(r,delay)); return callGeminiAPI(userAnswer, correctAnswer, apiKey, retries-1, delay*1.6); }
        throw err;
      }
    }

    el.hintBtn.addEventListener('click',()=>{ if(currentQuizData.length) handleHint(currentQuizData[currentQuestionIndex]); });
    async function handleHint(q){
      if(!geminiApiKey){ openApiModal(false); showToast('Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.','error'); return; }
      setLoading(true);
      try{
        const hint=await callGeminiHintAPI(el.userAnswer.value.trim(), q.ì •ë‹µ, q.ë¬¼ìŒ, geminiApiKey);
        el.hintBox.innerHTML=`<strong class="font-semibold">íŒíŠ¸</strong><br>${String(hint||'').replace(/\n/g,'<br>')}`;
        el.hintBox.classList.remove('hidden'); activeHintQuestionKey=normId(q.ê³ ìœ ID); showToast('íŒíŠ¸ë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤. (ì¦‰ì‹œ ì±„ì  ì‹œ ê°ì )','warn');
      }catch(e){ console.error(e); showToast(`íŒíŠ¸ ìƒì„± ì‹¤íŒ¨: ${e.message}`,'error'); }
      finally{ setLoading(false); }
    }
    async function callGeminiHintAPI(userAnswer, correctAnswer, questionText, apiKey, retries=2, delay=800){
      const modelMap={'gemini-2.5-flash':'gemini-2.5-flash','gemini-2.5-flash-lite':'gemini-2.5-flash-lite'};
      const model=modelMap[selectedAiModel]||'gemini-2.5-flash';
      const url=`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
      const generationConfig={ responseMimeType:'application/json', responseSchema:{ type:'OBJECT', properties:{hint:{type:'STRING'}}, required:['hint'] } };
      const systemInstruction={ parts:[{ text:`ì—­í• : íšŒê³„ê°ì‚¬ í•™ìŠµ íŠœí„°.\nëª©í‘œ: ì •ë‹µì„ ë…¸ì¶œí•˜ì§€ ì•Šê³  í•µì‹¬ ê°œë…ì„ ë– ì˜¬ë¦¬ê²Œ ë§Œë“œëŠ” 2~4ì¤„ íŒíŠ¸ ì œê³µ.\nì¶œë ¥: JSONë§Œ.` }] };
      const userQuery=`[ë¬¸ì œ]\n${questionText}\n\n[ëª¨ë²” ë‹µì•ˆ]\n${correctAnswer}\n\n[ì‚¬ìš©ì ë‹µì•ˆ]\n${userAnswer||'(ë¯¸ì…ë ¥)'}\n\n[ìš”ì²­]\n{"hint": string }`;
      const payload={ contents:[{ parts:[{ text:userQuery }] }], systemInstruction, generationConfig };
      try{
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!res.ok){ const body=await res.json().catch(()=>({})); const msg=body?.error?.message||res.statusText;
          if((res.status===404||res.status===400)&&/model/i.test(msg)) throw new Error(`ëª¨ë¸/ë²„ì „ ë¶ˆì¼ì¹˜: ${msg}`);
          if(res.status===429) throw new Error(`API í• ë‹¹ëŸ‰ ì´ˆê³¼ (429)`); if(res.status>=500) throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${res.status})`); throw new Error(msg);
        }
        const data=await res.json(); const raw=data?.candidates?.[0]?.content?.parts?.[0]?.text??''; const cleaned=sanitizeModelText(raw);
        let parsed; try{ parsed=JSON.parse(cleaned); }catch{ throw new Error('API ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨'); }
        return String(parsed.hint||'').trim();
      }catch(err){
        if(retries>0 && (String(err.message).includes('429') || /^ì„œë²„ ì˜¤ë¥˜/.test(String(err.message)))){ await new Promise(r=>setTimeout(r,delay)); return callGeminiHintAPI(userAnswer, correctAnswer, questionText, apiKey, retries-1, delay*1.6); }
        throw err;
      }
    }

    function showResult(scoreVal, feedback, correctAnswer){
      const s=clamp(+scoreVal,0,100);
      el.score.textContent=s.toFixed(1); el.progressBar.style.width=`${s}%`; el.progressBar.setAttribute('aria-valuenow',String(Math.round(s)));
      el.progressBar.className='h-4 rounded-full transition-all duration-500 ease-out '+(s<60?'bg-red-500': s<80?'bg-yellow-500':'bg-blue-600');
      el.aiFeedback.textContent=String(feedback||''); el.correctAnswer.textContent=String(correctAnswer||''); el.resultBox.classList.remove('hidden');
    }

    el.summaryViewAllBtn?.addEventListener('click',()=>{ summaryViewMode='ALL'; el.summaryViewAllBtn.classList.add('bg-gray-100'); el.summaryViewCurrentBtn.classList.remove('bg-gray-100'); updateSummary(); });
    el.summaryViewCurrentBtn?.addEventListener('click',()=>{ summaryViewMode='CURRENT'; el.summaryViewCurrentBtn.classList.add('bg-gray-100'); el.summaryViewAllBtn.classList.remove('bg-gray-100'); updateSummary(); });

    const READ_STORE_KEY='readSessions_v2', UNIQUE_WINDOW_MS=5*60*1000;
    const loadReadStore=()=>{ try{ return JSON.parse(localStorage.getItem(READ_STORE_KEY)||'{}'); }catch{ return {}; } };
    const saveReadStore=obj=>localStorage.setItem(READ_STORE_KEY,JSON.stringify(obj));
    const computeUniqueReadsFromHistory=h=>{ const times=(Array.isArray(h)?h:[]).map(x=>+x?.date).filter(Number.isFinite).sort((a,b)=>a-b); if(!times.length) return {uniqueReads:0,lastAt:0}; let c=0,last=-Infinity; for(const t of times){ if(t-last>=UNIQUE_WINDOW_MS){ c++; last=t; } } return {uniqueReads:c,lastAt:times.at(-1)}; };
    function backfillReadStoreFromScores(force=false){
      if(!force && localStorage.getItem('readStoreBackfilled_v2')==='1') return;
      const db=loadReadStore(); let touched=0;
      for(const [qid,rec] of Object.entries(questionScores||{})){ const hist=Array.isArray(rec?.solveHistory)?rec.solveHistory:[]; if(!hist.length) continue; const has=db[qid];
        if(!has || !Number.isFinite(+has.uniqueReads) || +has.uniqueReads===0){ const seed=computeUniqueReadsFromHistory(hist); if(seed.uniqueReads>0){ db[qid]=seed; touched++; } }
      }
      if(touched>0) saveReadStore(db); localStorage.setItem('readStoreBackfilled_v2','1');
    }
    function registerUniqueRead(qid){
      const t=Date.now(), db=loadReadStore(); let rec=db[qid];
      if(!rec){ const hist=questionScores[qid]?.solveHistory; rec=Array.isArray(hist)&&hist.length?computeUniqueReadsFromHistory(hist):{uniqueReads:0,lastAt:0}; }
      if(t-(rec.lastAt||0)>=UNIQUE_WINDOW_MS){ rec.uniqueReads=(+rec.uniqueReads||0)+1; rec.lastAt=t; db[qid]=rec; saveReadStore(db); return {increased:true, uniqueReads:rec.uniqueReads}; }
      rec.lastAt=t; db[qid]=rec; saveReadStore(db); return {increased:false, uniqueReads:rec.uniqueReads};
    }

    function updateSummary(){
      el.scoreSummary.innerHTML='';
      const base=(summaryViewMode==='CURRENT')?(currentQuizData||[]):(allData||[]);
      const groups=new Map(); for(const q of base){ const ch=String(q.ë‹¨ì›).trim(); if(!groups.has(ch)) groups.set(ch,[]); groups.get(ch).push(q); }
      const chapters=[...groups.keys()].sort((a,b)=>{ const na=+a, nb=+b; if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; if(Number.isFinite(na)) return -1; if(Number.isFinite(nb)) return 1; return a.localeCompare(b,'ko'); });

      const readStore=loadReadStore(), _clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

      chapters.forEach(ch=>{
        const n=+ch; if(Number.isFinite(n)){ const hit=PART_INSERTIONS.find(p=>p.before===n); if(hit){ const part=document.createElement('div'); part.className='w-full px-3 py-2 mb-2 rounded-lg border-2 bg-blue-50 border-blue-200 text-blue-800 font-bold'; part.textContent=hit.label; el.scoreSummary.appendChild(part); } }
        const list=(groups.get(ch)||[]).sort((a,b)=>{ const na=+(a.ë¬¼ìŒë²ˆí˜¸||a.í‘œì‹œë²ˆí˜¸), nb=+(b.ë¬¼ìŒë²ˆí˜¸||b.í‘œì‹œë²ˆí˜¸); if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; return String(a.í‘œì‹œë²ˆí˜¸||a.ë¬¼ìŒë²ˆí˜¸).localeCompare(String(b.í‘œì‹œë²ˆí˜¸||b.ë¬¼ìŒë²ˆí˜¸),'ko'); });

        let sum=0,cnt=0,sumRounds=0, last=0;
        list.forEach(q=>{
          const id=String(q.ê³ ìœ ID).trim(), s=questionScores[id];
          if(s && Number.isFinite(+s.score)){ sum+=+s.score; cnt++; }
          const rs=readStore[id]; const ur= rs && Number.isFinite(+rs.uniqueReads)? +rs.uniqueReads : computeUniqueReadsFromHistory(s?.solveHistory||[]).uniqueReads;
          sumRounds+=ur; if(s?.lastSolvedDate && s.lastSolvedDate>last) last=s.lastSolvedDate;
        });

        const avg=cnt? (sum/cnt):null, rounds=list.length? (sumRounds/list.length):0;
        const recent= last? ((d=>d===0?'ì˜¤ëŠ˜':d===1?'ì–´ì œ':`${d}ì¼ ì „`)(Math.floor((Date.now()-last)/86400000))):'í•™ìŠµ ê¸°ë¡ ì—†ìŒ';
        const ratio=`ì‘ì‹œ ${cnt}/${list.length}`, avgTxt=avg==null?'-':avg.toFixed(1), roundsTxt=rounds.toFixed(1);
        const barW=_clamp(avg??0,0,100), barCls= avg==null?'bg-gray-300': avg<60?'bg-red-500': avg<80?'bg-yellow-500':'bg-green-500';

        const header=document.createElement('div'); header.className='px-3 py-2 rounded-md border bg-gray-50 mb-2';
        header.innerHTML=`
          <div class="font-semibold text-lg">${chapterLabelText(ch)}</div>
          <div class="text-sm text-gray-700 mt-1 space-y-1">
            <div>í‰ê·  ${avgTxt}ì  Â· ${ratio}</div>
            <div>í‰ê·  ${roundsTxt}íšŒë… Â· ìµœê·¼ ${recent}</div>
          </div>
          <div class="w-28 h-2 bg-gray-200 rounded-full overflow-hidden mt-2"><div class="h-2 ${barCls}" style="width:${barW}%"></div></div>
          <div class="mt-2 flex justify-end"><button class="text-xs text-blue-700 hover:underline summary-toggle">ì ‘ê¸°</button></div>`;
        const grid=document.createElement('div'); grid.className='flex flex-wrap gap-2 mt-2 mb-4';

        list.forEach(q=>{
          const btn=document.createElement('button');

          // ë¼ë²¨ êµ¬ì„± (â– ì•„ì´ì½˜)
          const disp=(q.í‘œì‹œë²ˆí˜¸??'').toString().trim();
          const fallback=(q.ë¬¼ìŒë²ˆí˜¸??q.ê³ ìœ ID??'').toString().trim();
          const baseLabel = disp || fallback || '';

          const id=String(q.ê³ ìœ ID).trim();
          const saved=questionScores[id]||{};
          const excluded = !!saved.userReviewExclude;
          const flagged = !!saved.userReviewFlag && !excluded; // ì œì™¸ ìš°ì„ 

          const label = excluded ? `â– ${baseLabel}` : baseLabel;
          btn.textContent=label;
          if(baseLabel.length>=3) btn.style.fontSize='.72rem';
          if(baseLabel.length>=4){ btn.style.fontSize='.66rem'; btn.style.letterSpacing='-0.2px'; }

          const metaFlags=[];
          if(excluded) metaFlags.push('ë³µìŠµì œì™¸');
          else if(flagged) metaFlags.push('ë³µìŠµì¶”ê°€');

          const fullMeta=[ q.problemTitle && String(q.problemTitle).trim(),
            `í‘œì‹œë²ˆí˜¸:${disp||'-'}`, `ë¬¼ìŒë²ˆí˜¸:${(q.ë¬¼ìŒë²ˆí˜¸??'').toString().trim()||'-'}`, `ID:${(q.ê³ ìœ ID??'').toString().trim()||'-'}`, metaFlags.join(', ')
          ].filter(Boolean).join(' | ');
          btn.title=fullMeta; btn.setAttribute('aria-label',fullMeta);

          btn.classList.add('summary-btn','font-medium','rounded-lg','border');

          const sc= Number.isFinite(+saved?.score)? +saved.score : NaN;
          const cls= !Number.isFinite(sc)? ['bg-gray-100','text-gray-600','border-gray-300'] : sc<60? ['bg-red-100','text-red-700','border-red-300'] : sc<80? ['bg-yellow-100','text-yellow-700','border-yellow-300'] : ['bg-green-100','text-green-700','border-green-300'];
          btn.classList.add(...cls); btn.dataset.qid=id;

          btn.addEventListener('click',()=>{
            const idx=currentQuizData.findIndex(it=>String(it.ê³ ìœ ID).trim()===id);
            if(idx===-1){
              const chVal=String(q.ë‹¨ì›).trim(), set=allData.filter(it=>String(it.ë‹¨ì›).trim()===chVal);
              if(set.length){ currentQuizData=set; currentQuestionIndex=set.findIndex(it=>String(it.ê³ ìœ ID).trim()===id); }
            } else currentQuestionIndex=idx;
            if(currentQuestionIndex<0) currentQuestionIndex=0;
            el.quizArea.classList.remove('hidden'); displayQuestion(); showToast(`'${baseLabel}'ë¡œ ì´ë™`);
          });
          grid.appendChild(btn);
        });

        header.querySelector('.summary-toggle').addEventListener('click',e=>{
          const hidden=grid.classList.toggle('hidden'); e.currentTarget.textContent= hidden?'í¼ì¹˜ê¸°':'ì ‘ê¸°';
        });

        const section=document.createElement('div'); section.className='w-full space-y-2 mb-3'; section.appendChild(header); section.appendChild(grid);
        el.scoreSummary.appendChild(section);
      });
      updateSummaryHighlight();
    }
    function updateSummaryHighlight(){
      if(!currentQuizData.length) return; const cur=String(currentQuizData[currentQuestionIndex].ê³ ìœ ID).trim();
      el.scoreSummary.querySelectorAll('button.summary-btn').forEach(b=>{ b.classList.remove('ring-2','ring-blue-500','ring-offset-2'); if(b.dataset.qid===cur) b.classList.add('ring-2','ring-blue-500','ring-offset-2'); });
    }

    el.clearFilterBtn.addEventListener('click',()=>{
      el.filterSelect.value='all'; el.chapterSelect.value='';
      el.sourceGroupFilter?.querySelectorAll('input.source-filter')?.forEach(cb=>cb.checked=true);
      localStorage.setItem(SOURCE_LS,JSON.stringify(['basic','advanced','other']));
      reloadAndRefresh(); showToast('í•„í„° í•´ì œ: ëª¨ë“  ë¬¸ì œ í‘œì‹œ');
    });
    el.resetScoresBtn.addEventListener('click',()=>{
      if(confirm('ì •ë§ë¡œ ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
        questionScores={}; localStorage.removeItem('auditQuizScores'); localStorage.removeItem('schemaVersion'); localStorage.removeItem('readSessions_v2'); localStorage.removeItem('readStoreBackfilled_v2');
        updateSummary(); if(currentQuizData.length){ currentQuestionIndex=0; reloadAndRefresh(); } refreshPanels(); showToast('í•™ìŠµ ê¸°ë¡ ì´ˆê¸°í™” ì™„ë£Œ');
      }
    });

    function ensureResultBoxReady(){ if(currentQuizData.length){ const q=currentQuizData[currentQuestionIndex]; if(!el.correctAnswer.textContent?.trim()) el.correctAnswer.textContent=String(q.ì •ë‹µ||''); } el.resultBox.classList.remove('hidden'); }
    function enterFocusMode(){ lastScrollYBeforeFocus=window.pageYOffset; document.documentElement.classList.add('focus-mode'); ensureResultBoxReady(); const header=el.userAnswer; const margin=12; const y=header.getBoundingClientRect().top + window.pageYOffset - (el.fixedHeader?.getBoundingClientRect().height||0) - margin; window.scrollTo({top:Math.max(0,y),behavior:'smooth'}); ctrlNavState='focus'; }
    function exitToDashboard(){ document.documentElement.classList.remove('focus-mode'); if(el.summaryArea) window.scrollTo({top:el.summaryArea.getBoundingClientRect().top + window.pageYOffset - (el.fixedHeader?.getBoundingClientRect().height||0) - 8, behavior:'smooth'}); else window.scrollTo({top:0,behavior:'smooth'}); ctrlNavState='dashboard'; }
    function backFromFocus(){ document.documentElement.classList.remove('focus-mode'); window.scrollTo({top:Math.max(0,lastScrollYBeforeFocus),behavior:'smooth'}); ctrlNavState='dashboard'; }
    const isEditing=t=> t && (t.tagName==='INPUT' || t.tagName==='TEXTAREA' || t.isContentEditable);
    document.addEventListener('keydown',e=>{
      if((e.key==='h'||e.key==='H') && !isEditing(e.target)){ e.preventDefault(); el.hintBtn?.click(); return; }
      if(e.ctrlKey && !e.altKey && !e.metaKey){
        if(e.key==='ArrowLeft'){ e.preventDefault(); el.prevBtn?.click(); return; }
        if(e.key==='ArrowRight'){ e.preventDefault(); el.nextBtn?.click(); return; }
        if(e.key==='['){ e.preventDefault(); if(ctrlNavState==='focus') backFromFocus(); else window.scrollTo({top:0,behavior:'smooth'}); return; }
        if(e.key===']'){ e.preventDefault(); if(ctrlNavState!=='focus') enterFocusMode(); else exitToDashboard(); return; }
      }
    });

    const getScopeFilteredData=()=> filterByChapterSelection(applySourceFilter(allData||[]));

    function renderCalendarMonth() {
      const grid = el.calendarGrid, title = el.calTitle; if (!grid || !title) return;
      title.textContent = `${calRefDate.getFullYear()}.${String(calRefDate.getMonth()+1).padStart(2,'0')}`;
      const base = getScopeFilteredData(); const idSet = new Set(base.map(q => String(q.ê³ ìœ ID).trim()));
      const counts = new Map();
      for (const [qid, rec] of Object.entries(questionScores || {})) {
        if (!idSet.has(qid)) continue;
        const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
        for (const h of hist) {
          const t = Number(h?.date); if (!Number.isFinite(t)) continue;
          const d = new Date(t); d.setHours(0,0,0,0);
          const k = ymd(d);
          counts.set(k, (counts.get(k)||0) + 1);
        }
      }
      const first = new Date(calRefDate); const firstDow = dowMon0(first);
      const start = new Date(first); start.setDate(first.getDate() - firstDow);
      const lastDay = new Date(calRefDate.getFullYear(), calRefDate.getMonth()+1, 0);
      const lastDow = dowMon0(lastDay);
      const end = new Date(lastDay); end.setDate(lastDay.getDate() + (6 - lastDow));

      grid.innerHTML = '';
      for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
        const inMonth = (d.getMonth() === calRefDate.getMonth() && d.getFullYear() === calRefDate.getFullYear());
        const key = ymd(d);
        const c = counts.get(key) || 0;
        const { bg, fg } = colorForCount(c);
        const cell = document.createElement('div');
        cell.className = `cal-cell` + (inMonth ? '' : ' muted');
        cell.title = `${key} Â· í’€ì´ ${c}íšŒ`;
        cell.style.backgroundColor = bg;
        cell.style.color = fg;
        const day = document.createElement('div');
        day.className = 'cal-day';
        day.textContent = String(d.getDate());
        cell.appendChild(day);
        grid.appendChild(cell);
      }
      bindCalendarDateClick();
    }
      function bindCalendarDateClick() {
  const cells = el.calendarGrid?.querySelectorAll('.cal-cell');
  cells?.forEach(cell => {
    cell.style.cursor = 'pointer';
    
    cell.addEventListener('click', (e) => {
      const title = cell.title;
      if (!title) return;
      
      const dateStr = title.split(' ')[0];
      const clickedDate = new Date(dateStr + 'T00:00:00');
      if (isNaN(clickedDate.getTime())) return;
      
      statsRefDate = clickedDate;
      saveStatsDate();
      renderStats();
      
      showToast(`${dateStr} í†µê³„ë¡œ ì´ë™`, 'info');
      
      setTimeout(() => {
        const offset = getHeaderOffset();
        const statsBox = el.statsOverview?.closest('.bg-white');
        if (statsBox) {
          const y = statsBox.getBoundingClientRect().top + window.pageYOffset - offset - 8;
          window.scrollTo({ top: Math.max(0, y), behavior: 'smooth' });
        }
      }, 100);
    });
  });
}

    el.calPrev?.addEventListener('click', () => { calRefDate.setMonth(calRefDate.getMonth()-1); renderCalendarMonth(); });
    el.calNext?.addEventListener('click', () => { calRefDate.setMonth(calRefDate.getMonth()+1); renderCalendarMonth(); });

function renderStatsDateNav() {
  const existingNav = el.statsOverview?.querySelector('#stats-date-nav');
  if (existingNav) existingNav.remove();
  
  const nav = document.createElement('div');
  nav.id = 'stats-date-nav';
  nav.className = 'flex items-center justify-between mb-3 pb-3 border-b';
  
  const displayY = statsRefDate.getFullYear();
  const displayM = String(statsRefDate.getMonth() + 1).padStart(2, '0');
  const displayD = String(statsRefDate.getDate()).padStart(2, '0');
  const displayStr = `${displayY}-${displayM}-${displayD}`;
  
  nav.innerHTML = `
    <div class="flex items-center gap-2">
      <button id="stats-prev-day" class="w-7 h-7 flex items-center justify-center rounded border hover:bg-gray-100 text-sm" title="ì´ì „ ë‚ ">â—€</button>
      <input id="stats-date-input" type="date" class="px-2 py-1 border rounded text-sm" value="${displayStr}">
      <button id="stats-next-day" class="w-7 h-7 flex items-center justify-center rounded border hover:bg-gray-100 text-sm" title="ë‹¤ìŒ ë‚ ">â–¶</button>
    </div>
    <button id="stats-today-btn" class="text-xs px-2 py-1 border rounded hover:bg-gray-100">ì˜¤ëŠ˜</button>
  `;
  
  el.statsOverview.insertBefore(nav, el.statsOverview.firstChild);
  
  const prevBtn = el.statsOverview.querySelector('#stats-prev-day');
  const nextBtn = el.statsOverview.querySelector('#stats-next-day');
  const todayBtn = el.statsOverview.querySelector('#stats-today-btn');
  const dateInput = el.statsOverview.querySelector('#stats-date-input');
  
  prevBtn?.addEventListener('click', () => {
    statsRefDate.setDate(statsRefDate.getDate() - 1);
    saveStatsDate();
    renderStats();
  });
  
  nextBtn?.addEventListener('click', () => {
    statsRefDate.setDate(statsRefDate.getDate() + 1);
    saveStatsDate();
    renderStats();
  });
  
  todayBtn?.addEventListener('click', () => {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    statsRefDate = now;
    saveStatsDate();
    renderStats();
  });
  
  dateInput?.addEventListener('change', (e) => {
    if (e.target.value) {
      const newDate = new Date(e.target.value + 'T00:00:00');
      if (!isNaN(newDate.getTime())) {
        statsRefDate = newDate;
        saveStatsDate();
        renderStats();
      }
    }
  });
}
function renderStats(){
  if(!el.statsOverview) return;
  
  renderStatsDateNav();
  
  const startOfDay=d=>{const t=new Date(d); t.setHours(0,0,0,0); return t;};
  const endOfDay=d=>{const t=new Date(d); t.setHours(23,59,59,999); return t;};
  
  // âœ… ì£¼ê°„: ì›”ìš”ì¼ ì‹œì‘ ~ ì¼ìš”ì¼ ë
  const startOfWeek=d=>{
    const t=new Date(d); 
    t.setHours(0,0,0,0);
    const dow = (t.getDay() + 6) % 7; // 0=ì›”, 6=ì¼
    t.setDate(t.getDate() - dow);
    return t;
  };
  
  const endOfWeek=d=>{
    const t=new Date(d);
    t.setHours(23,59,59,999);
    const dow = (t.getDay() + 6) % 7;
    t.setDate(t.getDate() + (6 - dow));
    return t;
  };
  
  // âœ… ì›”ê°„: í•´ë‹¹ ì›”ì˜ 1ì¼ ì‹œì‘ ~ ë§ˆì§€ë§‰ì¼ ë
  const startOfMonth=d=>{
    const t=new Date(d.getFullYear(), d.getMonth(), 1);
    t.setHours(0,0,0,0);
    return t;
  };
  
  const endOfMonth=d=>{
    const t=new Date(d.getFullYear(), d.getMonth() + 1, 0); // ë‹¤ìŒ ë‹¬ 0ì¼ = ì´ë²ˆ ë‹¬ ë§ˆì§€ë§‰ ë‚ 
    t.setHours(23,59,59,999);
    return t;
  };
  
  // âœ… ê¸°ê°„ ì„¤ì • (ë³€ê²½ëœ ë¶€ë¶„)
  let title='ì˜¤ëŠ˜ì˜ í†µê³„', label='ì˜¤ëŠ˜', start=startOfDay(statsRefDate), end=endOfDay(statsRefDate);
  
  if(statsView==='week'){ 
    title='ì£¼ê°„ í†µê³„'; 
    label='ì£¼ê°„'; 
    start=startOfWeek(statsRefDate);
    end=endOfWeek(statsRefDate);
  }
  
  if(statsView==='month'){ 
    title='ì›”ê°„ í†µê³„'; 
    label='ì›”ê°„'; 
    start=startOfMonth(statsRefDate);
    end=endOfMonth(statsRefDate);
  }

  // ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ë™ì¼...
  const base=getScopeFilteredData(), idSet=new Set(base.map(q=>String(q.ê³ ìœ ID).trim()));
  let solved=0,sum=0, flagged=0,last=0; const daySet=new Set();
  
  for(const q of base){
    const id=String(q.ê³ ìœ ID).trim(), rec=questionScores[id];
    if(rec && Number.isFinite(+rec.score)){ solved++; sum+=+rec.score; }
    if(rec?.userReviewFlag && !rec.userReviewExclude) flagged++;
    if(rec?.lastSolvedDate && rec.lastSolvedDate>last) last=rec.lastSolvedDate;
    (Array.isArray(rec?.solveHistory)?rec.solveHistory:[]).forEach(h=>{ 
      const t=+h?.date; 
      if(!Number.isFinite(t)) return; 
      const d=new Date(t); 
      d.setHours(0,0,0,0); 
      daySet.add(ymd(d)); 
    });
  }
  
  const avgAll=solved?(sum/solved):null;
  const recentTxt= last? ((d=>d===0?'ì˜¤ëŠ˜':d===1?'ì–´ì œ':`${d}ì¼ ì „`)(Math.floor((Date.now()-last)/86400000))):'ê¸°ë¡ ì—†ìŒ';
  const hasSolved=dayKey=> daySet.has(dayKey);
  
  let streak=0, cur=new Date(); 
  cur.setHours(0,0,0,0);
  while(hasSolved(ymd(cur))){ streak++; cur.setDate(cur.getDate()-1); }
  
  const bestKey='bestStreak_v1', best=Math.max(streak, +(localStorage.getItem(bestKey)||0)); 
  if(best>+(localStorage.getItem(bestKey)||0)) localStorage.setItem(bestKey,String(best));

  // âœ… ê¸°ê°„ ë‚´ í’€ì´ ì§‘ê³„ (ë³€ê²½ëœ ë¶€ë¶„ - startì™€ end ì‚¬ìš©)
  let periodSolves=0, periodSum=0; 
  const byCh=new Map(), chRec=ch=>{ 
    if(!byCh.has(ch)) byCh.set(ch,{solves:0,sum:0}); 
    return byCh.get(ch); 
  };
  
  for(const q of base){
    const id=String(q.ê³ ìœ ID).trim(), ch=String(q.ë‹¨ì›).trim(), rec=questionScores[id];
    const hist=Array.isArray(rec?.solveHistory)?rec.solveHistory:[];
    
    for(const h of hist){ 
      const t=+h?.date, sc=+h?.score; 
      if(!Number.isFinite(t)) continue; 
      
      // âœ… ê¸°ê°„ ì²´í¬: start <= t <= end
      if(t >= +start && t <= +end){ 
        periodSolves++; 
        if(Number.isFinite(sc)) periodSum+=sc; 
        const slot=chRec(ch); 
        slot.solves++; 
        if(Number.isFinite(sc)) slot.sum+=sc; 
      } 
    }
  }
  
  const periodAvg=periodSolves? (periodSum/periodSolves):null;

  const weak=[];
  byCh.forEach((v,ch)=>{
    if(v.solves>=3) weak.push({ch,avg:v.sum/v.solves,cnt:v.solves});
  });
  weak.sort((a,b)=>a.avg-b.avg);
  const weakTop=weak.slice(0,3);

  // HLR í†µê³„ ê³„ì‚°
  let hlrDataCount=0, hlrRecallSum=0, hlrForgetting=0;
  for(const q of base){
    const id=String(q.ê³ ìœ ID).trim();
    const hlrData = calculateRecallProbability(id);
    if(hlrData){
      hlrDataCount++;
      hlrRecallSum += hlrData.p_current;
      if(hlrData.p_current < 0.5) hlrForgetting++;
    }
  }
  const hlrAvgRecall = hlrDataCount > 0 ? (hlrRecallSum / hlrDataCount) : 0;

  const baseDaily=+(localStorage.getItem('dailyTarget_v1')||20);
  if(!localStorage.getItem('weeklyTarget_v1')) localStorage.setItem('weeklyTarget_v1', String(baseDaily*7));
  if(!localStorage.getItem('monthlyTarget_v1')) localStorage.setItem('monthlyTarget_v1', String(baseDaily*30));
  
  const targetKey= statsView==='day'?'dailyTarget_v1': statsView==='week'?'weeklyTarget_v1':'monthlyTarget_v1';
  
  // âœ… ëª©í‘œ ë¼ë²¨ ë³€ê²½
  const targetLabel= statsView==='day'?'ì˜¤ëŠ˜ ëª©í‘œ': statsView==='week'?'ì´ë²ˆ ì£¼ ëª©í‘œ (ì›”~ì¼)':'ì´ë²ˆ ë‹¬ ëª©í‘œ';
  
  const targetVal= +(localStorage.getItem(targetKey) || (statsView==='day'?baseDaily: (statsView==='week'? baseDaily*7: baseDaily*30)));
  const pct=Math.max(0,Math.min(100,Math.round((periodSolves/Math.max(1,targetVal))*100)));
  const fmt=v=> v==null?'-':(Math.round(v*10)/10).toFixed(1);
  const chip=txt=>`<button data-go-ch="${txt}" class="px-2 py-0.5 text-xs rounded border hover:bg-gray-50">${chapterLabelText(txt)}</button>`;
  const weakHtml= weakTop.length? weakTop.map(w=>`${chip(w.ch)} <span class="text-xs text-red-600 ml-1">${fmt(w.avg)}ì Â·${w.cnt}íšŒ</span>`).join('<br>'):'ë°ì´í„° ë¶€ì¡±';

  // âœ… ê¸°ê°„ í‘œì‹œ ì¶”ê°€ (ì„ íƒì‚¬í•­)
  let periodInfo = '';
  if(statsView === 'week') {
    const startStr = `${start.getMonth()+1}/${start.getDate()}`;
    const endStr = `${end.getMonth()+1}/${end.getDate()}`;
    periodInfo = `<div class="text-[11px] text-gray-400 mb-1">${startStr} ~ ${endStr}</div>`;
  } else if(statsView === 'month') {
    periodInfo = `<div class="text-[11px] text-gray-400 mb-1">${statsRefDate.getFullYear()}ë…„ ${statsRefDate.getMonth()+1}ì›”</div>`;
  }

  // ê¸°ì¡´ HTML ë Œë”ë§ ì½”ë“œì— periodInfo ì¶”ê°€
  const existingNav = el.statsOverview.querySelector('#stats-date-nav');
  const statsContent = document.createElement('div');
  statsContent.id = 'stats-content';
  statsContent.innerHTML = `
    <div class="border rounded p-3 relative">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h3 class="font-bold" id="stats-title">${title}</h3>
          ${periodInfo}
        </div>
        <div class="relative">
          <button id="stats-view-btn" class="flex items-center gap-1 text-sm px-2 py-1 rounded border hover:bg-gray-50">
            <span id="stats-view-label">${label}</span>
            <span id="stats-caret" class="inline-block transition-transform">â–¼</span>
          </button>
          <div id="stats-view-menu" class="hidden absolute right-0 mt-1 w-28 bg-white dark:bg-gray-900 border rounded shadow-md overflow-hidden z-10">
            <button data-view="day" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">ì˜¤ëŠ˜</button>
            <button data-view="week" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">ì£¼ê°„</button>
            <button data-view="month" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50">ì›”ê°„</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ê¸°ê°„ í’€ì´</div><div class="text-lg font-semibold">${periodSolves} ê°œ</div></div>
        <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ê¸°ê°„ í‰ê· </div><div class="text-lg font-semibold">${fmt(periodAvg)} ì </div></div>
        <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ì¶œì„</div><div class="text-lg font-semibold">${streak} ì¼ì§¸ <span class="text-xs text-gray-500">(ìµœê³  ${best}ì¼)</span></div></div>
        <div class="p-2 rounded border"><div class="text-[12px] text-gray-500">ìŠ¤ì½”í”„ í‰ê· </div><div class="text-lg font-semibold">${fmt(avgAll)} ì </div></div>
      </div>

      <div class="mt-3">
        <div class="flex items-center justify-between"><div class="text-[12px] text-gray-500">${targetLabel} ${targetVal}ê°œ</div><div class="text-[12px] text-gray-500">${pct}%</div></div>
        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div class="h-2 ${pct<60?'bg-red-500':(pct<100?'bg-yellow-500':'bg-green-600')}" style="width:${pct}%"></div></div>
        <div class="flex items-center gap-2 mt-2">
          <label for="stats-target-input" class="text-xs text-gray-500">ëª©í‘œ:</label>
          <input id="stats-target-input" type="number" min="1" class="w-20 px-2 py-1 text-xs border rounded" value="${targetVal}">
          <button id="apply-stats-target" class="text-xs px-2 py-1 border rounded hover:bg-gray-50">ì ìš©</button>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-3 mt-3">
        <div class="p-2 rounded border">
          <div class="text-[12px] text-gray-500 mb-1">ì•½í•œ ë‹¨ì› Top 3 <span class="text-[11px] text-gray-400">(ê¸°ê°„ ê¸°ì¤€)</span></div>
          <div class="text-sm leading-5">${weakHtml}</div>
        </div>
      </div>

      <div class="text-[12px] text-gray-500 mt-2">
        ìµœê·¼ í•™ìŠµ: <strong class="text-gray-700">${recentTxt}</strong> Â· ë³µìŠµ ì¶”ê°€(â˜…): <strong class="text-gray-700">${flagged}</strong>
        ${hlrDataCount > 0 ? `<br>HLR: í‰ê·  íšŒìƒ <strong class="text-gray-700">${(hlrAvgRecall*100).toFixed(0)}%</strong> Â· ë§ê° ì„ë°• <strong class="text-red-600">${hlrForgetting}</strong>ê°œ` : ''}
      </div>
    </div>`;

  // ê¸°ì¡´ stats-content ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
  const oldContent = el.statsOverview.querySelector('#stats-content');
  if (oldContent) oldContent.remove();
  el.statsOverview.appendChild(statsContent);

  const btn=$('stats-view-btn'), caret=$('stats-caret'), menu=$('stats-view-menu');
  const openMenu=()=>{ menu.classList.remove('hidden'); caret.style.transform='rotate(180deg)'; };
  const closeMenu=()=>{ menu.classList.add('hidden'); caret.style.transform='rotate(0deg)'; };
  btn?.addEventListener('click',e=>{ e.stopPropagation(); if(menu.classList.contains('hidden')) openMenu(); else closeMenu(); });
  document.addEventListener('click', closeMenu, {once:true});
  menu?.querySelectorAll('[data-view]')?.forEach(i=> i.addEventListener('click',()=>{ const v=i.getAttribute('data-view'); statsView=v; localStorage.setItem('statsView_v1',v); renderStats(); }) );
  $('apply-stats-target')?.addEventListener('click',()=>{ const v=Math.max(1,Math.min(9999,Math.round(+($('stats-target-input')?.value||1)))); localStorage.setItem(targetKey,String(v)); renderStats(); });
  el.statsOverview.querySelectorAll('[data-go-ch]')?.forEach(b=> b.addEventListener('click',()=>{ const ch=b.getAttribute('data-go-ch')||''; if(ch){ el.chapterSelect.value=ch; reloadAndRefresh(); showToast(`${chapterLabelText(ch)} ë¡œ ì´ë™`);} }));
}
    function renderExplorer(){
      if(!el.explorerChapters||!el.explorerProblems) return;
      const base=getScopeFilteredData(), group=new Map();
      for(const q of base){ const ch=String(q.ë‹¨ì›).trim(); if(!group.has(ch)) group.set(ch,[]); group.get(ch).push(q); }
      const chapters=[...group.keys()].sort((a,b)=>{ const na=+a, nb=+b; if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; if(Number.isFinite(na)) return -1; if(Number.isFinite(nb)) return 1; return a.localeCompare(b,'ko'); });

      el.explorerChapters.innerHTML='';
      chapters.forEach(ch=>{
        const btn=document.createElement('button'); btn.className='w-full text-left px-3 py-2 rounded border hover:bg-gray-50'; btn.textContent=chapterLabelText(ch);
        btn.addEventListener('click',()=>{
          const list=group.get(ch)||[]; if(list.length){ currentQuizData=list; currentQuestionIndex=0; el.quizArea.classList.remove('hidden'); displayQuestion(); showToast(`${chapterLabelText(ch)} ë¡œ ì´ë™`); updateSummaryHighlight(); }
        });
        el.explorerChapters.appendChild(btn);
      });

      const q=(el.explorerSearch?.value||'').trim().toLowerCase();
      const filtered=base.filter(it=> (it.problemTitle||'').toLowerCase().includes(q) || (it.ë¬¼ìŒ||'').toLowerCase().includes(q) );
      el.explorerProblems.innerHTML='';
      filtered.sort((a,b)=>{ const na=+(a.ë¬¼ìŒë²ˆí˜¸||a.í‘œì‹œë²ˆí˜¸), nb=+(b.ë¬¼ìŒë²ˆí˜¸||b.í‘œì‹œë²ˆí˜¸); if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb; return String(a.í‘œì‹œë²ˆí˜¸||a.ë¬¼ìŒë²ˆí˜¸).localeCompare(String(b.í‘œì‹œë²ˆí˜¸||b.ë¬¼ìŒë²ˆí˜¸),'ko'); })
      .forEach(it=>{
        const rec=questionScores[String(it.ê³ ìœ ID).trim()]||{};
        const score= Number.isFinite(+rec?.score)? +rec.score : null;
        const excluded=!!rec.userReviewExclude;
        const flagged=!!rec.userReviewFlag && !excluded; // ì œì™¸ ìš°ì„ 

        const row=document.createElement('button'); row.className='w-full flex items-center justify-between gap-2 px-3 py-1.5 rounded hover:bg-gray-50 border';

        const left=document.createElement('div'); left.className='flex items-center gap-2 text-sm';
        if(flagged){ const star=document.createElement('span'); star.textContent='â˜…'; star.className='text-purple-500'; left.appendChild(star); }
        if(excluded){ const minus=document.createElement('span'); minus.textContent='â–'; minus.className='text-gray-500'; left.appendChild(minus); }

        const title=document.createElement('span'); const label=(it.problemTitle && String(it.problemTitle).trim())||`ë¬¸í•­ ${it.í‘œì‹œë²ˆí˜¸||it.ë¬¼ìŒë²ˆí˜¸||it.ê³ ìœ ID}`;
        title.textContent=label; title.className='block max-w-[18rem] xl:max-w-[22rem] truncate'; left.appendChild(title);

        const right=document.createElement('div'); right.className='text-xs'; const badge=document.createElement('span'); badge.className='px-2 py-0.5 rounded-full border '+(score==null?'text-gray-600 border-gray-300':'text-blue-700 border-blue-300'); badge.textContent= score==null?'X':`${score}`; right.appendChild(badge);

        row.appendChild(left); row.appendChild(right); row.title=`ì¶œì²˜:${it.ì¶œì²˜||'-'} | ID:${it.ê³ ìœ ID}`;
        row.addEventListener('click',()=>{
          const ch=String(it.ë‹¨ì›).trim(), list=base.filter(x=>String(x.ë‹¨ì›).trim()===ch);
          currentQuizData=list.length?list:[it]; currentQuestionIndex=list.findIndex(x=>String(x.ê³ ìœ ID).trim()===String(it.ê³ ìœ ID).trim()); if(currentQuestionIndex<0) currentQuestionIndex=0;
          el.quizArea.classList.remove('hidden'); displayQuestion(); showToast(`'${label}' ë¡œ ì´ë™`);
        });
        el.explorerProblems.appendChild(row);
      });
    }
    const moveSourceFilterToSide=()=>{ if(!el.sourceFilterSide||!el.sourceGroupFilter) return; el.sourceFilterSide.innerHTML=''; el.sourceGroupFilter.classList.remove('mb-6'); el.sourceFilterSide.appendChild(el.sourceGroupFilter); };
    const refreshPanels=()=>{ renderCalendarMonth(); renderStats(); renderExplorer(); };

    /* ========================================
     * HLR (Half-Life Regression) ë³µìŠµ ì•Œê³ ë¦¬ì¦˜
     * ======================================== */

    /**
     * HLR ë°ì´í„°ì…‹ ìƒì„±: solveHistoryë¥¼ HLR í•™ìŠµìš© í”¼ì²˜ë¡œ ë³€í™˜
     * @returns {Array} HLR í•™ìŠµìš© ë ˆì½”ë“œ ë°°ì—´
     */
    function buildHLRDataset() {
      const records = [];
      const now = Date.now();

      for (const [qid, rec] of Object.entries(questionScores || {})) {
        const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
        if (hist.length < 1) continue;

        // ì‹œê°„ìˆœ ì •ë ¬
        hist.sort((a, b) => (+a?.date || 0) - (+b?.date || 0));

        let prevDate = null;
        let totalReviews = 0;
        let correctCount = 0;
        let incorrectCount = 0;
        const scores = [];

        for (let i = 0; i < hist.length; i++) {
          const h = hist[i];
          const date = +h?.date;
          const score = clamp(+h?.score || 0, 0, 100);

          if (!Number.isFinite(date)) continue;

          scores.push(score);
          totalReviews++;
          if (score >= 80) correctCount++;
          else incorrectCount++;

          // i >= 1: ì´ì „ í•™ìŠµ ê¸°ë¡ì´ ìˆì–´ì•¼ Î” ê³„ì‚° ê°€ëŠ¥
          if (prevDate && i >= 1) {
            const delta = (date - prevDate) / (1000 * 86400); // ì¼ ë‹¨ìœ„
            if (delta <= 0) continue; // ê°™ì€ ë‚  ì—°ì† í’€ì´ëŠ” skip

            let p_observed = score / 100.0;
            p_observed = Math.max(0.01, Math.min(0.99, p_observed)); // log(0) ë°©ì§€

            // h ê³„ì‚°: p = 2^(-Î”/h) â†’ h = -Î” / logâ‚‚(p)
            const h_true = -delta / Math.log2(p_observed);
            const y = Math.log2(h_true); // íƒ€ê²Ÿ: logâ‚‚(h)

            // í”¼ì²˜ ë²¡í„° x
            const x = {
              bias: 1,
              total_reviews: totalReviews,
              mean_score: scores.reduce((a, b) => a + b, 0) / scores.length,
              last_score: score,
              correct_count: correctCount,
              incorrect_count: incorrectCount,
              correct_ratio: correctCount / totalReviews,
              last_is_correct: score >= 80 ? 1 : 0,
              time_since_first: (date - hist[0].date) / (1000 * 86400),
              first_solve_quality: hist[0].score / 100.0
            };

            records.push({ qid, y, x, delta, p_observed, h_true });
          }

          prevDate = date;
        }
      }

      return records;
    }

    /**
     * HLR ë°ì´í„°ì…‹ CSV ë‚´ë³´ë‚´ê¸°
     */
    function exportHLRDataset() {
      const records = buildHLRDataset();
      const csv = [
        ['qid', 'y(log2h)', 'delta', 'p_observed', 'h_true', 'total_reviews', 'mean_score', 'last_score', 'correct_count', 'incorrect_count'].join(','),
        ...records.map(r => [
          r.qid,
          r.y.toFixed(4),
          r.delta.toFixed(2),
          r.p_observed.toFixed(2),
          r.h_true.toFixed(2),
          r.x.total_reviews,
          r.x.mean_score.toFixed(2),
          r.x.last_score,
          r.x.correct_count,
          r.x.incorrect_count
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hlr_dataset_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('HLR ë°ì´í„°ì…‹ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
    }

    /**
     * LocalHLRPredictor í´ë˜ìŠ¤: ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜ HLR ëª¨ë¸
     */
    class LocalHLRPredictor {
      constructor() {
        // ì´ˆê¸° ê°€ì¤‘ì¹˜ (ê²½í—˜ì  ê¸°ë³¸ê°’)
        this.modelWeights = {
          bias: 4.0,              // logâ‚‚(h) ê¸°ë³¸ê°’ â‰ˆ h=16ì¼
          total_reviews: 0.15,    // ë¦¬ë·° ë§ì„ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
          mean_score: 0.008,      // í‰ê·  ì ìˆ˜ ë†’ì„ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
          last_score: 0.005,      // ìµœê·¼ ì ìˆ˜ ë†’ì„ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
          correct_count: 0.1,     // ì •ë‹µ íšŸìˆ˜ ë§ì„ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
          incorrect_count: -0.12, // ì˜¤ë‹µ íšŸìˆ˜ ë§ì„ìˆ˜ë¡ ë°˜ê°ê¸° ê°ì†Œ
          time_since_first: 0.02, // ì²« í’€ì´ë¶€í„° ì˜¤ë˜ë ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
          first_solve_quality: 0.5 // ì²« í’€ì´ ì ìˆ˜ ë†’ì„ìˆ˜ë¡ ë°˜ê°ê¸° ì¦ê°€
        };
      }

      predict(features) {
        let log2h = this.modelWeights.bias;

        for (const [key, weight] of Object.entries(this.modelWeights)) {
          if (key === 'bias') continue;
          const val = features[key] || 0;
          log2h += weight * val;
        }

        // logâ‚‚(h)ë¥¼ hë¡œ ë³€í™˜
        const h = Math.pow(2, log2h);
        return Math.max(1, Math.min(365, h)); // 1ì¼~1ë…„ ì‚¬ì´ë¡œ ì œí•œ
      }

      getNextReviewDelta(h, targetRetrieval = 0.9) {
        // p = 2^(-Î”/h) = R_target
        // Î” = -h * logâ‚‚(R_target)
        const log2_R = Math.log2(targetRetrieval);
        const delta = -h * log2_R;
        return delta; // ì¼ ë‹¨ìœ„
      }
    }

    // HLR Predictor ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
    const hlrPredictor = new LocalHLRPredictor();

    /**
     * íŠ¹ì • ë¬¸ì œì˜ HLR í”¼ì²˜ ìƒì„±
     * @param {string} qid - ë¬¸ì œ ê³ ìœ  ID
     * @returns {object} HLR í”¼ì²˜ ê°ì²´
     */
    function buildFeaturesForQID(qid) {
      const rec = questionScores[normId(qid)];
      if (!rec) return null;

      const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
      if (hist.length < 1) return null;

      hist.sort((a, b) => (+a?.date || 0) - (+b?.date || 0));

      const now = Date.now();
      const scores = hist.map(h => clamp(+h?.score || 0, 0, 100));
      const totalReviews = hist.length;
      const correctCount = scores.filter(s => s >= 80).length;
      const incorrectCount = scores.filter(s => s < 80).length;

      return {
        bias: 1,
        total_reviews: totalReviews,
        mean_score: scores.reduce((a, b) => a + b, 0) / scores.length,
        last_score: scores[scores.length - 1],
        correct_count: correctCount,
        incorrect_count: incorrectCount,
        correct_ratio: correctCount / totalReviews,
        last_is_correct: scores[scores.length - 1] >= 80 ? 1 : 0,
        time_since_first: (now - (+hist[0]?.date || now)) / (1000 * 86400),
        first_solve_quality: scores[0] / 100.0
      };
    }

    /**
     * HLR ê¸°ë°˜ íšŒìƒ í™•ë¥  ê³„ì‚°
     * @param {string} qid - ë¬¸ì œ ê³ ìœ  ID
     * @returns {object} { h_pred, p_current, timeSinceLastReview } ë˜ëŠ” null
     */
    function calculateRecallProbability(qid) {
      const rec = questionScores[normId(qid)];
      if (!rec) return null;

      const features = buildFeaturesForQID(qid);
      if (!features) return null;

      // HLR ë°˜ê°ê¸° ì˜ˆì¸¡
      const h_pred = hlrPredictor.predict(features);

      // ë§ˆì§€ë§‰ í’€ì´ í›„ ê²½ê³¼ ì‹œê°„
      const lastReview = rec?.lastSolvedDate || 0;
      const now = Date.now();
      const timeSinceLastReview = (now - lastReview) / (1000 * 86400); // ì¼ ë‹¨ìœ„

      // í˜„ì¬ íšŒìƒ í™•ë¥ : p = 2^(-Î”/h)
      const p_current = Math.pow(2, -timeSinceLastReview / h_pred);

      return { h_pred, p_current, timeSinceLastReview };
    }

    /**
     * HLR ì•Œê³ ë¦¬ì¦˜ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (ê°œë°œì ì½˜ì†”ì—ì„œ ì‚¬ìš©)
     * ì‚¬ìš©ë²•: testHLR() - ì „ì²´ ë¬¸ì œ HLR ë¶„ì„
     *        testHLR('Q001') - íŠ¹ì • ë¬¸ì œ ë¶„ì„
     */
    window.testHLR = function(qid = null) {
      console.log('=== HLR ì•Œê³ ë¦¬ì¦˜ í…ŒìŠ¤íŠ¸ ===\n');

      if (qid) {
        // íŠ¹ì • ë¬¸ì œ í…ŒìŠ¤íŠ¸
        const rec = questionScores[normId(qid)];
        if (!rec) {
          console.log(`âŒ ë¬¸ì œ ${qid}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
          return;
        }

        const features = buildFeaturesForQID(qid);
        if (!features) {
          console.log(`âŒ ë¬¸ì œ ${qid}ì˜ í•™ìŠµ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.`);
          return;
        }

        const hlrData = calculateRecallProbability(qid);
        console.log(`ë¬¸ì œ ID: ${qid}`);
        console.log(`í”¼ì²˜:`, features);
        console.log(`ë°˜ê°ê¸° (h): ${hlrData.h_pred.toFixed(2)}ì¼`);
        console.log(`ë§ˆì§€ë§‰ í’€ì´: ${hlrData.timeSinceLastReview.toFixed(2)}ì¼ ì „`);
        console.log(`íšŒìƒ í™•ë¥ : ${(hlrData.p_current * 100).toFixed(1)}%`);
        console.log(`ë‹¤ìŒ ë³µìŠµ ê¶Œì¥: ${hlrPredictor.getNextReviewDelta(hlrData.h_pred, 0.9).toFixed(1)}ì¼ í›„\n`);
      } else {
        // ì „ì²´ ë¬¸ì œ í†µê³„
        const results = [];
        let totalCount = 0, recallSum = 0, forgettingCount = 0;

        for (const [qid, rec] of Object.entries(questionScores || {})) {
          const hlrData = calculateRecallProbability(qid);
          if (hlrData) {
            totalCount++;
            recallSum += hlrData.p_current;
            if (hlrData.p_current < 0.5) forgettingCount++;
            results.push({ qid, ...hlrData });
          }
        }

        console.log(`ì´ ë¬¸ì œ ìˆ˜: ${totalCount}ê°œ`);
        console.log(`í‰ê·  íšŒìƒ í™•ë¥ : ${(recallSum / totalCount * 100).toFixed(1)}%`);
        console.log(`ë§ê° ì„ë°• (íšŒìƒ<50%): ${forgettingCount}ê°œ`);
        console.log(`í‰ê·  ë°˜ê°ê¸°: ${(results.reduce((sum, r) => sum + r.h_pred, 0) / totalCount).toFixed(2)}ì¼\n`);

        // ìƒìœ„ 10ê°œ ë¬¸ì œ (íšŒìƒ í™•ë¥  ë‚®ì€ ìˆœ)
        const top10 = results.sort((a, b) => a.p_current - b.p_current).slice(0, 10);
        console.log('íšŒìƒ í™•ë¥  ë‚®ì€ TOP 10:');
        top10.forEach((r, i) => {
          console.log(`${i+1}. ${r.qid} - íšŒìƒ ${(r.p_current*100).toFixed(1)}% (ë°˜ê°ê¸° ${r.h_pred.toFixed(1)}ì¼, ${r.timeSinceLastReview.toFixed(1)}ì¼ ì „)`);
        });
      }

      console.log('\n=== í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
    };

    const REVIEW_STRATEGY_LS='reviewStrategy_v1';
    const getReviewStrategy=()=> localStorage.getItem(REVIEW_STRATEGY_LS)||'smart';
    function prioritizeTodayReview(list){
      list = (list||[]).filter(a => !questionScores[normId(a.ê³ ìœ ID)]?.userReviewExclude);
      const strat=getReviewStrategy();

      // HLR ì „ëµ: íšŒìƒ í™•ë¥  ê¸°ë°˜ ì •ë ¬
      if(strat==='hlr') {
        const now = Date.now();
        const scored = list.map(q => {
          const qid = normId(q.ê³ ìœ ID);
          const rec = questionScores[qid];

          // ìš°ì„ ìˆœìœ„ ì ìˆ˜ ê³„ì‚° (ë‚®ì„ìˆ˜ë¡ ë†’ì€ ìš°ì„ ìˆœìœ„)
          let priority = 0;

          // 1. ë³µìŠµ í”Œë˜ê·¸ ìµœìƒìœ„
          if (rec?.userReviewFlag && !rec?.userReviewExclude) priority -= 1000;

          // 2. HLR íšŒìƒ í™•ë¥  ê³„ì‚°
          const hlrData = calculateRecallProbability(qid);
          if (hlrData) {
            // íšŒìƒ í™•ë¥  ë‚®ì„ìˆ˜ë¡ ìš°ì„ ìˆœìœ„ ë†’ìŒ (ë§ê° ì„ë°•)
            priority += hlrData.p_current * 100; // 0~100

            // ë§ˆì§€ë§‰ í’€ì´ ì˜¤ë˜ëœ ìˆœ
            priority += hlrData.timeSinceLastReview * 0.5;
          } else {
            // HLR ë°ì´í„° ì—†ìœ¼ë©´ (ë¯¸í’€ì´) ì¤‘ê°„ ìš°ì„ ìˆœìœ„
            priority += 50;
          }

          // 3. í‰ê·  ì ìˆ˜ ë‚®ì€ ìˆœ
          const hist = Array.isArray(rec?.solveHistory) ? rec.solveHistory : [];
          if (hist.length > 0) {
            const scores = hist.map(h => clamp(+h?.score || 0, 0, 100));
            const meanScore = scores.reduce((a, b) => a + b, 0) / scores.length;
            priority += (100 - meanScore) * 0.1;
          } else {
            priority += 5; // ë¯¸í’€ì´ëŠ” ë‚®ì€ ê°€ì¤‘ì¹˜
          }

          return { q, priority, hlrData };
        });

        return scored.sort((a, b) => a.priority - b.priority).map(s => s.q);
      }

      if(strat==='flag'){ const f=list.filter(a=>questionScores[normId(a.ê³ ìœ ID)]?.userReviewFlag && !questionScores[normId(a.ê³ ìœ ID)]?.userReviewExclude); const r=list.filter(a=>!(questionScores[normId(a.ê³ ìœ ID)]?.userReviewFlag && !questionScores[normId(a.ê³ ìœ ID)]?.userReviewExclude)); return f.concat(r); }
      if(strat==='low'){ return [...list].sort((a,b)=>{ const sa=questionScores[normId(a.ê³ ìœ ID)]?.score??101, sb=questionScores[normId(b.ê³ ìœ ID)]?.score??101; return sa-sb; }); }
      if(strat==='recentWrong'){ return [...list].sort((a,b)=>{ const sa=questionScores[normId(a.ê³ ìœ ID)], sb=questionScores[normId(b.ê³ ìœ ID)], as=sa?.score??101, bs=sb?.score??101, ad=sa?.lastSolvedDate??0, bd=sb?.lastSolvedDate??0; return (as-bs)||(bd-ad); }); }
      return [...list].sort((a,b)=>{ const sa=questionScores[normId(a.ê³ ìœ ID)], sb=questionScores[normId(b.ê³ ìœ ID)], af=(sa?.userReviewFlag && !sa?.userReviewExclude)?0:1, bf=(sb?.userReviewFlag && !sb?.userReviewExclude)?0:1, aUn=sa?1:0, bUn=sb?1:0, aS=sa?.score??101, bS=sb?.score??101, aD=sa?.lastSolvedDate??0, bD=sb?.lastSolvedDate??0; return (af-bf)||(aUn-bUn)||(aS-bS)||(aD-bD); });
    }
    el.reviewStrategySelect?.addEventListener('change',e=>{ localStorage.setItem(REVIEW_STRATEGY_LS, e.target.value); showToast(`ì˜¤ëŠ˜ì˜ ë³µìŠµ ì „ëµ: ${e.target.value}`); refreshPanels(); });
    (function syncStrategy(){ const cur=getReviewStrategy(); if(el.reviewStrategySelect) el.reviewStrategySelect.value=cur; })();
    el.startReviewBtn?.addEventListener('click',()=>{ if(el.filterSelect) el.filterSelect.value='today-review'; reloadAndRefresh(); showToast('ì˜¤ëŠ˜ì˜ ë³µìŠµ ì‹œì‘'); });

    function openDrawer(){ 
      //document.body.classList.add('drawer-open'); 
      el.drawerBackdrop.classList.remove('hidden'); 
      el.leftDashboard.classList.remove('hidden'); el.leftDashboard.classList.add('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900','relative'); 
      el.drawerClose.classList.remove('hidden'); }
    function closeDrawer(){
      //document.body.classList.remove('drawer-open'); 
      el.drawerBackdrop.classList.add('hidden'); 
      el.leftDashboard.classList.add('hidden'); el.leftDashboard.classList.remove('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900','relative'); 
      el.drawerClose.classList.add('hidden'); }
    el.hamburger?.addEventListener('click', openDrawer);
    el.drawerBackdrop?.addEventListener('click', closeDrawer);
    el.drawerClose?.addEventListener('click', closeDrawer);
    window.addEventListener('resize',()=>{
      if(window.innerWidth>=1024){
        el.leftDashboard.classList.remove('hidden'); el.drawerBackdrop.classList.add('hidden'); document.body.classList.remove('drawer-open');
        el.leftDashboard.classList.remove('fixed','inset-0','z-[1100]','p-4','overflow-y-auto','bg-white','dark:bg-gray-900','relative'); el.drawerClose.classList.add('hidden');
      }else{ el.leftDashboard.classList.add('hidden'); }
    });

    document.addEventListener('DOMContentLoaded', async ()=>{
      try{ await loadData(); }catch(err){ console.error(err); $('question-text').textContent='ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (questions.json ë˜ëŠ” dataset-json í™•ì¸).'; showToast(`ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}`,'error'); }
      loadScores();initStatsDate();   loadApiKey(); loadSettings(); applyDarkMode(); migrateData();
      // ìƒí˜¸ë°°íƒ€ ì •í•©ì„± 1ì°¨ ë³´ì •
      enforceExclusiveFlagsOnAll();
      backfillReadStoreFromScores(false); ensureApiKeyGate();
      buildSourceFilterUI(); moveSourceFilterToSide();
      el.explorerSearch?.addEventListener('input', renderExplorer);
      refreshPanels();
    });
  </script>
</body>
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TC8G7NJD"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
</html>

