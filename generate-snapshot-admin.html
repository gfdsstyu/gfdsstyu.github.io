<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤ëƒ…ìƒ· ìƒì„± (ê´€ë¦¬ì ì „ìš©)</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Pretendard', -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2563eb;
      margin-bottom: 20px;
    }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .info { background: #dbeafe; border-left: 4px solid #2563eb; }
    .success { background: #d1fae5; border-left: 4px solid #10b981; }
    .error { background: #fee2e2; border-left: 4px solid #ef4444; }
    .warning { background: #fef3c7; border-left: 4px solid #f59e0b; }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 15px;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .steps {
      background: #f9fafb;
      padding: 20px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .steps ol {
      margin: 10px 0;
      padding-left: 20px;
    }
    .steps li {
      margin: 8px 0;
    }
    code {
      background: #e5e7eb;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ ë­í‚¹ ìŠ¤ëƒ…ìƒ· ìƒì„± (ê´€ë¦¬ì ì „ìš©)</h1>

    <div class="status info">
<strong>âš ï¸ ì£¼ì˜: ì´ í˜ì´ì§€ëŠ” ìµœì´ˆ 1íšŒ ìŠ¤ëƒ…ìƒ· ìƒì„±ìš©ì…ë‹ˆë‹¤</strong>

ì´ ì‘ì—…ì€ Firebase ê·œì¹™ì„ ì„ì‹œë¡œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
ì‘ì—… ì™„ë£Œ í›„ ë°˜ë“œì‹œ ê·œì¹™ì„ ì›ë˜ëŒ€ë¡œ ë³µì›í•˜ì„¸ìš”!
    </div>

    <div class="steps">
      <h3>ğŸ“‹ ì‹¤í–‰ ì „ ì¤€ë¹„ì‚¬í•­</h3>
      <ol>
        <li><strong>Firebase Console ì ‘ì†</strong>: <a href="https://console.firebase.google.com/" target="_blank">console.firebase.google.com</a></li>
        <li><strong>í”„ë¡œì íŠ¸ ì„ íƒ</strong>: gamrini-24b1f</li>
        <li><strong>Firestore Database â†’ ê·œì¹™(Rules) íƒ­</strong> í´ë¦­</li>
        <li><strong>ì„ì‹œ ê·œì¹™ìœ¼ë¡œ ë³€ê²½</strong>: ì•„ë˜ ì½”ë“œë¥¼ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ê¸°</li>
      </ol>

      <h4>ì„ì‹œ ê·œì¹™ (ë³µì‚¬í•˜ì„¸ìš”):</h4>
      <pre style="background: #1f2937; color: #f3f4f6; padding: 15px; border-radius: 5px; overflow-x: auto;">// ranking_cache ë¶€ë¶„ë§Œ ìˆ˜ì •
match /ranking_cache/{document} {
  // ì„ì‹œë¡œ ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ì ì“°ê¸° í—ˆìš©
  allow read, write: if isAuthenticated();
}</pre>

      <ol start="5">
        <li><strong>ê²Œì‹œ(Publish)</strong> í´ë¦­</li>
        <li>ì•„ë˜ <strong>"ìŠ¤ëƒ…ìƒ· ìƒì„±"</strong> ë²„íŠ¼ í´ë¦­</li>
        <li>ì™„ë£Œ í›„ <strong>ê·œì¹™ì„ ì›ë˜ëŒ€ë¡œ ë³µì›</strong></li>
      </ol>

      <h4>ì›ë˜ ê·œì¹™ (ë³µì›ìš©):</h4>
      <pre style="background: #1f2937; color: #f3f4f6; padding: 15px; border-radius: 5px; overflow-x: auto;">// ì›ë˜ ê·œì¹™
match /ranking_cache/{document} {
  allow read: if isAuthenticated();
  allow write: if false; // Cloud Functionsë§Œ ê°€ëŠ¥
}</pre>
    </div>

    <button id="loginBtn" onclick="login()">1. ë¡œê·¸ì¸</button>
    <button id="generateBtn" onclick="generateSnapshot()" disabled>2. ìŠ¤ëƒ…ìƒ· ìƒì„±</button>

    <div id="log"></div>
  </div>

  <script>
    // Firebase ì„¤ì • (index.htmlê³¼ ë™ì¼)
    const firebaseConfig = {
      apiKey: "AIzaSyByW5-HUH-dsvQpIZ1EHt_eUWNOa-7aLd8",
      authDomain: "gamrini-24b1f.firebaseapp.com",
      projectId: "gamrini-24b1f",
      storageBucket: "gamrini-24b1f.firebasestorage.app",
      messagingSenderId: "824078154253",
      appId: "1:824078154253:web:01937b50bc00c6f10e13c0",
      measurementId: "G-99WSKW2W53"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;

    // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const statusDiv = document.createElement('div');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      logDiv.appendChild(statusDiv);
      console.log(message);
    }

    // ë¡œê·¸ì¸
    async function login() {
      try {
        log('ğŸ” ë¡œê·¸ì¸ ì¤‘...', 'info');
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        currentUser = result.user;

        log(`âœ… ë¡œê·¸ì¸ ì„±ê³µ: ${currentUser.email}`, 'success');
        document.getElementById('loginBtn').disabled = true;
        document.getElementById('generateBtn').disabled = false;
      } catch (error) {
        log(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }

    // ìŠ¤ëƒ…ìƒ· ìƒì„±
    async function generateSnapshot() {
      if (!currentUser) {
        log('âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
        return;
      }

      try {
        log('ğŸš€ ìŠ¤ëƒ…ìƒ· ìƒì„± ì‹œì‘...', 'info');
        document.getElementById('generateBtn').disabled = true;

        // 1. rankings ì»¬ë ‰ì…˜ ì½ê¸°
        log('ğŸ“– rankings ì»¬ë ‰ì…˜ ì½ê¸° ì¤‘...', 'info');
        const rankingsSnapshot = await db.collection('rankings').get();
        log(`âœ… ì´ ${rankingsSnapshot.size}ëª…ì˜ ì‚¬ìš©ì ë°ì´í„° ë°œê²¬`, 'success');

        // 2. ë°ì´í„° ì¶”ì¶œ
        const users = [];
        rankingsSnapshot.forEach(doc => {
          const data = doc.data();
          users.push({
            userId: data.userId || doc.id,
            nickname: data.nickname || 'ìµëª…',
            university: data.university || null,
            daily: data.daily || {},
            weekly: data.weekly || {},
            monthly: data.monthly || {}
          });
        });

        // 3. ìŠ¤ëƒ…ìƒ· ìƒì„±
        const snapshot = {
          users: users,
          generatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          totalUsers: users.length,
          version: '1.0'
        };

        // 4. ranking_cacheì— ì €ì¥
        log('ğŸ’¾ ranking_cacheì— ìŠ¤ëƒ…ìƒ· ì €ì¥ ì¤‘...', 'info');
        await db.collection('ranking_cache').doc('snapshot').set(snapshot);

        // 5. ì™„ë£Œ
        const sizeKB = (JSON.stringify(snapshot).length / 1024).toFixed(2);
        log(`âœ… ìŠ¤ëƒ…ìƒ· ìƒì„± ì™„ë£Œ!`, 'success');
        log(`   - ì‚¬ìš©ì ìˆ˜: ${users.length}ëª…`, 'success');
        log(`   - ë°ì´í„° í¬ê¸°: ì•½ ${sizeKB} KB`, 'success');
        log('', 'success');
        log('ğŸ‰ ì„±ê³µ! ì´ì œ Firebase Consoleì—ì„œ ê·œì¹™ì„ ì›ë˜ëŒ€ë¡œ ë³µì›í•˜ì„¸ìš”!', 'warning');

      } catch (error) {
        log(`âŒ ìŠ¤ëƒ…ìƒ· ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');

        if (error.code === 'permission-denied') {
          log('', 'error');
          log('âš ï¸ ê¶Œí•œ ì˜¤ë¥˜: Firebase ê·œì¹™ì´ ì•„ì§ ìˆ˜ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
          log('ìœ„ì˜ "ì„ì‹œ ê·œì¹™"ì„ Firebase Consoleì—ì„œ ì ìš©í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.', 'warning');
        }

        document.getElementById('generateBtn').disabled = false;
      }
    }

    // ì¸ì¦ ìƒíƒœ ëª¨ë‹ˆí„°ë§
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        log(`âœ… ì´ë¯¸ ë¡œê·¸ì¸ë¨: ${user.email}`, 'success');
        document.getElementById('loginBtn').disabled = true;
        document.getElementById('generateBtn').disabled = false;
      }
    });
  </script>
</body>
</html>
