# 단원별 문제풀이 기능 PRD (Product Requirements Document)

## 문서 정보
- **최종 업데이트**: 2025-01-23 (v2)
- **상태**: 구현 완료 / 일부 항목 미구현

---

## 1. 현재 구조 분석

### 기존 데이터 구조 (2025_hierarchical.json)
```json
{
  "examId": "2025완료 (2)",
  "cases": [
    {
      "caseId": "2025_Q1",
      "topic": "윤리기준과 독립성",
      "chapter": "2.0",  // <- chapter 필드 (문자열, 소수점 허용)
      "subQuestions": [...]
    }
  ]
}
```

### 단원 매핑 (config.js의 CHAPTER_LABELS 참조)
```javascript
// js/config/config.js에 정의됨
export const CHAPTER_LABELS = {
  1: "제1장 감사와 회계감사의 기본개념",
  2: "제2장 감사인의 의무, 책임 및 자격요건",
  3: "제3장 감사인의 독립성과 품질관리",
  // ... 1~20까지 정의됨
};
```

### UI 흐름
```
renderExamMode()
  → renderYearSelection()       // 연도 카드 그리드 + 단원별 풀이 버튼
    ├─ startExam(year)          // 연도별 시험 시작
    │   → renderExamPaper()
    └─ renderChapterSelection() // 단원 선택 화면 (신규)
        → startChapterExam()    // 단원별 시험 시작
            → renderChapterExamPaper()
```

---

## 2. 구현 현황

### ✅ 완료된 항목 (2025-01-23)

#### 2.1 단원별 문제풀이 기능
| 항목 | 상태 | 설명 |
|------|------|------|
| 단원별 풀이 버튼 | ✅ | 연도 선택 화면에 "📚 단원별 풀이" 버튼 추가 |
| 단원 선택 화면 | ✅ | 기준서 단원(1장~15장)별 문제 카드 표시 |
| 단원별 통계 | ✅ | 각 단원별 문제 수, 총 배점, 응시 횟수, 최고 점수 표시 |
| 단원별 문제풀이 | ✅ | 해당 단원의 모든 연도 문제를 통합하여 풀이 |
| 제한 시간 | ✅ | 총 배점 × 1분으로 계산 (최소 5분) |
| 제한 시간 설정 | ✅ | ⚙️ 버튼으로 사용자 커스텀 시간 설정 (5분~180분), localStorage 저장 |
| 자동 저장 | ✅ | localStorage에 답안 자동 저장 |
| 단원별 채점 | ✅ | AI 채점 후 상세 피드백 제공 |

#### 2.2 플로팅 바로가기 컨트롤
| 항목 | 상태 | 설명 |
|------|------|------|
| 연도별 문제풀이 | ✅ | 우측 플로팅 컨트롤로 문제 번호 바로가기 |
| 연도별 채점결과 | ✅ | 문제별 점수 색상 표시 (녹색=90%↑, 노랑=50%↑, 빨강=50%↓) |
| 단원별 문제풀이 | ✅ | 물음별 바로가기 컨트롤 추가 |
| UI 스타일 | ✅ | 세로 리스트 형태, 왼쪽 border 색상으로 상태 표시 |

#### 2.3 문제별 메모 기능
| 항목 | 상태 | 설명 |
|------|------|------|
| 메모 저장 | ✅ | 각 문제별 개인 메모 작성/수정/삭제 |
| 저장 위치 | ✅ | localStorage (`exam_question_memos` 키) |
| 연도별/단원별 공유 | ✅ | 같은 문제 ID면 메모 공유 |
| 채점 결과 화면 | ✅ | 각 문제 해설 아래 노란색 메모 영역 표시 |
| PDF 내보내기 | ✅ | "📝 나의 메모 포함" 체크박스 옵션 추가 |

#### 2.4 연도 선택 화면 UI 개선
| 항목 | 상태 | 설명 |
|------|------|------|
| 오답만 다시 풀기 | ✅ | 버튼 → 텍스트 링크로 변경 (카드 높이 축소) |
| 결과보기 버튼 | ✅ | 📊 아이콘만 표시 (컴팩트) |

---

### ⏳ 미구현 항목

#### 2.5 단원별 오답 다시 풀기
| 항목 | 상태 | 설명 |
|------|------|------|
| 단원별 오답 풀이 | ⏳ | 해당 단원에서 틀린 문제만 다시 풀기 |
| 오답 통계 | ⏳ | 단원별 오답률 표시 |

#### 2.6 단원별 결과 보기
| 항목 | 상태 | 설명 |
|------|------|------|
| 결과보기 버튼 | ⏳ | 단원 카드에 📊 결과보기 버튼 추가 |
| 과거 결과 조회 | ⏳ | 단원별 응시 기록 목록 조회 |

#### 2.7 문제 정렬 옵션
| 항목 | 상태 | 설명 |
|------|------|------|
| 정렬 옵션 UI | ⏳ | 연도순/랜덤 정렬 선택 |
| 랜덤 정렬 | ⏳ | 문제 순서 섞기 기능 |

#### 2.8 회차별 답안 히스토리 조회
| 항목 | 상태 | 설명 |
|------|------|------|
| 히스토리 저장 | ✅ | `exam_question_history_${questionId}` 키로 회차별 답안/점수/피드백 저장 (최대 20개) |
| 점수 원형 표시 | ✅ | 채점결과 화면에 점수 히스토리 원형 표시 (최근 5회, 날짜 포함) |
| 회차별 답안 보기 | ✅ | 원형 클릭 시 해당 회차 답안/피드백 표시 (연도별/단원별 모두) |
| 히스토리 토글 | ✅ | 선택된 원형 다시 클릭 시 상세 패널 숨김 (토글 기능) |
| 단원별 문제지 점수흐름 | ✅ | 문제지 UI에 최근 3회 점수 추이 표시 (📊 4.0 ↑5.0 형식) |

---

## 3. 파일 변경 내역

| 파일 | 변경 내용 |
|------|----------|
| `js/features/exam/examUI.js` | 단원별 풀이 화면, 플로팅 컨트롤, 버튼 UI, renderChapterSelection(), renderChapterExamPaper(), setupChapterFloatingControls(), showChapterTimerSettingModal() |
| `js/features/exam/examResultUI.js` | 단원별 결과 화면, 메모 UI, 플로팅 컨트롤 |
| `js/features/exam/examService.js` | 단원별 데이터 조회 (getQuestionsByChapter, getAvailableChapters), 메모 저장/조회/삭제 함수 |
| `js/features/exam/examPdfExport.js` | PDF 내보내기에 메모 포함 |

---

## 4. 데이터 저장 구조

### localStorage 키
```
exam_chapter_${chapter}_answers      // 단원별 답안 저장
exam_chapter_${chapter}_scores       // 단원별 점수 저장
exam_chapter_${chapter}_time_limit   // 단원별 사용자 설정 제한시간 (분)
exam_question_memos                  // 문제별 메모 저장
exam_question_history_${questionId}  // 문제별 풀이 히스토리 (최대 20회)
```

### 메모 데이터 구조
```javascript
{
  "questionId": {
    "memo": "사용자 메모 내용",
    "updatedAt": "2025-01-23T12:00:00Z"
  }
}
```

---

## 5. UI 레이아웃

### 연도 선택 화면 (수정됨)
```
┌─────────────────────────────────────────┐
│  📝 기출문제 실전연습                    │
├─────────────────────────────────────────┤
│                                         │
│  [📚 단원별 풀이]  ← 단원 선택으로 이동  │
│                                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ 2025    │ │ 2024    │ │ 2023    │   │
│  │ 9문제   │ │ 10문제  │ │ 10문제  │   │
│  │ 📊      │ │ 📊 85   │ │ 미응시  │   │
│  │ 오답재시│ │ 오답재시│ │         │   │
│  └─────────┘ └─────────┘ └─────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### 단원 선택 화면
```
┌─────────────────────────────────────────────────────┐
│  📚 단원별 문제풀이          [← 연도별 풀이]         │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────────┐  ┌─────────────────┐          │
│  │ 제3장           │  │ 제7장           │          │
│  │ 감사인의 독립성 │  │ 위험평가절차와  │          │
│  │ 과 품질관리     │  │ 계획수립        │          │
│  │                 │  │                 │          │
│  │ 📊 8문제 / 40점 │  │ 📊 12문제 / 60점│          │
│  │ 🏆 최고 85점    │  │ 미응시          │          │
│  │                 │  │                 │          │
│  │ [시작하기]      │  │ [시작하기]      │          │
│  └─────────────────┘  └─────────────────┘          │
│  ...                                                │
└─────────────────────────────────────────────────────┘
```

### 플로팅 바로가기 컨트롤
```
┌──────┐
│ ▼ 📋 │ ← 접기/펼치기 토글
├──────┤
│ █ 1  │ ← 녹색 border = 완료
│ █ 2  │ ← 노란색 border = 진행중
│ █ 3  │ ← 회색 border = 미작성
│ █ 4  │
│ ...  │
└──────┘
```

---

## 6. 결정 사항

1. **chapter 번호 체계**: 문자열 허용 ("2.0", "10.5" 등), 정렬 시 parseFloat() 사용
2. **단원명 매핑**: `js/config/config.js`의 `CHAPTER_LABELS` 참조
3. **문제 정렬**: 연도순 정렬 (기본값)
4. **제한 시간**: 총 배점 × 1분 (기본값, 최소 5분), 사용자 설정 가능 (5분~180분)

---

## 7. 향후 개선 사항

1. **단원별 오답 다시 풀기**: 틀린 문제만 모아서 재응시
2. **정렬 옵션**: 연도순/랜덤 정렬 선택 기능
3. **단원별 과거 결과 조회**: 응시 기록 목록 화면
4. **단원간 이동**: 채점 결과 화면에서 다음/이전 단원으로 바로 이동

---

## 8. 회차별 답안 히스토리 조회 UX 계획

### 8.1 기존 데이터 구조 (이미 구현됨)
```javascript
// localStorage: exam_question_history_${questionId}
[
  {
    "timestamp": 1706012345678,
    "mode": "year" | "chapter",
    "context": "2025" | "3",  // 연도 또는 단원번호
    "userAnswer": "사용자가 작성한 답안...",
    "score": 4.5,
    "maxScore": 5,
    "feedback": "AI 피드백 내용..."
  },
  // ... 최대 20개 (오래된 것부터 삭제)
]
```

### 8.2 채점결과 화면 - 회차별 답안 보기 UI

#### 현재 상태 (점수만 표시)
```
점수 히스토리: [3.5] [4.0] [4.5] [5.0] [4.5]  ← 마지막에 파란 테두리
```

#### 개선 후 (클릭하여 답안 조회)
```
┌───────────────────────────────────────────────────────────────┐
│ 점수 히스토리: (클릭하여 답안 보기)                            │
│                                                               │
│  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐               │
│  │ 3.5 │  │ 4.0 │  │ 4.5 │  │ 5.0 │  │ 4.5 │  ← 클릭 가능   │
│  │ 1/15│  │ 1/18│  │ 1/20│  │ 1/21│  │ 1/23│  ← 날짜 표시   │
│  └─────┘  └─────┘  └─────┘  └─────┘  └─────┘               │
│           선택됨 ↑ (파란 테두리 + 아래 화살표)                │
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 📅 2025-01-18 풀이 (연도별 2025)                        │ │
│  │                                                         │ │
│  │ ✍️ 당시 내 답안:                                        │ │
│  │ "감사인은 독립성을 유지해야 하며..."                     │ │
│  │                                                         │ │
│  │ 🤖 당시 AI 피드백:                                      │ │
│  │ "핵심 개념은 맞으나 구체적 요건 서술 부족..."            │ │
│  └─────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────┘
```

### 8.3 단원별 문제지 - 점수 흐름 표시

#### 문제 카드 헤더 영역
```
┌─────────────────────────────────────────────────────────────┐
│ ▶ 물음 1 (5점)        📊 4.0 → 4.5 → 5.0   [텍스트 영역]    │
│                       ~~~~~~~~~~~~                          │
│                       과거 점수 미니 표시                    │
└─────────────────────────────────────────────────────────────┘
```

- 문제 카드에 최근 3회 점수 흐름 간략 표시
- 색상: 상승(초록), 하락(빨강), 유지(회색) 화살표
- 점수 없으면 "미응시" 또는 표시 안함

### 8.4 구현 순서

1. **1단계: 채점결과 - 회차 선택 UI**
   - 기존 점수 원형에 날짜 표시 추가
   - 클릭 이벤트 추가 (선택 상태 관리)
   - 선택된 회차의 답안/피드백 표시 영역 추가

2. **2단계: 단원별 문제지 - 점수 흐름**
   - 문제 카드 헤더에 미니 히스토리 추가
   - 최근 3회 점수 + 화살표로 추세 표시

### 8.5 컴포넌트 구조

```javascript
// 회차별 히스토리 컴포넌트
function renderHistorySelector(questionId, questionHistory, selectedIndex) {
  // 클릭 가능한 점수 원형 리스트
  // 날짜 표시 (MM/DD 형식)
  // 선택된 항목 강조 (파란 테두리 + 아래 화살표)
}

function renderSelectedHistoryDetail(historyItem) {
  // 선택된 회차의 상세 정보
  // 풀이 일시, 모드(연도별/단원별), 컨텍스트
  // 당시 답안
  // 당시 AI 피드백
}

// 점수 흐름 미니 컴포넌트
function renderScoreTrend(questionHistory, maxCount = 3) {
  // 최근 N회 점수 + 화살표
  // ex: "4.0 → 4.5 → 5.0"
}
```
